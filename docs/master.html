<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mount 2K Management System</title>
    <link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="M2K Portal" />
    <link rel="manifest" href="/favicon/site.webmanifest" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #f3f4f6;
            min-height: 100vh;
            color: #1f2937;
            line-height: 1.6;
        }

        .container {
            max-width: 100%;
            margin: 0;
            padding: 0;
        }

        /* Modern Navigation Bar */
        .top-nav {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .top-nav-title {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .top-nav-welcome {
            font-size: 14px;
            font-weight: 500;
            padding: 6px 16px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .top-nav-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .top-nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .top-nav-btn.save {
            background: #10b981;
            border-color: #059669;
        }

        .top-nav-btn.save:hover {
            background: #059669;
        }

        .top-nav-btn.logout {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .top-nav-btn.logout:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .header {
            display: none;
        }

        /* Modern Horizontal Tabs */
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 0;
            flex-wrap: wrap;
            background: white;
            padding: 0;
            border-radius: 0;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 68px;
            z-index: 99;
        }

        .tab-button {
            padding: 16px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 14px;
            color: #6b7280;
            white-space: nowrap;
            flex-shrink: 0;
            border-radius: 0;
        }

        .tab-button.active {
            background: transparent;
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            box-shadow: none;
        }

        .tab-button:hover {
            background: #f9fafb;
            color: #1e40af;
        }

        .tab-button.active:hover {
            background: #f9fafb;
            color: #3b82f6;
        }

        /* Dropdown Tabs */
        .tab-dropdown {
            position: relative;
            display: inline-block;
        }

        .tab-dropdown-button {
            padding: 16px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 14px;
            color: #6b7280;
            white-space: nowrap;
            flex-shrink: 0;
            border-radius: 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tab-dropdown-button:hover {
            background: #f9fafb;
            color: #1e40af;
        }

        .tab-dropdown-button.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .tab-dropdown-button svg {
            width: 12px;
            height: 12px;
            transition: transform 0.2s ease;
        }

        .tab-dropdown-button.open svg {
            transform: rotate(180deg);
        }

        .tab-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            min-width: 220px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 0 0 8px 8px;
            overflow: hidden;
            z-index: 1000;
            animation: dropdown-slide-down 0.2s ease;
            border: 1px solid #e5e7eb;
            border-top: none;
        }

        @keyframes dropdown-slide-down {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-dropdown-content.show {
            display: block;
        }

        .tab-dropdown-item {
            display: block;
            padding: 12px 20px;
            color: #4b5563;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.15s ease;
            cursor: pointer;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
        }

        .tab-dropdown-item:hover {
            background: #f3f4f6;
            color: #1e40af;
            padding-left: 24px;
        }

        .tab-dropdown-item.active {
            background: #eff6ff;
            color: #3b82f6;
            font-weight: 600;
        }

        /* Content Area */
        .content-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .tab-content {
            display: none;
            background: transparent;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
        }

        .tab-content.active {
            display: block;
        }

        .tab-content h2 {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }

        .header h1 {
            margin-bottom: 8px;
            font-size: 2.2em;
            color: #1b2937;
            font-weight: 700;
        }

        .header p {
            color: #4b5563;
            font-size: 1em;
        }

        /* Logout Button */
        .logout-btn {
            position: absolute;
            top: 24px;
            right: 24px;
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .logout-btn:hover {
            background: #fee2e2;
            border-color: #fca5a5;
            transform: translateY(-1px);
        }

        /* Front View Button */
        .front-view-btn {
            position: absolute;
            top: 24px;
            right: 140px;
            background: #eff6ff;
            color: #0ea5e9;
            border: 1px solid #bfdbfe;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            font-weight: 600;
        }

        .front-view-btn:hover {
            background: #dbeafe;
            border-color: #93c5fd;
            transform: translateY(-1px);
        }

        /* Tab System */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: white;
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        .tab-button {
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 14px;
            color: #6b7280;
        }

        .tab-button.active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .tab-button:hover {
            background: #dbeafe;
            color: #1e40af;
        }

        .tab-button.active:hover {
            background: #2563eb;
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .tab-content.active {
            display: block;
        }

        /* Dashboard Statistics */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
        }

        .stat-card:hover {
            box-shadow: 0 4px 12px 0 rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
            border-color: #3b82f6;
        }

        .stat-card h3 {
            font-size: 1.8em;
            margin-bottom: 6px;
            color: #1f2937;
            font-weight: 700;
        }

        .stat-card p {
            color: #6b7280;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 6px;
            font-weight: 600;
            color: #374151;
            font-size: 0.9em;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            margin: 5px;
            font-size: 14px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background: #2563eb;
        }
        .btn-success {
            background: #10b981;
            color: white;
        }
        .btn-success:hover {
            background: #059669;
        }
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        .btn-warning:hover { background: #b8941f; }

        /* Tables */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow: hidden;
            border-radius: 8px;
        }

        .table th, .table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
        }

        .table th {
            background: #f9fafb;
            color: #6b7280;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75em;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }

        .table tr:hover {
            background: #f9fafb;
        }

        .table tbody tr {
            transition: all 0.2s ease;
        }

        /* Search */
        .search-bar {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 15px;
            margin-bottom: 20px;
            transition: all 0.2s ease;
        }

        .search-bar:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Assignment System */
        .assignment-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .group-details, .available-rooms {
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .room-card {
            background: white;
            padding: 16px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .room-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: translateY(-2px);
            border-left-color: #2563eb;
        }

        .room-card.selected {
            background: #dbeafe;
            border: 4px solid #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2), 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: scale(1.02);
            position: relative;
        }

        .room-card.selected::before {
            content: '‚úì SELECTED';
            position: absolute;
            top: 8px;
            right: 12px;
            background: #3b82f6;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        /* Status Indicators */
        .section-id {
            background: #3b82f6;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            border: 1px solid #d4af37;
        }

        .assignment-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 700;
        }

        .status-assigned { background: #d1fae5; color: #065f46; }
        .status-unassigned { background: #fee2e2; color: #991b1b; }

        /* Gender Color Coding */
        .male-section {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 16px;
            border-radius: 8px;
            margin: 8px 0;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .female-section {
            background: #fce7f3;
            border-left: 4px solid #ec4899;
            padding: 16px;
            border-radius: 8px;
            margin: 8px 0;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        /* Notifications */
        .notification {
            padding: 16px;
            margin: 12px 0;
            border-radius: 8px;
            font-weight: 600;
        }

        .notification.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .notification.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .notification.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        /* Capacity Displays */
        .capacity-display {
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.875em;
        }

        .capacity-positive { background: #d1fae5; color: #065f46; }
        .capacity-negative { background: #fee2e2; color: #991b1b; }
        .capacity-zero { background: #fef3c7; color: #92400e; }

        /* Scrollable Tables */
        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-top: 10px;
        }

        /* Table Filtering and Sorting */
        .table-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-input {
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            font-size: 14px;
        }

        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .sort-select {
            padding: 8px 12px;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        /* Sortable Table Headers */
        .table th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px;
        }

        .table th.sortable:hover {
            background: #0f3a4a !important;
        }

        .table th.sortable::after {
            content: '‚ÜïÔ∏è';
            position: absolute;
            right: 8px;
            opacity: 0.5;
            font-size: 12px;
        }

        .table th.sortable.sort-asc::after {
            content: '‚¨ÜÔ∏è';
            opacity: 1;
        }

        .table th.sortable.sort-desc::after {
            content: '‚¨áÔ∏è';
            opacity: 1;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .assignment-container {
                grid-template-columns: 1fr;
            }
            
            .dashboard-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tabs {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 5px;
            }
            
            .tab-button {
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        /* Print Styles for PDF Generation */
        @media print {
            @page {
                size: letter;
                margin: 0.5in;
            }
            
            .no-print {
                display: none !important;
            }
            
            .page-break {
                page-break-after: always;
            }
            
            body {
                background: white;
            }
        }

        /* Password Protection Styles - Modern Login Screen */
        #password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0f1419 0%, #1b2937 50%, #2d3748 100%);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        }

        .password-container {
            background: white;
            padding: 48px;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 420px;
            width: 90%;
            text-align: center;
        }

        .password-container h1 {
            color: #1b2937;
            margin-bottom: 12px;
            font-size: 2em;
            font-weight: 700;
        }

        .password-container p {
            color: #4b5563;
            margin-bottom: 32px;
            font-size: 1em;
        }

        .password-input-group {
            margin-bottom: 24px;
            text-align: left;
        }

        .password-input-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
            font-size: 0.9em;
        }

        .password-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            transition: all 0.2s ease;
        }

        .password-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .password-btn {
            width: 100%;
            padding: 14px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .password-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .password-error {
            background: #fee2e2;
            color: #991b1b;
            margin-top: 16px;
            padding: 12px;
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid #fecaca;
            display: none;
        }

        .password-setup {
            background: #fef3c7;
            border: 2px solid #fde68a;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .password-setup h3 {
            color: #92400e;
            margin-bottom: 12px;
            font-size: 1.1em;
            font-weight: 700;
        }

        .password-setup p {
            color: #856404;
            font-size: 14px;
            margin-bottom: 15px;
        }

        /* Edit User Modal Styles */
        #edit-user-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        }

        #edit-user-modal.active {
            display: flex;
        }

        .edit-user-modal-content {
            background: white;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .edit-user-modal-content h2 {
            color: #1f2937;
            margin-bottom: 8px;
            font-size: 1.5em;
            font-weight: 700;
        }

        .edit-user-modal-content .subtitle {
            color: #6b7280;
            margin-bottom: 24px;
            font-size: 0.9em;
        }

        .edit-user-form-group {
            margin-bottom: 20px;
        }

        .edit-user-form-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
            font-size: 0.9em;
        }

        .edit-user-form-group input,
        .edit-user-form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 15px;
            box-sizing: border-box;
            transition: all 0.2s ease;
        }

        .edit-user-form-group input:focus,
        .edit-user-form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .edit-user-checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .edit-user-checkbox-group:hover {
            background: #f3f4f6;
        }

        .edit-user-checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .edit-user-checkbox-group label {
            margin: 0;
            cursor: pointer;
            flex: 1;
        }

        .edit-user-modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .edit-user-modal-buttons button {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .edit-user-modal-buttons .btn-save {
            background: #3b82f6;
            color: white;
        }

        .edit-user-modal-buttons .btn-save:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .edit-user-modal-buttons .btn-cancel {
            background: #e5e7eb;
            color: #374151;
        }

        .edit-user-modal-buttons .btn-cancel:hover {
            background: #d1d5db;
        }

        .edit-user-password-section {
            background: #fef3c7;
            border: 2px solid #fde68a;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .edit-user-password-section h4 {
            color: #92400e;
            margin-bottom: 12px;
            font-size: 1em;
            font-weight: 600;
        }

        #main-content {
            display: none;
        }

        #main-content.unlocked {
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .top-nav {
                padding: 12px 16px;
                flex-direction: column;
                gap: 12px;
            }

            .top-nav-left {
                flex-direction: column;
                gap: 8px;
                text-align: center;
                width: 100%;
            }

            .top-nav-right {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }

            .top-nav-btn {
                padding: 8px 16px;
                font-size: 13px;
            }

            .tabs {
                top: 120px;
            }

            .tab-button {
                padding: 12px 16px;
                font-size: 13px;
            }

            .content-wrapper {
                padding: 16px;
            }

            .dashboard-stats {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .top-nav-title {
                font-size: 16px;
            }

            .tab-content h2 {
                font-size: 22px;
            }

            .stat-card h3 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <!-- Password Protection Overlay -->
    <div id="password-overlay">
        <div class="password-container">
            <h1>üîí Secure Access</h1>
            <p>Mount 2K Management System</p>

            <div id="password-setup-mode" class="password-setup" style="display: none;">
                <h3>‚öôÔ∏è First Time Setup</h3>
                <p>Create a password to protect this system</p>
            </div>

            <div class="password-input-group" id="username-field-group">
                <input type="text"
                       id="username-input"
                       class="password-input"
                       placeholder="Enter username"
                       onkeypress="if(event.key==='Enter') { event.preventDefault(); document.getElementById('password-input').focus(); }">
            </div>

            <div class="password-input-group">
                <input type="password"
                       id="password-input"
                       class="password-input"
                       placeholder="Enter password"
                       onkeypress="if(event.key==='Enter') { event.preventDefault(); checkPassword(); }">
            </div>

            <button type="button" class="password-btn" onclick="event.preventDefault(); checkPassword();">
                <span id="password-btn-text">üîì Unlock</span>
            </button>

            <a href="/index.html" class="portal-btn" onclick="ensureHTTPS(event, '/index.html')" style="display: inline-block; margin-top: 12px; padding: 14px 32px; background: linear-gradient(135deg, #3b82f6 0%, #1e3a8a 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                üè† Back to Portal
            </a>

            <div id="password-error" class="password-error">
                ‚ùå Incorrect password. Please try again.
            </div>

            <div id="login-mode-note" style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; text-align: left;">
                <small style="color: #1565c0;">
                    <strong>üõ°Ô∏è Security Note:</strong><br>
                    <span id="login-note-text">Please enter your username and password to access the system.</span>
                </small>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="edit-user-modal">
        <div class="edit-user-modal-content">
            <h2>Edit User</h2>
            <p class="subtitle">Update user information and credentials</p>

            <div class="edit-user-form-group">
                <label for="edit-user-username">Username</label>
                <input type="text" id="edit-user-username" disabled style="background: #f3f4f6; cursor: not-allowed;">
            </div>

            <div class="edit-user-form-group">
                <label for="edit-user-fullname">Full Name</label>
                <input type="text" id="edit-user-fullname" placeholder="Enter full name">
            </div>

            <div class="edit-user-form-group">
                <label for="edit-user-role">Role</label>
                <select id="edit-user-role">
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                </select>
            </div>

            <div class="edit-user-checkbox-group" onclick="document.getElementById('edit-user-is-admin').click(); event.stopPropagation();">
                <input type="checkbox" id="edit-user-is-admin" onclick="event.stopPropagation();">
                <label for="edit-user-is-admin">
                    <strong>Admin Privileges</strong><br>
                    <small style="color: #6b7280;">Can manage all settings and clear data</small>
                </label>
            </div>

            <div class="edit-user-password-section">
                <h4>Change Password</h4>
                <div class="edit-user-checkbox-group" onclick="togglePasswordChange(); event.stopPropagation();" style="margin-bottom: 12px;">
                    <input type="checkbox" id="edit-user-change-password" onclick="event.stopPropagation();">
                    <label for="edit-user-change-password">I want to change the password</label>
                </div>
                <div id="edit-user-password-fields" style="display: none;">
                    <div class="edit-user-form-group">
                        <label for="edit-user-new-password">New Password</label>
                        <input type="password" id="edit-user-new-password" placeholder="Enter new password">
                    </div>
                </div>
            </div>

            <div class="edit-user-modal-buttons">
                <button class="btn-save" onclick="saveUserEdit()">Save Changes</button>
                <button class="btn-cancel" onclick="closeEditUserModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="main-content" class="container">
        <!-- Modern Top Navigation -->
        <div class="top-nav">
            <div class="top-nav-left">
                <div class="top-nav-title">Mount 2K Management System</div>
                <div class="top-nav-welcome" id="welcome-user" style="display: none;"></div>
            </div>
            <div class="top-nav-right">
                <button class="top-nav-btn save" onclick="saveToGitHub()">Master Save</button>
                <a href="https://m2kportal.github.io/index.html" class="top-nav-btn">Portal</a>
                <button class="top-nav-btn logout" onclick="logout()">üö™ Logout</button>
            </div>
        </div>

        <!-- Modern Horizontal Tabs with Dropdowns -->
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="tab-button" onclick="switchTab('youth-groups')">Youth Groups</button>
            <button class="tab-button" onclick="switchTab('room-management')">Room Management</button>

            <!-- Assignments Dropdown -->
            <div class="tab-dropdown">
                <button class="tab-dropdown-button" onclick="toggleDropdown('assignments-dropdown', event)">
                    Assignments
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <div id="assignments-dropdown" class="tab-dropdown-content">
                    <button class="tab-dropdown-item" onclick="switchTabWithEvent('housing-assignments', event)">Housing Assignments</button>
                    <button class="tab-dropdown-item" onclick="switchTabWithEvent('small-group-assignments', event)">Small Group Assignments</button>
                    <button class="tab-dropdown-item" onclick="switchTabWithEvent('meal-color-assignments', event)">Meal Color Assignments</button>
                    <button class="tab-dropdown-item" onclick="switchTabWithEvent('ada-individuals', event)">ADA</button>
                </div>
            </div>

            <!-- Resources Dropdown -->
            <div class="tab-dropdown">
                <button class="tab-dropdown-button" onclick="toggleDropdown('resources-dropdown', event)">
                    Resources
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <div id="resources-dropdown" class="tab-dropdown-content">
                    <button class="tab-dropdown-item" onclick="switchTabWithEvent('resources', event)">Setup Resources</button>
                    <button class="tab-dropdown-item" onclick="switchTabWithEvent('meal-colors', event)">Meal Colors & Times</button>
                    <button class="tab-dropdown-item" onclick="switchTabWithEvent('schedule-editor', event)">Schedule</button>
                </div>
            </div>

            <!-- Printable Forms Dropdown -->
            <div class="tab-dropdown">
                <button class="tab-dropdown-button" onclick="toggleDropdown('printables-dropdown', event)">
                    Printable Forms
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <div id="printables-dropdown" class="tab-dropdown-content">
                    <button class="tab-dropdown-item" onclick="switchTabWithEvent('printable-forms', event)">Youth Group Forms</button>
                    <button class="tab-dropdown-item" onclick="switchTabWithEvent('room-posters', event)">Room Posters</button>
                </div>
            </div>

            <button class="tab-button" id="activity-reports-menu" onclick="switchTab('activity-reports')">Activity Logs</button>
            <button class="tab-button" onclick="switchTab('settings')">Settings</button>
        </div>

        <!-- Content Wrapper -->
        <div class="content-wrapper">

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h2>Statistics Overview</h2>
            
            <div class="dashboard-stats">
                <div class="stat-card">
                    <h3 id="total-groups">0</h3>
                    <p>Total Youth Groups</p>
                </div>
                <div class="stat-card">
                    <h3 id="total-participants">0</h3>
                    <p>Total Participants</p>
                </div>
                <div class="stat-card">
                    <h3 id="off-campus-groups">0</h3>
                    <p>Off-Campus People</p>
                </div>
                <div class="stat-card">
                    <h3 id="on-campus-people">0</h3>
                    <p>People Staying On Campus</p>
                </div>
                <div class="stat-card">
                    <h3 id="groups-needing-housing">0</h3>
                    <p>Groups Needing Housing</p>
                </div>
                <div class="stat-card">
                    <h3 id="groups-needing-small-group">0</h3>
                    <p>Groups Needing Small Group</p>
                </div>
                <div class="stat-card">
                    <h3 id="groups-needing-meal-color">0</h3>
                    <p>Groups Needing Meal Color</p>
                </div>
                <div class="stat-card">
                    <h3 id="sgl-assigns">0</h3>
                    <p>SGL Assigns</p>
                </div>
                <div class="stat-card">
                    <h3 id="religious-assigns">0</h3>
                    <p>Religious Assigns</p>
                </div>
                <div class="stat-card">
                    <h3 id="ada-people-total">0</h3>
                    <p>ADA People Total</p>
                </div>
                <div class="stat-card">
                    <h3 id="ada-people-needing-rooms">0</h3>
                    <p>ADA People Needing Rooms</p>
                </div>
            </div>

            <h3 style="margin: 16px 0 8px 0; font-size: 1.2em;">Housing Capacity Details</h3>
            <div class="dashboard-stats">
                <div class="stat-card">
                    <h3 id="male-housing-capacity">0</h3>
                    <p>Male Housing Capacity</p>
                </div>
                <div class="stat-card">
                    <h3 id="male-housing-used">0</h3>
                    <p>Male Housing Used</p>
                </div>
                <div class="stat-card">
                    <h3 id="male-housing-utilization">0%</h3>
                    <p>Male Housing Used %</p>
                </div>
                <div class="stat-card">
                    <h3 id="female-housing-capacity">0</h3>
                    <p>Female Housing Capacity</p>
                </div>
                <div class="stat-card">
                    <h3 id="female-housing-used">0</h3>
                    <p>Female Housing Used</p>
                </div>
                <div class="stat-card">
                    <h3 id="female-housing-utilization">0%</h3>
                    <p>Female Housing Used %</p>
                </div>
            </div>

            <h3 style="margin: 16px 0 8px 0; font-size: 1.2em;">Small Group Room Capacity</h3>
            <div class="dashboard-stats">
                <div class="stat-card">
                    <h3 id="mixed-sg-capacity">0</h3>
                    <p>Mixed/Co-ed Room Capacity</p>
                </div>
                <div class="stat-card">
                    <h3 id="mixed-sg-used">0</h3>
                    <p>Mixed/Co-ed Rooms Used</p>
                </div>
                <div class="stat-card">
                    <h3 id="mixed-sg-utilization">0%</h3>
                    <p>Mixed/Co-ed Rooms Used %</p>
                </div>
                <div class="stat-card">
                    <h3 id="available-small-group-rooms">0</h3>
                    <p>Available Small Group Rooms</p>
                </div>
            </div>

            <h3>Quick Parish Assignment Search</h3>
            <input type="text" class="search-bar" id="parish-search" placeholder="Search by Parish, Group ID, Leader, Seminarian SGL, Religious, or Phone..." oninput="performSearch()">

            <div id="search-results"></div>

            <!-- Dashboard Filters -->
            <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-top: 20px; border: 2px solid #3b82f6;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleDashboardFilters()">
                    <h3 style="margin: 0; color: #1e3a8a; font-size: 1.1em;">üìä Filter Dashboard View</h3>
                    <span id="dashboard-filters-toggle" style="font-size: 24px; color: #1e3a8a;">‚ñº</span>
                </div>
                <div id="dashboard-filters-content" style="display: none; margin-top: 15px;">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                        <input type="checkbox" id="filter-hide-male-housing-assigned" onchange="applyDashboardFilters()" style="width: 16px; height: 16px;">
                        <span>Hide Male Housing Assigned</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                        <input type="checkbox" id="filter-hide-female-housing-assigned" onchange="applyDashboardFilters()" style="width: 16px; height: 16px;">
                        <span>Hide Female Housing Assigned</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                        <input type="checkbox" id="filter-show-male-housing-missing" onchange="applyDashboardFilters()" style="width: 16px; height: 16px;">
                        <span>Show Only Male Housing Missing</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                        <input type="checkbox" id="filter-show-female-housing-missing" onchange="applyDashboardFilters()" style="width: 16px; height: 16px;">
                        <span>Show Only Female Housing Missing</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                        <input type="checkbox" id="filter-hide-off-campus" onchange="applyDashboardFilters()" style="width: 16px; height: 16px;">
                        <span>Hide Off-Campus Groups</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                        <input type="checkbox" id="filter-show-off-campus-only" onchange="applyDashboardFilters()" style="width: 16px; height: 16px;">
                        <span>Show Only Off-Campus Groups</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                        <input type="checkbox" id="filter-hide-small-group-assigned" onchange="applyDashboardFilters()" style="width: 16px; height: 16px;">
                        <span>Hide Small Group Assigned</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                        <input type="checkbox" id="filter-show-small-group-missing" onchange="applyDashboardFilters()" style="width: 16px; height: 16px;">
                        <span>Show Only Small Group Missing</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                        <input type="checkbox" id="filter-hide-meal-color-assigned" onchange="applyDashboardFilters()" style="width: 16px; height: 16px;">
                        <span>Hide Meal Color Assigned</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                        <input type="checkbox" id="filter-show-meal-color-missing" onchange="applyDashboardFilters()" style="width: 16px; height: 16px;">
                        <span>Show Only Meal Color Missing</span>
                    </label>
                </div>
                <div style="margin-top: 12px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: bold; color: #1e3a8a; font-size: 13px;">Filter by Meal Color:</label>
                    <select id="filter-meal-color" onchange="applyDashboardFilters()" style="padding: 8px; border: 2px solid #3b82f6; border-radius: 6px; font-size: 13px; width: 100%; max-width: 300px;">
                        <option value="">All Colors</option>
                        <option value="Blue">Blue</option>
                        <option value="Red">Red</option>
                        <option value="Orange">Orange</option>
                        <option value="Yellow">Yellow</option>
                        <option value="Green">Green</option>
                        <option value="Purple">Purple</option>
                        <option value="Brown">Brown</option>
                        <option value="Grey">Grey</option>
                    </select>
                </div>
                <div style="margin-top: 10px;">
                    <button onclick="clearDashboardFilters()" style="padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold;">Clear All Filters</button>
                </div>
                </div>
            </div>

            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">
                <h3>Assignment Overview</h3>
                <div id="assignment-overview"></div>
            </div>
        </div>

        <!-- Youth Groups Tab -->
        <div id="youth-groups" class="tab-content">
            <h2>Youth Group Management</h2>
            
            <div class="notification" style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; margin-bottom: 20px; border-radius: 6px;">
                <h4 style="margin: 0 0 8px 0; color: #1976d2;">üí° Quick Import from CSV</h4>
                <p style="margin: 0; font-size: 14px; color: #1565c0;">
                    <strong>Step 1:</strong> Click "Download CSV Template" to get the format<br>
                    <strong>Step 2:</strong> Fill in your group data (only Group ID and Parish Name required)<br>
                    <strong>Step 3:</strong> Click "Import from CSV" and select your filled CSV file<br>
                    <strong>Note:</strong> Import adds to existing groups - duplicates are skipped
                </p>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Group ID *</label>
                    <input type="text" id="group-id" placeholder="Enter Group ID">
                </div>
                <div class="form-group">
                    <label>Parish Name *</label>
                    <input type="text" id="parish-name" placeholder="Enter Parish Name">
                </div>
                <div class="form-group">
                    <label>Group Leader</label>
                    <input type="text" id="group-leader" placeholder="Enter Leader Name">
                </div>
                <div class="form-group">
                    <label>Seminarian SGL</label>
                    <input type="text" id="seminarian-sgl" placeholder="Enter Seminarian Small Group Leader">
                </div>
                <div class="form-group">
                    <label>Religious</label>
                    <input type="text" id="religious" placeholder="Enter Religious (Priest, Brother, Sister, etc.)">
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="phone-number" placeholder="Enter Phone Number">
                </div>
                <div class="form-group">
                    <label>Male Teens</label>
                    <input type="number" id="male-teens" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>Female Teens</label>
                    <input type="number" id="female-teens" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>Male Chaperones</label>
                    <input type="number" id="male-chaperones" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>Female Chaperones</label>
                    <input type="number" id="female-chaperones" min="0" value="0">
                </div>
                <div class="form-group" style="display: flex; align-items: center; padding-top: 20px;">
                    <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                        <input type="checkbox" id="staying-off-campus" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
                        <span style="font-weight: 600;">Staying Off-Campus</span>
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <label>Special Accommodations</label>
                <textarea id="special-accommodations" placeholder="Enter any special accommodations (CPAP machine, wheelchair access, medical needs, etc.)"></textarea>
            </div>

            <div>
                <button class="btn btn-success" onclick="addYouthGroup()">Add Youth Group</button>
                <button class="btn btn-primary" onclick="updateYouthGroup()" id="update-group-btn" style="display:none;">Update Youth Group</button>
                <button class="btn btn-danger" onclick="deleteYouthGroup()" id="delete-group-btn" style="display:none;">Delete Group</button>
                <button class="btn btn-warning" onclick="cancelEdit()" id="cancel-edit-btn" style="display:none;">Cancel</button>
                <button class="btn btn-primary" onclick="downloadCSVTemplate()" style="margin-left: 20px;">üì• Download CSV Template</button>
                <label class="btn btn-success" style="margin-left: 10px; cursor: pointer;">
                    üì§ Import from CSV
                    <input type="file" id="csv-import" accept=".csv" style="display: none;" onchange="handleCSVImport(event)">
                </label>
            </div>

            <div class="table-controls">
                <input type="text" class="filter-input" id="youth-groups-filter" placeholder="Filter by Parish, Group ID, Leader, Seminarian SGL, Religious, or Phone..." oninput="filterYouthGroupsTable()">
                <div class="sort-controls">
                    <label>Sort by:</label>
                    <select class="sort-select" id="youth-groups-sort" onchange="sortYouthGroupsTable()">
                        <option value="id">Group ID</option>
                        <option value="parish">Parish Name</option>
                        <option value="leader">Leader Name</option>
                        <option value="seminarianSgl">Seminarian SGL</option>
                        <option value="total">Total People</option>
                        <option value="maleTeens">Male Teens</option>
                        <option value="femaleTeens">Female Teens</option>
                        <option value="status">Assignment Status</option>
                    </select>
                    <button class="btn btn-warning" onclick="toggleYouthGroupsSortOrder()" id="youth-groups-sort-order">A‚ÜíZ</button>
                </div>
            </div>

            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortYouthGroupsBy('id')">Group ID</th>
                            <th class="sortable" onclick="sortYouthGroupsBy('parish')">Parish</th>
                            <th class="sortable" onclick="sortYouthGroupsBy('leader')">Leader</th>
                            <th class="sortable" onclick="sortYouthGroupsBy('seminarianSgl')">Seminarian SGL</th>
                            <th class="sortable" onclick="sortYouthGroupsBy('religious')">Religious</th>
                            <th class="sortable" onclick="sortYouthGroupsBy('phone')">Phone</th>
                            <th class="sortable" onclick="sortYouthGroupsBy('maleTeens')">M Teens</th>
                            <th class="sortable" onclick="sortYouthGroupsBy('femaleTeens')">F Teens</th>
                            <th class="sortable" onclick="sortYouthGroupsBy('maleChaperones')">M Chap</th>
                            <th class="sortable" onclick="sortYouthGroupsBy('femaleChaperones')">F Chap</th>
                            <th class="sortable" onclick="sortYouthGroupsBy('total')">Total</th>
                            <th>Special Needs</th>
                            <th class="sortable" onclick="sortYouthGroupsBy('status')">Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="youth-groups-table"></tbody>
                </table>
            </div>
        </div>

        <!-- Room Management Tab (Unified Housing & Small Group Rooms) -->
        <div id="room-management" class="tab-content">
            <h2>Room Management</h2>

            <!-- Room Type Selection -->
            <div class="form-group" style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #061d28;">
                <label style="font-weight: bold; margin-bottom: 10px; display: block;">Room Type *</label>
                <div style="display: flex; gap: 20px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="room-type" value="housing" id="room-type-housing" onchange="handleRoomTypeChange()" style="width: 18px; height: 18px;">
                        <span style="font-weight: 600;">Housing (Overnight Sleeping)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="room-type" value="smallGroup" id="room-type-smallgroup" onchange="handleRoomTypeChange()" style="width: 18px; height: 18px;">
                        <span style="font-weight: 600;">Small Group (Meeting/Discussion)</span>
                    </label>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Building Name *</label>
                    <input type="text" id="building-name" placeholder="e.g., Gymnasium, Student Center">
                </div>
                <div class="form-group">
                    <label>Room/Section ID *</label>
                    <input type="text" id="room-id" placeholder="e.g., Room 123, East Section">
                </div>
                <div class="form-group" id="gender-field-container" style="display:none;">
                    <label>Gender Designation *</label>
                    <select id="gender-designation">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Room Capacity *</label>
                    <input type="number" id="room-capacity" min="1" placeholder="Number of people">
                </div>
            </div>

            <!-- Conditional Fields -->
            <div class="form-group" id="accessibility-field-container" style="display:none;">
                <label>Accessibility Features (ADA)</label>
                <textarea id="accessibility-features" placeholder="Wheelchair accessible, ground floor, Sleep help, etc."></textarea>
            </div>

            <div class="form-group" id="features-field-container" style="display:none;">
                <label>Room Features</label>
                <textarea id="room-features" placeholder="Projector, whiteboard, tables/chairs setup, etc."></textarea>
            </div>

            <div>
                <button class="btn btn-success" onclick="addRoom()" id="add-room-btn">Add Room</button>
                <button class="btn btn-primary" onclick="updateRoom()" id="update-room-btn" style="display:none;">Update Room</button>
                <button class="btn btn-danger" onclick="deleteRoom()" id="delete-room-btn" style="display:none;">Delete Room</button>
                <button class="btn btn-warning" onclick="cancelRoomEdit()" id="cancel-room-edit-btn" style="display:none;">Cancel</button>
            </div>

            <div class="table-controls">
                <input type="text" class="filter-input" id="rooms-filter" placeholder="Filter by Building, Room, Type, or Features..." oninput="filterRoomsTable()">
                <div class="sort-controls">
                    <label>Sort by:</label>
                    <select class="sort-select" id="rooms-sort" onchange="sortRoomsTable()">
                        <option value="type">Room Type</option>
                        <option value="building">Building</option>
                        <option value="roomId">Room/Section</option>
                        <option value="gender">Gender</option>
                        <option value="capacity">Capacity</option>
                        <option value="occupied">Occupied</option>
                        <option value="available">Available Space</option>
                    </select>
                    <button class="btn btn-warning" onclick="toggleRoomsSortOrder()" id="rooms-sort-order">A‚ÜíZ</button>
                </div>
            </div>

            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortRoomsBy('type')">Type</th>
                            <th class="sortable" onclick="sortRoomsBy('building')">Building</th>
                            <th class="sortable" onclick="sortRoomsBy('roomId')">Room/Section</th>
                            <th class="sortable" onclick="sortRoomsBy('gender')">Gender</th>
                            <th class="sortable" onclick="sortRoomsBy('capacity')">Capacity</th>
                            <th class="sortable" onclick="sortRoomsBy('occupied')">Occupied</th>
                            <th class="sortable" onclick="sortRoomsBy('available')">Available</th>
                            <th>Notes</th>
                            <th>Assigned Groups</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="rooms-table"></tbody>
                </table>
            </div>
        </div>

        <!-- Housing Assignments Tab -->
        <div id="housing-assignments" class="tab-content">
            <h2>Housing Room Assignments</h2>
            
            <div class="form-group">
                <label>Search Groups</label>
                <input type="text" class="search-bar" id="housing-assignment-search" placeholder="Search by Parish name, Group ID, or Leader name..." oninput="filterHousingAssignmentDropdown()">
            </div>

            <div class="form-group" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <label style="font-weight: bold; margin-bottom: 10px; display: block;">Filter Groups:</label>
                <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="housing-hide-assigned" onchange="filterHousingAssignmentDropdown()" style="width: 18px; height: 18px;">
                        <span>Hide already assigned groups</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="housing-hide-offcampus" onchange="filterHousingAssignmentDropdown()" style="width: 18px; height: 18px;">
                        <span>Hide off-campus groups</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="housing-show-male-only" onchange="filterHousingAssignmentDropdown()" style="width: 18px; height: 18px;">
                        <span>Show only male groups</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="housing-show-female-only" onchange="filterHousingAssignmentDropdown()" style="width: 18px; height: 18px;">
                        <span>Show only female groups</span>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label>Select Group Gender Assignment</label>
                <select id="housing-assignment-group-select" onchange="selectGroupForHousingAssignment()">
                    <option value="">Select a Group-Gender Assignment</option>
                </select>
            </div>

            <div class="assignment-container">
                <div class="group-details">
                    <h3>Selected Assignment Details</h3>
                    <div id="housing-selected-group-info">
                        <p>Please select a group-gender assignment above to see room options.</p>
                    </div>
                </div>

                <div class="available-rooms">
                    <h3>Available Housing Rooms</h3>
                    <input type="text" id="housing-rooms-search" placeholder="üîç Search housing rooms by building, room ID..."
                           oninput="filterHousingRooms()"
                           style="width: 100%; padding: 10px; border: 2px solid #061d28; border-radius: 6px; font-size: 14px; margin-bottom: 15px; display: none;">
                    <div id="housing-available-rooms-list">
                        <p>Select a group-gender assignment to see matching rooms.</p>
                    </div>
                </div>
            </div>

            <div id="housing-assignment-actions" style="display:none; margin-top: 20px; text-align: center;">
                <button class="btn btn-success" onclick="confirmHousingAssignment()">Save Housing Assignment</button>
                <button class="btn btn-danger" onclick="clearHousingAssignment()">Clear Assignment</button>
                <button class="btn btn-warning" onclick="cancelHousingSelection()">Cancel</button>
            </div>
        </div>

        <!-- Small Group Assignments Tab -->
        <div id="small-group-assignments" class="tab-content">
            <h2>Small Group Location Assignments</h2>
            
            <div class="form-group">
                <label>Search Groups</label>
                <input type="text" class="search-bar" id="sg-assignment-search" placeholder="Search by Parish name, Group ID, or Leader name..." oninput="filterSmallGroupAssignmentDropdown()">
            </div>

            <div class="form-group" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <label style="font-weight: bold; margin-bottom: 10px; display: block;">Filter Groups:</label>
                <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="sg-hide-assigned" onchange="filterSmallGroupAssignmentDropdown()" style="width: 18px; height: 18px;">
                        <span>Hide already assigned groups</span>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label>Select Group for Small Group Assignment</label>
                <select id="sg-assignment-group-select" onchange="selectGroupForSmallGroupAssignment()">
                    <option value="">Select a Group for Small Group Assignment</option>
                </select>
            </div>

            <div class="assignment-container">
                <div class="group-details">
                    <h3>Selected Group Details</h3>
                    <div id="sg-selected-group-info">
                        <p>Please select a group above to see small group location options.</p>
                    </div>
                </div>

                <div class="available-rooms">
                    <h3>Available Small Group Locations</h3>
                    <input type="text" id="sg-rooms-search" placeholder="üîç Search small group rooms by building, room ID, features..."
                           oninput="filterSmallGroupRooms()"
                           style="width: 100%; padding: 10px; border: 2px solid #061d28; border-radius: 6px; font-size: 14px; margin-bottom: 15px; display: none;">
                    <div id="sg-available-rooms-list">
                        <p>Select a group to see available small group locations.</p>
                    </div>
                </div>
            </div>

            <div id="sg-assignment-actions" style="display:none; margin-top: 20px; text-align: center;">
                <button class="btn btn-success" onclick="confirmSmallGroupAssignment()">Save Small Group Assignment</button>
                <button class="btn btn-danger" onclick="clearSmallGroupAssignment()">Clear Assignment</button>
                <button class="btn btn-warning" onclick="cancelSmallGroupSelection()">Cancel</button>
            </div>
        </div>

        <!-- Meal Colors & Times Configuration Tab -->
        <div id="meal-colors" class="tab-content">
            <h2>Meal Colors & Times Configuration</h2>
            <p style="margin-bottom: 20px; color: #666;">Configure which meal colors are active and set meal times for each color. Assignments are done in the Assignments tab.</p>

            <!-- Active Colors Configuration -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleActiveColorsConfig()">
                    <h3 style="margin: 0;">üé® Active Meal Colors</h3>
                    <span id="active-colors-toggle" style="font-size: 24px;">‚ñº</span>
                </div>
                <p style="font-size: 14px; color: #666; margin: 10px 0;">Select which meal colors you want to use. Only active colors will appear in dropdowns and on schedules.</p>

                <div id="active-colors-config" style="display: none; margin-top: 15px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                    <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: white; border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" value="Blue" onchange="toggleColorActive(this)" style="width: 20px; height: 20px;">
                        <span style="background: #3498db; color: white; padding: 4px 12px; border-radius: 4px; font-weight: bold;">üîµ Blue</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: white; border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" value="Red" onchange="toggleColorActive(this)" style="width: 20px; height: 20px;">
                        <span style="background: #e74c3c; color: white; padding: 4px 12px; border-radius: 4px; font-weight: bold;">üî¥ Red</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: white; border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" value="Orange" onchange="toggleColorActive(this)" style="width: 20px; height: 20px;">
                        <span style="background: #e67e22; color: white; padding: 4px 12px; border-radius: 4px; font-weight: bold;">üü† Orange</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: white; border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" value="Yellow" onchange="toggleColorActive(this)" style="width: 20px; height: 20px;">
                        <span style="background: #f1c40f; color: #333; padding: 4px 12px; border-radius: 4px; font-weight: bold;">üü° Yellow</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: white; border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" value="Green" onchange="toggleColorActive(this)" style="width: 20px; height: 20px;">
                        <span style="background: #27ae60; color: white; padding: 4px 12px; border-radius: 4px; font-weight: bold;">üü¢ Green</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: white; border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" value="Purple" onchange="toggleColorActive(this)" style="width: 20px; height: 20px;">
                        <span style="background: #9b59b6; color: white; padding: 4px 12px; border-radius: 4px; font-weight: bold;">üü£ Purple</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: white; border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" value="Brown" onchange="toggleColorActive(this)" style="width: 20px; height: 20px;">
                        <span style="background: #8b4513; color: white; padding: 4px 12px; border-radius: 4px; font-weight: bold;">ü§é Brown</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: white; border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" value="Grey" onchange="toggleColorActive(this)" style="width: 20px; height: 20px;">
                        <span style="background: #95a5a6; color: white; padding: 4px 12px; border-radius: 4px; font-weight: bold;">‚ö™ Grey</span>
                    </label>
                </div>
                </div>
            </div>

            <!-- Meal Times Configuration -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleMealTimesConfig()">
                    <h3 style="margin: 0;">‚è∞ Meal Time Schedule Configuration</h3>
                    <span id="meal-times-toggle" style="font-size: 24px;">‚ñº</span>
                </div>
                <p style="font-size: 14px; color: #666; margin: 10px 0;">Set the meal times for each color group. These will appear on the printable check-in forms and the public schedule.</p>

                <div id="meal-times-config" style="display: none; margin-top: 15px;"></div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-success" onclick="saveMealColorConfiguration()" style="font-size: 16px; padding: 12px 24px;">Save Configuration</button>
            </div>
        </div>

        <!-- Meal Color Assignments Tab -->
        <div id="meal-color-assignments" class="tab-content">
            <h2>Meal Color Assignments</h2>
            <p style="margin-bottom: 20px; color: #666;">Assign meal colors to youth groups. Configure active colors and meal times in Resources > Meal Colors & Times.</p>

            <!-- Meal Color Summary Dashboard -->
            <div class="dashboard-stats" style="margin-bottom: 20px;">
                <div class="stat-card" style="background: linear-gradient(135deg, #3498db, #2980b9); border-color: #3498db;">
                    <h3 id="blue-meal-count">0</h3>
                    <p>üîµ Blue Teams</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #e74c3c, #c0392b); border-color: #e74c3c;">
                    <h3 id="red-meal-count">0</h3>
                    <p>üî¥ Red Teams</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #e67e22, #d35400); border-color: #e67e22;">
                    <h3 id="orange-meal-count">0</h3>
                    <p>üü† Orange Teams</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f1c40f, #f39c12); border-color: #f1c40f;">
                    <h3 id="yellow-meal-count">0</h3>
                    <p>üü° Yellow Teams</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #27ae60, #229954); border-color: #27ae60;">
                    <h3 id="green-meal-count">0</h3>
                    <p>üü¢ Green Teams</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); border-color: #9b59b6;">
                    <h3 id="purple-meal-count">0</h3>
                    <p>üü£ Purple Teams</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #8b4513, #654321); border-color: #8b4513;">
                    <h3 id="brown-meal-count">0</h3>
                    <p>ü§é Brown Teams</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #95a5a6, #7f8c8d); border-color: #95a5a6;">
                    <h3 id="grey-meal-count">0</h3>
                    <p>‚ö™ Grey Teams</p>
                </div>
            </div>

            <div class="table-controls">
                <input type="text" class="filter-input" id="meal-colors-filter" placeholder="Filter by Parish, Group ID, or Leader..." oninput="filterMealColorsTable()">
                <div class="sort-controls">
                    <label>Sort by:</label>
                    <select class="sort-select" id="meal-colors-sort" onchange="sortMealColorsTable()">
                        <option value="id">Group ID</option>
                        <option value="parish">Parish Name</option>
                        <option value="location">Location</option>
                        <option value="total">Total People</option>
                        <option value="color">Meal Color</option>
                    </select>
                    <button class="btn btn-warning" onclick="toggleMealColorsSortOrder()" id="meal-colors-sort-order">A‚ÜíZ</button>
                </div>
            </div>

            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortMealColorsBy('id')">Group ID</th>
                            <th class="sortable" onclick="sortMealColorsBy('parish')">Parish</th>
                            <th class="sortable" onclick="sortMealColorsBy('leader')">Leader</th>
                            <th class="sortable" onclick="sortMealColorsBy('location')">Location</th>
                            <th class="sortable" onclick="sortMealColorsBy('total')">Total People</th>
                            <th class="sortable" onclick="sortMealColorsBy('color')">Meal Color</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="meal-colors-table"></tbody>
                </table>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-success" onclick="confirmMealColorAssignments()" style="font-size: 16px; padding: 12px 24px;">Save Meal Color Assignments</button>
            </div>
        </div>

        <!-- ADA Individuals Tab -->
        <div id="ada-individuals" class="tab-content">
            <h2>‚ôø ADA Accommodation Management</h2>
            <p style="margin-bottom: 20px; color: #666;">Manage individuals requiring ADA accommodations. These individuals are already counted in their group's totals but need special room assignments.</p>

            <!-- ADA Statistics -->
            <div class="dashboard-stats" style="margin-bottom: 20px;">
                <div class="stat-card" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); border-color: #9b59b6;">
                    <h3 id="total-ada-individuals">0</h3>
                    <p>‚ôø Total ADA Individuals</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #3498db, #2980b9); border-color: #3498db;">
                    <h3 id="male-ada-count">0</h3>
                    <p>üîµ Male</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #e91e63, #c2185b); border-color: #e91e63;">
                    <h3 id="female-ada-count">0</h3>
                    <p>üü£ Female</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #27ae60, #229954); border-color: #27ae60;">
                    <h3 id="ada-assigned-count">0</h3>
                    <p>‚úÖ Assigned</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #e67e22, #d35400); border-color: #e67e22;">
                    <h3 id="ada-unassigned-count">0</h3>
                    <p>‚ùå Unassigned</p>
                </div>
            </div>

            <!-- Add New ADA Individual Form -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0;">‚ûï Add New ADA Individual</h3>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Name <span style="color: red;">*</span></label>
                        <input type="text" id="ada-name" placeholder="Individual's name" required>
                    </div>

                    <div class="form-group">
                        <label>Gender <span style="color: red;">*</span></label>
                        <select id="ada-gender" onchange="updateADARoomDropdown()" required>
                            <option value="">-- Select Gender --</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Youth Group <span style="color: red;">*</span></label>
                        <select id="ada-group" required>
                            <option value="">-- Select Group --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Accessibility Need <span style="color: red;">*</span></label>
                        <input type="text" id="ada-accessibility" placeholder="e.g., Wheelchair, Mobility aid, etc." required>
                    </div>

                    <div class="form-group">
                        <label>Room Assignment</label>
                        <select id="ada-room">
                            <option value="">-- Select Room --</option>
                        </select>
                    </div>
                </div>

                <div style="margin-top: 15px;">
                    <button class="btn btn-success" onclick="addADAIndividual()">
                        ‚ûï Add ADA Individual
                    </button>
                    <button class="btn btn-warning" onclick="clearADAForm()">
                        üîÑ Clear Form
                    </button>
                </div>
            </div>

            <!-- ADA Individuals Table -->
            <div class="table-controls">
                <input type="text" class="filter-input" id="ada-filter" placeholder="Filter by Name, Group, or Accessibility..." oninput="filterADATable()">
                <div class="sort-controls">
                    <label>Sort by:</label>
                    <select class="sort-select" id="ada-sort" onchange="sortADATable()">
                        <option value="name">Name</option>
                        <option value="group">Group</option>
                        <option value="gender">Gender</option>
                        <option value="room">Room</option>
                    </select>
                </div>
            </div>

            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortADATableBy('name')">Name</th>
                            <th class="sortable" onclick="sortADATableBy('gender')">Gender</th>
                            <th class="sortable" onclick="sortADATableBy('group')">Youth Group</th>
                            <th class="sortable" onclick="sortADATableBy('accessibility')">Accessibility Need</th>
                            <th class="sortable" onclick="sortADATableBy('room')">Room Assignment</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ada-table-body"></tbody>
                </table>
            </div>

            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-success" onclick="saveADAData()" style="font-size: 16px; padding: 12px 24px;">
                    üíæ Save ADA Data
                </button>
            </div>
        </div>

        <!-- Resources Tab -->
        <div id="resources" class="tab-content">
            <h2>Resource Links Management</h2>
            <p style="margin-bottom: 20px; color: #666;">Manage the resource links that appear on the public dashboard. Edit the name and URL for each resource (except Meal Times, which is managed in Meal Color Assignments).</p>

            <div id="resources-list"></div>
        </div>

        <!-- Schedule Editor Tab -->
        <div id="schedule-editor" class="tab-content">
            <h2>üìÖ Schedule Editor</h2>
            <p style="margin-bottom: 20px; color: #666;">Edit the event schedule that appears on the public dashboard. Add, edit, or remove schedule entries for each day of the retreat.</p>

            <!-- Friday Schedule -->
            <div style="background: white; border: 2px solid #3b82f6; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: #3b82f6; margin-bottom: 15px;">üìÖ Friday, February 7</h3>
                <div id="friday-schedule-list"></div>
                <button class="btn btn-primary" onclick="addScheduleEntry('friday')" style="margin-top: 10px;">‚ûï Add Friday Event</button>
            </div>

            <!-- Saturday Schedule -->
            <div style="background: white; border: 2px solid #10b981; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: #10b981; margin-bottom: 15px;">üìÖ Saturday, February 8</h3>
                <div id="saturday-schedule-list"></div>
                <button class="btn btn-success" onclick="addScheduleEntry('saturday')" style="margin-top: 10px;">‚ûï Add Saturday Event</button>
            </div>

            <!-- Sunday Schedule -->
            <div style="background: white; border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: #f59e0b; margin-bottom: 15px;">üìÖ Sunday, February 9</h3>
                <div id="sunday-schedule-list"></div>
                <button class="btn btn-warning" onclick="addScheduleEntry('sunday')" style="margin-top: 10px;">‚ûï Add Sunday Event</button>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-success" onclick="saveSchedule()" style="font-size: 18px; padding: 15px 30px;">
                    üíæ Save Schedule
                </button>
            </div>
        </div>

        <!-- Print Youth Group Information Tab -->
        <div id="printable-forms" class="tab-content">
            <h2>Print Youth Group Information</h2>
            <p style="margin-bottom: 20px; color: #666;">Generate professional PDF check-in forms for each youth group with all housing and meal assignments.</p>

            <!-- Generate PDF Buttons at Top -->
            <div style="text-align: center; margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #061d28, #0f3a4a); border-radius: 10px;">
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="generateSelectedPDFs()" style="font-size: 18px; padding: 15px 30px; background: #d4af37; color: #061d28; border: 2px solid #d4af37;">
                        üìÑ Generate Selected Forms
                    </button>
                    <button class="btn btn-primary" onclick="generatePDFView()" style="font-size: 18px; padding: 15px 30px; background: #27ae60; color: white; border: 2px solid #27ae60;">
                        üìÑ Generate All Forms
                    </button>
                </div>
                <p style="color: #d4af37; margin-top: 10px; font-size: 14px;">Check boxes below to select specific forms, then use Ctrl+P (or Cmd+P) to save as PDF</p>
            </div>

            <!-- Default Notes Configuration -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">üìù Default Information (Appears on ALL Forms)</h3>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label>General Information</label>
                    <textarea id="default-general-info" rows="3" placeholder="Enter general information that will appear on ALL forms (both on-campus and off-campus)..." style="width: 100%; padding: 10px; border: 2px solid #bdc3c7; border-radius: 6px; font-size: 14px; font-family: inherit;"></textarea>
                </div>

                <h3 style="margin: 20px 0 15px 0;">üè† On-Campus Only Information</h3>
                <p style="font-size: 13px; color: #666; margin-bottom: 15px;">The following fields only appear on forms for groups staying on-campus:</p>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Housing Notes/Information</label>
                    <textarea id="default-housing-notes" rows="3" placeholder="Enter housing information for on-campus groups..." style="width: 100%; padding: 10px; border: 2px solid #bdc3c7; border-radius: 6px; font-size: 14px; font-family: inherit;"></textarea>
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Teen Shower Plan</label>
                    <textarea id="default-teen-shower" rows="3" placeholder="Enter teen shower schedule/plan for on-campus groups..." style="width: 100%; padding: 10px; border: 2px solid #bdc3c7; border-radius: 6px; font-size: 14px; font-family: inherit;"></textarea>
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Adult Chaperone Shower Plan</label>
                    <textarea id="default-adult-shower" rows="3" placeholder="Enter adult chaperone shower schedule/plan for on-campus groups..." style="width: 100%; padding: 10px; border: 2px solid #bdc3c7; border-radius: 6px; font-size: 14px; font-family: inherit;"></textarea>
                </div>

                <button class="btn btn-success" onclick="saveDefaultNotes()">üíæ Save Default Notes</button>
            </div>

            <!-- Search/Filter for Forms -->
            <div style="margin-bottom: 20px;">
                <input
                    type="text"
                    id="forms-search"
                    class="search-bar"
                    placeholder="üîç Search forms by Parish, Group ID, or Leader name..."
                    oninput="filterFormsPreview()"
                    style="width: 100%; padding: 12px; border: 2px solid #061d28; border-radius: 8px; font-size: 16px;"
                >
            </div>

            <!-- Individual Group Forms Preview & Notes -->
            <div id="forms-preview-section"></div>

            <!-- Generate PDF Buttons at Bottom -->
            <div style="text-align: center; margin: 30px 0; padding: 20px; background: linear-gradient(135deg, #061d28, #0f3a4a); border-radius: 10px;">
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="generateSelectedPDFs()" style="font-size: 18px; padding: 15px 30px; background: #d4af37; color: #061d28; border: 2px solid #d4af37;">
                        üìÑ Generate Selected Forms
                    </button>
                    <button class="btn btn-primary" onclick="generatePDFView()" style="font-size: 18px; padding: 15px 30px; background: #27ae60; color: white; border: 2px solid #27ae60;">
                        üìÑ Generate All Forms
                    </button>
                </div>
                <p style="color: #d4af37; margin-top: 10px; font-size: 14px;">Check boxes above to select specific forms, then use Ctrl+P (or Cmd+P) to save as PDF</p>
            </div>
        </div>

        <!-- Print Room Information Tab -->
        <div id="room-posters" class="tab-content">
            <h2>Print Room Information</h2>
            <p style="margin-bottom: 20px; color: #666;">Generate professional room posters for housing and small group rooms with all assignment details.</p>

            <!-- Search and Filter Controls -->
            <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <input type="text"
                       id="room-search"
                       class="form-input"
                       placeholder="üîç Search rooms by building, room number, or assigned group..."
                       oninput="filterRoomPosters()"
                       style="width: 100%; padding: 15px; border: 3px solid #061d28; border-radius: 8px; font-size: 16px; margin-bottom: 15px;">

                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="showAllRoomPosters('all')" class="btn btn-primary">Show All Rooms</button>
                    <button onclick="showAllRoomPosters('housing')" class="btn btn-primary">Housing Rooms Only</button>
                    <button onclick="showAllRoomPosters('smallgroup')" class="btn btn-primary">Small Group Rooms Only</button>
                </div>
            </div>

            <!-- Print Controls -->
            <div style="text-align: center; margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #061d28, #0f3a4a); border-radius: 10px;">
                <h3 style="color: #d4af37; margin-bottom: 15px;">üìÑ Print Options</h3>
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="printAllRoomPosters()" class="btn" style="background: #27ae60; color: white; padding: 15px 30px; font-size: 16px;">
                        üñ®Ô∏è Print All Visible Posters
                    </button>
                    <button onclick="printSelectedRoomPosters()" class="btn" style="background: #f39c12; color: white; padding: 15px 30px; font-size: 16px;">
                        üñ®Ô∏è Print Selected Only
                    </button>
                </div>
            </div>

            <!-- Room Posters Container -->
            <div id="room-posters-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(600px, 1fr)); gap: 20px;">
                <!-- Room posters will be generated here -->
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <h2>‚öôÔ∏è System Settings</h2>
            <p style="margin-bottom: 20px; color: #666;">Configure system settings, manage users, and control data.</p>

            <!-- Conference Configuration -->
            <div id="conference-config" style="background: #fff3e0; border: 2px solid #ff9800; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="margin-top: 0; color: #e65100;">üìù Conference Configuration</h3>
                <p style="color: #e65100; margin-bottom: 15px;">
                    Configure conference information that appears throughout the site (dashboard, forms, schedules). This is typically updated year to year.
                </p>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="conference-name" style="display: block; margin-bottom: 8px; font-weight: 600;">Conference Name:</label>
                    <input type="text" id="conference-name" placeholder="e.g., MOUNT 2000 YOUTH RETREAT"
                           style="width: 100%; padding: 12px; border: 2px solid #ff9800; border-radius: 8px; font-size: 14px;">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="conference-start-date" style="display: block; margin-bottom: 8px; font-weight: 600;">Conference Start Date (Friday):</label>
                    <input type="date" id="conference-start-date"
                           style="width: 100%; padding: 12px; border: 2px solid #ff9800; border-radius: 8px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 8px; font-size: 13px; color: #666;">
                    <strong>üìä Auto-Generated Dashboard Subtitle:</strong>
                    <div id="subtitle-preview" style="margin-top: 8px; padding: 8px; background: #f5f5f5; border-radius: 4px; font-weight: 600;">
                        Housing and Small Group Assignments - 2026
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveConferenceConfig()" style="background: #ff9800; border-color: #e65100;">
                    üíæ Save Conference Configuration
                </button>
                <div style="margin-top: 12px; padding: 12px; background: white; border-radius: 8px; font-size: 13px; color: #e65100;">
                    <strong>üí° Note:</strong> Conference name and year will update the dashboard subtitle, youth group forms, and schedule dates. Click "Master Save" to update the live site.
                </div>
            </div>

            <!-- GitHub Token Settings -->
            <div style="background: #e8f5e9; border: 2px solid #4CAF50; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="margin-top: 0; color: #2e7d32;">üîë GitHub Token Settings</h3>
                <p style="color: #2e7d32; margin-bottom: 15px;">
                    Configure your GitHub Personal Access Token to enable automatic saving to GitHub.
                </p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn" onclick="manageGitHubToken()" style="background: #2e7d32; color: white; border-color: #2e7d32;">
                        üîë Manage GitHub Token
                    </button>
                    <button class="btn btn-primary" onclick="saveToGitHub()" style="background: #10b981; border-color: #10b981;">
                        üíæ Save to GitHub Now
                    </button>
                </div>
                <div style="margin-top: 12px; padding: 12px; background: white; border-radius: 8px; font-size: 13px; color: #2e7d32;">
                    <strong>üí° Note:</strong> Token is stored locally in your browser and used to save housing data and credentials to GitHub.
                </div>
            </div>

            <!-- Data Export/Import -->
            <div style="background: #e3f2fd; border: 2px solid #2196F3; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="margin-top: 0; color: #1565c0;">üì¶ Data Export & Import</h3>
                <p style="color: #1565c0; margin-bottom: 15px;">
                    Export your housing data for backup or import data from previous backups.
                </p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                    <button class="btn btn-primary" onclick="exportToCSV()">üì• Export Data to CSV</button>
                    <button class="btn btn-success" onclick="saveData()">üíæ Save Data (JSON)</button>
                    <button class="btn btn-warning" onclick="loadData()">üìÇ Load Data</button>
                    <button class="btn btn-primary" onclick="exportCompleteHTML()">üåê Export Complete HTML Site</button>
                </div>
                <input type="file" id="load-file" accept=".json" style="display: none;" onchange="handleLoadFile(event)">
            </div>

            <!-- User Management Section (Admin-Only) -->
            <div id="user-management-section" style="background: #f8f9fa; border: 2px solid #6c757d; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: none;">
                <h3 style="margin-top: 0;">üë• User Management (Admin-Only)</h3>
                <p style="color: #666; margin-bottom: 15px;">
                    <strong>‚ö†Ô∏è Admin Access Required:</strong> Manage system users and their access credentials. Changes are automatically saved to GitHub.
                </p>

                <!-- Add User Form -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4>Add New User</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="new-username">Username *</label>
                            <input type="text" id="new-username" placeholder="Enter username">
                        </div>
                        <div class="form-group">
                            <label for="new-user-fullname">Full Name *</label>
                            <input type="text" id="new-user-fullname" placeholder="Enter full name">
                        </div>
                        <div class="form-group">
                            <label for="new-user-password">Password *</label>
                            <input type="password" id="new-user-password" placeholder="Enter password">
                        </div>
                        <div class="form-group">
                            <label for="new-user-role">Role *</label>
                            <select id="new-user-role">
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="new-user-is-admin" style="width: 18px; height: 18px;">
                            <span><strong>Grant Admin Privileges</strong> (Can clear data and manage all settings)</span>
                        </label>
                    </div>
                    <div style="margin-top: 15px;">
                        <button onclick="addUser()" class="btn btn-primary">Add User</button>
                        <button onclick="clearUserForm()" class="btn btn-secondary">Clear Form</button>
                    </div>
                </div>

                <!-- Users List -->
                <div>
                    <h4>System Users</h4>
                    <div style="background: white; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                        <input type="text" id="users-search" placeholder="üîç Search users..."
                               oninput="filterUsers()"
                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                    </div>
                    <div id="users-list" style="display: grid; gap: 15px;">
                        <!-- Users will be displayed here -->
                    </div>
                </div>

                <!-- Collapsible Clear Data Section -->
                <div style="margin-top: 30px;">
                    <button onclick="toggleClearDataSection()" style="width: 100%; padding: 12px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; cursor: pointer; font-weight: 600; color: #856404; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s;">
                        <span>‚ö†Ô∏è Danger Zone: Clear System Data</span>
                        <svg id="clear-data-chevron" style="width: 16px; height: 16px; transition: transform 0.2s;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>

                    <div id="admin-clear-section" style="display: none; background: #ffebee; border: 2px solid #f44336; border-top: none; padding: 20px; border-radius: 0 0 8px 8px; margin-top: -2px;">
                        <p style="color: #c62828; margin-bottom: 15px;">
                            <strong>‚ö†Ô∏è EXTREME CAUTION:</strong> These actions permanently delete data and cannot be undone. Password confirmation required.
                        </p>
                        <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <p style="font-weight: 600; margin-bottom: 12px; color: #1f2937;">Select items to delete:</p>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                                    <input type="checkbox" id="clear-housing-info" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="font-weight: 500;">Clear Housing Assignments</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                                    <input type="checkbox" id="clear-small-group-info" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="font-weight: 500;">Clear Small Group Assignments</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                                    <input type="checkbox" id="clear-youth-groups" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="font-weight: 500;">Clear Youth Group Information</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                                    <input type="checkbox" id="clear-rooms" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="font-weight: 500;">Clear Housing Rooms</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                                    <input type="checkbox" id="clear-small-group-rooms" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="font-weight: 500;">Clear Small Group Rooms</span>
                                </label>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-danger" onclick="clearSelectedData()" style="font-size: 16px; padding: 12px 24px;">üóëÔ∏è Delete Selected Items</button>
                            <button class="btn btn-secondary" onclick="clearDataCheckboxes()" style="font-size: 16px; padding: 12px 24px;">Clear Selection</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Reports Tab -->
        <div id="activity-reports" class="tab-content">
            <h2>Activity Reports</h2>
            <p style="margin-bottom: 20px; color: #666;">View all system changes and user activity logs.</p>

            <!-- Filters -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3>Filter Reports</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="report-user-filter">User</label>
                        <select id="report-user-filter" onchange="filterActivityReports()">
                            <option value="">All Users</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="report-action-filter">Action Type</label>
                        <select id="report-action-filter" onchange="filterActivityReports()">
                            <option value="">All Actions</option>
                            <option value="create">Create</option>
                            <option value="update">Update</option>
                            <option value="delete">Delete</option>
                            <option value="login">Login</option>
                            <option value="logout">Logout</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="report-date-from">From Date</label>
                        <input type="date" id="report-date-from" onchange="filterActivityReports()">
                    </div>
                    <div class="form-group">
                        <label for="report-date-to">To Date</label>
                        <input type="date" id="report-date-to" onchange="filterActivityReports()">
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="exportActivityReports()" class="btn btn-primary">üì• Export to CSV</button>
                    <button onclick="clearActivityReports()" class="btn btn-secondary">üóëÔ∏è Clear All Logs</button>
                </div>
            </div>

            <!-- Activity Log Display -->
            <div>
                <h3>Activity Log (<span id="activity-count">0</span> entries)</h3>
                <div id="activity-reports-list" style="background: white; border-radius: 8px; overflow: hidden;">
                    <!-- Activity logs will be displayed here -->
                </div>
            </div>
        </div>

        </div> <!-- End of content-wrapper -->

    </div> <!-- End of main-content -->

    <script>
        // ===== GLOBAL VARIABLES =====
        let appData = {
            youthGroups: [],
            rooms: [],  // Unified rooms array
            housingRooms: [],  // Filtered view for backward compatibility
            smallGroupRooms: [],  // Filtered view for backward compatibility
            housingAssignments: {
                male: {},
                female: {}
            },
            smallGroupAssignments: {},
            mealColorAssignments: {},
            adaIndividuals: [],
            activeColors: ['Blue', 'Red', 'Orange', 'Yellow', 'Green', 'Purple'],
            mealTimes: {
                Blue: { satBreakfast: '7:00 AM', satLunch: '12:00 PM', satDinner: '5:30 PM', sunBreakfast: '7:30 AM' },
                Red: { satBreakfast: '7:30 AM', satLunch: '12:30 PM', satDinner: '6:00 PM', sunBreakfast: '8:00 AM' },
                Orange: { satBreakfast: '8:00 AM', satLunch: '1:00 PM', satDinner: '6:30 PM', sunBreakfast: '8:30 AM' },
                Yellow: { satBreakfast: '8:30 AM', satLunch: '1:30 PM', satDinner: '7:00 PM', sunBreakfast: '9:00 AM' },
                Green: { satBreakfast: '7:00 AM', satLunch: '12:00 PM', satDinner: '5:30 PM', sunBreakfast: '7:30 AM' },
                Purple: { satBreakfast: '7:30 AM', satLunch: '12:30 PM', satDinner: '6:00 PM', sunBreakfast: '8:00 AM' },
                Brown: { satBreakfast: '8:00 AM', satLunch: '1:00 PM', satDinner: '6:30 PM', sunBreakfast: '8:30 AM' },
                Grey: { satBreakfast: '8:30 AM', satLunch: '1:30 PM', satDinner: '7:00 PM', sunBreakfast: '9:00 AM' }
            },
            defaultNotes: {
                generalInfo: '',
                housingNotes: '',
                teenShowerPlan: '',
                adultShowerPlan: ''
            },
            groupNotes: {},
            dashboardSubtitle: 'Housing and Small Group Assignments - 2026',  // Public dashboard subtitle (auto-generated)
            conferenceName: 'MOUNT 2000 YOUTH RETREAT',  // Conference name
            conferenceStartDate: '2026-02-07',  // Conference start date (Friday)
            schedule: {
                friday: [
                    { startTime: "5:00 PM", endTime: "6:30 PM", event: "Arrival / Registration", location: "Various" },
                    { startTime: "6:30 PM", endTime: "", event: "ARCC Arena Opens", location: "ARCC" },
                    { startTime: "7:00 PM", endTime: "7:35 PM", event: "Start of Program - Introductions", location: "ARCC Arena" },
                    { startTime: "7:40 PM", endTime: "8:20 PM", event: "Keynote 1: Dr. John-Mark Miravalle", location: "ARCC Arena" },
                    { startTime: "8:35 PM", endTime: "9:50 PM", event: "Holy Mass", location: "ARCC Arena" },
                    { startTime: "10:00 PM", endTime: "", event: "Dismissal", location: "" }
                ],
                saturday: [
                    { startTime: "7:40 AM", endTime: "8:40 AM", event: "On-Campus Breakfast", location: "Patriot Hall" },
                    { startTime: "8:30 AM", endTime: "", event: "ARCC Arena Opens", location: "ARCC" },
                    { startTime: "9:00 AM", endTime: "9:30 AM", event: "Start of Program", location: "ARCC Arena" },
                    { startTime: "9:40 AM", endTime: "10:10 AM", event: "Keynote 2: Patricia Sandoval", location: "ARCC Arena" },
                    { startTime: "10:10 AM", endTime: "10:25 AM", event: "Dismissal and Prep for Holy Mass", location: "ARCC Arena" },
                    { startTime: "10:25 AM", endTime: "11:45 AM", event: "Holy Mass", location: "ARCC Arena" },
                    { startTime: "10:25 AM", endTime: "11:45 AM", event: "(Confirmation ONLY) Holy Mass", location: "JC Chapel" },
                    { startTime: "12:15 PM", endTime: "1:15 PM", event: "Lunch", location: "Patriot Hall" },
                    { startTime: "1:30 PM", endTime: "2:30 PM", event: "Breakout Sessions", location: "Various" },
                    { startTime: "2:30 PM", endTime: "4:20 PM", event: "Group Time/Recreation", location: "Various" },
                    { startTime: "4:20 PM", endTime: "6:40 PM", event: "Dinner", location: "Patriot Hall" },
                    { startTime: "6:15 PM", endTime: "", event: "ARCC Arena Opens", location: "ARCC" },
                    { startTime: "6:50 PM", endTime: "7:40 PM", event: "Start of Program", location: "ARCC Arena" },
                    { startTime: "7:40 PM", endTime: "8:00 PM", event: "Break", location: "ARCC Arena" },
                    { startTime: "8:00 PM", endTime: "8:40 PM", event: "Keynote 3: Archbishop Sample", location: "ARCC Arena" },
                    { startTime: "8:50 PM", endTime: "9:50 PM", event: "Eucharistic Adoration", location: "ARCC Arena" },
                    { startTime: "10:00 PM", endTime: "", event: "Dismissal", location: "" }
                ],
                sunday: [
                    { startTime: "7:40 AM", endTime: "8:40 AM", event: "On-Campus Breakfast", location: "Patriot Hall" },
                    { startTime: "8:30 AM", endTime: "", event: "ARCC Arena Opens", location: "ARCC" },
                    { startTime: "8:50 AM", endTime: "9:20 AM", event: "Start of Program", location: "ARCC Arena" },
                    { startTime: "9:25 AM", endTime: "10:05 AM", event: "Keynote 4: Sr. Catherine Holum", location: "ARCC Arena" },
                    { startTime: "10:40 AM", endTime: "12:10 PM", event: "Holy Mass", location: "ARCC Arena" },
                    { startTime: "12:20 PM", endTime: "", event: "Departure", location: "All Exits" }
                ]
            },  // Event schedule for public dashboard
            resources: [],
            users: [],  // User accounts with credentials
            activityLogs: []  // Activity tracking logs
        };

        // ===== HTTPS ENFORCEMENT =====
        function ensureHTTPS(event, path) {
            // Only enforce HTTPS on production (not localhost)
            if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                event.preventDefault();
                const httpsUrl = 'https://' + window.location.host + path;
                window.location.href = httpsUrl;
            }
        }

        // Current logged in user
        let currentUser = null;

        // Pending activity logs (stored in memory until Master Save)
        let pendingActivityLogs = [];
        let userLoginTime = null;  // Track when user logged in

        let editingGroupIndex = -1;
        let editingHousingRoomIndex = -1;
        let editingSmallGroupRoomIndex = -1;
        let selectedHousingAssignment = null;
        let selectedSmallGroupAssignment = null;
        let selectedFormsForPDF = new Set(); // Track which forms are selected for PDF generation

        // Available meal colors
        const MEAL_COLORS = ['Blue', 'Red', 'Orange', 'Yellow', 'Green', 'Purple', 'Brown', 'Grey'];

        // Sorting state
        let sortStates = {
            youthGroups: { field: null, ascending: true },
            housingRooms: { field: null, ascending: true },
            smallGroupRooms: { field: null, ascending: true },
            mealColors: { field: null, ascending: true }
        };

        // ===== TABLE FILTERING AND SORTING FUNCTIONS =====
        
        // Youth Groups Table Filtering and Sorting
        function filterYouthGroupsTable() {
            const filterValue = document.getElementById('youth-groups-filter').value.toLowerCase();
            const tbody = document.getElementById('youth-groups-table');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.getElementsByTagName('td');
                let showRow = false;
                
                // Check Group ID, Parish, Leader, Seminarian SGL, Religious, Phone
                for (let j = 0; j < 6; j++) {
                    if (cells[j] && cells[j].textContent.toLowerCase().includes(filterValue)) {
                        showRow = true;
                        break;
                    }
                }
                
                row.style.display = showRow ? '' : 'none';
            }
        }

        function sortYouthGroupsTable() {
            const sortField = document.getElementById('youth-groups-sort').value;
            sortYouthGroupsBy(sortField);
        }

        function sortYouthGroupsBy(field) {
            const isNewField = sortStates.youthGroups.field !== field;
            sortStates.youthGroups.field = field;
            
            if (isNewField) {
                sortStates.youthGroups.ascending = true;
            } else {
                sortStates.youthGroups.ascending = !sortStates.youthGroups.ascending;
            }
            
            updateSortHeaders('youth-groups-table', field, sortStates.youthGroups.ascending);
            updateYouthGroupsTable();
            updateSortOrderButton('youth-groups-sort-order', sortStates.youthGroups.ascending);
        }

        function toggleYouthGroupsSortOrder() {
            if (sortStates.youthGroups.field) {
                sortStates.youthGroups.ascending = !sortStates.youthGroups.ascending;
                updateYouthGroupsTable();
                updateSortOrderButton('youth-groups-sort-order', sortStates.youthGroups.ascending);
            }
        }

        // Housing Rooms Table Filtering and Sorting
        function filterHousingRoomsTable() {
            const filterValue = document.getElementById('housing-rooms-filter').value.toLowerCase();
            const tbody = document.getElementById('housing-rooms-table');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.getElementsByTagName('td');
                let showRow = false;
                
                // Check Building, Room, Accessibility
                if ((cells[1] && cells[1].textContent.toLowerCase().includes(filterValue)) ||
                    (cells[2] && cells[2].textContent.toLowerCase().includes(filterValue)) ||
                    (cells[7] && cells[7].textContent.toLowerCase().includes(filterValue))) {
                    showRow = true;
                }
                
                row.style.display = showRow ? '' : 'none';
            }
        }

        function sortHousingRoomsTable() {
            const sortField = document.getElementById('housing-rooms-sort').value;
            sortHousingRoomsBy(sortField);
        }

        function sortHousingRoomsBy(field) {
            const isNewField = sortStates.housingRooms.field !== field;
            sortStates.housingRooms.field = field;
            
            if (isNewField) {
                sortStates.housingRooms.ascending = true;
            } else {
                sortStates.housingRooms.ascending = !sortStates.housingRooms.ascending;
            }
            
            updateSortHeaders('housing-rooms-table', field, sortStates.housingRooms.ascending);
            updateHousingRoomsTable();
            updateSortOrderButton('housing-rooms-sort-order', sortStates.housingRooms.ascending);
        }

        function toggleHousingRoomsSortOrder() {
            if (sortStates.housingRooms.field) {
                sortStates.housingRooms.ascending = !sortStates.housingRooms.ascending;
                updateHousingRoomsTable();
                updateSortOrderButton('housing-rooms-sort-order', sortStates.housingRooms.ascending);
            }
        }

        // Small Group Rooms Table Filtering and Sorting
        function filterSmallGroupRoomsTable() {
            const filterValue = document.getElementById('small-group-rooms-filter').value.toLowerCase();
            const tbody = document.getElementById('small-group-rooms-table');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.getElementsByTagName('td');
                let showRow = false;
                
                // Check Building, Room, Features
                if ((cells[1] && cells[1].textContent.toLowerCase().includes(filterValue)) ||
                    (cells[2] && cells[2].textContent.toLowerCase().includes(filterValue)) ||
                    (cells[7] && cells[7].textContent.toLowerCase().includes(filterValue))) {
                    showRow = true;
                }
                
                row.style.display = showRow ? '' : 'none';
            }
        }

        function sortSmallGroupRoomsTable() {
            const sortField = document.getElementById('small-group-rooms-sort').value;
            sortSmallGroupRoomsBy(sortField);
        }

        function sortSmallGroupRoomsBy(field) {
            const isNewField = sortStates.smallGroupRooms.field !== field;
            sortStates.smallGroupRooms.field = field;
            
            if (isNewField) {
                sortStates.smallGroupRooms.ascending = true;
            } else {
                sortStates.smallGroupRooms.ascending = !sortStates.smallGroupRooms.ascending;
            }
            
            updateSortHeaders('small-group-rooms-table', field, sortStates.smallGroupRooms.ascending);
            updateSmallGroupRoomsTable();
            updateSortOrderButton('small-group-rooms-sort-order', sortStates.smallGroupRooms.ascending);
        }

        function toggleSmallGroupRoomsSortOrder() {
            if (sortStates.smallGroupRooms.field) {
                sortStates.smallGroupRooms.ascending = !sortStates.smallGroupRooms.ascending;
                updateSmallGroupRoomsTable();
                updateSortOrderButton('small-group-rooms-sort-order', sortStates.smallGroupRooms.ascending);
            }
        }

        // Utility functions for sorting
        function updateSortHeaders(tableId, field, ascending) {
            const table = document.getElementById(tableId);
            const headers = table.querySelectorAll('th.sortable');
            
            headers.forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
            });
            
            // Add sort class to the active header
            headers.forEach(header => {
                if (header.textContent.toLowerCase().includes(field.toLowerCase()) || 
                    header.onclick.toString().includes(`'${field}'`)) {
                    header.classList.add(ascending ? 'sort-asc' : 'sort-desc');
                }
            });
        }

        function updateSortOrderButton(buttonId, ascending) {
            const button = document.getElementById(buttonId);
            if (button) {
                button.textContent = ascending ? 'A‚ÜíZ' : 'Z‚ÜíA';
            }
        }

        function getSortedYouthGroups() {
            let sorted = [...appData.youthGroups];
            const { field, ascending } = sortStates.youthGroups;
            
            if (!field) return sorted;
            
            sorted.sort((a, b) => {
                let valueA, valueB;
                
                switch (field) {
                    case 'total':
                        valueA = a.maleTeens + a.femaleTeens + a.maleChaperones + a.femaleChaperones;
                        valueB = b.maleTeens + b.femaleTeens + b.maleChaperones + b.femaleChaperones;
                        break;
                    case 'status':
                        valueA = isGroupHousingAssigned(a.id) ? 1 : 0;
                        valueB = isGroupHousingAssigned(b.id) ? 1 : 0;
                        break;
                    case 'maleTeens':
                    case 'femaleTeens':
                    case 'maleChaperones':
                    case 'femaleChaperones':
                        valueA = a[field];
                        valueB = b[field];
                        break;
                    default:
                        valueA = (a[field] || '').toString().toLowerCase();
                        valueB = (b[field] || '').toString().toLowerCase();
                }
                
                if (typeof valueA === 'number') {
                    return ascending ? valueA - valueB : valueB - valueA;
                } else {
                    if (valueA < valueB) return ascending ? -1 : 1;
                    if (valueA > valueB) return ascending ? 1 : -1;
                    return 0;
                }
            });
            
            return sorted;
        }

        // Meal Colors Table Filtering and Sorting
        function filterMealColorsTable() {
            const filterValue = document.getElementById('meal-colors-filter').value.toLowerCase();
            const tbody = document.getElementById('meal-colors-table');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.getElementsByTagName('td');
                let showRow = false;
                
                // Check Group ID, Parish, Leader
                for (let j = 0; j < 3; j++) {
                    if (cells[j] && cells[j].textContent.toLowerCase().includes(filterValue)) {
                        showRow = true;
                        break;
                    }
                }
                
                row.style.display = showRow ? '' : 'none';
            }
        }

        function sortMealColorsTable() {
            const sortField = document.getElementById('meal-colors-sort').value;
            sortMealColorsBy(sortField);
        }

        function sortMealColorsBy(field) {
            const isNewField = sortStates.mealColors.field !== field;
            sortStates.mealColors.field = field;
            
            if (isNewField) {
                sortStates.mealColors.ascending = true;
            } else {
                sortStates.mealColors.ascending = !sortStates.mealColors.ascending;
            }
            
            updateSortHeaders('meal-colors-table', field, sortStates.mealColors.ascending);
            updateMealColorsTable();
            updateSortOrderButton('meal-colors-sort-order', sortStates.mealColors.ascending);
        }

        function toggleMealColorsSortOrder() {
            if (sortStates.mealColors.field) {
                sortStates.mealColors.ascending = !sortStates.mealColors.ascending;
                updateMealColorsTable();
                updateSortOrderButton('meal-colors-sort-order', sortStates.mealColors.ascending);
            }
        }

        function getSortedMealColorGroups() {
            let sorted = [...appData.youthGroups];
            const { field, ascending } = sortStates.mealColors;
            
            if (!field) return sorted;
            
            sorted.sort((a, b) => {
                let valueA, valueB;

                switch (field) {
                    case 'total':
                        valueA = a.maleTeens + a.femaleTeens + a.maleChaperones + a.femaleChaperones;
                        valueB = b.maleTeens + b.femaleTeens + b.maleChaperones + b.femaleChaperones;
                        break;
                    case 'color':
                        valueA = appData.mealColorAssignments[a.id] || '';
                        valueB = appData.mealColorAssignments[b.id] || '';
                        break;
                    case 'location':
                        valueA = (a.stayingOffCampus ? 'Off Campus' : 'On Campus');
                        valueB = (b.stayingOffCampus ? 'Off Campus' : 'On Campus');
                        break;
                    default:
                        valueA = (a[field] || '').toString().toLowerCase();
                        valueB = (b[field] || '').toString().toLowerCase();
                }
                
                if (typeof valueA === 'number') {
                    return ascending ? valueA - valueB : valueB - valueA;
                } else {
                    if (valueA < valueB) return ascending ? -1 : 1;
                    if (valueA > valueB) return ascending ? 1 : -1;
                    return 0;
                }
            });
            
            return sorted;
        }

        function getSortedHousingRooms() {
            let sorted = [...appData.housingRooms];
            const { field, ascending } = sortStates.housingRooms;
            
            if (!field) return sorted;
            
            sorted.sort((a, b) => {
                let valueA, valueB;
                
                switch (field) {
                    case 'occupied':
                        valueA = getHousingRoomOccupancy(`${a.building}-${a.roomId}`);
                        valueB = getHousingRoomOccupancy(`${b.building}-${b.roomId}`);
                        break;
                    case 'available':
                        valueA = a.capacity - getHousingRoomOccupancy(`${a.building}-${a.roomId}`);
                        valueB = b.capacity - getHousingRoomOccupancy(`${b.building}-${b.roomId}`);
                        break;
                    case 'sectionId':
                        valueA = `${a.building.substring(0, 3).toUpperCase()}-${a.roomId}`;
                        valueB = `${b.building.substring(0, 3).toUpperCase()}-${b.roomId}`;
                        break;
                    case 'capacity':
                        valueA = a.capacity;
                        valueB = b.capacity;
                        break;
                    default:
                        valueA = (a[field] || '').toString().toLowerCase();
                        valueB = (b[field] || '').toString().toLowerCase();
                }
                
                if (typeof valueA === 'number') {
                    return ascending ? valueA - valueB : valueB - valueA;
                } else {
                    if (valueA < valueB) return ascending ? -1 : 1;
                    if (valueA > valueB) return ascending ? 1 : -1;
                    return 0;
                }
            });
            
            return sorted;
        }

        function getSortedSmallGroupRooms() {
            let sorted = [...appData.smallGroupRooms];
            const { field, ascending } = sortStates.smallGroupRooms;
            
            if (!field) return sorted;
            
            sorted.sort((a, b) => {
                let valueA, valueB;
                
                switch (field) {
                    case 'occupied':
                        valueA = getSmallGroupRoomOccupancy(`${a.building}-${a.roomId}`);
                        valueB = getSmallGroupRoomOccupancy(`${b.building}-${b.roomId}`);
                        break;
                    case 'available':
                        valueA = a.capacity - getSmallGroupRoomOccupancy(`${a.building}-${a.roomId}`);
                        valueB = b.capacity - getSmallGroupRoomOccupancy(`${b.building}-${b.roomId}`);
                        break;
                    case 'locationId':
                        valueA = `${a.building.substring(0, 3).toUpperCase()}-${a.roomId}`;
                        valueB = `${b.building.substring(0, 3).toUpperCase()}-${b.roomId}`;
                        break;
                    case 'capacity':
                        valueA = a.capacity;
                        valueB = b.capacity;
                        break;
                    default:
                        valueA = (a[field] || '').toString().toLowerCase();
                        valueB = (b[field] || '').toString().toLowerCase();
                }
                
                if (typeof valueA === 'number') {
                    return ascending ? valueA - valueB : valueB - valueA;
                } else {
                    if (valueA < valueB) return ascending ? -1 : 1;
                    if (valueA > valueB) return ascending ? 1 : -1;
                    return 0;
                }
            });
            
            return sorted;
        }

        // ===== PRINTABLE FORMS MANAGEMENT =====
        function toggleColorActive(checkbox) {
            const color = checkbox.value;
            if (checkbox.checked) {
                if (!appData.activeColors.includes(color)) {
                    appData.activeColors.push(color);
                }
            } else {
                appData.activeColors = appData.activeColors.filter(c => c !== color);
            }
            updateMealColorsTable();
            autoSave();
        }

        function updateActiveColorsDisplay() {
            // Check the checkboxes for active colors
            const checkboxes = document.querySelectorAll('input[type="checkbox"][onchange*="toggleColorActive"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = appData.activeColors.includes(checkbox.value);
            });
        }

        function toggleMealTimesConfig() {
            const configDiv = document.getElementById('meal-times-config');
            const toggleIcon = document.getElementById('meal-times-toggle');

            if (configDiv.style.display === 'none') {
                configDiv.style.display = 'block';
                toggleIcon.textContent = '‚ñ≤';
                renderMealTimesConfig();
            } else {
                configDiv.style.display = 'none';
                toggleIcon.textContent = '‚ñº';
            }
        }

        function toggleDashboardFilters() {
            const configDiv = document.getElementById('dashboard-filters-content');
            const toggleIcon = document.getElementById('dashboard-filters-toggle');

            if (configDiv.style.display === 'none') {
                configDiv.style.display = 'block';
                toggleIcon.textContent = '‚ñ≤';
            } else {
                configDiv.style.display = 'none';
                toggleIcon.textContent = '‚ñº';
            }
        }

        function toggleActiveColorsConfig() {
            const configDiv = document.getElementById('active-colors-config');
            const toggleIcon = document.getElementById('active-colors-toggle');

            if (configDiv.style.display === 'none') {
                configDiv.style.display = 'block';
                toggleIcon.textContent = '‚ñ≤';
            } else {
                configDiv.style.display = 'none';
                toggleIcon.textContent = '‚ñº';
            }
        }

        function updateMealTimesConfig() {
            const container = document.getElementById('meal-times-config');
            if (!container) return;

            const mealSlots = [
                { key: 'friDinner', label: 'Friday Dinner' },
                { key: 'satBreakfast', label: 'Saturday Breakfast' },
                { key: 'satLunch', label: 'Saturday Lunch' },
                { key: 'satDinner', label: 'Saturday Dinner' },
                { key: 'sunBreakfast', label: 'Sunday Breakfast' }
            ];

            let html = '';
            MEAL_COLORS.forEach(color => {
                const colorLower = color.toLowerCase();
                const colorBg = getColorForMealAssignment(color);
                
                html += `
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid ${colorBg};">
                        <h4 style="margin-bottom: 10px; color: ${colorBg}; font-weight: bold;">
                            <span style="display: inline-block; width: 20px; height: 20px; background: ${colorBg}; border-radius: 50%; margin-right: 8px; vertical-align: middle;"></span>
                            ${color} Group Meal Times
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                `;
                
                mealSlots.forEach(slot => {
                    const currentValue = appData.mealTimes[color] && appData.mealTimes[color][slot.key] ? appData.mealTimes[color][slot.key] : '';
                    html += `
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; color: #666;">${slot.label}</label>
                            <input 
                                type="text" 
                                value="${currentValue}"
                                onchange="updateMealTime('${color}', '${slot.key}', this.value)"
                                placeholder="e.g., 6:00 PM"
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;"
                            />
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateMealTime(color, slot, time) {
            if (!appData.mealTimes[color]) {
                appData.mealTimes[color] = {};
            }
            appData.mealTimes[color][slot] = time;
            autoSave();
        }

        function saveDefaultNotes() {
            appData.defaultNotes.generalInfo = document.getElementById('default-general-info').value;
            appData.defaultNotes.housingNotes = document.getElementById('default-housing-notes').value;
            appData.defaultNotes.teenShowerPlan = document.getElementById('default-teen-shower').value;
            appData.defaultNotes.adultShowerPlan = document.getElementById('default-adult-shower').value;
            autoSave();
            alert('‚úÖ Default notes saved successfully!');
        }

        function loadDefaultNotes() {
            document.getElementById('default-general-info').value = appData.defaultNotes.generalInfo || '';
            document.getElementById('default-housing-notes').value = appData.defaultNotes.housingNotes || '';
            document.getElementById('default-teen-shower').value = appData.defaultNotes.teenShowerPlan || '';
            document.getElementById('default-adult-shower').value = appData.defaultNotes.adultShowerPlan || '';
        }

        function updateGroupNote(groupId, note) {
            appData.groupNotes[groupId] = note;
            autoSave();
        }

        function saveConferenceConfig() {
            const conferenceName = document.getElementById('conference-name').value;
            const conferenceStartDate = document.getElementById('conference-start-date').value;

            if (!conferenceName || !conferenceStartDate) {
                alert('‚ö†Ô∏è Please fill in both conference name and start date.');
                return;
            }

            appData.conferenceName = conferenceName;
            appData.conferenceStartDate = conferenceStartDate;

            // Auto-generate dashboard subtitle
            const year = new Date(conferenceStartDate).getFullYear();
            appData.dashboardSubtitle = `${conferenceName} - ${year}`;

            updateSubtitlePreview();
            updateScheduleDates();
            autoSave();
            alert('‚úÖ Conference configuration saved successfully! Click "Master Save" to update the live site.');
        }

        function loadConferenceConfig() {
            document.getElementById('conference-name').value = appData.conferenceName || 'MOUNT 2000 YOUTH RETREAT';
            document.getElementById('conference-start-date').value = appData.conferenceStartDate || '2026-02-07';
            updateSubtitlePreview();
            updateScheduleDates();

            // Add event listeners for live preview
            document.getElementById('conference-name').addEventListener('input', updateSubtitlePreview);
            document.getElementById('conference-start-date').addEventListener('change', function() {
                updateSubtitlePreview();
                updateScheduleDates();
            });
        }

        function updateSubtitlePreview() {
            const conferenceName = document.getElementById('conference-name').value;
            const conferenceStartDate = document.getElementById('conference-start-date').value;

            if (conferenceName && conferenceStartDate) {
                const year = new Date(conferenceStartDate).getFullYear();
                document.getElementById('subtitle-preview').textContent = `${conferenceName} - ${year}`;
            }
        }

        function updateScheduleDates() {
            const startDate = new Date(appData.conferenceStartDate || '2026-02-07');

            const friday = new Date(startDate);
            const saturday = new Date(startDate);
            saturday.setDate(saturday.getDate() + 1);
            const sunday = new Date(startDate);
            sunday.setDate(sunday.getDate() + 2);

            const options = { weekday: 'long', month: 'long', day: 'numeric' };

            // Update schedule editor headers if they exist
            const fridayHeader = document.querySelector('#schedule-editor h3:nth-of-type(1)');
            const saturdayHeader = document.querySelector('#schedule-editor h3:nth-of-type(2)');
            const sundayHeader = document.querySelector('#schedule-editor h3:nth-of-type(3)');

            if (fridayHeader) {
                fridayHeader.innerHTML = `üìÖ ${friday.toLocaleDateString('en-US', options)}`;
            }
            if (saturdayHeader) {
                saturdayHeader.innerHTML = `üìÖ ${saturday.toLocaleDateString('en-US', options)}`;
            }
            if (sundayHeader) {
                sundayHeader.innerHTML = `üìÖ ${sunday.toLocaleDateString('en-US', options)}`;
            }
        }

        function filterFormsPreview() {
            const searchTerm = document.getElementById('forms-search').value.toLowerCase();
            const allForms = document.querySelectorAll('.individual-form-preview');
            
            allForms.forEach(form => {
                const formText = form.textContent.toLowerCase();
                if (formText.includes(searchTerm)) {
                    form.style.display = 'block';
                } else {
                    form.style.display = 'none';
                }
            });
        }

        function updateFormsPreview() {
            const container = document.getElementById('forms-preview-section');
            if (!container) return;

            if (appData.youthGroups.length === 0) {
                container.innerHTML = '<div class="notification warning">No youth groups added yet. Add groups in the Youth Groups tab first.</div>';
                return;
            }

            // Sort groups alphabetically by parish name
            const sortedGroups = [...appData.youthGroups].sort((a, b) => 
                a.parish.localeCompare(b.parish)
            );

            let html = '<h3 style="margin: 20px 0 15px 0;">üìã Individual Group Forms Preview</h3>';
            html += '<p style="font-size: 14px; color: #666; margin-bottom: 20px;">Preview and add custom notes for each group before generating PDFs.</p>';

            sortedGroups.forEach(group => {
                const groupNote = appData.groupNotes[group.id] || '';
                const maleHousing = getMaleHousingForForm(group.id);
                const femaleHousing = getFemaleHousingForForm(group.id);
                const smallGroupRoom = getSmallGroupForForm(group.id);
                const mealColor = appData.mealColorAssignments[group.id] || 'Not Assigned';
                const mealSchedule = getMealScheduleText(group.id);
                const isOffCampus = group.stayingOffCampus || false;
                const isSelected = selectedFormsForPDF.has(group.id);

                html += `
                    <div class="individual-form-preview" style="background: white; border: 2px solid #061d28; border-radius: 10px; padding: 20px; margin-bottom: 20px; page-break-inside: avoid;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 15px;">
                            <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input
                                        type="checkbox"
                                        ${isSelected ? 'checked' : ''}
                                        onchange="toggleFormSelection('${group.id}')"
                                        style="width: 24px; height: 24px; cursor: pointer; margin: 0;"
                                    >
                                </label>
                                <div style="background: linear-gradient(135deg, #061d28, #0f3a4a); color: #d4af37; padding: 10px 20px; border-radius: 6px; flex: 1; text-align: center;">
                                    <h3 style="margin: 0; font-size: 20px;">${appData.conferenceName} ${new Date(appData.conferenceStartDate).getFullYear()}</h3>
                                    <p style="margin: 5px 0 0 0; font-size: 12px;">Group Leader Information Sheet - ${new Date(appData.conferenceStartDate).getFullYear()}</p>
                                </div>
                            </div>
                            <button
                                onclick="generateIndividualPDF('${group.id}')"
                                class="btn btn-primary"
                                style="margin-left: 15px; padding: 10px 20px; font-size: 14px; white-space: nowrap;"
                            >
                                üñ®Ô∏è Print This Form
                            </button>
                        </div>

                        <!-- Group ID and Parish Name -->
                        <div style="margin-bottom: 15px;">
                            <strong style="font-size: 12px; color: #666;">Group ID & Parish:</strong>
                            <div style="font-size: 18px; font-weight: bold; border-bottom: 2px solid #d4af37; padding: 5px 0;">
                                <span style="background: #fff9c4; color: #333; padding: 4px 12px; border-radius: 4px; margin-right: 12px; border: 2px solid #f9d71c;">ID: ${group.id}</span>
                                ${group.parish}
                            </div>
                        </div>

                        <!-- Group Leader and Phone -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <strong style="font-size: 12px; color: #666;">Group Leader:</strong>
                                <div style="font-size: 16px; border-bottom: 2px solid #d4af37; padding: 5px 0;">${group.leader}</div>
                            </div>
                            <div>
                                <strong style="font-size: 12px; color: #666;">Phone Number:</strong>
                                <div style="font-size: 16px; border-bottom: 2px solid #d4af37; padding: 5px 0;">${group.phone}</div>
                            </div>
                        </div>

                        <!-- Seminarian SGL and Religious -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <strong style="font-size: 12px; color: #666;">Seminarian Small Group Leader:</strong>
                                <div style="font-size: 16px; border-bottom: 2px solid #d4af37; padding: 5px 0;">${group.seminarianSgl || 'N/A'}</div>
                            </div>
                            <div>
                                <strong style="font-size: 12px; color: #666;">Religious:</strong>
                                <div style="font-size: 16px; border-bottom: 2px solid #d4af37; padding: 5px 0;">${group.religious || 'N/A'}</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                            <div>
                                <strong style="font-size: 11px; color: #666;">Male Teens:</strong>
                                <div style="font-size: 18px; font-weight: bold;">${group.maleTeens}</div>
                            </div>
                            <div>
                                <strong style="font-size: 11px; color: #666;">Female Teens:</strong>
                                <div style="font-size: 18px; font-weight: bold;">${group.femaleTeens}</div>
                            </div>
                            <div>
                                <strong style="font-size: 11px; color: #666;">Male Chaperones:</strong>
                                <div style="font-size: 18px; font-weight: bold;">${group.maleChaperones}</div>
                            </div>
                            <div>
                                <strong style="font-size: 11px; color: #666;">Female Chaperones:</strong>
                                <div style="font-size: 18px; font-weight: bold;">${group.femaleChaperones}</div>
                            </div>
                        </div>

                        <div style="border-top: 2px solid #061d28; padding-top: 15px; margin-top: 15px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <!-- Left Column: Housing and Small Group -->
                                <div>
                                    <h4 style="margin: 0 0 10px 0; font-size: 16px;">üè† HOUSING & SMALL GROUP</h4>
                                    <div style="margin-bottom: 10px;">
                                        <strong style="font-size: 13px; display: block; margin-bottom: 4px;">Male Housing:</strong>
                                        <div style="background: ${isOffCampus ? '#ffe0b2' : '#b3e5fc'}; color: #333; padding: 10px; border-radius: 6px; font-size: 13px; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid ${isOffCampus ? '#ff9800' : '#2196f3'};">${maleHousing}</div>
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <strong style="font-size: 13px; display: block; margin-bottom: 4px;">Female Housing:</strong>
                                        <div style="background: ${isOffCampus ? '#ffe0b2' : '#f8bbd0'}; color: #333; padding: 10px; border-radius: 6px; font-size: 13px; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid ${isOffCampus ? '#ff9800' : '#e91e63'};">${femaleHousing}</div>
                                    </div>
                                    <div>
                                        <strong style="font-size: 13px; display: block; margin-bottom: 4px;">üë• Small Group Room:</strong>
                                        <div style="background: #c8e6c9; color: #333; padding: 10px; border-radius: 6px; font-size: 13px; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid #4caf50;">${smallGroupRoom}</div>
                                    </div>
                                </div>

                                <!-- Right Column: Meal Schedule -->
                                <div>
                                    <h4 style="margin: 0 0 10px 0; font-size: 16px;">üçΩÔ∏è MEAL SCHEDULE</h4>
                                    <div style="border-radius: 6px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <div style="background: ${getColorForMealAssignment(mealColor)}; color: white; font-weight: bold; font-size: 14px; padding: 12px; text-align: center;">
                                            Color: ${mealColor}
                                        </div>
                                        <div style="background: ${mealColor === 'Blue' ? '#e3f2fd' : mealColor === 'Red' ? '#ffebee' : mealColor === 'Orange' ? '#fff3e0' : mealColor === 'Yellow' ? '#fffde7' : mealColor === 'Green' ? '#e8f5e9' : mealColor === 'Purple' ? '#f3e5f5' : mealColor === 'Brown' ? '#efebe9' : '#f5f5f5'}; color: #333; padding: 12px; white-space: pre-line; font-size: 12px; line-height: 1.6; min-height: 150px;">${mealSchedule}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        ${appData.defaultNotes.generalInfo ? `
                            <div style="margin-top: 15px;">
                                <strong style="font-size: 13px;">‚ÑπÔ∏è General Information:</strong>
                                <div style="background: #e3f2fd; padding: 8px; border-radius: 4px; border-left: 4px solid #2196f3; margin-top: 4px; white-space: pre-line; font-size: 12px;">${appData.defaultNotes.generalInfo}</div>
                            </div>
                        ` : ''}

                        ${!isOffCampus && appData.defaultNotes.housingNotes ? `
                            <div style="margin-top: 15px;">
                                <strong style="font-size: 13px;">üìù Housing Notes/Information:</strong>
                                <div style="background: #fffbea; padding: 8px; border-radius: 4px; border-left: 4px solid #f1c40f; margin-top: 4px; white-space: pre-line; font-size: 12px;">${appData.defaultNotes.housingNotes}</div>
                            </div>
                        ` : ''}

                        ${!isOffCampus && (appData.defaultNotes.teenShowerPlan || appData.defaultNotes.adultShowerPlan) ? `
                            <div style="margin-top: 15px;">
                                <h4 style="margin: 0 0 8px 0; font-size: 14px;">üöø SHOWER PLANS</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    ${appData.defaultNotes.teenShowerPlan ? `
                                        <div>
                                            <strong style="font-size: 12px; display: block; margin-bottom: 4px; color: #27ae60;">Teen Shower Plan:</strong>
                                            <div style="background: linear-gradient(135deg, #e8f5e9, #d0ead4); padding: 6px 8px; border-radius: 4px; border-left: 3px solid #27ae60; white-space: pre-line; font-size: 10px; line-height: 1.4;">${appData.defaultNotes.teenShowerPlan}</div>
                                        </div>
                                    ` : ''}
                                    ${appData.defaultNotes.adultShowerPlan ? `
                                        <div>
                                            <strong style="font-size: 12px; display: block; margin-bottom: 4px; color: #9b59b6;">Adult Chaperone Plan:</strong>
                                            <div style="background: linear-gradient(135deg, #f3e5f5, #e8d4ed); padding: 6px 8px; border-radius: 4px; border-left: 3px solid #9b59b6; white-space: pre-line; font-size: 10px; line-height: 1.4;">${appData.defaultNotes.adultShowerPlan}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}

                        ${group.specialAccommodations ? `
                            <div style="margin-top: 15px; background: #fff3cd; padding: 10px; border-radius: 4px; border-left: 4px solid #f39c12;">
                                <strong style="font-size: 13px;">‚ö†Ô∏è Special Accommodations:</strong>
                                <div style="margin-top: 4px; font-size: 12px;">${group.specialAccommodations}</div>
                            </div>
                        ` : ''}

                        ${(() => {
                            const groupAdaIndividuals = (appData.adaIndividuals || []).filter(ada => ada.groupId === group.id);
                            if (groupAdaIndividuals.length === 0) return '';
                            return `
                                <div style="margin-top: 15px; background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 12px; border-radius: 6px; border-left: 5px solid #2196f3;">
                                    <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #1565c0;">‚ôø ADA Individuals:</h4>
                                    ${groupAdaIndividuals.map(ada => `
                                        <div style="background: white; padding: 10px; border-radius: 4px; margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 6px;">
                                                <div>
                                                    <strong style="font-size: 13px;">${ada.name}</strong>
                                                    <div style="font-size: 11px; color: #666;">${ada.gender === 'male' ? 'Male ‚ôÇ' : 'Female ‚ôÄ'}</div>
                                                </div>
                                                <div style="text-align: right;">
                                                    <strong style="font-size: 11px; color: #666;">Room Assignment:</strong>
                                                    <div style="font-size: 12px; font-weight: 600; color: #1976d2;">${ada.roomAssignment || 'Not Assigned'}</div>
                                                </div>
                                            </div>
                                            <div style="background: #fff3cd; padding: 6px 8px; border-radius: 3px; border-left: 3px solid #ff9800;">
                                                <strong style="font-size: 11px; color: #e65100;">Accessibility Needs:</strong>
                                                <div style="font-size: 12px; margin-top: 2px; color: #333;">${ada.accessibility}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        })()}

                        <div style="margin-top: 15px;">
                            <strong style="font-size: 13px;">üí¨ Additional Notes for ${group.parish}:</strong>
                            <textarea 
                                id="group-note-${group.id}"
                                onchange="updateGroupNote('${group.id}', this.value)"
                                placeholder="Add any specific notes for this group..."
                                style="width: 100%; padding: 10px; border: 2px solid #bdc3c7; border-radius: 6px; font-size: 13px; margin-top: 4px; min-height: 80px; font-family: inherit;"
                            >${groupNote}</textarea>
                        </div>

                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; text-align: center; font-size: 11px; color: #666;">
                            Mount St. Mary's University/Seminary | ${appData.conferenceName} ${new Date(appData.conferenceStartDate).getFullYear()}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function getMaleHousingForForm(groupId) {
            const assignments = appData.housingAssignments.male[groupId];
            if (!assignments || assignments.length === 0) return 'Not Assigned';
            
            return assignments.map(roomKey => {
                const room = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                return room ? `${room.building} - ${room.roomId}` : roomKey;
            }).join(', ');
        }

        function getFemaleHousingForForm(groupId) {
            const assignments = appData.housingAssignments.female[groupId];
            if (!assignments || assignments.length === 0) return 'Not Assigned';
            
            return assignments.map(roomKey => {
                const room = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                return room ? `${room.building} - ${room.roomId}` : roomKey;
            }).join(', ');
        }

        function getSmallGroupForForm(groupId) {
            const assignments = appData.smallGroupAssignments[groupId];
            if (!assignments || assignments.length === 0) return 'Not Assigned';
            
            return assignments.map(roomKey => {
                const room = appData.smallGroupRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                if (room && room.features) {
                    return `${room.building} - ${room.roomId} (${room.features})`;
                }
                return room ? `${room.building} - ${room.roomId}` : roomKey;
            }).join(', ');
        }

        function getMealScheduleText(groupId) {
            const color = appData.mealColorAssignments[groupId];
            if (!color) return 'Not Assigned';

            const times = appData.mealTimes[color];
            if (!times) return color;

            const mealSlots = [
                { key: 'friDinner', label: 'Friday Dinner' },
                { key: 'satBreakfast', label: 'Saturday Breakfast' },
                { key: 'satLunch', label: 'Saturday Lunch' },
                { key: 'satDinner', label: 'Saturday Dinner' },
                { key: 'sunBreakfast', label: 'Sunday Breakfast' }
            ];

            const schedule = [];
            mealSlots.forEach(slot => {
                if (times[slot.key]) {
                    schedule.push(`${slot.label}: ${times[slot.key]}`);
                }
            });

            return schedule.length > 0 ? schedule.join('\n') : color;
        }

        function toggleFormSelection(groupId) {
            if (selectedFormsForPDF.has(groupId)) {
                selectedFormsForPDF.delete(groupId);
            } else {
                selectedFormsForPDF.add(groupId);
            }
        }

        function generateSelectedPDFs() {
            if (selectedFormsForPDF.size === 0) {
                alert('‚ö†Ô∏è Please select at least one form by checking the boxes next to the forms you want to generate.');
                return;
            }

            const selectedGroups = appData.youthGroups.filter(g => selectedFormsForPDF.has(g.id));
            generatePDFViewForGroups(selectedGroups);
        }

        function generateIndividualPDF(groupId) {
            const group = appData.youthGroups.find(g => g.id === groupId);
            if (!group) {
                alert('Group not found!');
                return;
            }

            const printWindow = window.open('', '_blank');
            
            const maleHousing = getMaleHousingForForm(group.id);
            const femaleHousing = getFemaleHousingForForm(group.id);
            const smallGroupRoom = getSmallGroupForForm(group.id);
            const mealColor = appData.mealColorAssignments[group.id] || 'Not Assigned';
            const mealSchedule = getMealScheduleText(group.id);
            const groupNote = appData.groupNotes[group.id] || '';
            const isOffCampus = group.stayingOffCampus || false;

            let printHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${group.parish} - Check-In Form</title>
                    <style>
                        @page {
                            size: letter;
                            margin: 0.5in;
                        }
                        @media print {
                            .no-print {
                                display: none !important;
                            }
                            * {
                                -webkit-print-color-adjust: exact !important;
                                print-color-adjust: exact !important;
                                color-adjust: exact !important;
                            }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 12pt;
                            line-height: 1.4;
                            color: #000;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                            color-adjust: exact;
                        }
                        .form-container {
                            background: white;
                            padding: 20px;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        .header {
                            background: #061d28;
                            color: #d4af37;
                            padding: 20px;
                            text-align: center;
                            border-radius: 8px;
                            margin-bottom: 20px;
                        }
                        .header h1 {
                            margin: 0;
                            font-size: 24pt;
                        }
                        .header p {
                            margin: 8px 0 0 0;
                            font-size: 14pt;
                        }
                        .field-label {
                            font-weight: bold;
                            font-size: 10pt;
                            color: #666;
                            margin-bottom: 4px;
                        }
                        .field-value {
                            font-size: 14pt;
                            border-bottom: 2px solid #d4af37;
                            padding: 6px 0;
                            margin-bottom: 12px;
                        }
                        .stats-grid {
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            gap: 12px;
                            background: #f8f9fa;
                            padding: 15px;
                            border-radius: 6px;
                            margin-bottom: 15px;
                        }
                        .section-header {
                            font-size: 14pt;
                            font-weight: bold;
                            border-top: 2px solid #061d28;
                            padding-top: 15px;
                            margin-top: 15px;
                            margin-bottom: 10px;
                        }
                        .housing-box {
                            padding: 12px;
                            border-radius: 6px;
                            margin: 8px 0;
                            color: #333;
                            font-weight: 600;
                            border-left: 4px solid;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        .male-housing-oncampus {
                            background: #b3e5fc;
                            border-left-color: #2196f3;
                        }
                        .female-housing-oncampus {
                            background: #f8bbd0;
                            border-left-color: #e91e63;
                        }
                        .male-housing-offcampus {
                            background: #ffe0b2;
                            border-left-color: #ff9800;
                        }
                        .female-housing-offcampus {
                            background: #ffe0b2;
                            border-left-color: #ff9800;
                        }
                        .off-campus-box {
                            background: #fff3cd;
                            border-left: 4px solid #e67e22;
                            color: #856404;
                            text-align: center;
                            padding: 15px;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        .small-group-box {
                            background: #c8e6c9;
                            border-left-color: #4caf50;
                        }
                        .two-column-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 20px;
                            margin-top: 15px;
                        }
                        .meal-box-header {
                            padding: 12px;
                            color: white;
                            font-weight: bold;
                            text-align: center;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        .meal-box-content {
                            padding: 12px;
                            color: #333;
                            min-height: 150px;
                            white-space: pre-line;
                            line-height: 1.6;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        .notes-box {
                            background: #fffbea;
                            padding: 10px;
                            border-radius: 4px;
                            border-left: 4px solid #f1c40f;
                            margin: 8px 0;
                            white-space: pre-line;
                        }
                        .general-info-box {
                            background: #e3f2fd;
                            padding: 10px;
                            border-radius: 4px;
                            border-left: 4px solid #2196f3;
                            margin: 8px 0;
                            white-space: pre-line;
                        }
                        .special-box {
                            background: #fff3cd;
                            padding: 10px;
                            border-radius: 4px;
                            border-left: 4px solid #f39c12;
                            margin: 8px 0;
                        }
                        .footer {
                            margin-top: 20px;
                            padding-top: 10px;
                            border-top: 1px solid #ddd;
                            text-align: center;
                            font-size: 9pt;
                            color: #666;
                        }
                    </style>
                </head>
                <body>
                    <div class="no-print" style="position: fixed; top: 20px; right: 20px; z-index: 1000; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <button onclick="window.print()" style="padding: 12px 24px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; margin-right: 10px;">
                            üñ®Ô∏è Print to PDF
                        </button>
                        <button onclick="window.close()" style="padding: 12px 24px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            Close
                        </button>
                    </div>
                    
                    <div class="form-container">
                        <div class="header">
                            <h1>${appData.conferenceName} ${new Date(appData.conferenceStartDate).getFullYear()}</h1>
                            <p>Group Leader Information Sheet - ${new Date(appData.conferenceStartDate).getFullYear()}</p>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <div class="field-label">Group ID & Parish:</div>
                            <div class="field-value" style="font-size: 16pt;">
                                <span style="background: #fff9c4; color: #333; padding: 4px 12px; border-radius: 4px; margin-right: 12px; font-weight: bold; border: 2px solid #f9d71c; -webkit-print-color-adjust: exact; print-color-adjust: exact;">ID: ${group.id}</span>
                                <strong>${group.parish}</strong>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <div class="field-label">Group Leader:</div>
                                <div class="field-value">${group.leader}</div>
                            </div>
                            <div>
                                <div class="field-label">Phone Number:</div>
                                <div class="field-value">${group.phone}</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <div class="field-label">Seminarian Small Group Leader:</div>
                                <div class="field-value">${group.seminarianSgl || 'N/A'}</div>
                            </div>
                            <div>
                                <div class="field-label">Religious:</div>
                                <div class="field-value">${group.religious || 'N/A'}</div>
                            </div>
                        </div>

                        <div class="stats-grid">
                            <div>
                                <div class="field-label">Male Teens:</div>
                                <div style="font-size: 18pt; font-weight: bold;">${group.maleTeens}</div>
                            </div>
                            <div>
                                <div class="field-label">Female Teens:</div>
                                <div style="font-size: 18pt; font-weight: bold;">${group.femaleTeens}</div>
                            </div>
                            <div>
                                <div class="field-label">Male Chaperones:</div>
                                <div style="font-size: 18pt; font-weight: bold;">${group.maleChaperones}</div>
                            </div>
                            <div>
                                <div class="field-label">Female Chaperones:</div>
                                <div style="font-size: 18pt; font-weight: bold;">${group.femaleChaperones}</div>
                            </div>
                        </div>

                        <div class="two-column-grid">
                            <div>
                                <div class="section-header" style="margin-top: 0;">üè† HOUSING & SMALL GROUP</div>
                                ${isOffCampus ? `
                                    <div class="housing-box off-campus-box">
                                        <strong style="font-size: 14pt;">üèïÔ∏è OFF-CAMPUS HOUSING</strong>
                                        <p style="margin: 5px 0 0 0;">This group is staying off-campus</p>
                                    </div>
                                ` : `
                                    <div>
                                        <div class="field-label">Male Housing:</div>
                                        <div class="housing-box male-housing-oncampus">${maleHousing}</div>
                                    </div>
                                    <div>
                                        <div class="field-label">Female Housing:</div>
                                        <div class="housing-box female-housing-oncampus">${femaleHousing}</div>
                                    </div>
                                `}
                                ${getADAIndividualsForGroup(group.id).length > 0 ? `
                                    <div style="margin-top: 12px;">
                                        <div class="field-label">‚ôø ADA Accommodations:</div>
                                        ${getADAIndividualsForGroup(group.id).map(ada => `
                                            <div class="housing-box" style="background: #e1bee7; border-left-color: #9c27b0;">
                                                <strong>${ada.name}</strong> (${ada.gender === 'male' ? 'Male' : 'Female'}) - ${ada.accessibility}
                                                ${ada.roomAssignment ? `<br>Room: ${ada.roomAssignment}` : '<br><span style="color: #d32f2f;">Room not assigned</span>'}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                                <div style="margin-top: 12px;">
                                    <div class="field-label">üë• Small Group Room:</div>
                                    <div class="housing-box small-group-box">${smallGroupRoom}</div>
                                </div>
                            </div>

                            <div>
                                <div class="section-header" style="margin-top: 0;">üçΩÔ∏è MEAL SCHEDULE</div>
                                <div style="border-radius: 6px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <div class="meal-box-header" style="background: ${getColorForMealAssignment(mealColor)};">
                                        Color: ${mealColor}
                                    </div>
                                    <div class="meal-box-content" style="background: ${mealColor === 'Blue' ? '#e3f2fd' : mealColor === 'Red' ? '#ffebee' : mealColor === 'Orange' ? '#fff3e0' : mealColor === 'Yellow' ? '#fffde7' : mealColor === 'Green' ? '#e8f5e9' : mealColor === 'Purple' ? '#f3e5f5' : mealColor === 'Brown' ? '#efebe9' : '#f5f5f5'};">${mealSchedule}</div>
                                </div>
                            </div>
                        </div>

                        ${!isOffCampus && appData.defaultNotes.housingNotes ? `
                            <div style="margin-top: 15px;">
                                <div class="field-label">üìù Housing Notes/Information:</div>
                                <div class="notes-box">${appData.defaultNotes.housingNotes}</div>
                            </div>
                        ` : ''}

                        ${!isOffCampus && (appData.defaultNotes.teenShowerPlan || appData.defaultNotes.adultShowerPlan) ? `
                            <div style="margin-top: 15px;">
                                <div class="section-header">üöø SHOWER PLANS</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    ${appData.defaultNotes.teenShowerPlan ? `
                                        <div>
                                            <div class="field-label" style="color: #27ae60; font-weight: bold;">Teen Shower Plan:</div>
                                            <div style="background: #e8f5e9; padding: 10px; border-radius: 6px; border-left: 3px solid #27ae60; white-space: pre-line; font-size: 10pt; line-height: 1.5; color: #333; -webkit-print-color-adjust: exact; print-color-adjust: exact;">${appData.defaultNotes.teenShowerPlan}</div>
                                        </div>
                                    ` : ''}
                                    ${appData.defaultNotes.adultShowerPlan ? `
                                        <div>
                                            <div class="field-label" style="color: #9b59b6; font-weight: bold;">Adult Chaperone Plan:</div>
                                            <div style="background: #f3e5f5; padding: 10px; border-radius: 6px; border-left: 3px solid #9b59b6; white-space: pre-line; font-size: 10pt; line-height: 1.5; color: #333; -webkit-print-color-adjust: exact; print-color-adjust: exact;">${appData.defaultNotes.adultShowerPlan}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}

                        ${appData.defaultNotes.generalInfo ? `
                            <div style="margin-top: 15px;">
                                <div class="field-label">‚ÑπÔ∏è General Information:</div>
                                <div class="general-info-box">${appData.defaultNotes.generalInfo}</div>
                            </div>
                        ` : ''}

                        ${group.specialAccommodations ? `
                            <div style="margin-top: 15px;">
                                <div class="field-label">‚ö†Ô∏è Special Accommodations:</div>
                                <div class="special-box">${group.specialAccommodations}</div>
                            </div>
                        ` : ''}

                        ${groupNote ? `
                            <div style="margin-top: 15px;">
                                <div class="field-label">üí¨ Additional Notes:</div>
                                <div class="general-info-box">${groupNote}</div>
                            </div>
                        ` : ''}

                        <div class="footer">
                            Mount St. Mary's University/Seminary | ${appData.conferenceName} ${new Date(appData.conferenceStartDate).getFullYear()}
                        </div>
                    </div>
                </body>
                </html>
            `;

            printWindow.document.write(printHTML);
            printWindow.document.close();
        }

        function generatePDFView() {
            if (appData.youthGroups.length === 0) {
                alert('No youth groups to generate forms for!');
                return;
            }

            const sortedGroups = [...appData.youthGroups].sort((a, b) => 
                a.parish.localeCompare(b.parish)
            );
            
            generatePDFViewForGroups(sortedGroups);
        }

        function generatePDFViewForGroups(groupsToGenerate) {
            if (!groupsToGenerate || groupsToGenerate.length === 0) {
                alert('No youth groups to generate forms for!');
                return;
            }

            // Create a new window with print-optimized content
            const printWindow = window.open('', '_blank');
            
            // Sort the provided groups alphabetically
            const sortedGroups = [...groupsToGenerate].sort((a, b) => 
                a.parish.localeCompare(b.parish)
            );

            let printHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Mount 2000 Check-In Forms - ${new Date().toLocaleDateString()}</title>
                    <style>
                        @page {
                            size: letter;
                            margin: 0.5in;
                        }
                        @media print {
                            .page-break {
                                page-break-after: always;
                            }
                            .no-print {
                                display: none !important;
                            }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 12pt;
                            line-height: 1.4;
                            color: #000;
                        }
                        .form-container {
                            background: white;
                            padding: 20px;
                            margin-bottom: 20px;
                        }
                        .header {
                            background: #061d28;
                            color: #d4af37;
                            padding: 20px;
                            text-align: center;
                            border-radius: 8px;
                            margin-bottom: 20px;
                        }
                        .header h1 {
                            margin: 0;
                            font-size: 24pt;
                        }
                        .header p {
                            margin: 8px 0 0 0;
                            font-size: 14pt;
                        }
                        .field-label {
                            font-weight: bold;
                            font-size: 10pt;
                            color: #666;
                            margin-bottom: 4px;
                        }
                        .field-value {
                            font-size: 14pt;
                            border-bottom: 2px solid #d4af37;
                            padding: 6px 0;
                            margin-bottom: 12px;
                        }
                        .stats-grid {
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            gap: 12px;
                            background: #f8f9fa;
                            padding: 15px;
                            border-radius: 6px;
                            margin-bottom: 15px;
                        }
                        .section-header {
                            font-size: 14pt;
                            font-weight: bold;
                            border-top: 2px solid #061d28;
                            padding-top: 15px;
                            margin-top: 15px;
                            margin-bottom: 10px;
                        }
                        .housing-box {
                            padding: 12px;
                            border-radius: 6px;
                            margin: 8px 0;
                            color: #333;
                            font-weight: 600;
                            border-left: 4px solid;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        .male-housing-oncampus {
                            background: #b3e5fc;
                            border-left-color: #2196f3;
                        }
                        .female-housing-oncampus {
                            background: #f8bbd0;
                            border-left-color: #e91e63;
                        }
                        .male-housing-offcampus {
                            background: #ffe0b2;
                            border-left-color: #ff9800;
                        }
                        .female-housing-offcampus {
                            background: #ffe0b2;
                            border-left-color: #ff9800;
                        }
                        .off-campus-box {
                            background: #fff3cd;
                            border-left: 4px solid #e67e22;
                            color: #856404;
                            text-align: center;
                            padding: 15px;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        .small-group-box {
                            background: #c8e6c9;
                            border-left-color: #4caf50;
                        }
                        .two-column-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 20px;
                            margin-top: 15px;
                        }
                        .meal-box-header {
                            padding: 12px;
                            color: white;
                            font-weight: bold;
                            text-align: center;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        .meal-box-content {
                            padding: 12px;
                            color: #333;
                            min-height: 150px;
                            white-space: pre-line;
                            line-height: 1.6;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        .notes-box {
                            background: #fffbea;
                            padding: 10px;
                            border-radius: 4px;
                            border-left: 4px solid #f1c40f;
                            margin: 8px 0;
                            white-space: pre-line;
                        }
                        .general-info-box {
                            background: #e3f2fd;
                            padding: 10px;
                            border-radius: 4px;
                            border-left: 4px solid #2196f3;
                            margin: 8px 0;
                            white-space: pre-line;
                        }
                        .special-box {
                            background: #fff3cd;
                            padding: 10px;
                            border-radius: 4px;
                            border-left: 4px solid #f39c12;
                            margin: 8px 0;
                        }
                        .footer {
                            margin-top: 20px;
                            padding-top: 10px;
                            border-top: 1px solid #ddd;
                            text-align: center;
                            font-size: 9pt;
                            color: #666;
                        }
                    </style>
                </head>
                <body>
                    <div class="no-print" style="position: fixed; top: 20px; right: 20px; z-index: 1000; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <button onclick="window.print()" style="padding: 12px 24px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; margin-right: 10px;">
                            üñ®Ô∏è Print to PDF
                        </button>
                        <button onclick="window.close()" style="padding: 12px 24px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            Close
                        </button>
                    </div>
            `;

            sortedGroups.forEach((group, index) => {
                const maleHousing = getMaleHousingForForm(group.id);
                const femaleHousing = getFemaleHousingForForm(group.id);
                const smallGroupRoom = getSmallGroupForForm(group.id);
                const mealColor = appData.mealColorAssignments[group.id] || 'Not Assigned';
                const mealSchedule = getMealScheduleText(group.id);
                const groupNote = appData.groupNotes[group.id] || '';
                const isOffCampus = group.stayingOffCampus || false;

                printHTML += `
                    <div class="form-container ${index < sortedGroups.length - 1 ? 'page-break' : ''}">
                        <div class="header">
                            <h1>${appData.conferenceName} ${new Date(appData.conferenceStartDate).getFullYear()}</h1>
                            <p>Group Leader Information Sheet - ${new Date(appData.conferenceStartDate).getFullYear()}</p>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <div class="field-label">Group ID & Parish:</div>
                            <div class="field-value" style="font-size: 16pt;">
                                <span style="background: #fff9c4; color: #333; padding: 4px 12px; border-radius: 4px; margin-right: 12px; font-weight: bold; border: 2px solid #f9d71c; -webkit-print-color-adjust: exact; print-color-adjust: exact;">ID: ${group.id}</span>
                                <strong>${group.parish}</strong>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <div class="field-label">Group Leader:</div>
                                <div class="field-value">${group.leader}</div>
                            </div>
                            <div>
                                <div class="field-label">Phone Number:</div>
                                <div class="field-value">${group.phone}</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <div class="field-label">Seminarian Small Group Leader:</div>
                                <div class="field-value">${group.seminarianSgl || 'N/A'}</div>
                            </div>
                            <div>
                                <div class="field-label">Religious:</div>
                                <div class="field-value">${group.religious || 'N/A'}</div>
                            </div>
                        </div>

                        <div class="stats-grid">
                            <div>
                                <div class="field-label">Male Teens:</div>
                                <div style="font-size: 18pt; font-weight: bold;">${group.maleTeens}</div>
                            </div>
                            <div>
                                <div class="field-label">Female Teens:</div>
                                <div style="font-size: 18pt; font-weight: bold;">${group.femaleTeens}</div>
                            </div>
                            <div>
                                <div class="field-label">Male Chaperones:</div>
                                <div style="font-size: 18pt; font-weight: bold;">${group.maleChaperones}</div>
                            </div>
                            <div>
                                <div class="field-label">Female Chaperones:</div>
                                <div style="font-size: 18pt; font-weight: bold;">${group.femaleChaperones}</div>
                            </div>
                        </div>

                        <div class="two-column-grid">
                            <div>
                                <div class="section-header" style="margin-top: 0;">üè† HOUSING & SMALL GROUP</div>
                                ${isOffCampus ? `
                                    <div class="housing-box off-campus-box">
                                        <strong style="font-size: 14pt;">üèïÔ∏è OFF-CAMPUS HOUSING</strong>
                                        <p style="margin: 5px 0 0 0;">This group is staying off-campus</p>
                                    </div>
                                ` : `
                                    <div>
                                        <div class="field-label">Male Housing:</div>
                                        <div class="housing-box male-housing-oncampus">${maleHousing}</div>
                                    </div>
                                    <div>
                                        <div class="field-label">Female Housing:</div>
                                        <div class="housing-box female-housing-oncampus">${femaleHousing}</div>
                                    </div>
                                `}
                                ${getADAIndividualsForGroup(group.id).length > 0 ? `
                                    <div style="margin-top: 12px;">
                                        <div class="field-label">‚ôø ADA Accommodations:</div>
                                        ${getADAIndividualsForGroup(group.id).map(ada => `
                                            <div class="housing-box" style="background: #e1bee7; border-left-color: #9c27b0;">
                                                <strong>${ada.name}</strong> (${ada.gender === 'male' ? 'Male' : 'Female'}) - ${ada.accessibility}
                                                ${ada.roomAssignment ? `<br>Room: ${ada.roomAssignment}` : '<br><span style="color: #d32f2f;">Room not assigned</span>'}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                                <div style="margin-top: 12px;">
                                    <div class="field-label">üë• Small Group Room:</div>
                                    <div class="housing-box small-group-box">${smallGroupRoom}</div>
                                </div>
                            </div>

                            <div>
                                <div class="section-header" style="margin-top: 0;">üçΩÔ∏è MEAL SCHEDULE</div>
                                <div style="border-radius: 6px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <div class="meal-box-header" style="background: ${getColorForMealAssignment(mealColor)};">
                                        Color: ${mealColor}
                                    </div>
                                    <div class="meal-box-content" style="background: ${mealColor === 'Blue' ? '#e3f2fd' : mealColor === 'Red' ? '#ffebee' : mealColor === 'Orange' ? '#fff3e0' : mealColor === 'Yellow' ? '#fffde7' : mealColor === 'Green' ? '#e8f5e9' : mealColor === 'Purple' ? '#f3e5f5' : mealColor === 'Brown' ? '#efebe9' : '#f5f5f5'};">${mealSchedule}</div>
                                </div>
                            </div>
                        </div>

                        ${!isOffCampus && appData.defaultNotes.housingNotes ? `
                            <div style="margin-top: 15px;">
                                <div class="field-label">üìù Housing Notes/Information:</div>
                                <div class="notes-box">${appData.defaultNotes.housingNotes}</div>
                            </div>
                        ` : ''}

                        ${!isOffCampus && (appData.defaultNotes.teenShowerPlan || appData.defaultNotes.adultShowerPlan) ? `
                            <div style="margin-top: 15px;">
                                <div class="section-header">üöø SHOWER PLANS</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    ${appData.defaultNotes.teenShowerPlan ? `
                                        <div>
                                            <div class="field-label" style="color: #27ae60; font-weight: bold;">Teen Shower Plan:</div>
                                            <div style="background: #e8f5e9; padding: 10px; border-radius: 6px; border-left: 3px solid #27ae60; white-space: pre-line; font-size: 10pt; line-height: 1.5; color: #333; -webkit-print-color-adjust: exact; print-color-adjust: exact;">${appData.defaultNotes.teenShowerPlan}</div>
                                        </div>
                                    ` : ''}
                                    ${appData.defaultNotes.adultShowerPlan ? `
                                        <div>
                                            <div class="field-label" style="color: #9b59b6; font-weight: bold;">Adult Chaperone Plan:</div>
                                            <div style="background: #f3e5f5; padding: 10px; border-radius: 6px; border-left: 3px solid #9b59b6; white-space: pre-line; font-size: 10pt; line-height: 1.5; color: #333; -webkit-print-color-adjust: exact; print-color-adjust: exact;">${appData.defaultNotes.adultShowerPlan}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}

                        ${appData.defaultNotes.generalInfo ? `
                            <div style="margin-top: 15px;">
                                <div class="field-label">‚ÑπÔ∏è General Information:</div>
                                <div class="general-info-box">${appData.defaultNotes.generalInfo}</div>
                            </div>
                        ` : ''}

                        ${group.specialAccommodations ? `
                            <div style="margin-top: 15px;">
                                <div class="field-label">‚ö†Ô∏è Special Accommodations:</div>
                                <div class="special-box">${group.specialAccommodations}</div>
                            </div>
                        ` : ''}

                        ${groupNote ? `
                            <div style="margin-top: 15px;">
                                <div class="field-label">üí¨ Additional Notes:</div>
                                <div class="notes-box" style="background: #e3f2fd; border-left-color: #2196f3;">${groupNote}</div>
                            </div>
                        ` : ''}

                        <div class="footer">
                            Mount St. Mary's University/Seminary | ${appData.conferenceName} ${new Date(appData.conferenceStartDate).getFullYear()}
                        </div>
                    </div>
                `;
            });

            printHTML += `
                </body>
                </html>
            `;

            printWindow.document.write(printHTML);
            printWindow.document.close();
        }

        // ===== SYSTEM INITIALIZATION =====
        async function initializeSystem() {
            await loadDataFromJSON();
            updateAllDisplays();
            setupKeyboardShortcuts();
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(event) {
                // Check for Cmd+S (Mac) or Ctrl+S (Windows/Linux)
                if ((event.metaKey || event.ctrlKey) && event.key === 's') {
                    event.preventDefault(); // Prevent browser's default save
                    exportCompleteHTML();
                }
            });
        }

        async function loadDataFromJSON() {
            try {
                // Add timestamp to prevent browser caching
                const timestamp = new Date().getTime();
                const response = await fetch(`m2k_2026_housing_data (1).json?v=${timestamp}`);

                if (!response.ok) {
                    throw new Error('Data file not found');
                }

                const data = await response.json();

                // Load all data from JSON
                appData.youthGroups = data.youthGroups || [];

                // Load rooms - support both old and new formats
                if (data.rooms) {
                    // New unified format
                    appData.rooms = data.rooms;
                } else {
                    // Old format - migrate to new format
                    appData.rooms = [];
                    if (data.housingRooms) {
                        appData.rooms.push(...data.housingRooms.map(r => ({ ...r, type: 'housing' })));
                    }
                    if (data.smallGroupRooms) {
                        appData.rooms.push(...data.smallGroupRooms.map(r => ({ ...r, type: 'smallGroup' })));
                    }
                }

                // Create filtered views for backward compatibility
                appData.housingRooms = appData.rooms.filter(r => r.type === 'housing');
                appData.smallGroupRooms = appData.rooms.filter(r => r.type === 'smallGroup');

                appData.housingAssignments = data.housingAssignments || { male: {}, female: {} };
                appData.smallGroupAssignments = data.smallGroupAssignments || {};
                appData.mealColorAssignments = data.mealColorAssignments || {};
                appData.adaIndividuals = data.adaIndividuals || [];
                appData.activeColors = data.activeColors || ['Blue', 'Red', 'Orange', 'Yellow', 'Green', 'Purple'];
                appData.mealTimes = data.mealTimes || {
                    Blue: { satBreakfast: '7:00 AM', satLunch: '12:00 PM', satDinner: '5:30 PM', sunBreakfast: '7:30 AM' },
                    Red: { satBreakfast: '7:30 AM', satLunch: '12:30 PM', satDinner: '6:00 PM', sunBreakfast: '8:00 AM' },
                    Orange: { satBreakfast: '8:00 AM', satLunch: '1:00 PM', satDinner: '6:30 PM', sunBreakfast: '8:30 AM' },
                    Yellow: { satBreakfast: '8:30 AM', satLunch: '1:30 PM', satDinner: '7:00 PM', sunBreakfast: '9:00 AM' },
                    Green: { satBreakfast: '7:00 AM', satLunch: '12:00 PM', satDinner: '5:30 PM', sunBreakfast: '7:30 AM' },
                    Purple: { satBreakfast: '7:30 AM', satLunch: '12:30 PM', satDinner: '6:00 PM', sunBreakfast: '8:00 AM' },
                    Brown: { satBreakfast: '8:00 AM', satLunch: '1:00 PM', satDinner: '6:30 PM', sunBreakfast: '8:30 AM' },
                    Grey: { satBreakfast: '8:30 AM', satLunch: '1:30 PM', satDinner: '7:00 PM', sunBreakfast: '9:00 AM' }
                };

                // Ensure defaultNotes has all fields, including new generalInfo field
                appData.defaultNotes = {
                    generalInfo: data.defaultNotes?.generalInfo || '',
                    housingNotes: data.defaultNotes?.housingNotes || '',
                    teenShowerPlan: data.defaultNotes?.teenShowerPlan || '',
                    adultShowerPlan: data.defaultNotes?.adultShowerPlan || ''
                };

                appData.groupNotes = data.groupNotes || {};
                appData.dashboardSubtitle = data.dashboardSubtitle || 'Housing and Small Group Assignments - 2026';
                // Keep pre-populated schedule if no schedule data in JSON
                if (data.schedule) {
                    appData.schedule = data.schedule;
                }
                appData.resources = data.resources || [];
                appData.activityLogs = data.activityLogs || [];

                console.log('‚úÖ Data loaded successfully from JSON file');
                console.log(`   Loaded ${appData.activityLogs.length} activity logs`);

                // Update active colors checkboxes
                updateActiveColorsDisplay();
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Could not load data file:', error);
                
                // Show friendly error message on dashboard
                showDataLoadError();
                
                // Initialize with empty data structure
                appData.youthGroups = [];
                appData.rooms = [];
                appData.housingRooms = [];
                appData.smallGroupRooms = [];
                appData.housingAssignments = { male: {}, female: {} };
                appData.smallGroupAssignments = {};
                appData.mealColorAssignments = {};
                appData.mealTimes = {
                    Blue: { friDinner: '5:30 PM', satBreakfast: '7:00 AM', satLunch: '12:00 PM', satDinner: '5:30 PM', sunBreakfast: '7:30 AM' },
                    Red: { friDinner: '6:00 PM', satBreakfast: '7:30 AM', satLunch: '12:30 PM', satDinner: '6:00 PM', sunBreakfast: '8:00 AM' },
                    Orange: { friDinner: '6:30 PM', satBreakfast: '8:00 AM', satLunch: '1:00 PM', satDinner: '6:30 PM', sunBreakfast: '8:30 AM' },
                    Yellow: { friDinner: '7:00 PM', satBreakfast: '8:30 AM', satLunch: '1:30 PM', satDinner: '7:00 PM', sunBreakfast: '9:00 AM' },
                    Green: { friDinner: '5:30 PM', satBreakfast: '7:00 AM', satLunch: '12:00 PM', satDinner: '5:30 PM', sunBreakfast: '7:30 AM' },
                    Purple: { friDinner: '6:00 PM', satBreakfast: '7:30 AM', satLunch: '12:30 PM', satDinner: '6:00 PM', sunBreakfast: '8:00 AM' },
                    Brown: { friDinner: '6:30 PM', satBreakfast: '8:00 AM', satLunch: '1:00 PM', satDinner: '6:30 PM', sunBreakfast: '8:30 AM' },
                    Grey: { friDinner: '7:00 PM', satBreakfast: '8:30 AM', satLunch: '1:30 PM', satDinner: '7:00 PM', sunBreakfast: '9:00 AM' }
                };
                appData.defaultNotes = { generalInfo: '', housingNotes: '', teenShowerPlan: '', adultShowerPlan: '' };
                appData.groupNotes = {};
                appData.resources = [];
            }
        }

        function showDataLoadError() {
            // Add error notification to dashboard
            setTimeout(() => {
                const dashboard = document.getElementById('dashboard');
                if (dashboard) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'notification warning';
                    errorDiv.style.cssText = 'margin: 20px 0; padding: 20px; background: #fff3cd; border: 2px solid #f39c12; border-radius: 10px;';
                    errorDiv.innerHTML = `
                        <h3 style="margin: 0 0 10px 0; color: #856404;">‚ö†Ô∏è Whoops, looks like we can't find the data right now!</h3>
                        <p style="margin: 0; color: #856404;">You can insert old information into the folder or start here. Once you add data and save it, place the <strong>m2k_2026_housing_data.json</strong> file in the same folder as this HTML file and rename it to <strong>m2k_2026_housing_data (1).json</strong></p>
                    `;
                    dashboard.insertBefore(errorDiv, dashboard.firstChild.nextSibling);
                }
            }, 100);
        }

        function loadSampleData() {
            // This function is no longer used - data is loaded from JSON file
            // Kept for compatibility
        }

        // ===== TAB MANAGEMENT =====
        function toggleDropdown(dropdownId, e) {
            if (!e) e = window.event;

            // Close all other dropdowns
            document.querySelectorAll('.tab-dropdown-content').forEach(dropdown => {
                if (dropdown.id !== dropdownId) {
                    dropdown.classList.remove('show');
                }
            });

            // Close all dropdown buttons' open state
            document.querySelectorAll('.tab-dropdown-button').forEach(btn => {
                if (btn.nextElementSibling?.id !== dropdownId) {
                    btn.classList.remove('open');
                }
            });

            // Toggle the clicked dropdown
            const dropdown = document.getElementById(dropdownId);
            const button = e.target.closest('.tab-dropdown-button');

            if (dropdown) {
                dropdown.classList.toggle('show');
                if (button) {
                    button.classList.toggle('open');
                }
            }

            // Prevent event from bubbling
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            return false;
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.tab-dropdown')) {
                document.querySelectorAll('.tab-dropdown-content').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
                document.querySelectorAll('.tab-dropdown-button').forEach(btn => {
                    btn.classList.remove('open');
                });
            }
        });

        function switchTabWithEvent(tabName, e) {
            switchTab(tabName, e);
        }

        function switchTab(tabName, e) {
            // Check if user is trying to access admin-only tabs
            if (tabName === 'activity-reports') {
                if (!currentUser || (currentUser.role !== 'admin' && !currentUser.isAdmin)) {
                    alert('‚ùå Access Denied\n\nActivity Reports are only accessible to administrators.');
                    return;
                }
            }

            // Close all dropdowns
            document.querySelectorAll('.tab-dropdown-content').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
            document.querySelectorAll('.tab-dropdown-button').forEach(btn => {
                btn.classList.remove('open');
            });

            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-dropdown-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.tab-dropdown-button').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');

            // Highlight active tab button or dropdown item
            if (e && e.target) {
                if (e.target.classList.contains('tab-button')) {
                    e.target.classList.add('active');
                } else if (e.target.classList.contains('tab-dropdown-item')) {
                    e.target.classList.add('active');
                    // Also highlight the parent dropdown button
                    const parentDropdown = e.target.closest('.tab-dropdown');
                    if (parentDropdown) {
                        const dropdownButton = parentDropdown.querySelector('.tab-dropdown-button');
                        if (dropdownButton) {
                            dropdownButton.classList.add('active');
                        }
                    }
                }
            }

            if (tabName === 'housing-assignments') {
                updateHousingAssignmentDropdown();
            } else if (tabName === 'small-group-assignments') {
                updateSmallGroupAssignmentDropdown();
            } else if (tabName === 'meal-colors') {
                updateMealTimesConfig();
                // Expand meal times on first visit
                const configDiv = document.getElementById('meal-times-config');
                if (configDiv && configDiv.innerHTML && configDiv.style.display === 'none') {
                    // Keep it collapsed by default - user can expand if needed
                }
            } else if (tabName === 'meal-color-assignments') {
                updateMealColorsTable();
                updateMealColorSummary();
            } else if (tabName === 'resources') {
                displayResources();
            } else if (tabName === 'schedule-editor') {
                displayScheduleEditor();
            } else if (tabName === 'settings') {
                loadConferenceConfig();
                displayUsers();
                // Show/hide admin sections based on user role
                const userManagementSection = document.getElementById('user-management-section');

                if (userManagementSection && currentUser) {
                    userManagementSection.style.display = currentUser.isAdmin ? 'block' : 'none';
                }
            } else if (tabName === 'activity-reports') {
                displayActivityReports();
                updateActivityUserFilter();
            } else if (tabName === 'printable-forms') {
                loadDefaultNotes();
                updateFormsPreview();
            } else if (tabName === 'room-posters') {
                loadRoomNotes();
                displayRoomPosters();
            }
        }

        // ===== CSV IMPORT/EXPORT FOR YOUTH GROUPS =====
        function downloadCSVTemplate() {
            const headers = [
                'Group ID',
                'Parish Name',
                'Group Leader',
                'Seminarian SGL',
                'Religious',
                'Phone Number',
                'Male Teens',
                'Female Teens',
                'Male Chaperones',
                'Female Chaperones',
                'Off-Campus',
                'Special Accommodations'
            ];

            const sampleRow = [
                '1',
                'St. Example Parish',
                'John Smith',
                'Fr. Michael',
                'Sr. Mary',
                '123-456-7890',
                '15',
                '20',
                '3',
                '4',
                'No',
                'Wheelchair accessible room needed'
            ];
            
            let csvContent = headers.join(',') + '\n';
            csvContent += sampleRow.join(',') + '\n';
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'm2k_youth_groups_template.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('‚úÖ CSV Template downloaded!\n\nThe template includes:\n‚Ä¢ All required and optional columns\n‚Ä¢ One sample row showing the format\n‚Ä¢ Instructions in the sample data\n\nFill it out and use "Import from CSV" to add your groups!');
        }

        function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    const lines = csvContent.split('\n');
                    
                    if (lines.length < 2) {
                        alert('‚ùå CSV file is empty or invalid!');
                        return;
                    }
                    
                    // Parse header row
                    const headers = lines[0].split(',').map(h => h.trim());
                    
                    // Validate required headers
                    const groupIdIndex = headers.findIndex(h => h.toLowerCase().includes('group') && h.toLowerCase().includes('id'));
                    const parishIndex = headers.findIndex(h => h.toLowerCase().includes('parish'));
                    
                    if (groupIdIndex === -1 || parishIndex === -1) {
                        alert('‚ùå CSV must have "Group ID" and "Parish Name" columns!');
                        return;
                    }
                    
                    // Find optional column indices
                    const leaderIndex = headers.findIndex(h => h.toLowerCase().includes('leader'));
                    const seminarianIndex = headers.findIndex(h => h.toLowerCase().includes('seminarian') || h.toLowerCase().includes('sgl'));
                    const religiousIndex = headers.findIndex(h => h.toLowerCase().includes('religious'));
                    const phoneIndex = headers.findIndex(h => h.toLowerCase().includes('phone'));
                    const maleTeensIndex = headers.findIndex(h => h.toLowerCase().includes('male') && h.toLowerCase().includes('teen'));
                    const femaleTeensIndex = headers.findIndex(h => h.toLowerCase().includes('female') && h.toLowerCase().includes('teen'));
                    const maleChaperoneIndex = headers.findIndex(h => h.toLowerCase().includes('male') && h.toLowerCase().includes('chap'));
                    const femaleChaperoneIndex = headers.findIndex(h => h.toLowerCase().includes('female') && h.toLowerCase().includes('chap'));
                    const offCampusIndex = headers.findIndex(h => h.toLowerCase().includes('off') && h.toLowerCase().includes('campus'));
                    const accommodationsIndex = headers.findIndex(h => h.toLowerCase().includes('special') || h.toLowerCase().includes('accommod'));
                    
                    let importedCount = 0;
                    let skippedCount = 0;
                    const errors = [];
                    
                    // Process data rows
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue; // Skip empty lines
                        
                        const values = parseCSVLine(line);
                        
                        const groupId = values[groupIdIndex]?.trim();
                        const parishName = values[parishIndex]?.trim();
                        
                        // Skip if missing required fields
                        if (!groupId || !parishName) {
                            skippedCount++;
                            errors.push(`Row ${i + 1}: Missing Group ID or Parish Name`);
                            continue;
                        }
                        
                        // Check if group already exists
                        const existingIndex = appData.youthGroups.findIndex(g => g.id === groupId);
                        if (existingIndex !== -1) {
                            skippedCount++;
                            errors.push(`Row ${i + 1}: Group ID "${groupId}" already exists`);
                            continue;
                        }
                        
                        // Parse off-campus status
                        let offCampus = false;
                        if (offCampusIndex !== -1 && values[offCampusIndex]) {
                            const offCampusValue = values[offCampusIndex].trim().toLowerCase();
                            offCampus = offCampusValue === 'yes' || 
                                       offCampusValue === 'true' || 
                                       offCampusValue === 'x' || 
                                       offCampusValue === '1' ||
                                       offCampusValue === 'y';
                        }
                        
                        // Create new group
                        const newGroup = {
                            id: groupId,
                            parish: parishName,
                            leader: leaderIndex !== -1 ? (values[leaderIndex]?.trim() || '') : '',
                            seminarianSgl: seminarianIndex !== -1 ? (values[seminarianIndex]?.trim() || '') : '',
                            religious: religiousIndex !== -1 ? (values[religiousIndex]?.trim() || '') : '',
                            phone: phoneIndex !== -1 ? (values[phoneIndex]?.trim() || '') : '',
                            maleTeens: maleTeensIndex !== -1 ? (parseInt(values[maleTeensIndex]) || 0) : 0,
                            femaleTeens: femaleTeensIndex !== -1 ? (parseInt(values[femaleTeensIndex]) || 0) : 0,
                            maleChaperones: maleChaperoneIndex !== -1 ? (parseInt(values[maleChaperoneIndex]) || 0) : 0,
                            femaleChaperones: femaleChaperoneIndex !== -1 ? (parseInt(values[femaleChaperoneIndex]) || 0) : 0,
                            stayingOffCampus: offCampus,
                            specialAccommodations: accommodationsIndex !== -1 ? (values[accommodationsIndex]?.trim() || '') : ''
                        };
                        
                        appData.youthGroups.push(newGroup);
                        importedCount++;
                        
                        // Auto-assign off-campus housing if needed
                        if (offCampus) {
                            autoAssignOffCampusHousing(groupId);
                        }
                    }
                    
                    // Clear the file input
                    event.target.value = '';
                    
                    // Update displays
                    updateAllDisplays();
                    autoSave();
                    
                    // Show results
                    let message = `‚úÖ Import Complete!\n\n`;
                    message += `‚úì Successfully imported: ${importedCount} groups\n`;
                    if (skippedCount > 0) {
                        message += `‚ö† Skipped: ${skippedCount} rows\n\n`;
                        if (errors.length > 0 && errors.length <= 10) {
                            message += `Errors:\n${errors.join('\n')}`;
                        } else if (errors.length > 10) {
                            message += `Errors (first 10):\n${errors.slice(0, 10).join('\n')}\n... and ${errors.length - 10} more`;
                        }
                    }
                    
                    alert(message);
                    
                } catch (error) {
                    alert('‚ùå Error reading CSV file: ' + error.message + '\n\nMake sure your file is a valid CSV format.');
                    console.error('CSV Import Error:', error);
                }
            };
            reader.readAsText(file);
        }

        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current);
            
            return values.map(v => v.trim().replace(/^"|"$/g, ''));
        }

        // ===== YOUTH GROUP MANAGEMENT =====
        function addYouthGroup() {
            const groupData = getYouthGroupFormData();
            if (!validateYouthGroupData(groupData)) return;

            appData.youthGroups.push(groupData);

            // Auto-assign off-campus housing if needed
            if (groupData.stayingOffCampus) {
                autoAssignOffCampusHousing(groupData.id);
            }

            clearYouthGroupForm();
            updateAllDisplays();
            autoSave();

            // Log activity
            logActivity('create', 'youth-group', groupData.id, `Created youth group: ${groupData.parish} (ID: ${groupData.id})`);
        }

        function updateYouthGroup() {
            if (editingGroupIndex < 0) return;

            const groupData = getYouthGroupFormData();
            if (!validateYouthGroupData(groupData)) return;

            const oldId = appData.youthGroups[editingGroupIndex].id;
            const wasOffCampus = appData.youthGroups[editingGroupIndex].stayingOffCampus;

            appData.youthGroups[editingGroupIndex] = groupData;

            if (oldId !== groupData.id) {
                updateAssignmentIds(oldId, groupData.id);
            }

            // Handle off-campus housing changes
            if (groupData.stayingOffCampus && !wasOffCampus) {
                // Just checked off-campus - auto-assign
                autoAssignOffCampusHousing(groupData.id);
            } else if (!groupData.stayingOffCampus && wasOffCampus) {
                // Just unchecked off-campus - remove assignments
                removeOffCampusHousing(groupData.id);
            } else if (groupData.stayingOffCampus) {
                // Still off-campus - update assignments in case numbers changed
                autoAssignOffCampusHousing(groupData.id);
            }

            cancelEdit();
            updateAllDisplays();
            autoSave();

            // Log activity
            logActivity('update', 'youth-group', groupData.id, `Updated youth group: ${groupData.parish} (ID: ${groupData.id})`);
        }

        function autoAssignOffCampusHousing(groupId) {
            const group = appData.youthGroups.find(g => g.id === groupId);
            if (!group) return;
            
            const maleTotal = group.maleTeens + group.maleChaperones;
            const femaleTotal = group.femaleTeens + group.femaleChaperones;
            
            // Assign to Off Campus-Male if they have males
            if (maleTotal > 0) {
                if (!appData.housingAssignments.male[groupId]) {
                    appData.housingAssignments.male[groupId] = [];
                }
                // Check if already assigned to off-campus
                const offCampusMaleRoom = 'Off Campus-Male';
                if (!appData.housingAssignments.male[groupId].includes(offCampusMaleRoom)) {
                    appData.housingAssignments.male[groupId] = [offCampusMaleRoom];
                }
            }
            
            // Assign to Off Campus-Female if they have females
            if (femaleTotal > 0) {
                if (!appData.housingAssignments.female[groupId]) {
                    appData.housingAssignments.female[groupId] = [];
                }
                // Check if already assigned to off-campus
                const offCampusFemaleRoom = 'Off Campus-Female';
                if (!appData.housingAssignments.female[groupId].includes(offCampusFemaleRoom)) {
                    appData.housingAssignments.female[groupId] = [offCampusFemaleRoom];
                }
            }
        }

        function removeOffCampusHousing(groupId) {
            // Remove from off-campus male housing
            if (appData.housingAssignments.male[groupId]) {
                appData.housingAssignments.male[groupId] = appData.housingAssignments.male[groupId].filter(
                    room => room !== 'Off Campus-Male'
                );
                if (appData.housingAssignments.male[groupId].length === 0) {
                    delete appData.housingAssignments.male[groupId];
                }
            }
            
            // Remove from off-campus female housing
            if (appData.housingAssignments.female[groupId]) {
                appData.housingAssignments.female[groupId] = appData.housingAssignments.female[groupId].filter(
                    room => room !== 'Off Campus-Female'
                );
                if (appData.housingAssignments.female[groupId].length === 0) {
                    delete appData.housingAssignments.female[groupId];
                }
            }
        }

        function editYouthGroup(index) {
            const group = appData.youthGroups[index];
            populateYouthGroupForm(group);
            editingGroupIndex = index;
            showEditButtons();
        }

        function deleteYouthGroup() {
            if (editingGroupIndex < 0) return;

            if (confirm('Are you sure you want to delete this youth group and all its assignments?')) {
                const groupId = appData.youthGroups[editingGroupIndex].id;
                const groupParish = appData.youthGroups[editingGroupIndex].parish;

                delete appData.housingAssignments.male[groupId];
                delete appData.housingAssignments.female[groupId];
                delete appData.smallGroupAssignments[groupId];

                appData.youthGroups.splice(editingGroupIndex, 1);
                cancelEdit();
                updateAllDisplays();
                autoSave();

                // Log activity
                logActivity('delete', 'youth-group', groupId, `Deleted youth group: ${groupParish} (ID: ${groupId})`);
            }
        }

        function cancelEdit() {
            editingGroupIndex = -1;
            clearYouthGroupForm();
            hideEditButtons();
        }

        function getYouthGroupFormData() {
            return {
                id: document.getElementById('group-id').value.trim(),
                parish: document.getElementById('parish-name').value.trim(),
                leader: document.getElementById('group-leader').value.trim(),
                seminarianSgl: document.getElementById('seminarian-sgl').value.trim(),
                religious: document.getElementById('religious').value.trim(),
                phone: document.getElementById('phone-number').value.trim(),
                maleTeens: parseInt(document.getElementById('male-teens').value) || 0,
                femaleTeens: parseInt(document.getElementById('female-teens').value) || 0,
                maleChaperones: parseInt(document.getElementById('male-chaperones').value) || 0,
                femaleChaperones: parseInt(document.getElementById('female-chaperones').value) || 0,
                stayingOffCampus: document.getElementById('staying-off-campus').checked,
                specialAccommodations: document.getElementById('special-accommodations').value.trim()
            };
        }

        function validateYouthGroupData(data) {
            if (!data.id || !data.parish) {
                alert('Please fill in Group ID and Parish Name (required fields)');
                return false;
            }
            
            const existingIndex = appData.youthGroups.findIndex(g => g.id === data.id);
            if (existingIndex !== -1 && existingIndex !== editingGroupIndex) {
                alert('A group with this ID already exists');
                return false;
            }
            
            return true;
        }

        function populateYouthGroupForm(group) {
            document.getElementById('group-id').value = group.id;
            document.getElementById('parish-name').value = group.parish;
            document.getElementById('group-leader').value = group.leader;
            document.getElementById('seminarian-sgl').value = group.seminarianSgl || '';
            document.getElementById('religious').value = group.religious || '';
            document.getElementById('phone-number').value = group.phone;
            document.getElementById('male-teens').value = group.maleTeens;
            document.getElementById('female-teens').value = group.femaleTeens;
            document.getElementById('male-chaperones').value = group.maleChaperones;
            document.getElementById('female-chaperones').value = group.femaleChaperones;
            document.getElementById('staying-off-campus').checked = group.stayingOffCampus || false;
            document.getElementById('special-accommodations').value = group.specialAccommodations;
        }

        function clearYouthGroupForm() {
            document.getElementById('group-id').value = '';
            document.getElementById('parish-name').value = '';
            document.getElementById('group-leader').value = '';
            document.getElementById('seminarian-sgl').value = '';
            document.getElementById('phone-number').value = '';
            document.getElementById('male-teens').value = '0';
            document.getElementById('female-teens').value = '0';
            document.getElementById('male-chaperones').value = '0';
            document.getElementById('female-chaperones').value = '0';
            document.getElementById('staying-off-campus').checked = false;
            document.getElementById('special-accommodations').value = '';
        }

        function showEditButtons() {
            document.getElementById('update-group-btn').style.display = 'inline-block';
            document.getElementById('delete-group-btn').style.display = 'inline-block';
            document.getElementById('cancel-edit-btn').style.display = 'inline-block';
        }

        function hideEditButtons() {
            document.getElementById('update-group-btn').style.display = 'none';
            document.getElementById('delete-group-btn').style.display = 'none';
            document.getElementById('cancel-edit-btn').style.display = 'none';
        }

        function updateAssignmentIds(oldId, newId) {
            if (appData.housingAssignments.male[oldId]) {
                appData.housingAssignments.male[newId] = appData.housingAssignments.male[oldId];
                delete appData.housingAssignments.male[oldId];
            }
            if (appData.housingAssignments.female[oldId]) {
                appData.housingAssignments.female[newId] = appData.housingAssignments.female[oldId];
                delete appData.housingAssignments.female[oldId];
            }
            if (appData.smallGroupAssignments[oldId]) {
                appData.smallGroupAssignments[newId] = appData.smallGroupAssignments[oldId];
                delete appData.smallGroupAssignments[oldId];
            }
        }

        // ===== UNIFIED ROOM MANAGEMENT =====
        let editingRoomIndex = -1;

        function handleRoomTypeChange() {
            const roomType = document.querySelector('input[name="room-type"]:checked')?.value;

            const genderField = document.getElementById('gender-field-container');
            const accessibilityField = document.getElementById('accessibility-field-container');
            const featuresField = document.getElementById('features-field-container');
            const genderSelect = document.getElementById('gender-designation');

            if (roomType === 'housing') {
                // Show housing-specific fields
                genderField.style.display = 'block';
                accessibilityField.style.display = 'block';
                featuresField.style.display = 'none';

                // Reset gender to exclude "mixed" option
                genderSelect.innerHTML = `
                    <option value="">Select Gender</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                `;
            } else if (roomType === 'smallGroup') {
                // Show small group-specific fields
                genderField.style.display = 'none';
                accessibilityField.style.display = 'none';
                featuresField.style.display = 'block';

                // Set gender to mixed automatically for small groups
                genderSelect.value = 'mixed';
            } else {
                // Hide all conditional fields
                genderField.style.display = 'none';
                accessibilityField.style.display = 'none';
                featuresField.style.display = 'none';
            }
        }

        function addRoom() {
            const roomData = getRoomFormData();
            if (!validateRoomData(roomData)) return;

            appData.rooms.push(roomData);
            clearRoomForm();
            updateRoomFilteredViews();
            updateAllDisplays();
            autoSave();
        }

        function updateRoom() {
            if (editingRoomIndex < 0) return;

            const oldRoom = appData.rooms[editingRoomIndex];
            const newRoomData = getRoomFormData();

            if (!validateRoomData(newRoomData)) return;

            // Check if room type is changing
            if (oldRoom.type !== newRoomData.type) {
                const roomKey = `${oldRoom.building}-${oldRoom.roomId}`;
                const affectedGroups = getRoomAssignedGroups(roomKey, oldRoom.type);

                if (affectedGroups.length > 0) {
                    const groupList = affectedGroups.map(g => `Group ${g.id}: ${g.name}`).join('\n');
                    const confirmMsg = `‚ö†Ô∏è WARNING: Changing room type will remove all current assignments!\n\nThis room is currently assigned to:\n${groupList}\n\nDo you want to continue?`;

                    if (!confirm(confirmMsg)) {
                        return;
                    }

                    // Remove assignments based on old type
                    if (oldRoom.type === 'housing') {
                        removeRoomFromHousingAssignments(roomKey);
                    } else if (oldRoom.type === 'smallGroup') {
                        removeRoomFromSmallGroupAssignments(roomKey);
                    }
                }
            }

            appData.rooms[editingRoomIndex] = newRoomData;
            cancelRoomEdit();
            updateRoomFilteredViews();
            updateAllDisplays();
            autoSave();
        }

        function editRoom(index) {
            const room = appData.rooms[index];
            populateRoomForm(room);
            editingRoomIndex = index;
            showRoomEditButtons();
        }

        function deleteRoom() {
            if (editingRoomIndex < 0) return;

            const room = appData.rooms[editingRoomIndex];
            const roomKey = `${room.building}-${room.roomId}`;
            const affectedGroups = getRoomAssignedGroups(roomKey, room.type);

            let confirmMsg = `Are you sure you want to delete this room?`;

            if (affectedGroups.length > 0) {
                const groupList = affectedGroups.map(g => `Group ${g.id}: ${g.name}`).join('\n');
                confirmMsg = `‚ö†Ô∏è WARNING: This room is currently assigned to groups!\n\nAssigned groups:\n${groupList}\n\nDeleting this room will remove all these assignments. Continue?`;
            }

            if (confirm(confirmMsg)) {
                // Remove all assignments
                if (room.type === 'housing') {
                    removeRoomFromHousingAssignments(roomKey);
                } else if (room.type === 'smallGroup') {
                    removeRoomFromSmallGroupAssignments(roomKey);
                }

                appData.rooms.splice(editingRoomIndex, 1);
                cancelRoomEdit();
                updateRoomFilteredViews();
                updateAllDisplays();
                autoSave();
            }
        }

        function cancelRoomEdit() {
            editingRoomIndex = -1;
            clearRoomForm();
            hideRoomEditButtons();
        }

        function getRoomFormData() {
            const roomType = document.querySelector('input[name="room-type"]:checked')?.value;

            const baseData = {
                building: document.getElementById('building-name').value.trim(),
                roomId: document.getElementById('room-id').value.trim(),
                capacity: parseInt(document.getElementById('room-capacity').value) || 0,
                type: roomType
            };

            if (roomType === 'housing') {
                return {
                    ...baseData,
                    gender: document.getElementById('gender-designation').value,
                    accessibility: document.getElementById('accessibility-features').value.trim()
                };
            } else if (roomType === 'smallGroup') {
                return {
                    ...baseData,
                    gender: 'mixed',
                    features: document.getElementById('room-features').value.trim()
                };
            }

            return baseData;
        }

        function validateRoomData(data) {
            if (!data.type) {
                alert('Please select a room type (Housing or Small Group)');
                return false;
            }

            if (!data.building || !data.roomId || data.capacity < 1) {
                alert('Please fill in all required fields');
                return false;
            }

            if (data.type === 'housing' && !data.gender) {
                alert('Please select a gender designation for housing rooms');
                return false;
            }

            const roomKey = `${data.building}-${data.roomId}`;
            const existingIndex = appData.rooms.findIndex(r => `${r.building}-${r.roomId}` === roomKey);
            if (existingIndex !== -1 && existingIndex !== editingRoomIndex) {
                alert('A room with this building and room ID already exists');
                return false;
            }

            return true;
        }

        function populateRoomForm(room) {
            document.getElementById('building-name').value = room.building;
            document.getElementById('room-id').value = room.roomId;
            document.getElementById('room-capacity').value = room.capacity;

            // Set room type
            if (room.type === 'housing') {
                document.getElementById('room-type-housing').checked = true;
            } else if (room.type === 'smallGroup') {
                document.getElementById('room-type-smallgroup').checked = true;
            }

            handleRoomTypeChange();

            // Populate type-specific fields
            if (room.type === 'housing') {
                document.getElementById('gender-designation').value = room.gender;
                document.getElementById('accessibility-features').value = room.accessibility || '';
            } else if (room.type === 'smallGroup') {
                document.getElementById('room-features').value = room.features || '';
            }
        }

        function clearRoomForm() {
            document.getElementById('building-name').value = '';
            document.getElementById('room-id').value = '';
            document.getElementById('room-capacity').value = '';
            document.getElementById('gender-designation').value = '';
            document.getElementById('accessibility-features').value = '';
            document.getElementById('room-features').value = '';

            // Uncheck room type radios
            document.querySelectorAll('input[name="room-type"]').forEach(radio => radio.checked = false);

            // Hide all conditional fields
            document.getElementById('gender-field-container').style.display = 'none';
            document.getElementById('accessibility-field-container').style.display = 'none';
            document.getElementById('features-field-container').style.display = 'none';
        }

        function showRoomEditButtons() {
            document.getElementById('add-room-btn').style.display = 'none';
            document.getElementById('update-room-btn').style.display = 'inline-block';
            document.getElementById('delete-room-btn').style.display = 'inline-block';
            document.getElementById('cancel-room-edit-btn').style.display = 'inline-block';
        }

        function hideRoomEditButtons() {
            document.getElementById('add-room-btn').style.display = 'inline-block';
            document.getElementById('update-room-btn').style.display = 'none';
            document.getElementById('delete-room-btn').style.display = 'none';
            document.getElementById('cancel-room-edit-btn').style.display = 'none';
        }

        function getRoomAssignedGroups(roomKey, roomType) {
            const groups = [];

            if (roomType === 'housing') {
                // Check male assignments
                Object.entries(appData.housingAssignments.male || {}).forEach(([groupId, rooms]) => {
                    if (rooms.includes(roomKey)) {
                        const group = appData.youthGroups.find(g => g.id === groupId);
                        if (group) {
                            groups.push({ id: groupId, name: `${group.parish} (Male)` });
                        }
                    }
                });

                // Check female assignments
                Object.entries(appData.housingAssignments.female || {}).forEach(([groupId, rooms]) => {
                    if (rooms.includes(roomKey)) {
                        const group = appData.youthGroups.find(g => g.id === groupId);
                        if (group) {
                            groups.push({ id: groupId, name: `${group.parish} (Female)` });
                        }
                    }
                });
            } else if (roomType === 'smallGroup') {
                Object.entries(appData.smallGroupAssignments || {}).forEach(([groupId, rooms]) => {
                    if (rooms.includes(roomKey)) {
                        const group = appData.youthGroups.find(g => g.id === groupId);
                        if (group) {
                            groups.push({ id: groupId, name: group.parish });
                        }
                    }
                });
            }

            return groups;
        }

        function displayRoomsTable() {
            const tbody = document.getElementById('rooms-table');
            if (!tbody) return;

            if (!appData.rooms || appData.rooms.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px; color: #666;">No rooms available. Add a room using the form above.</td></tr>';
                return;
            }

            const sortedRooms = getSortedRooms();

            tbody.innerHTML = sortedRooms.map((room, sortedIndex) => {
                const originalIndex = appData.rooms.indexOf(room);
                const roomKey = `${room.building}-${room.roomId}`;
                const occupiedCount = room.type === 'housing' ?
                    getHousingRoomOccupancy(roomKey) :
                    getSmallGroupRoomOccupancy(roomKey);
                const availableSpace = room.capacity - occupiedCount;

                const availableClass =
                    availableSpace < 0 ? 'negative' :
                    availableSpace === 0 ? 'zero' : 'positive';

                const typeLabel = room.type === 'housing' ? 'üè† Housing' : 'üë• Small Group';
                const genderLabel =
                    room.gender === 'male' ? 'Male ‚ôÇ' :
                    room.gender === 'female' ? 'Female ‚ôÄ' :
                    'Mixed/Co-ed';

                const notes = room.type === 'housing' ?
                    (room.accessibility || '-') :
                    (room.features || '-');

                const assignedGroupsDisplay = room.type === 'housing' ?
                    getHousingRoomAssignedGroupsDisplay(roomKey) :
                    getSmallGroupRoomAssignedGroupsDisplay(roomKey);

                return `
                    <tr>
                        <td>${typeLabel}</td>
                        <td>${room.building}</td>
                        <td>${room.roomId}</td>
                        <td>${genderLabel}</td>
                        <td>${room.capacity}</td>
                        <td>${occupiedCount}</td>
                        <td class="${availableClass}">${availableSpace}</td>
                        <td>${notes}</td>
                        <td>${assignedGroupsDisplay}</td>
                        <td><button class="btn btn-primary" onclick="editRoom(${originalIndex})">Edit</button></td>
                    </tr>
                `;
            }).join('');
        }

        function getSortedRooms() {
            let sorted = [...appData.rooms];
            const sortField = document.getElementById('rooms-sort')?.value || 'type';
            const isAscending = document.getElementById('rooms-sort-order')?.textContent === 'A‚ÜíZ';

            sorted.sort((a, b) => {
                let aVal, bVal;

                switch (sortField) {
                    case 'type':
                        aVal = a.type;
                        bVal = b.type;
                        break;
                    case 'building':
                        aVal = a.building;
                        bVal = b.building;
                        break;
                    case 'roomId':
                        aVal = a.roomId;
                        bVal = b.roomId;
                        break;
                    case 'gender':
                        aVal = a.gender;
                        bVal = b.gender;
                        break;
                    case 'capacity':
                        aVal = a.capacity;
                        bVal = b.capacity;
                        break;
                    case 'occupied':
                        const aKey = `${a.building}-${a.roomId}`;
                        const bKey = `${b.building}-${b.roomId}`;
                        aVal = a.type === 'housing' ? getHousingRoomOccupancy(aKey) : getSmallGroupRoomOccupancy(aKey);
                        bVal = b.type === 'housing' ? getHousingRoomOccupancy(bKey) : getSmallGroupRoomOccupancy(bKey);
                        break;
                    case 'available':
                        const aKey2 = `${a.building}-${a.roomId}`;
                        const bKey2 = `${b.building}-${b.roomId}`;
                        const aOcc = a.type === 'housing' ? getHousingRoomOccupancy(aKey2) : getSmallGroupRoomOccupancy(aKey2);
                        const bOcc = b.type === 'housing' ? getHousingRoomOccupancy(bKey2) : getSmallGroupRoomOccupancy(bKey2);
                        aVal = a.capacity - aOcc;
                        bVal = b.capacity - bOcc;
                        break;
                    default:
                        return 0;
                }

                if (typeof aVal === 'string') {
                    return isAscending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                } else {
                    return isAscending ? aVal - bVal : bVal - aVal;
                }
            });

            return sorted;
        }

        function filterRoomsTable() {
            const filterValue = document.getElementById('rooms-filter')?.value.toLowerCase() || '';

            const rows = document.querySelectorAll('#rooms-table tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filterValue) ? '' : 'none';
            });
        }

        function sortRoomsTable() {
            displayRoomsTable();
        }

        function toggleRoomsSortOrder() {
            const btn = document.getElementById('rooms-sort-order');
            btn.textContent = btn.textContent === 'A‚ÜíZ' ? 'Z‚ÜíA' : 'A‚ÜíZ';
            displayRoomsTable();
        }

        // ===== HOUSING ROOM MANAGEMENT (Legacy - for backward compatibility) =====
        function addHousingRoom() {
            const roomData = getHousingRoomFormData();
            if (!validateHousingRoomData(roomData)) return;

            appData.housingRooms.push(roomData);
            clearHousingRoomForm();
            updateAllDisplays();
            autoSave();
        }

        function updateHousingRoom() {
            if (editingHousingRoomIndex < 0) return;
            
            const roomData = getHousingRoomFormData();
            if (!validateHousingRoomData(roomData)) return;

            appData.housingRooms[editingHousingRoomIndex] = roomData;
            cancelRoomEdit();
            updateAllDisplays();
            autoSave();
        }

        function editHousingRoom(index) {
            const room = appData.housingRooms[index];
            populateHousingRoomForm(room);
            editingHousingRoomIndex = index;
            showRoomEditButtons();
        }

        function deleteHousingRoom() {
            if (editingHousingRoomIndex < 0) return;
            
            if (confirm('Are you sure you want to delete this housing room and all its assignments?')) {
                const room = appData.housingRooms[editingHousingRoomIndex];
                const roomKey = `${room.building}-${room.roomId}`;
                
                removeRoomFromHousingAssignments(roomKey);
                
                appData.housingRooms.splice(editingHousingRoomIndex, 1);
                cancelRoomEdit();
                updateAllDisplays();
                autoSave();
            }
        }

        function cancelRoomEdit() {
            editingHousingRoomIndex = -1;
            clearHousingRoomForm();
            hideRoomEditButtons();
        }

        function getHousingRoomFormData() {
            return {
                building: document.getElementById('building-name').value.trim(),
                roomId: document.getElementById('room-id').value.trim(),
                gender: document.getElementById('gender-designation').value,
                capacity: parseInt(document.getElementById('room-capacity').value) || 0,
                accessibility: document.getElementById('accessibility-features').value.trim()
            };
        }

        function validateHousingRoomData(data) {
            if (!data.building || !data.roomId || !data.gender || data.capacity < 1) {
                alert('Please fill in all required housing room fields');
                return false;
            }
            
            const roomKey = `${data.building}-${data.roomId}`;
            const existingIndex = appData.housingRooms.findIndex(r => `${r.building}-${r.roomId}` === roomKey);
            if (existingIndex !== -1 && existingIndex !== editingHousingRoomIndex) {
                alert('A housing room with this building and room ID already exists');
                return false;
            }
            
            return true;
        }

        function populateHousingRoomForm(room) {
            document.getElementById('building-name').value = room.building;
            document.getElementById('room-id').value = room.roomId;
            document.getElementById('gender-designation').value = room.gender;
            document.getElementById('room-capacity').value = room.capacity;
            document.getElementById('accessibility-features').value = room.accessibility;
        }

        function clearHousingRoomForm() {
            document.getElementById('building-name').value = '';
            document.getElementById('room-id').value = '';
            document.getElementById('gender-designation').value = '';
            document.getElementById('room-capacity').value = '';
            document.getElementById('accessibility-features').value = '';
        }

        function showRoomEditButtons() {
            document.getElementById('update-room-btn').style.display = 'inline-block';
            document.getElementById('delete-room-btn').style.display = 'inline-block';
            document.getElementById('cancel-room-edit-btn').style.display = 'inline-block';
        }

        function hideRoomEditButtons() {
            document.getElementById('update-room-btn').style.display = 'none';
            document.getElementById('delete-room-btn').style.display = 'none';
            document.getElementById('cancel-room-edit-btn').style.display = 'none';
        }

        function removeRoomFromHousingAssignments(roomKey) {
            Object.keys(appData.housingAssignments.male).forEach(groupId => {
                if (Array.isArray(appData.housingAssignments.male[groupId])) {
                    appData.housingAssignments.male[groupId] = appData.housingAssignments.male[groupId].filter(key => key !== roomKey);
                    if (appData.housingAssignments.male[groupId].length === 0) {
                        delete appData.housingAssignments.male[groupId];
                    }
                }
            });
            Object.keys(appData.housingAssignments.female).forEach(groupId => {
                if (Array.isArray(appData.housingAssignments.female[groupId])) {
                    appData.housingAssignments.female[groupId] = appData.housingAssignments.female[groupId].filter(key => key !== roomKey);
                    if (appData.housingAssignments.female[groupId].length === 0) {
                        delete appData.housingAssignments.female[groupId];
                    }
                }
            });
        }

        // ===== SMALL GROUP ROOM MANAGEMENT =====
        function addSmallGroupRoom() {
            const roomData = getSmallGroupRoomFormData();
            if (!validateSmallGroupRoomData(roomData)) return;

            appData.smallGroupRooms.push(roomData);
            clearSmallGroupRoomForm();
            updateAllDisplays();
            autoSave();
        }

        function updateSmallGroupRoom() {
            if (editingSmallGroupRoomIndex < 0) return;
            
            const roomData = getSmallGroupRoomFormData();
            if (!validateSmallGroupRoomData(roomData)) return;

            appData.smallGroupRooms[editingSmallGroupRoomIndex] = roomData;
            cancelSmallGroupRoomEdit();
            updateAllDisplays();
            autoSave();
        }

        function editSmallGroupRoom(index) {
            const room = appData.smallGroupRooms[index];
            populateSmallGroupRoomForm(room);
            editingSmallGroupRoomIndex = index;
            showSmallGroupRoomEditButtons();
        }

        function deleteSmallGroupRoom() {
            if (editingSmallGroupRoomIndex < 0) return;
            
            if (confirm('Are you sure you want to delete this small group room and all its assignments?')) {
                const room = appData.smallGroupRooms[editingSmallGroupRoomIndex];
                const roomKey = `${room.building}-${room.roomId}`;
                
                removeRoomFromSmallGroupAssignments(roomKey);
                
                appData.smallGroupRooms.splice(editingSmallGroupRoomIndex, 1);
                cancelSmallGroupRoomEdit();
                updateAllDisplays();
                autoSave();
            }
        }

        function cancelSmallGroupRoomEdit() {
            editingSmallGroupRoomIndex = -1;
            clearSmallGroupRoomForm();
            hideSmallGroupRoomEditButtons();
        }

        function getSmallGroupRoomFormData() {
            return {
                building: document.getElementById('sg-building-name').value.trim(),
                roomId: document.getElementById('sg-room-id').value.trim(),
                gender: document.getElementById('sg-gender-designation').value,
                capacity: parseInt(document.getElementById('sg-room-capacity').value) || 0,
                features: document.getElementById('sg-room-features').value.trim()
            };
        }

        function validateSmallGroupRoomData(data) {
            if (!data.building || !data.roomId || !data.gender || data.capacity < 1) {
                alert('Please fill in all required small group room fields');
                return false;
            }
            
            const roomKey = `${data.building}-${data.roomId}`;
            const existingIndex = appData.smallGroupRooms.findIndex(r => `${r.building}-${r.roomId}` === roomKey);
            if (existingIndex !== -1 && existingIndex !== editingSmallGroupRoomIndex) {
                alert('A small group room with this building and room ID already exists');
                return false;
            }
            
            return true;
        }

        function populateSmallGroupRoomForm(room) {
            document.getElementById('sg-building-name').value = room.building;
            document.getElementById('sg-room-id').value = room.roomId;
            document.getElementById('sg-gender-designation').value = room.gender;
            document.getElementById('sg-room-capacity').value = room.capacity;
            document.getElementById('sg-room-features').value = room.features;
        }

        function clearSmallGroupRoomForm() {
            document.getElementById('sg-building-name').value = '';
            document.getElementById('sg-room-id').value = '';
            document.getElementById('sg-gender-designation').value = '';
            document.getElementById('sg-room-capacity').value = '';
            document.getElementById('sg-room-features').value = '';
        }

        function showSmallGroupRoomEditButtons() {
            document.getElementById('update-sg-room-btn').style.display = 'inline-block';
            document.getElementById('delete-sg-room-btn').style.display = 'inline-block';
            document.getElementById('cancel-sg-room-edit-btn').style.display = 'inline-block';
        }

        function hideSmallGroupRoomEditButtons() {
            document.getElementById('update-sg-room-btn').style.display = 'none';
            document.getElementById('delete-sg-room-btn').style.display = 'none';
            document.getElementById('cancel-sg-room-edit-btn').style.display = 'none';
        }

        function removeRoomFromSmallGroupAssignments(roomKey) {
            Object.keys(appData.smallGroupAssignments).forEach(groupId => {
                if (Array.isArray(appData.smallGroupAssignments[groupId])) {
                    appData.smallGroupAssignments[groupId] = appData.smallGroupAssignments[groupId].filter(key => key !== roomKey);
                    if (appData.smallGroupAssignments[groupId].length === 0) {
                        delete appData.smallGroupAssignments[groupId];
                    }
                }
            });
        }

        // ===== HOUSING ASSIGNMENT MANAGEMENT =====
        function updateHousingAssignmentDropdown() {
            document.getElementById('housing-assignment-search').value = '';
            const select = document.getElementById('housing-assignment-group-select');
            select.innerHTML = '<option value="">Select a Group-Gender Assignment</option>';
            
            appData.youthGroups.forEach(group => {
                const maleTotal = group.maleTeens + group.maleChaperones;
                const femaleTotal = group.femaleTeens + group.femaleChaperones;
                const isOffCampus = group.stayingOffCampus || false;
                
                if (maleTotal > 0) {
                    const option = document.createElement('option');
                    option.value = `${group.id}-male`;
                    option.textContent = `${group.id} - ${group.parish} - Males (${maleTotal} people)${isOffCampus ? ' üèïÔ∏è OFF-CAMPUS' : ''}`;
                    select.appendChild(option);
                }
                
                if (femaleTotal > 0) {
                    const option = document.createElement('option');
                    option.value = `${group.id}-female`;
                    option.textContent = `${group.id} - ${group.parish} - Females (${femaleTotal} people)${isOffCampus ? ' üèïÔ∏è OFF-CAMPUS' : ''}`;
                    select.appendChild(option);
                }
            });
        }

        function selectGroupForHousingAssignment() {
            const select = document.getElementById('housing-assignment-group-select');
            const value = select.value;
            
            if (!value) {
                selectedHousingAssignment = null;
                updateHousingAssignmentDisplay();
                return;
            }
            
            const [groupId, gender] = value.split('-');
            const group = appData.youthGroups.find(g => g.id === groupId);
            
            selectedHousingAssignment = {
                groupId: groupId,
                gender: gender,
                groupData: group
            };
            
            updateHousingAssignmentDisplay();
        }

        function updateHousingAssignmentDisplay() {
            updateSelectedHousingGroupInfo();
            updateAvailableHousingRoomsList();
            updateHousingAssignmentActions();
        }

        function updateSelectedHousingGroupInfo() {
            const infoDiv = document.getElementById('housing-selected-group-info');
            
            if (!selectedHousingAssignment) {
                infoDiv.innerHTML = '<p>Please select a group-gender assignment above to see room options.</p>';
                return;
            }
            
            const { groupId, gender, groupData } = selectedHousingAssignment;
            const peopleCount = gender === 'male' ? 
                (groupData.maleTeens + groupData.maleChaperones) : 
                (groupData.femaleTeens + groupData.femaleChaperones);
                
            const assignedRooms = appData.housingAssignments[gender][groupId] || [];
            const roomNames = assignedRooms.map(roomKey => {
                const room = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                return room ? `${room.building} - ${room.roomId}` : roomKey;
            });
            
            const isOffCampus = groupData.stayingOffCampus || false;
            
            infoDiv.innerHTML = `
                <h4>${groupData.parish} (${groupId})</h4>
                <p><strong>Leader:</strong> ${groupData.leader}</p>
                <p><strong>Phone:</strong> ${groupData.phone}</p>
                <p><strong>${gender.charAt(0).toUpperCase() + gender.slice(1)} Total:</strong> ${peopleCount} people</p>
                ${gender === 'male' ? 
                    `<p>(${groupData.maleTeens} teens + ${groupData.maleChaperones} chaperones)</p>` :
                    `<p>(${groupData.femaleTeens} teens + ${groupData.femaleChaperones} chaperones)</p>`
                }
                ${groupData.specialAccommodations ? `<p><strong>Special Accommodations:</strong> ${groupData.specialAccommodations}</p>` : ''}
                
                ${isOffCampus ? `
                    <div class="notification" style="background: #fff3cd; border-left: 4px solid #e67e22; padding: 12px; margin: 10px 0; border-radius: 6px;">
                        <strong style="color: #856404;">üèïÔ∏è OFF-CAMPUS GROUP</strong>
                        <p style="margin: 5px 0 0 0; font-size: 13px; color: #856404;">This group is staying off-campus and has been automatically assigned to off-campus housing.</p>
                    </div>
                ` : ''}
                
                ${assignedRooms.length > 0 ? `
                    <div class="${gender}-section">
                        <strong>Current Housing Assignments:</strong>
                        <p>${roomNames.join(', ')}</p>
                    </div>
                ` : `<p style="color: #e67e22;"><strong>‚ö†Ô∏è No ${gender} housing assignments yet.</strong></p>`}
            `;
        }

        function updateAvailableHousingRoomsList() {
            const roomsDiv = document.getElementById('housing-available-rooms-list');
            const searchBar = document.getElementById('housing-rooms-search');

            if (!selectedHousingAssignment) {
                roomsDiv.innerHTML = '<p>Select a group-gender assignment to see matching rooms.</p>';
                if (searchBar) searchBar.style.display = 'none';
                return;
            }

            // Show search bar
            if (searchBar) searchBar.style.display = 'block';

            const { gender, groupId } = selectedHousingAssignment;
            const group = appData.youthGroups.find(g => g.id === groupId);
            const groupSize = gender === 'male' ? (group.maleTeens + group.maleChaperones) : (group.femaleTeens + group.femaleChaperones);

            const matchingRooms = appData.housingRooms.filter(room => room.gender === gender);
            const assignedRooms = appData.housingAssignments[gender][groupId] || [];

            if (matchingRooms.length === 0) {
                roomsDiv.innerHTML = `<div class="notification error">‚ö†Ô∏è No ${gender} housing rooms available!</div>`;
                return;
            }

            // Sort rooms by recommendation (closest fit first)
            const roomsWithFit = matchingRooms.map(room => {
                const roomKey = `${room.building}-${room.roomId}`;
                const occupiedCount = getHousingRoomOccupancy(roomKey);
                const availableSpace = room.capacity - occupiedCount;
                const wastedSpace = availableSpace - groupSize;
                return { room, roomKey, occupiedCount, availableSpace, wastedSpace };
            });

            roomsWithFit.sort((a, b) => {
                // First, put assigned rooms at the top
                const aAssigned = assignedRooms.includes(a.roomKey);
                const bAssigned = assignedRooms.includes(b.roomKey);
                if (aAssigned && !bAssigned) return -1;
                if (!aAssigned && bAssigned) return 1;

                // Then sort by whether it fits (positive available space after assignment)
                const aFits = a.availableSpace >= groupSize;
                const bFits = b.availableSpace >= groupSize;
                if (aFits && !bFits) return -1;
                if (!aFits && bFits) return 1;

                // Then sort by least wasted space (but only for rooms that fit)
                if (aFits && bFits) {
                    return Math.abs(a.wastedSpace) - Math.abs(b.wastedSpace);
                }

                // For rooms that don't fit, sort by most available space
                return b.availableSpace - a.availableSpace;
            });

            let roomsHTML = '';
            roomsWithFit.forEach(({ room, roomKey, occupiedCount, availableSpace, wastedSpace }, index) => {
                const isAssigned = assignedRooms.includes(roomKey);

                // Determine color coding
                let backgroundColor = 'white';
                let borderColor = '#061d28';
                if (occupiedCount > 0) {
                    if (availableSpace === 0) {
                        backgroundColor = '#ffe5cc'; // Orange - completely full
                        borderColor = '#e67e22';
                    } else {
                        backgroundColor = '#fff9e6'; // Yellow - has people but still has space
                        borderColor = '#f39c12';
                    }
                }

                // Determine recommendation
                let recommendation = '';
                if (availableSpace >= groupSize) {
                    if (wastedSpace >= 0 && wastedSpace <= 5) {
                        recommendation = '<span style="background: #27ae60; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-left: 8px;">‚ú® Perfect fit!</span>';
                    } else if (wastedSpace > 5 && wastedSpace <= 10) {
                        recommendation = '<span style="background: #3498db; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-left: 8px;">üëç Good match</span>';
                    } else if (index === 0) {
                        recommendation = '<span style="background: #9b59b6; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-left: 8px;">‚≠ê Best available</span>';
                    }
                }

                roomsHTML += `
                    <div class="room-card ${isAssigned ? 'selected' : ''}"
                         data-room-search="${room.building.toLowerCase()} ${room.roomId.toLowerCase()} ${room.accessibility ? room.accessibility.toLowerCase() : ''}"
                         data-room-key="${roomKey.replace(/"/g, '&quot;')}"
                         onclick="toggleHousingRoomSelection(this.getAttribute('data-room-key'))"
                         style="cursor: pointer; background: ${backgroundColor}; border-left-color: ${borderColor};">
                        <strong>${room.building} - ${room.roomId}</strong> ${recommendation}
                        <p><strong>Capacity:</strong> ${room.capacity} | <strong>Available:</strong> ${availableSpace} | <strong>Currently Occupied:</strong> ${occupiedCount}</p>
                        ${room.accessibility ? `<p>‚ôø ${room.accessibility}</p>` : ''}
                        ${getHousingRoomAssignedGroupsDisplay(roomKey)}
                    </div>
                `;
            });
            
            roomsDiv.innerHTML = roomsHTML;
        }

        function toggleHousingRoomSelection(roomKey) {
            if (!selectedHousingAssignment) return;
            
            const { groupId, gender } = selectedHousingAssignment;
            
            if (!appData.housingAssignments[gender][groupId]) {
                appData.housingAssignments[gender][groupId] = [];
            }
            
            const assignedRooms = appData.housingAssignments[gender][groupId];
            const index = assignedRooms.indexOf(roomKey);
            
            if (index > -1) {
                assignedRooms.splice(index, 1);
                if (assignedRooms.length === 0) {
                    delete appData.housingAssignments[gender][groupId];
                }
            } else {
                assignedRooms.push(roomKey);
            }
            
            updateHousingAssignmentDisplay();
        }

        function updateHousingAssignmentActions() {
            const actionsDiv = document.getElementById('housing-assignment-actions');
            if (selectedHousingAssignment) {
                actionsDiv.style.display = 'block';
            } else {
                actionsDiv.style.display = 'none';
            }
        }

        function confirmHousingAssignment() {
            if (!selectedHousingAssignment) return;

            const { groupId, gender, groupData } = selectedHousingAssignment;
            const rooms = appData.housingAssignments[gender][groupId] || [];

            alert(`Housing assignment updated for ${groupData.parish} (${gender})`);

            // Log activity
            logActivity('update', 'housing-assignment', groupId,
                `Assigned ${gender} housing for ${groupData.parish}: ${rooms.length} room(s)`);

            updateAllDisplays();
            autoSave();
        }

        function clearHousingAssignment() {
            if (!selectedHousingAssignment) return;

            const { groupId, gender, groupData } = selectedHousingAssignment;

            if (confirm(`Clear all ${gender} housing assignments for ${groupData.parish}?`)) {
                delete appData.housingAssignments[gender][groupId];

                // Log activity
                logActivity('delete', 'housing-assignment', groupId,
                    `Cleared ${gender} housing for ${groupData.parish}`);

                updateHousingAssignmentDisplay();
                updateAllDisplays();
                autoSave();
            }
        }

        function cancelHousingSelection() {
            selectedHousingAssignment = null;
            document.getElementById('housing-assignment-group-select').value = '';
            updateHousingAssignmentDisplay();
        }

        function filterHousingAssignmentDropdown() {
            const searchTerm = document.getElementById('housing-assignment-search').value.toLowerCase();
            const hideAssigned = document.getElementById('housing-hide-assigned')?.checked || false;
            const hideOffCampus = document.getElementById('housing-hide-offcampus')?.checked || false;
            const showMaleOnly = document.getElementById('housing-show-male-only')?.checked || false;
            const showFemaleOnly = document.getElementById('housing-show-female-only')?.checked || false;
            const select = document.getElementById('housing-assignment-group-select');

            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }

            appData.youthGroups.forEach(group => {
                const matchesSearch = !searchTerm ||
                    group.parish.toLowerCase().includes(searchTerm) ||
                    group.id.toLowerCase().includes(searchTerm) ||
                    group.leader.toLowerCase().includes(searchTerm);

                if (matchesSearch) {
                    const maleTotal = group.maleTeens + group.maleChaperones;
                    const femaleTotal = group.femaleTeens + group.femaleChaperones;
                    const isOffCampus = group.stayingOffCampus || false;

                    // Check if group is assigned
                    const maleAssigned = appData.housingAssignments.male[group.id] && appData.housingAssignments.male[group.id].length > 0;
                    const femaleAssigned = appData.housingAssignments.female[group.id] && appData.housingAssignments.female[group.id].length > 0;

                    // Apply filters for males
                    if (maleTotal > 0 && !showFemaleOnly) {
                        const shouldShow =
                            (!hideAssigned || !maleAssigned) &&
                            (!hideOffCampus || !isOffCampus);

                        if (shouldShow) {
                            const option = document.createElement('option');
                            option.value = `${group.id}-male`;
                            option.textContent = `${group.id} - ${group.parish} - Males (${maleTotal} people)${isOffCampus ? ' üèïÔ∏è OFF-CAMPUS' : ''}`;
                            select.appendChild(option);
                        }
                    }

                    // Apply filters for females
                    if (femaleTotal > 0 && !showMaleOnly) {
                        const shouldShow =
                            (!hideAssigned || !femaleAssigned) &&
                            (!hideOffCampus || !isOffCampus);

                        if (shouldShow) {
                            const option = document.createElement('option');
                            option.value = `${group.id}-female`;
                            option.textContent = `${group.id} - ${group.parish} - Females (${femaleTotal} people)${isOffCampus ? ' üèïÔ∏è OFF-CAMPUS' : ''}`;
                            select.appendChild(option);
                        }
                    }
                }
            });
        }

        // ===== SMALL GROUP ASSIGNMENT MANAGEMENT =====
        function updateSmallGroupAssignmentDropdown() {
            document.getElementById('sg-assignment-search').value = '';
            const select = document.getElementById('sg-assignment-group-select');
            select.innerHTML = '<option value="">Select a Group for Small Group Assignment</option>';
            
            appData.youthGroups.forEach(group => {
                const totalGroup = group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;
                
                if (totalGroup > 0) {
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = `${group.id} - ${group.parish} (${totalGroup} people total)`;
                    select.appendChild(option);
                }
            });
        }

        function selectGroupForSmallGroupAssignment() {
            const select = document.getElementById('sg-assignment-group-select');
            const groupId = select.value;
            
            if (!groupId) {
                selectedSmallGroupAssignment = null;
                updateSmallGroupAssignmentDisplay();
                return;
            }
            
            const group = appData.youthGroups.find(g => g.id === groupId);
            
            selectedSmallGroupAssignment = {
                groupId: groupId,
                groupData: group
            };
            
            updateSmallGroupAssignmentDisplay();
        }

        function updateSmallGroupAssignmentDisplay() {
            updateSelectedSmallGroupInfo();
            updateAvailableSmallGroupRoomsList();
            updateSmallGroupAssignmentActions();
        }

        function updateSelectedSmallGroupInfo() {
            const infoDiv = document.getElementById('sg-selected-group-info');
            
            if (!selectedSmallGroupAssignment) {
                infoDiv.innerHTML = '<p>Please select a group above to see small group location options.</p>';
                return;
            }
            
            const { groupId, groupData } = selectedSmallGroupAssignment;
            const maleTotal = groupData.maleTeens + groupData.maleChaperones;
            const femaleTotal = groupData.femaleTeens + groupData.femaleChaperones;
            const totalPeople = maleTotal + femaleTotal;
                
            const assignedRooms = appData.smallGroupAssignments[groupId] || [];
            const roomNames = assignedRooms.map(roomKey => {
                const room = appData.smallGroupRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                return room ? `${room.building} - ${room.roomId}` : roomKey;
            });
            
            infoDiv.innerHTML = `
                <h4>${groupData.parish} (${groupId})</h4>
                <p><strong>Leader:</strong> ${groupData.leader}</p>
                <p><strong>Phone:</strong> ${groupData.phone}</p>
                <p><strong>Total Group:</strong> ${totalPeople} people</p>
                <p>(${maleTotal} males + ${femaleTotal} females)</p>
                ${groupData.specialAccommodations ? `<p><strong>Special Accommodations:</strong> ${groupData.specialAccommodations}</p>` : ''}
                
                ${assignedRooms.length > 0 ? `
                    <div class="male-section">
                        <strong>Current Small Group Location:</strong>
                        <p>${roomNames.join(', ')}</p>
                    </div>
                ` : `<p style="color: #e67e22;"><strong>‚ö†Ô∏è No small group location assigned yet.</strong></p>`}
            `;
        }

        function updateAvailableSmallGroupRoomsList() {
            const roomsDiv = document.getElementById('sg-available-rooms-list');
            const searchBar = document.getElementById('sg-rooms-search');

            if (!selectedSmallGroupAssignment) {
                roomsDiv.innerHTML = '<p>Select a group to see available small group locations.</p>';
                if (searchBar) searchBar.style.display = 'none';
                return;
            }

            // Show search bar
            if (searchBar) searchBar.style.display = 'block';

            const { groupId } = selectedSmallGroupAssignment;
            const group = appData.youthGroups.find(g => g.id === groupId);
            const groupSize = group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;

            const assignedRooms = appData.smallGroupAssignments[groupId] || [];

            if (appData.smallGroupRooms.length === 0) {
                roomsDiv.innerHTML = `<div class="notification error">‚ö†Ô∏è No small group rooms available!</div>`;
                return;
            }

            // Sort rooms by recommendation (closest fit first)
            const roomsWithFit = appData.smallGroupRooms.map(room => {
                const roomKey = `${room.building}-${room.roomId}`;
                const occupiedCount = getSmallGroupRoomOccupancy(roomKey);
                const availableSpace = room.capacity - occupiedCount;
                const wastedSpace = availableSpace - groupSize;
                return { room, roomKey, occupiedCount, availableSpace, wastedSpace };
            });

            roomsWithFit.sort((a, b) => {
                // First, put assigned rooms at the top
                const aAssigned = assignedRooms.includes(a.roomKey);
                const bAssigned = assignedRooms.includes(b.roomKey);
                if (aAssigned && !bAssigned) return -1;
                if (!aAssigned && bAssigned) return 1;

                // Then sort by whether it fits
                const aFits = a.availableSpace >= groupSize;
                const bFits = b.availableSpace >= groupSize;
                if (aFits && !bFits) return -1;
                if (!aFits && bFits) return 1;

                // Then sort by least wasted space
                if (aFits && bFits) {
                    return Math.abs(a.wastedSpace) - Math.abs(b.wastedSpace);
                }

                // For rooms that don't fit, sort by most available space
                return b.availableSpace - a.availableSpace;
            });

            let roomsHTML = '';
            roomsWithFit.forEach(({ room, roomKey, occupiedCount, availableSpace, wastedSpace }, index) => {
                const isAssigned = assignedRooms.includes(roomKey);

                // Determine color coding - Light blue if has people
                let backgroundColor = 'white';
                let borderColor = '#061d28';
                if (occupiedCount > 0) {
                    backgroundColor = '#e8f4f8'; // Light blue - has people assigned
                    borderColor = '#3498db';
                }

                // Determine recommendation
                let recommendation = '';
                if (availableSpace >= groupSize) {
                    if (wastedSpace >= 0 && wastedSpace <= 5) {
                        recommendation = '<span style="background: #27ae60; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-left: 8px;">‚ú® Perfect fit!</span>';
                    } else if (wastedSpace > 5 && wastedSpace <= 10) {
                        recommendation = '<span style="background: #3498db; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-left: 8px;">üëç Good match</span>';
                    } else if (index === 0) {
                        recommendation = '<span style="background: #9b59b6; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-left: 8px;">‚≠ê Best available</span>';
                    }
                }

                roomsHTML += `
                    <div class="room-card ${isAssigned ? 'selected' : ''}"
                         data-room-search="${room.building.toLowerCase()} ${room.roomId.toLowerCase()} ${room.features ? room.features.toLowerCase() : ''} ${room.gender}"
                         data-room-key="${roomKey.replace(/"/g, '&quot;')}"
                         onclick="toggleSmallGroupRoomSelection(this.getAttribute('data-room-key'))"
                         style="cursor: pointer; background: ${backgroundColor}; border-left-color: ${borderColor};">
                        <strong>${room.building} - ${room.roomId}</strong> ${recommendation}
                        <p><strong>Type:</strong> ${room.gender === 'mixed' ? 'Co-ed/Mixed' : room.gender.charAt(0).toUpperCase() + room.gender.slice(1)} | <strong>Capacity:</strong> ${room.capacity} | <strong>Available:</strong> ${availableSpace} | <strong>Currently Occupied:</strong> ${occupiedCount}</p>
                        ${room.features ? `<p>üèóÔ∏è ${room.features}</p>` : ''}
                        ${getSmallGroupRoomAssignedGroupsDisplay(roomKey)}
                    </div>
                `;
            });

            roomsDiv.innerHTML = roomsHTML;
        }

        function toggleSmallGroupRoomSelection(roomKey) {
            if (!selectedSmallGroupAssignment) return;
            
            const { groupId } = selectedSmallGroupAssignment;
            
            if (!appData.smallGroupAssignments[groupId]) {
                appData.smallGroupAssignments[groupId] = [];
            }
            
            const assignedRooms = appData.smallGroupAssignments[groupId];
            const index = assignedRooms.indexOf(roomKey);
            
            if (index > -1) {
                assignedRooms.splice(index, 1);
                if (assignedRooms.length === 0) {
                    delete appData.smallGroupAssignments[groupId];
                }
            } else {
                assignedRooms.push(roomKey);
            }
            
            updateSmallGroupAssignmentDisplay();
        }

        function updateSmallGroupAssignmentActions() {
            const actionsDiv = document.getElementById('sg-assignment-actions');
            if (selectedSmallGroupAssignment) {
                actionsDiv.style.display = 'block';
            } else {
                actionsDiv.style.display = 'none';
            }
        }

        function confirmSmallGroupAssignment() {
            if (!selectedSmallGroupAssignment) return;

            const { groupId, groupData } = selectedSmallGroupAssignment;
            const rooms = appData.smallGroupAssignments[groupId] || [];

            alert(`Small group assignment updated for ${groupData.parish}`);

            // Log activity
            logActivity('update', 'smallgroup-assignment', groupId,
                `Assigned small group for ${groupData.parish}: ${rooms.length} room(s)`);

            updateAllDisplays();
            autoSave();
        }

        function clearSmallGroupAssignment() {
            if (!selectedSmallGroupAssignment) return;

            const { groupId, groupData } = selectedSmallGroupAssignment;

            if (confirm(`Clear all small group location assignments for ${groupData.parish}?`)) {
                delete appData.smallGroupAssignments[groupId];

                // Log activity
                logActivity('delete', 'smallgroup-assignment', groupId,
                    `Cleared small group for ${groupData.parish}`);

                updateSmallGroupAssignmentDisplay();
                updateAllDisplays();
                autoSave();
            }
        }

        function cancelSmallGroupSelection() {
            selectedSmallGroupAssignment = null;
            document.getElementById('sg-assignment-group-select').value = '';
            updateSmallGroupAssignmentDisplay();
        }

        function filterSmallGroupAssignmentDropdown() {
            const searchTerm = document.getElementById('sg-assignment-search').value.toLowerCase();
            const hideAssigned = document.getElementById('sg-hide-assigned')?.checked || false;
            const select = document.getElementById('sg-assignment-group-select');

            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }

            appData.youthGroups.forEach(group => {
                const matchesSearch = !searchTerm ||
                    group.parish.toLowerCase().includes(searchTerm) ||
                    group.id.toLowerCase().includes(searchTerm) ||
                    group.leader.toLowerCase().includes(searchTerm);

                if (matchesSearch) {
                    const totalGroup = group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;

                    // Check if group is assigned
                    const isAssigned = appData.smallGroupAssignments[group.id] && appData.smallGroupAssignments[group.id].length > 0;

                    const shouldShow = (!hideAssigned || !isAssigned);

                    if (totalGroup > 0 && shouldShow) {
                        const option = document.createElement('option');
                        option.value = group.id;
                        option.textContent = `${group.id} - ${group.parish} (${totalGroup} people total)`;
                        select.appendChild(option);
                    }
                }
            });
        }

        // ===== MEAL COLOR ASSIGNMENT MANAGEMENT =====
        function saveMealColorConfiguration() {
            alert('‚úÖ Meal color configuration saved successfully!');
            updateAllDisplays();
            autoSave();
        }

        function updateMealColorAssignment(groupId, color) {
            const group = appData.youthGroups.find(g => g.id === groupId);

            if (color === '') {
                delete appData.mealColorAssignments[groupId];
                // Log activity
                if (group) {
                    logActivity('delete', 'meal-color', groupId,
                        `Cleared meal color for ${group.parish}`);
                }
            } else {
                appData.mealColorAssignments[groupId] = color;
                // Log activity
                if (group) {
                    logActivity('update', 'meal-color', groupId,
                        `Assigned ${color} meal color to ${group.parish}`);
                }
            }
            updateMealColorSummary();
            updateDashboard();
            autoSave();
        }

        function updateMealColorsTable() {
            const tbody = document.getElementById('meal-colors-table');
            tbody.innerHTML = '';

            const sortedGroups = getSortedMealColorGroups();
            
            sortedGroups.forEach(group => {
                const total = group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;
                const assignedColor = appData.mealColorAssignments[group.id] || '';
                const isOffCampus = group.stayingOffCampus || false;
                const locationBadge = isOffCampus
                    ? '<span style="background: #ff9800; color: white; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">üìç Off Campus</span>'
                    : '<span style="background: #2196f3; color: white; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">üè´ On Campus</span>';

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><span class="section-id">${group.id}</span></td>
                    <td>${group.parish}</td>
                    <td>${group.leader}</td>
                    <td>${locationBadge}</td>
                    <td><strong>${total}</strong></td>
                    <td>
                        <select onchange="updateMealColorAssignment('${group.id}', this.value)" style="padding: 5px; border-radius: 4px; border: 1px solid #bdc3c7;">
                            <option value="">Select Color</option>
                            ${appData.activeColors.map(color =>
                                `<option value="${color}" ${assignedColor === color ? 'selected' : ''}>${color}</option>`
                            ).join('')}
                        </select>
                        ${assignedColor ? `<span style="margin-left: 10px; padding: 2px 8px; border-radius: 4px; background: ${getColorForMealAssignment(assignedColor)}; color: white; font-size: 12px;">${assignedColor}</span>` : ''}
                    </td>
                    <td>
                        <button class="btn btn-warning" onclick="clearMealColor('${group.id}')" style="font-size: 12px; padding: 4px 8px;">Clear</button>
                    </td>
                `;
            });
        }

        function updateMealColorSummary() {
            // Initialize counts
            const colorCounts = {};
            MEAL_COLORS.forEach(color => {
                colorCounts[color] = 0;
            });
            
            // Count people per color
            Object.keys(appData.mealColorAssignments).forEach(groupId => {
                const color = appData.mealColorAssignments[groupId];
                const group = appData.youthGroups.find(g => g.id === groupId);
                if (group && color) {
                    const totalPeople = group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;
                    colorCounts[color] += totalPeople;
                }
            });
            
            // Update display
            MEAL_COLORS.forEach(color => {
                const element = document.getElementById(`${color.toLowerCase()}-meal-count`);
                if (element) {
                    element.textContent = colorCounts[color];
                }
            });
        }

        function getColorForMealAssignment(colorName) {
            const colorMap = {
                'Blue': '#3498db',
                'Red': '#e74c3c',
                'Orange': '#e67e22',
                'Yellow': '#f1c40f',
                'Green': '#27ae60',
                'Purple': '#9b59b6',
                'Brown': '#8b4513',
                'Grey': '#95a5a6'
            };
            return colorMap[colorName] || '#bdc3c7';
        }

        function clearMealColor(groupId) {
            if (confirm('Clear meal color assignment for this group?')) {
                delete appData.mealColorAssignments[groupId];
                updateMealColorsTable();
                updateMealColorSummary();
                updateDashboard();
                autoSave();
            }
        }

        function confirmMealColorAssignments() {
            alert('Meal color assignments updated successfully!');
            updateAllDisplays();
            autoSave();
        }

        // ===== ADA INDIVIDUALS MANAGEMENT =====

        function populateADAFormDropdowns() {
            // Populate group dropdown
            const groupSelect = document.getElementById('ada-group');
            if (groupSelect) {
                groupSelect.innerHTML = '<option value="">-- Select Group --</option>';
                appData.youthGroups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = `${group.id} - ${group.parish}`;
                    groupSelect.appendChild(option);
                });
            }

            // Update room dropdown based on gender selection
            updateADARoomDropdown();
        }

        function updateADARoomDropdown() {
            const genderSelect = document.getElementById('ada-gender');
            const roomSelect = document.getElementById('ada-room');

            if (!genderSelect || !roomSelect) return;

            const selectedGender = genderSelect.value;
            roomSelect.innerHTML = '<option value="">-- Select Room --</option>';

            if (!selectedGender) return;

            // Filter rooms by gender
            const filteredRooms = appData.housingRooms.filter(room => room.gender === selectedGender);

            filteredRooms.forEach(room => {
                const roomKey = `${room.building}-${room.roomId}`;
                const occupancy = getHousingRoomOccupancy(roomKey);
                const available = room.capacity - occupancy;
                const accessibilityInfo = room.accessibility ? ` ‚ôø ${room.accessibility}` : '';

                const option = document.createElement('option');
                option.value = roomKey;
                option.textContent = `${room.building} - ${room.roomId} (${available} available)${accessibilityInfo}`;
                roomSelect.appendChild(option);
            });
        }

        function addADAIndividual() {
            const name = document.getElementById('ada-name').value.trim();
            const gender = document.getElementById('ada-gender').value;
            const groupId = document.getElementById('ada-group').value;
            const accessibility = document.getElementById('ada-accessibility').value.trim();
            const roomAssignment = document.getElementById('ada-room').value;

            if (!name) {
                alert(`Please enter the individual's name.`);
                return;
            }

            if (!gender) {
                alert('Please select a gender.');
                return;
            }

            if (!groupId) {
                alert('Please select a youth group.');
                return;
            }

            if (!accessibility) {
                alert('Please enter the accessibility need.');
                return;
            }

            // Create ADA individual object
            const adaIndividual = {
                id: Date.now().toString(),
                name: name,
                gender: gender,
                groupId: groupId,
                accessibility: accessibility,
                roomAssignment: roomAssignment || ''
            };

            appData.adaIndividuals.push(adaIndividual);

            updateADATable();
            updateADAStats();
            clearADAForm();

            alert(`ADA individual "${name}" added successfully!`);
        }

        function clearADAForm() {
            document.getElementById('ada-name').value = '';
            document.getElementById('ada-gender').value = '';
            document.getElementById('ada-group').value = '';
            document.getElementById('ada-accessibility').value = '';
            document.getElementById('ada-room').value = '';
            updateADARoomDropdown();
        }

        function updateADATable() {
            const tbody = document.getElementById('ada-table-body');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (appData.adaIndividuals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #666;">No ADA individuals added yet.</td></tr>';
                return;
            }

            appData.adaIndividuals.forEach((ada, index) => {
                const group = appData.youthGroups.find(g => g.id === ada.groupId);
                const groupName = group ? `${group.id} - ${group.parish}` : 'Unknown Group';
                const roomDisplay = ada.roomAssignment || '<span style="color: #e67e22;">Not assigned</span>';

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${ada.name}</td>
                    <td>${ada.gender === 'male' ? 'üîµ Male' : 'üü£ Female'}</td>
                    <td>${groupName}</td>
                    <td>‚ôø ${ada.accessibility}</td>
                    <td>${roomDisplay}</td>
                    <td>
                        <button class="btn btn-warning" onclick="editADAIndividual(${index})" style="font-size: 12px; padding: 6px 12px;">Edit</button>
                        <button class="btn btn-danger" onclick="deleteADAIndividual(${index})" style="font-size: 12px; padding: 6px 12px;">Delete</button>
                    </td>
                `;
            });
        }

        function editADAIndividual(index) {
            const ada = appData.adaIndividuals[index];
            if (!ada) return;

            document.getElementById('ada-name').value = ada.name;
            document.getElementById('ada-gender').value = ada.gender;
            document.getElementById('ada-group').value = ada.groupId;
            document.getElementById('ada-accessibility').value = ada.accessibility;

            // Update room dropdown based on gender
            updateADARoomDropdown();
            document.getElementById('ada-room').value = ada.roomAssignment;

            // Remove the individual from the array (will be re-added when saving)
            appData.adaIndividuals.splice(index, 1);
            updateADATable();
            updateADAStats();
        }

        function deleteADAIndividual(index) {
            const ada = appData.adaIndividuals[index];
            if (!ada) return;

            if (confirm(`Are you sure you want to remove "${ada.name}" from ADA individuals?`)) {
                appData.adaIndividuals.splice(index, 1);
                updateADATable();
                updateADAStats();
                alert('ADA individual removed successfully.');
            }
        }

        function updateADAStats() {
            const total = appData.adaIndividuals.length;
            const maleCount = appData.adaIndividuals.filter(ada => ada.gender === 'male').length;
            const femaleCount = appData.adaIndividuals.filter(ada => ada.gender === 'female').length;
            const assignedCount = appData.adaIndividuals.filter(ada => ada.roomAssignment && ada.roomAssignment !== '').length;
            const unassignedCount = total - assignedCount;

            document.getElementById('total-ada-individuals').textContent = total;
            document.getElementById('male-ada-count').textContent = maleCount;
            document.getElementById('female-ada-count').textContent = femaleCount;
            document.getElementById('ada-assigned-count').textContent = assignedCount;
            document.getElementById('ada-unassigned-count').textContent = unassignedCount;
        }

        function filterADATable() {
            const filterValue = document.getElementById('ada-filter').value.toLowerCase();
            const tbody = document.getElementById('ada-table-body');
            const rows = tbody.getElementsByTagName('tr');

            for (let row of rows) {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filterValue) ? '' : 'none';
            }
        }

        function sortADATable() {
            const sortBy = document.getElementById('ada-sort').value;

            appData.adaIndividuals.sort((a, b) => {
                if (sortBy === 'name') {
                    return a.name.localeCompare(b.name);
                } else if (sortBy === 'group') {
                    return a.groupId.localeCompare(b.groupId);
                } else if (sortBy === 'gender') {
                    return a.gender.localeCompare(b.gender);
                } else if (sortBy === 'room') {
                    return (a.roomAssignment || '').localeCompare(b.roomAssignment || '');
                }
                return 0;
            });

            updateADATable();
        }

        function saveADAData() {
            autoSave();
            alert('ADA data saved successfully!');
        }

        function getADAIndividualsForGroup(groupId) {
            return appData.adaIndividuals.filter(ada => ada.groupId === groupId);
        }

        function getADAIndividualsForRoom(roomKey) {
            return appData.adaIndividuals.filter(ada => ada.roomAssignment === roomKey);
        }

        function getHousingRoomOccupancy(roomKey) {
            let total = 0;

            Object.keys(appData.housingAssignments.male).forEach(groupId => {
                const assignments = appData.housingAssignments.male[groupId];
                if (Array.isArray(assignments) && assignments.includes(roomKey)) {
                    const group = appData.youthGroups.find(g => g.id === groupId);
                    if (group) {
                        total += group.maleTeens + group.maleChaperones;
                    }
                }
            });

            Object.keys(appData.housingAssignments.female).forEach(groupId => {
                const assignments = appData.housingAssignments.female[groupId];
                if (Array.isArray(assignments) && assignments.includes(roomKey)) {
                    const group = appData.youthGroups.find(g => g.id === groupId);
                    if (group) {
                        total += group.femaleTeens + group.femaleChaperones;
                    }
                }
            });

            // Add ADA individuals assigned to this room
            const adaCount = appData.adaIndividuals.filter(ada => ada.roomAssignment === roomKey).length;
            total += adaCount;

            return total;
        }

        function getSmallGroupRoomOccupancy(roomKey) {
            let total = 0;
            
            Object.keys(appData.smallGroupAssignments).forEach(groupId => {
                const assignments = appData.smallGroupAssignments[groupId];
                if (Array.isArray(assignments) && assignments.includes(roomKey)) {
                    const group = appData.youthGroups.find(g => g.id === groupId);
                    if (group) {
                        total += group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;
                    }
                }
            });
            
            return total;
        }

        function getHousingRoomAssignedGroupsDisplay(roomKey) {
            const assignedGroups = [];

            Object.keys(appData.housingAssignments.male).forEach(groupId => {
                const assignments = appData.housingAssignments.male[groupId];
                if (Array.isArray(assignments) && assignments.includes(roomKey)) {
                    assignedGroups.push(`${groupId}(M)`);
                }
            });

            Object.keys(appData.housingAssignments.female).forEach(groupId => {
                const assignments = appData.housingAssignments.female[groupId];
                if (Array.isArray(assignments) && assignments.includes(roomKey)) {
                    assignedGroups.push(`${groupId}(F)`);
                }
            });

            // Add ADA individuals
            const adaIndividuals = getADAIndividualsForRoom(roomKey);
            if (adaIndividuals.length > 0) {
                adaIndividuals.forEach(ada => {
                    assignedGroups.push(`‚ôø ${ada.name} (${ada.groupId})`);
                });
            }

            return assignedGroups.length > 0 ?
                `<p><strong>Assigned:</strong> ${assignedGroups.join(', ')}</p>` : '';
        }

        function getSmallGroupRoomAssignedGroupsDisplay(roomKey) {
            const assignedGroups = [];
            
            Object.keys(appData.smallGroupAssignments).forEach(groupId => {
                const assignments = appData.smallGroupAssignments[groupId];
                if (Array.isArray(assignments) && assignments.includes(roomKey)) {
                    assignedGroups.push(groupId);
                }
            });
            
            return assignedGroups.length > 0 ? 
                `<p><strong>Assigned:</strong> ${assignedGroups.join(', ')}</p>` : '';
        }

        function isGroupHousingAssigned(groupId) {
            const group = appData.youthGroups.find(g => g.id === groupId);
            if (group && group.stayingOffCampus) {
                return true; // Off-campus groups are considered "assigned"
            }
            const maleAssignments = appData.housingAssignments.male[groupId];
            const femaleAssignments = appData.housingAssignments.female[groupId];
            return (Array.isArray(maleAssignments) && maleAssignments.length > 0) ||
                   (Array.isArray(femaleAssignments) && femaleAssignments.length > 0);
        }

        function isGroupSmallGroupAssigned(groupId) {
            const assignments = appData.smallGroupAssignments[groupId];
            return Array.isArray(assignments) && assignments.length > 0;
        }

        // ===== DISPLAY UPDATE FUNCTIONS =====
        function updateAllDisplays() {
            updateYouthGroupsTable();
            displayRoomsTable();  // New unified rooms table
            updateHousingRoomsTable();  // Keep for backward compatibility
            updateSmallGroupRoomsTable();  // Keep for backward compatibility
            updateMealColorsTable();
            updateMealColorSummary();
            updateMealTimesConfig();
            updateADATable();
            updateADAStats();
            populateADAFormDropdowns();
            updateDashboard();
            updateAssignmentOverview();

            // Update forms preview if we're on that tab
            const formsTab = document.getElementById('printable-forms');
            if (formsTab && formsTab.classList.contains('active')) {
                updateFormsPreview();
            }
        }

        function updateYouthGroupsTable() {
            const tbody = document.getElementById('youth-groups-table');
            tbody.innerHTML = '';

            const sortedGroups = getSortedYouthGroups();
            
            sortedGroups.forEach((group, sortedIndex) => {
                const originalIndex = appData.youthGroups.indexOf(group);
                const total = group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;
                const isAssigned = isGroupHousingAssigned(group.id);
                const isOffCampus = group.stayingOffCampus || false;
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><span class="section-id">${group.id}</span>${isOffCampus ? ' <span style="background: #e67e22; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">üèïÔ∏è OFF</span>' : ''}</td>
                    <td>${group.parish}</td>
                    <td>${group.leader}</td>
                    <td>${group.seminarianSgl || 'Not Assigned'}</td>
                    <td>${group.religious || 'Not Assigned'}</td>
                    <td>${group.phone}</td>
                    <td>${group.maleTeens}</td>
                    <td>${group.femaleTeens}</td>
                    <td>${group.maleChaperones}</td>
                    <td>${group.femaleChaperones}</td>
                    <td><strong>${total}</strong></td>
                    <td style="font-size: 12px; max-width: 150px; word-wrap: break-word;">${group.specialAccommodations || 'None'}</td>
                    <td><span class="assignment-status ${isAssigned || isOffCampus ? 'status-assigned' : 'status-unassigned'}">${isAssigned || isOffCampus ? '‚úÖ Assigned' : '‚ùå Unassigned'}</span></td>
                    <td>
                        <button class="btn btn-warning" onclick="editYouthGroup(${originalIndex})" style="font-size: 12px; padding: 6px 12px;">Edit</button>
                    </td>
                `;
            });
        }

        function updateHousingRoomsTable() {
            const tbody = document.getElementById('housing-rooms-table');
            if (!tbody) return; // Tab no longer exists, skip update

            tbody.innerHTML = '';

            const sortedRooms = getSortedHousingRooms();

            sortedRooms.forEach((room, sortedIndex) => {
                const originalIndex = appData.housingRooms.indexOf(room);
                const roomKey = `${room.building}-${room.roomId}`;
                const occupiedCount = getHousingRoomOccupancy(roomKey);
                const availableSpace = room.capacity - occupiedCount;
                const assignedGroups = getHousingRoomAssignedGroupsDisplay(roomKey);
                
                const row = tbody.insertRow();
                const sectionId = `${room.building.substring(0, 3).toUpperCase()}-${room.roomId}`;
                
                row.innerHTML = `
                    <td><span class="section-id">${sectionId}</span></td>
                    <td>${room.building}</td>
                    <td>${room.roomId}</td>
                    <td>${room.gender.charAt(0).toUpperCase() + room.gender.slice(1)}</td>
                    <td>${room.capacity}</td>
                    <td>${occupiedCount}</td>
                    <td class="capacity-display ${availableSpace < 0 ? 'capacity-negative' : availableSpace === 0 ? 'capacity-zero' : 'capacity-positive'}">${availableSpace}</td>
                    <td>${room.accessibility ? '‚ôø' : '‚úÖ'}</td>
                    <td style="font-size: 12px;">${assignedGroups.replace(/<[^>]*>/g, '').replace('Assigned: ', '') || 'None'}</td>
                    <td>
                        <button class="btn btn-warning" onclick="editHousingRoom(${originalIndex})" style="font-size: 12px; padding: 6px 12px;">Edit</button>
                    </td>
                `;
            });
        }

        function updateSmallGroupRoomsTable() {
            const tbody = document.getElementById('small-group-rooms-table');
            if (!tbody) return; // Tab no longer exists, skip update

            tbody.innerHTML = '';

            const sortedRooms = getSortedSmallGroupRooms();

            sortedRooms.forEach((room, sortedIndex) => {
                const originalIndex = appData.smallGroupRooms.indexOf(room);
                const roomKey = `${room.building}-${room.roomId}`;
                const occupiedCount = getSmallGroupRoomOccupancy(roomKey);
                const availableSpace = room.capacity - occupiedCount;
                const assignedGroups = getSmallGroupRoomAssignedGroupsDisplay(roomKey);
                
                const row = tbody.insertRow();
                const locationId = `${room.building.substring(0, 3).toUpperCase()}-${room.roomId}`;
                
                row.innerHTML = `
                    <td><span class="section-id">${locationId}</span></td>
                    <td>${room.building}</td>
                    <td>${room.roomId}</td>
                    <td>${room.gender === 'mixed' ? 'Mixed/Co-ed' : room.gender.charAt(0).toUpperCase() + room.gender.slice(1)}</td>
                    <td>${room.capacity}</td>
                    <td>${occupiedCount}</td>
                    <td class="capacity-display ${availableSpace < 0 ? 'capacity-negative' : availableSpace === 0 ? 'capacity-zero' : 'capacity-positive'}">${availableSpace}</td>
                    <td>${room.features ? 'üèóÔ∏è' : '‚úÖ'}</td>
                    <td style="font-size: 12px;">${assignedGroups.replace(/<[^>]*>/g, '').replace('Assigned: ', '') || 'None'}</td>
                    <td>
                        <button class="btn btn-warning" onclick="editSmallGroupRoom(${originalIndex})" style="font-size: 12px; padding: 6px 12px;">Edit</button>
                    </td>
                `;
            });
        }

        function updateDashboard() {
            // Basic counts
            const totalGroups = appData.youthGroups.length;
            const totalParticipants = appData.youthGroups.reduce((total, group) => 
                total + group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones, 0);
            
            // Off-campus people count (total people in off-campus groups)
            const offCampusPeople = appData.youthGroups
                .filter(g => g.stayingOffCampus)
                .reduce((total, group) => 
                    total + group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones, 0);
            
            // Housing analysis (only for on-campus groups)
            const groupsNeedingHousing = appData.youthGroups.filter(g => !g.stayingOffCampus && !isGroupHousingAssigned(g.id)).length;
            const groupsNeedingSmallGroup = appData.youthGroups.filter(g => !isGroupSmallGroupAssigned(g.id)).length;
            const groupsNeedingMealColor = appData.youthGroups.filter(g => !appData.mealColorAssignments[g.id]).length;
            
            // Male housing capacity analysis (excluding Off Campus)
            const maleHousingRooms = appData.housingRooms.filter(room => room.gender === 'male' && room.building !== 'Off Campus');
            const totalMaleHousingCapacity = maleHousingRooms.reduce((total, room) => total + room.capacity, 0);
            const usedMaleHousingCapacity = maleHousingRooms.reduce((total, room) => {
                return total + getHousingRoomOccupancy(`${room.building}-${room.roomId}`);
            }, 0);
            const maleHousingUtilization = totalMaleHousingCapacity > 0 ? Math.round((usedMaleHousingCapacity / totalMaleHousingCapacity) * 100) : 0;
            
            // Female housing capacity analysis (excluding Off Campus)
            const femaleHousingRooms = appData.housingRooms.filter(room => room.gender === 'female' && room.building !== 'Off Campus');
            const totalFemaleHousingCapacity = femaleHousingRooms.reduce((total, room) => total + room.capacity, 0);
            const usedFemaleHousingCapacity = femaleHousingRooms.reduce((total, room) => {
                return total + getHousingRoomOccupancy(`${room.building}-${room.roomId}`);
            }, 0);
            const femaleHousingUtilization = totalFemaleHousingCapacity > 0 ? Math.round((usedFemaleHousingCapacity / totalFemaleHousingCapacity) * 100) : 0;
            
            // Mixed/Co-ed small group room capacity analysis
            const mixedSmallGroupRooms = appData.smallGroupRooms.filter(room => room.gender === 'mixed');
            const totalMixedSGCapacity = mixedSmallGroupRooms.reduce((total, room) => total + room.capacity, 0);
            const usedMixedSGCapacity = mixedSmallGroupRooms.reduce((total, room) => {
                return total + getSmallGroupRoomOccupancy(`${room.building}-${room.roomId}`);
            }, 0);
            const mixedSGUtilization = totalMixedSGCapacity > 0 ? Math.round((usedMixedSGCapacity / totalMixedSGCapacity) * 100) : 0;
            
            // Available rooms analysis
            const availableHousingRooms = appData.housingRooms.filter(room => {
                const occupancy = getHousingRoomOccupancy(`${room.building}-${room.roomId}`);
                return occupancy < room.capacity;
            }).length;
            
            const availableSmallGroupRooms = appData.smallGroupRooms.filter(room => {
                const occupancy = getSmallGroupRoomOccupancy(`${room.building}-${room.roomId}`);
                return occupancy < room.capacity;
            }).length;
            
            // Calculate people staying on campus
            const onCampusPeople = totalParticipants - offCampusPeople;

            // Calculate SGL and Religious assignments
            const sglAssigns = appData.youthGroups.filter(g => g.seminarianSgl && g.seminarianSgl.trim() !== '').length;
            const religiousAssigns = appData.youthGroups.filter(g => g.religious && g.religious.trim() !== '').length;

            // Calculate ADA statistics
            const adaPeopleTotal = appData.adaIndividuals ? appData.adaIndividuals.length : 0;
            const adaPeopleNeedingRooms = appData.adaIndividuals ? appData.adaIndividuals.filter(ada => {
                // Check if this person's group has housing assigned
                const group = appData.youthGroups.find(g => g.id === ada.groupId);
                if (!group || group.stayingOffCampus) return false;
                return !isGroupHousingAssigned(ada.groupId);
            }).length : 0;

            // Update the display
            document.getElementById('total-groups').textContent = totalGroups;
            document.getElementById('total-participants').textContent = totalParticipants;
            document.getElementById('off-campus-groups').textContent = offCampusPeople;
            document.getElementById('on-campus-people').textContent = onCampusPeople;
            document.getElementById('groups-needing-housing').textContent = groupsNeedingHousing;
            document.getElementById('groups-needing-small-group').textContent = groupsNeedingSmallGroup;
            document.getElementById('groups-needing-meal-color').textContent = groupsNeedingMealColor;
            
            // Male housing stats
            document.getElementById('male-housing-capacity').textContent = totalMaleHousingCapacity;
            document.getElementById('male-housing-used').textContent = usedMaleHousingCapacity;
            document.getElementById('male-housing-utilization').textContent = maleHousingUtilization + '%';
            
            // Female housing stats
            document.getElementById('female-housing-capacity').textContent = totalFemaleHousingCapacity;
            document.getElementById('female-housing-used').textContent = usedFemaleHousingCapacity;
            document.getElementById('female-housing-utilization').textContent = femaleHousingUtilization + '%';
            
            // Mixed small group stats
            document.getElementById('mixed-sg-capacity').textContent = totalMixedSGCapacity;
            document.getElementById('mixed-sg-used').textContent = usedMixedSGCapacity;
            document.getElementById('mixed-sg-utilization').textContent = mixedSGUtilization + '%';
            
            // General stats
            document.getElementById('available-small-group-rooms').textContent = availableSmallGroupRooms;

            // Assignment stats
            document.getElementById('sgl-assigns').textContent = sglAssigns;
            document.getElementById('religious-assigns').textContent = religiousAssigns;
            document.getElementById('ada-people-total').textContent = adaPeopleTotal;
            document.getElementById('ada-people-needing-rooms').textContent = adaPeopleNeedingRooms;
        }

        function updateAssignmentOverview() {
            const overviewDiv = document.getElementById('assignment-overview');
            
            if (appData.youthGroups.length === 0) {
                overviewDiv.innerHTML = '<p>No youth groups added yet.</p>';
                return;
            }
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 15px;">';

            let visibleCount = 0;
            appData.youthGroups.forEach(group => {
                // Apply dashboard filters
                if (!shouldShowGroupInDashboard(group)) {
                    return; // Skip this group
                }
                visibleCount++;

                const isHousingAssigned = isGroupHousingAssigned(group.id);
                const isSmallGroupAssigned = isGroupSmallGroupAssigned(group.id);
                const mealColor = appData.mealColorAssignments[group.id] || '';
                const maleTotal = group.maleTeens + group.maleChaperones;
                const femaleTotal = group.femaleTeens + group.femaleChaperones;
                const totalGroup = maleTotal + femaleTotal;
                
                // Check if off-campus
                const isOffCampus = group.stayingOffCampus || false;
                
                // Get housing assignments
                const maleHousingRooms = appData.housingAssignments.male[group.id] || [];
                const femaleHousingRooms = appData.housingAssignments.female[group.id] || [];
                
                const maleHousingRoomNames = maleHousingRooms.map(roomKey => {
                    const room = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                    return room ? `${room.building}-${room.roomId}` : roomKey;
                });
                
                const femaleHousingRoomNames = femaleHousingRooms.map(roomKey => {
                    const room = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                    return room ? `${room.building}-${room.roomId}` : roomKey;
                });
                
                // Get small group assignments
                const groupSmallGroupRooms = appData.smallGroupAssignments[group.id] || [];
                
                const groupSmallGroupRoomNames = groupSmallGroupRooms.map(roomKey => {
                    const room = appData.smallGroupRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                    return room ? `${room.building}-${room.roomId}` : roomKey;
                });
                
                const overallAssigned = isHousingAssigned || isSmallGroupAssigned;
                
                html += `
                    <div class="room-card" style="border-left-color: ${overallAssigned ? '#27ae60' : '#e74c3c'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong>${group.parish}</strong>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                ${isOffCampus ? '<span class="assignment-status" style="background: #e67e22; color: white; font-size: 10px;">üèïÔ∏è OFF-CAMPUS</span>' : ''}
                                <span class="assignment-status ${isHousingAssigned ? 'status-assigned' : 'status-unassigned'}" style="font-size: 10px;">
                                    üè† ${isHousingAssigned ? '‚úÖ' : '‚ùå'}
                                </span>
                                <span class="assignment-status ${isSmallGroupAssigned ? 'status-assigned' : 'status-unassigned'}" style="font-size: 10px;">
                                    üë• ${isSmallGroupAssigned ? '‚úÖ' : '‚ùå'}
                                </span>
                                ${mealColor ? `<span style="padding: 2px 6px; border-radius: 4px; background: ${getColorForMealAssignment(mealColor)}; color: white; font-size: 10px; font-weight: bold;">üçΩÔ∏è ${mealColor}</span>` : '<span style="font-size: 10px; color: #e67e22;">üçΩÔ∏è No Color</span>'}
                            </div>
                        </div>
                        <p><span class="section-id">${group.id}</span> | ${totalGroup} people total</p>
                        ${group.seminarianSgl ? `<p style="font-size: 12px; color: #2c3e50;"><strong>Seminarian SGL:</strong> ${group.seminarianSgl}</p>` : ''}
                        ${group.religious ? `<p style="font-size: 12px; color: #2c3e50;"><strong>Religious:</strong> ${group.religious}</p>` : ''}

                        <!-- Housing Assignments -->
                        ${isOffCampus ? `
                            <div style="background: #fff3cd; padding: 8px; border-radius: 6px; margin: 8px 0; border-left: 4px solid #e67e22;">
                                <strong style="font-size: 14px;">üèïÔ∏è OFF-CAMPUS HOUSING</strong>
                                <p style="font-size: 12px; margin-top: 4px;">This group is staying off-campus</p>
                            </div>
                        ` : `
                            <div style="background: #f8f9fa; padding: 8px; border-radius: 6px; margin: 8px 0;">
                                <strong style="font-size: 14px;">üè† Housing Assignments</strong>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px;">
                                    ${maleTotal > 0 ? `
                                        <div class="male-section" style="padding: 6px;">
                                            <strong style="font-size: 12px;">üîµ Males: ${maleTotal}</strong>
                                            ${maleHousingRoomNames.length > 0 ? `<p style="font-size: 10px; margin: 2px 0 0 0;">${maleHousingRoomNames.join(', ')}</p>` : '<p style="font-size: 10px; color: #e67e22; margin: 2px 0 0 0;">Not assigned</p>'}
                                        </div>
                                    ` : '<div></div>'}
                                    
                                    ${femaleTotal > 0 ? `
                                        <div class="female-section" style="padding: 6px;">
                                            <strong style="font-size: 12px;">üü£ Females: ${femaleTotal}</strong>
                                            ${femaleHousingRoomNames.length > 0 ? `<p style="font-size: 10px; margin: 2px 0 0 0;">${femaleHousingRoomNames.join(', ')}</p>` : '<p style="font-size: 10px; color: #e67e22; margin: 2px 0 0 0;">Not assigned</p>'}
                                        </div>
                                    ` : '<div></div>'}
                                </div>
                            </div>
                        `}

                        <!-- ADA Accommodations (Simple Notice) -->
                        ${getADAIndividualsForGroup(group.id).length > 0 ? `
                            <div style="background: #f3e5f5; padding: 8px; border-radius: 6px; margin: 8px 0; border-left: 4px solid #9c27b0; text-align: center;">
                                <strong style="font-size: 12px; color: #6a1b9a;">‚ôø ADA Accommodations Assigned</strong>
                            </div>
                        ` : ''}

                        <!-- Small Group Assignments -->
                        <div style="background: #f0f8ff; padding: 8px; border-radius: 6px; margin: 8px 0;">
                            <strong style="font-size: 14px;">üë• Small Group Location</strong>
                            ${groupSmallGroupRoomNames.length > 0 ? `
                                <div style="background: linear-gradient(45deg, #e8f4f8, #fdf2f2); padding: 6px; border-radius: 4px; margin-top: 5px;">
                                    <strong style="font-size: 12px;">üü° Group Location:</strong>
                                    <p style="font-size: 10px; margin: 2px 0 0 0;">${groupSmallGroupRoomNames.join(', ')}</p>
                                </div>
                            ` : `<div style="background: #fff3cd; padding: 4px; border-radius: 4px; margin-top: 5px; text-align: center;">
                                <p style="font-size: 10px; color: #856404; margin: 0;">No small group location assigned</p>
                            </div>`}
                        </div>
                    </div>
                `;
            });

            html += '</div>';

            if (visibleCount === 0) {
                overviewDiv.innerHTML = '<div style="background: #fff3cd; padding: 20px; border-radius: 8px; text-align: center; border: 2px solid #f39c12;"><p style="font-size: 16px; color: #856404; margin: 0;"><strong>üìä No groups match the current filters</strong></p><p style="color: #666; margin-top: 10px;">Try adjusting or clearing the filters above.</p></div>';
            } else {
                overviewDiv.innerHTML = html;
            }
        }

        // ===== SEARCH FUNCTIONALITY =====
        function performSearch() {
            const searchTerm = document.getElementById('parish-search').value.toLowerCase();
            const resultsDiv = document.getElementById('search-results');
            
            if (!searchTerm.trim()) {
                resultsDiv.innerHTML = '';
                return;
            }
            
            const matchingGroups = appData.youthGroups.filter(group =>
                group.parish.toLowerCase().includes(searchTerm) ||
                group.id.toLowerCase().includes(searchTerm) ||
                group.leader.toLowerCase().includes(searchTerm) ||
                (group.seminarianSgl && group.seminarianSgl.toLowerCase().includes(searchTerm)) ||
                (group.religious && group.religious.toLowerCase().includes(searchTerm)) ||
                group.phone.toLowerCase().includes(searchTerm)
            );
            
            if (matchingGroups.length === 0) {
                resultsDiv.innerHTML = '<div class="notification warning">No groups found matching your search.</div>';
                return;
            }
            
            let html = '<h3>Search Results</h3><div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 15px;">';
            
            matchingGroups.forEach(group => {
                const isHousingAssigned = isGroupHousingAssigned(group.id);
                const isSmallGroupAssigned = isGroupSmallGroupAssigned(group.id);
                const mealColor = appData.mealColorAssignments[group.id] || '';
                const maleTotal = group.maleTeens + group.maleChaperones;
                const femaleTotal = group.femaleTeens + group.femaleChaperones;
                const totalGroup = maleTotal + femaleTotal;
                
                // Check if off-campus
                const isOffCampus = group.stayingOffCampus || false;
                
                // Get housing assignments
                const maleHousingRooms = appData.housingAssignments.male[group.id] || [];
                const femaleHousingRooms = appData.housingAssignments.female[group.id] || [];
                
                const maleHousingRoomNames = maleHousingRooms.map(roomKey => {
                    const room = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                    return room ? `${room.building}-${room.roomId}` : roomKey;
                });
                
                const femaleHousingRoomNames = femaleHousingRooms.map(roomKey => {
                    const room = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                    return room ? `${room.building}-${room.roomId}` : roomKey;
                });
                
                // Get small group assignments
                const groupSmallGroupRooms = appData.smallGroupAssignments[group.id] || [];
                
                const groupSmallGroupRoomNames = groupSmallGroupRooms.map(roomKey => {
                    const room = appData.smallGroupRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                    return room ? `${room.building}-${room.roomId}` : roomKey;
                });
                
                const overallAssigned = isHousingAssigned || isSmallGroupAssigned;
                
                html += `
                    <div class="room-card" style="border-left-color: ${overallAssigned ? '#27ae60' : '#e74c3c'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong>${group.parish}</strong>
                            <div style="display: flex; gap: 5px;">
                                ${isOffCampus ? '<span class="assignment-status" style="background: #e67e22; color: white; font-size: 10px;">üèïÔ∏è OFF-CAMPUS</span>' : ''}
                                <span class="assignment-status ${isHousingAssigned ? 'status-assigned' : 'status-unassigned'}" style="font-size: 10px;">
                                    üè† ${isHousingAssigned ? '‚úÖ' : '‚ùå'}
                                </span>
                                <span class="assignment-status ${isSmallGroupAssigned ? 'status-assigned' : 'status-unassigned'}" style="font-size: 10px;">
                                    üë• ${isSmallGroupAssigned ? '‚úÖ' : '‚ùå'}
                                </span>
                            </div>
                        </div>
                        <p><span class="section-id">${group.id}</span> | <strong>Leader:</strong> ${group.leader} | <strong>Phone:</strong> ${group.phone}</p>
                        ${group.seminarianSgl ? `<p style="font-size: 12px;"><strong>Seminarian SGL:</strong> ${group.seminarianSgl}</p>` : ''}
                        ${group.religious ? `<p style="font-size: 12px;"><strong>Religious:</strong> ${group.religious}</p>` : ''}
                        <p><strong>Total People:</strong> ${totalGroup} (${maleTotal} males, ${femaleTotal} females)</p>
                        ${group.specialAccommodations ? `<p style="margin-top: 8px; font-size: 12px;"><strong>Special Accommodations:</strong> ${group.specialAccommodations}</p>` : ''}
                        
                        <!-- Meal Color Display -->
                        ${mealColor ? `<div style="margin: 8px 0;"><strong>Meal Color:</strong> <span style="padding: 2px 6px; border-radius: 4px; background: ${getColorForMealAssignment(mealColor)}; color: white; font-size: 12px; font-weight: bold;">${mealColor}</span></div>` : '<div style="margin: 8px 0; color: #e67e22;"><strong>Meal Color:</strong> Not assigned</div>'}
                        
                        <!-- Housing Assignments -->
                        ${isOffCampus ? `
                            <div style="background: #fff3cd; padding: 8px; border-radius: 6px; margin: 8px 0; border-left: 4px solid #e67e22;">
                                <strong style="font-size: 14px;">üèïÔ∏è OFF-CAMPUS HOUSING</strong>
                                <p style="font-size: 12px; margin-top: 4px;">This group is staying off-campus</p>
                            </div>
                        ` : `
                            <div style="background: #f8f9fa; padding: 8px; border-radius: 6px; margin: 8px 0;">
                                <strong style="font-size: 14px;">üè† Housing Assignments</strong>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px;">
                                    ${maleTotal > 0 ? `
                                        <div class="male-section" style="padding: 6px;">
                                            <strong style="font-size: 12px;">üîµ Males: ${maleTotal}</strong>
                                            ${maleHousingRoomNames.length > 0 ? `<p style="font-size: 10px; margin: 2px 0 0 0;">${maleHousingRoomNames.join(', ')}</p>` : '<p style="font-size: 10px; color: #e67e22; margin: 2px 0 0 0;">Not assigned</p>'}
                                        </div>
                                    ` : '<div></div>'}
                                    
                                    ${femaleTotal > 0 ? `
                                        <div class="female-section" style="padding: 6px;">
                                            <strong style="font-size: 12px;">üü£ Females: ${femaleTotal}</strong>
                                            ${femaleHousingRoomNames.length > 0 ? `<p style="font-size: 10px; margin: 2px 0 0 0;">${femaleHousingRoomNames.join(', ')}</p>` : '<p style="font-size: 10px; color: #e67e22; margin: 2px 0 0 0;">Not assigned</p>'}
                                        </div>
                                    ` : '<div></div>'}
                                </div>
                            </div>
                        `}

                        <!-- ADA Accommodations (Simple Notice) -->
                        ${getADAIndividualsForGroup(group.id).length > 0 ? `
                            <div style="background: #f3e5f5; padding: 8px; border-radius: 6px; margin: 8px 0; border-left: 4px solid #9c27b0; text-align: center;">
                                <strong style="font-size: 12px; color: #6a1b9a;">‚ôø ADA Accommodations Assigned</strong>
                            </div>
                        ` : ''}

                        <!-- Small Group Assignments -->
                        <div style="background: #f0f8ff; padding: 8px; border-radius: 6px; margin: 8px 0;">
                            <strong style="font-size: 14px;">üë• Small Group Location</strong>
                            ${groupSmallGroupRoomNames.length > 0 ? `
                                <div style="background: linear-gradient(45deg, #e8f4f8, #fdf2f2); padding: 6px; border-radius: 4px; margin-top: 5px;">
                                    <strong style="font-size: 12px;">üü° Group Location:</strong>
                                    <p style="font-size: 10px; margin: 2px 0 0 0;">${groupSmallGroupRoomNames.join(', ')}</p>
                                </div>
                            ` : `<div style="background: #fff3cd; padding: 4px; border-radius: 4px; margin-top: 5px; text-align: center;">
                                <p style="font-size: 10px; color: #856404; margin: 0;">No small group location assigned</p>
                            </div>`}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        // ===== RESOURCES MANAGEMENT =====
        function displayResources() {
            const container = document.getElementById('resources-list');
            if (!container) return;

            let html = '';

            if (!appData.resources || appData.resources.length === 0) {
                html = '<p style="color: #666;">No resources configured yet.</p>';
            } else {
                appData.resources.forEach((resource, index) => {
                    // Skip Meal Times and Event Schedule - they are managed in separate tabs
                    if (resource.name === 'Meal Times' || resource.name === 'Event Schedule') {
                        return;
                    }

                    html += `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #dee2e6;">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <span style="font-size: 2em;">${resource.emoji}</span>
                                <h3 style="margin: 0; color: #061d28;">${resource.emoji} Resource</h3>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">Display Name:</label>
                                <input type="text"
                                       value="${resource.name || ''}"
                                       onchange="updateResourceName(${index}, this.value)"
                                       style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 14px;"
                                       placeholder="e.g., Click here for full schedule">
                            </div>

                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">URL Link:</label>
                                <input type="text"
                                       value="${resource.url || ''}"
                                       onchange="updateResourceUrl(${index}, this.value)"
                                       style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 14px;"
                                       placeholder="https://example.com/schedule">
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        function updateResourceName(index, name) {
            if (appData.resources && appData.resources[index]) {
                appData.resources[index].name = name;
                autoSave();
            }
        }

        function updateResourceUrl(index, url) {
            if (appData.resources && appData.resources[index]) {
                appData.resources[index].url = url;
                autoSave();
            }
        }

        // ===== SCHEDULE MANAGEMENT =====
        function initializeScheduleData() {
            if (!appData.schedule) {
                // Pre-populate with existing schedule data
                appData.schedule = {
                    friday: [
                        { startTime: "5:00 PM", endTime: "6:30 PM", event: "Arrival / Registration", location: "Various" },
                        { startTime: "6:30 PM", endTime: "", event: "ARCC Arena Opens", location: "ARCC" },
                        { startTime: "7:00 PM", endTime: "7:35 PM", event: "Start of Program - Introductions", location: "ARCC Arena" },
                        { startTime: "7:40 PM", endTime: "8:20 PM", event: "Keynote 1: Dr. John-Mark Miravalle", location: "ARCC Arena" },
                        { startTime: "8:35 PM", endTime: "9:50 PM", event: "Holy Mass", location: "ARCC Arena" },
                        { startTime: "10:00 PM", endTime: "", event: "Dismissal", location: "" }
                    ],
                    saturday: [
                        { startTime: "7:40 AM", endTime: "8:40 AM", event: "On-Campus Breakfast", location: "Patriot Hall" },
                        { startTime: "8:30 AM", endTime: "", event: "ARCC Arena Opens", location: "ARCC" },
                        { startTime: "9:00 AM", endTime: "9:30 AM", event: "Start of Program", location: "ARCC Arena" },
                        { startTime: "9:40 AM", endTime: "10:10 AM", event: "Keynote 2: Patricia Sandoval", location: "ARCC Arena" },
                        { startTime: "10:10 AM", endTime: "10:25 AM", event: "Dismissal and Prep for Holy Mass", location: "ARCC Arena" },
                        { startTime: "10:25 AM", endTime: "11:45 AM", event: "Holy Mass", location: "ARCC Arena" },
                        { startTime: "10:25 AM", endTime: "11:45 AM", event: "(Confirmation ONLY) Holy Mass", location: "JC Chapel" },
                        { startTime: "12:15 PM", endTime: "1:15 PM", event: "Lunch", location: "Patriot Hall" },
                        { startTime: "1:30 PM", endTime: "2:30 PM", event: "Breakout Sessions", location: "Various" },
                        { startTime: "2:30 PM", endTime: "4:20 PM", event: "Group Time/Recreation", location: "Various" },
                        { startTime: "4:20 PM", endTime: "6:40 PM", event: "Dinner", location: "Patriot Hall" },
                        { startTime: "6:15 PM", endTime: "", event: "ARCC Arena Opens", location: "ARCC" },
                        { startTime: "6:50 PM", endTime: "7:40 PM", event: "Start of Program", location: "ARCC Arena" },
                        { startTime: "7:40 PM", endTime: "8:00 PM", event: "Break", location: "ARCC Arena" },
                        { startTime: "8:00 PM", endTime: "8:40 PM", event: "Keynote 3: Archbishop Sample", location: "ARCC Arena" },
                        { startTime: "8:50 PM", endTime: "9:50 PM", event: "Eucharistic Adoration", location: "ARCC Arena" },
                        { startTime: "10:00 PM", endTime: "", event: "Dismissal", location: "" }
                    ],
                    sunday: [
                        { startTime: "7:40 AM", endTime: "8:40 AM", event: "On-Campus Breakfast", location: "Patriot Hall" },
                        { startTime: "8:30 AM", endTime: "", event: "ARCC Arena Opens", location: "ARCC" },
                        { startTime: "8:50 AM", endTime: "9:20 AM", event: "Start of Program", location: "ARCC Arena" },
                        { startTime: "9:25 AM", endTime: "10:05 AM", event: "Keynote 4: Sr. Catherine Holum", location: "ARCC Arena" },
                        { startTime: "10:40 AM", endTime: "12:10 PM", event: "Holy Mass", location: "ARCC Arena" },
                        { startTime: "12:20 PM", endTime: "", event: "Departure", location: "All Exits" }
                    ]
                };
                // Auto-save the pre-populated schedule
                autoSave();
            }
        }

        function displayScheduleEditor() {
            initializeScheduleData();
            renderScheduleDay('friday');
            renderScheduleDay('saturday');
            renderScheduleDay('sunday');
        }

        function renderScheduleDay(day) {
            const container = document.getElementById(`${day}-schedule-list`);
            if (!container) return;

            const events = appData.schedule[day] || [];

            // Sort events by start time
            events.sort((a, b) => {
                const timeA = a.startTime || '';
                const timeB = b.startTime || '';
                return timeA.localeCompare(timeB);
            });

            let html = '';

            if (events.length === 0) {
                html = '<p style="color: #999; font-style: italic; padding: 10px;">No events scheduled for this day. Click "Add Event" to create one.</p>';
            } else {
                events.forEach((event, index) => {
                    html += `
                        <div style="background: #f8f9fa; border: 2px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 2fr 2fr auto; gap: 10px; align-items: center;">
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 600; color: #6b7280; margin-bottom: 4px;">Start Time *</label>
                                    <input type="text"
                                           value="${event.startTime || ''}"
                                           onchange="updateScheduleEntry('${day}', ${index}, 'startTime', this.value)"
                                           placeholder="8:00 AM"
                                           style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 600; color: #6b7280; margin-bottom: 4px;">End Time</label>
                                    <input type="text"
                                           value="${event.endTime || ''}"
                                           onchange="updateScheduleEntry('${day}', ${index}, 'endTime', this.value)"
                                           placeholder="9:00 AM"
                                           style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 600; color: #6b7280; margin-bottom: 4px;">Event Name *</label>
                                    <input type="text"
                                           value="${event.event || ''}"
                                           onchange="updateScheduleEntry('${day}', ${index}, 'event', this.value)"
                                           placeholder="Event Name"
                                           style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 600; color: #6b7280; margin-bottom: 4px;">Location</label>
                                    <input type="text"
                                           value="${event.location || ''}"
                                           onchange="updateScheduleEntry('${day}', ${index}, 'location', this.value)"
                                           placeholder="Location"
                                           style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                </div>
                                <div style="display: flex; gap: 5px; padding-top: 20px;">
                                    ${index > 0 ? `<button onclick="moveScheduleEntry('${day}', ${index}, -1)" class="btn btn-primary" style="padding: 8px 12px; font-size: 12px;" title="Move Up">‚Üë</button>` : ''}
                                    ${index < events.length - 1 ? `<button onclick="moveScheduleEntry('${day}', ${index}, 1)" class="btn btn-primary" style="padding: 8px 12px; font-size: 12px;" title="Move Down">‚Üì</button>` : ''}
                                    <button onclick="deleteScheduleEntry('${day}', ${index})" class="btn btn-danger" style="padding: 8px 12px; font-size: 12px;">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        function addScheduleEntry(day) {
            if (!appData.schedule[day]) {
                appData.schedule[day] = [];
            }

            appData.schedule[day].push({
                startTime: '',
                endTime: '',
                event: '',
                location: ''
            });

            renderScheduleDay(day);
        }

        function updateScheduleEntry(day, index, field, value) {
            if (appData.schedule[day] && appData.schedule[day][index]) {
                appData.schedule[day][index][field] = value;
                // Re-render to maintain sort order
                renderScheduleDay(day);
            }
        }

        function deleteScheduleEntry(day, index) {
            if (confirm('Are you sure you want to delete this event?')) {
                if (appData.schedule[day]) {
                    appData.schedule[day].splice(index, 1);
                    renderScheduleDay(day);
                }
            }
        }

        function moveScheduleEntry(day, index, direction) {
            if (!appData.schedule[day]) return;

            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= appData.schedule[day].length) return;

            // Swap the entries
            const temp = appData.schedule[day][index];
            appData.schedule[day][index] = appData.schedule[day][newIndex];
            appData.schedule[day][newIndex] = temp;

            renderScheduleDay(day);
        }

        function saveSchedule() {
            autoSave();
            alert('Schedule saved successfully!');
        }

        // ===== ROOM POSTER MANAGEMENT =====
        let roomNotesData = {};
        let currentRoomFilter = 'all';

        function loadRoomNotes() {
            const saved = localStorage.getItem('m2k_room_notes');
            if (saved) {
                try {
                    roomNotesData = JSON.parse(saved);
                } catch (e) {
                    roomNotesData = {};
                }
            }
        }

        function saveRoomNotes() {
            localStorage.setItem('m2k_room_notes', JSON.stringify(roomNotesData));
        }

        function updateRoomNote(roomKey, note) {
            roomNotesData[roomKey] = note;
            saveRoomNotes();
        }

        function getRoomNote(roomKey) {
            return roomNotesData[roomKey] || '';
        }

        function showAllRoomPosters(filter) {
            currentRoomFilter = filter;
            displayRoomPosters();
        }

        function filterRoomPosters() {
            const searchTerm = document.getElementById('room-search').value.toLowerCase();
            const container = document.getElementById('room-posters-container');
            if (!container) return;

            const posters = container.querySelectorAll('.room-poster');
            posters.forEach(poster => {
                const searchText = poster.getAttribute('data-search-text') || '';
                if (searchText.includes(searchTerm)) {
                    poster.style.display = 'block';
                } else {
                    poster.style.display = 'none';
                }
            });
        }

        function displayRoomPosters() {
            const container = document.getElementById('room-posters-container');
            if (!container) return;

            let html = '';

            // Generate Housing Room Posters
            if (currentRoomFilter === 'all' || currentRoomFilter === 'housing') {
                appData.housingRooms.forEach(room => {
                    const roomKey = `${room.building}-${room.roomId}`;
                    const assignedGroups = getHousingRoomAssignments(roomKey);
                    const note = getRoomNote(roomKey);

                    const searchText = `${room.building} ${room.roomId} ${assignedGroups.map(g => g.parish + ' ' + g.id).join(' ')}`.toLowerCase();

                    html += `
                        <div class="room-poster" data-search-text="${searchText}" data-room-key="${roomKey}" style="background: white; border: 3px solid #061d28; border-radius: 10px; padding: 30px; page-break-after: always; position: relative;">
                            <!-- Select Checkbox -->
                            <input type="checkbox" class="room-poster-checkbox" style="position: absolute; top: 15px; right: 15px; width: 25px; height: 25px; cursor: pointer;">

                            <!-- Header -->
                            <div style="text-align: center; margin-bottom: 25px; border-bottom: 4px solid #d4af37; padding-bottom: 20px;">
                                <h1 style="color: #061d28; margin: 0 0 10px 0; font-size: 2.5em;">Mount 2000 Youth Retreat</h1>
                                <h2 style="color: #d4af37; margin: 0; font-size: 1.8em;">HOUSING</h2>
                            </div>

                            <!-- Room Info -->
                            <div style="background: linear-gradient(135deg, #061d28, #0f3a4a); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                <h2 style="margin: 0 0 10px 0; font-size: 2em;">${room.building}</h2>
                                <h3 style="margin: 0; font-size: 1.5em; color: #d4af37;">Room ${room.roomId}</h3>
                                <p style="margin: 10px 0 0 0; font-size: 1.2em;">Capacity: ${room.capacity} | Gender: ${room.gender.toUpperCase()}</p>
                            </div>

                            <!-- Assigned Groups -->
                            <div style="margin-bottom: 20px;">
                                <h3 style="color: #061d28; border-bottom: 2px solid #d4af37; padding-bottom: 10px; margin-bottom: 15px;">Assigned Groups:</h3>
                                ${assignedGroups.length > 0 ? assignedGroups.map(group => `
                                    <div style="background: #f8f9fa; padding: 15px; border-left: 5px solid #d4af37; margin-bottom: 10px; border-radius: 5px;">
                                        <p style="margin: 0 0 5px 0; font-size: 1.3em; font-weight: bold; color: #061d28;">Group ${group.id}: ${group.parish}</p>
                                        <p style="margin: 0; color: #555;">Leader: ${group.leader} | ${group.count} people</p>
                                    </div>
                                `).join('') : '<p style="color: #999; font-style: italic;">No groups assigned to this room yet</p>'}
                            </div>

                            <!-- ADA Individuals -->
                            ${(() => {
                                const adaIndividuals = (appData.adaIndividuals || []).filter(ada => ada.roomAssignment === roomKey);
                                if (adaIndividuals.length === 0) return '';
                                return `
                                    <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 15px; border-radius: 8px; border-left: 5px solid #2196f3; margin-bottom: 20px;">
                                        <h4 style="margin: 0 0 10px 0; color: #1565c0;">‚ôø ADA Individuals:</h4>
                                        ${adaIndividuals.map(ada => {
                                            const group = appData.youthGroups.find(g => g.id === ada.groupId);
                                            return `
                                                <div style="background: white; padding: 10px; border-radius: 5px; margin-bottom: 8px; border-left: 3px solid #2196f3;">
                                                    <p style="margin: 0 0 5px 0; font-size: 1.1em; font-weight: bold;">${ada.name} (${ada.gender})</p>
                                                    <p style="margin: 0 0 5px 0; color: #555;"><strong>Group ${ada.groupId}:</strong> ${group ? group.parish : 'Unknown'}</p>
                                                    <p style="margin: 0; color: #d32f2f; font-weight: bold;"><strong>Accessibility:</strong> ${ada.accessibility}</p>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                `;
                            })()}

                            <!-- Accessibility & Notes -->
                            ${room.accessibility || note ? `
                                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 5px solid #f39c12; margin-bottom: 20px;">
                                    <h4 style="margin: 0 0 10px 0; color: #856404;">Important Information:</h4>
                                    ${room.accessibility ? `<p style="margin: 5px 0; font-weight: bold;">‚ôø Accessibility: ${room.accessibility}</p>` : ''}
                                    ${note ? `<p style="margin: 5px 0;"><strong>Notes:</strong> ${note}</p>` : ''}
                                </div>
                            ` : ''}

                            <!-- Custom Notes Section -->
                            <div style="margin-top: 20px; padding-top: 15px; border-top: 2px dashed #ccc;">
                                <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #061d28;">Add Custom Notes:</label>
                                <textarea onchange="updateRoomNote('${roomKey}', this.value)"
                                          style="width: 100%; min-height: 80px; padding: 10px; border: 2px solid #ced4da; border-radius: 5px; font-size: 14px; font-family: inherit;"
                                          placeholder="Add any special instructions or notes for this room...">${note}</textarea>
                            </div>
                        </div>
                    `;
                });
            }

            // Generate Small Group Room Posters
            if (currentRoomFilter === 'all' || currentRoomFilter === 'smallgroup') {
                appData.smallGroupRooms.forEach(room => {
                    const roomKey = `${room.building}-${room.roomId}`;
                    const assignedGroups = getSmallGroupRoomAssignments(roomKey);
                    const note = getRoomNote(roomKey);

                    const searchText = `${room.building} ${room.roomId} ${assignedGroups.map(g => g.parish + ' ' + g.id).join(' ')}`.toLowerCase();

                    html += `
                        <div class="room-poster" data-search-text="${searchText}" data-room-key="${roomKey}" style="background: white; border: 3px solid #061d28; border-radius: 10px; padding: 30px; page-break-after: always; position: relative;">
                            <!-- Select Checkbox -->
                            <input type="checkbox" class="room-poster-checkbox" style="position: absolute; top: 15px; right: 15px; width: 25px; height: 25px; cursor: pointer;">

                            <!-- Header -->
                            <div style="text-align: center; margin-bottom: 25px; border-bottom: 4px solid #d4af37; padding-bottom: 20px;">
                                <h1 style="color: #061d28; margin: 0 0 10px 0; font-size: 2.5em;">Mount 2000 Youth Retreat</h1>
                                <h2 style="color: #d4af37; margin: 0; font-size: 1.8em;">SMALL GROUP ROOM</h2>
                            </div>

                            <!-- Room Info -->
                            <div style="background: linear-gradient(135deg, #061d28, #0f3a4a); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                <h2 style="margin: 0 0 10px 0; font-size: 2em;">${room.building}</h2>
                                <h3 style="margin: 0; font-size: 1.5em; color: #d4af37;">Room ${room.roomId}</h3>
                                <p style="margin: 10px 0 0 0; font-size: 1.2em;">Capacity: ${room.capacity}</p>
                            </div>

                            <!-- Assigned Groups -->
                            <div style="margin-bottom: 20px;">
                                <h3 style="color: #061d28; border-bottom: 2px solid #d4af37; padding-bottom: 10px; margin-bottom: 15px;">Assigned Groups:</h3>
                                ${assignedGroups.length > 0 ? assignedGroups.map(group => `
                                    <div style="background: #f8f9fa; padding: 15px; border-left: 5px solid #d4af37; margin-bottom: 10px; border-radius: 5px;">
                                        <p style="margin: 0 0 5px 0; font-size: 1.3em; font-weight: bold; color: #061d28;">Group ${group.id}: ${group.parish}</p>
                                        <p style="margin: 0; color: #555;">Leader: ${group.leader} | ${group.count} people</p>
                                    </div>
                                `).join('') : '<p style="color: #999; font-style: italic;">No groups assigned to this room yet</p>'}
                            </div>

                            <!-- Room Features & Setup -->
                            ${room.features || note ? `
                                <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; border-left: 5px solid #3498db; margin-bottom: 20px;">
                                    <h4 style="margin: 0 0 10px 0; color: #2c3e50;">Setup Requirements:</h4>
                                    ${room.features ? `<p style="margin: 5px 0; font-weight: bold;">ü™ë ${room.features}</p>` : ''}
                                    ${note ? `<p style="margin: 5px 0;"><strong>Notes:</strong> ${note}</p>` : ''}
                                </div>
                            ` : ''}

                            <!-- Custom Notes Section -->
                            <div style="margin-top: 20px; padding-top: 15px; border-top: 2px dashed #ccc;">
                                <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #061d28;">Add Custom Notes:</label>
                                <textarea onchange="updateRoomNote('${roomKey}', this.value)"
                                          style="width: 100%; min-height: 80px; padding: 10px; border: 2px solid #ced4da; border-radius: 5px; font-size: 14px; font-family: inherit;"
                                          placeholder="Add any special instructions or notes for this room...">${note}</textarea>
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        function getHousingRoomAssignments(roomKey) {
            const assignments = [];

            Object.keys(appData.housingAssignments.male).forEach(groupId => {
                const rooms = appData.housingAssignments.male[groupId];
                if (Array.isArray(rooms) && rooms.includes(roomKey)) {
                    const group = appData.youthGroups.find(g => g.id === groupId);
                    if (group) {
                        assignments.push({
                            id: group.id,
                            parish: group.parish,
                            leader: group.leader,
                            seminarianSgl: group.seminarianSgl || '',
                            religious: group.religious || '',
                            count: group.maleTeens + group.maleChaperones,
                            gender: 'Male'
                        });
                    }
                }
            });

            Object.keys(appData.housingAssignments.female).forEach(groupId => {
                const rooms = appData.housingAssignments.female[groupId];
                if (Array.isArray(rooms) && rooms.includes(roomKey)) {
                    const group = appData.youthGroups.find(g => g.id === groupId);
                    if (group) {
                        assignments.push({
                            id: group.id,
                            parish: group.parish,
                            leader: group.leader,
                            seminarianSgl: group.seminarianSgl || '',
                            religious: group.religious || '',
                            count: group.femaleTeens + group.femaleChaperones,
                            gender: 'Female'
                        });
                    }
                }
            });

            return assignments;
        }

        function getSmallGroupRoomAssignments(roomKey) {
            const assignments = [];

            Object.keys(appData.smallGroupAssignments).forEach(groupId => {
                const rooms = appData.smallGroupAssignments[groupId];
                if (Array.isArray(rooms) && rooms.includes(roomKey)) {
                    const group = appData.youthGroups.find(g => g.id === groupId);
                    if (group) {
                        assignments.push({
                            id: group.id,
                            parish: group.parish,
                            leader: group.leader,
                            seminarianSgl: group.seminarianSgl || '',
                            religious: group.religious || '',
                            count: group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones
                        });
                    }
                }
            });

            return assignments;
        }

        function printAllRoomPosters() {
            const allPosters = document.querySelectorAll('.room-poster');
            const visiblePosters = Array.from(allPosters).filter(p => p.style.display !== 'none');

            if (visiblePosters.length === 0) {
                alert('No room posters to print. Please add some rooms first.');
                return;
            }

            // Collect room keys from visible posters
            const roomKeys = Array.from(visiblePosters).map(p => p.getAttribute('data-room-key'));
            generateRoomPostersPDF(roomKeys);
        }

        function printSelectedRoomPosters() {
            const checkboxes = document.querySelectorAll('.room-poster-checkbox:checked');

            if (checkboxes.length === 0) {
                alert('No room posters selected. Please check the boxes of the posters you want to print.');
                return;
            }

            // Collect room keys from checked posters
            const roomKeys = Array.from(checkboxes).map(cb => cb.closest('.room-poster').getAttribute('data-room-key'));
            generateRoomPostersPDF(roomKeys);
        }

        function generateRoomPostersPDF(roomKeys) {
            if (!roomKeys || roomKeys.length === 0) return;

            const printWindow = window.open('', '_blank');

            let postersHTML = '';

            roomKeys.forEach(roomKey => {
                // Check if housing or small group
                const housingRoom = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                const smallGroupRoom = appData.smallGroupRooms.find(r => `${r.building}-${r.roomId}` === roomKey);

                if (housingRoom) {
                    postersHTML += generateHousingRoomPosterHTML(housingRoom, roomKey);
                } else if (smallGroupRoom) {
                    postersHTML += generateSmallGroupRoomPosterHTML(smallGroupRoom, roomKey);
                }
            });

            const printHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Mount 2000 Room Posters - ${new Date().toLocaleDateString()}</title>
                    <style>
                        @page {
                            size: letter landscape;
                            margin: 0.5in;
                        }
                        @media print {
                            .page-break {
                                page-break-after: always;
                            }
                            * {
                                -webkit-print-color-adjust: exact !important;
                                print-color-adjust: exact !important;
                                color-adjust: exact !important;
                            }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 14pt;
                            line-height: 1.5;
                            color: #000;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        .room-poster-page {
                            background: white;
                            padding: 40px;
                            min-height: 7.5in;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 35px;
                            border-bottom: 5px solid #d4af37;
                            padding-bottom: 25px;
                        }
                        .header h1 {
                            color: #061d28;
                            margin: 0 0 15px 0;
                            font-size: 42pt;
                            font-weight: bold;
                        }
                        .header h2 {
                            color: #d4af37;
                            margin: 0;
                            font-size: 32pt;
                            font-weight: bold;
                        }
                        .room-info-box {
                            background: linear-gradient(135deg, #061d28, #0f3a4a);
                            color: white;
                            padding: 35px;
                            border-radius: 10px;
                            margin-bottom: 30px;
                            text-align: center;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        .room-info-box h2 {
                            margin: 0 0 15px 0;
                            font-size: 36pt;
                            font-weight: bold;
                        }
                        .room-info-box h3 {
                            margin: 0;
                            font-size: 28pt;
                            color: #d4af37;
                            font-weight: bold;
                        }
                        .room-info-box p {
                            margin: 20px 0 0 0;
                            font-size: 18pt;
                            font-weight: bold;
                        }
                        .section-title {
                            color: #061d28;
                            border-bottom: 3px solid #d4af37;
                            padding-bottom: 12px;
                            margin: 30px 0 20px 0;
                            font-size: 22pt;
                            font-weight: bold;
                        }
                        .group-box {
                            background: #f8f9fa;
                            padding: 20px;
                            border-left: 6px solid #d4af37;
                            margin-bottom: 15px;
                            border-radius: 6px;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        .group-box .group-name {
                            margin: 0 0 8px 0;
                            font-size: 20pt;
                            font-weight: bold;
                            color: #061d28;
                        }
                        .group-box .group-info {
                            margin: 0;
                            color: #333;
                            font-size: 16pt;
                            font-weight: 600;
                        }
                        .info-box {
                            padding: 20px;
                            border-radius: 10px;
                            border-left: 6px solid;
                            margin: 20px 0;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        .warning-box {
                            background: #fff3cd;
                            border-left-color: #f39c12;
                        }
                        .info-box-blue {
                            background: #e8f4f8;
                            border-left-color: #3498db;
                        }
                        .info-box h4 {
                            margin: 0 0 12px 0;
                            font-size: 18pt;
                            font-weight: bold;
                        }
                        .info-box p {
                            margin: 8px 0;
                            font-size: 16pt;
                            font-weight: 600;
                        }
                        .no-groups {
                            color: #999;
                            font-style: italic;
                            font-size: 14pt;
                        }
                    </style>
                </head>
                <body>
                    ${postersHTML}
                </body>
                </html>
            `;

            printWindow.document.write(printHTML);
            printWindow.document.close();

            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
            }, 250);
        }

        function generateHousingRoomPosterHTML(room, roomKey) {
            const assignedGroups = getHousingRoomAssignments(roomKey);
            const note = getRoomNote(roomKey);

            // Find ADA individuals assigned to this room
            const adaIndividuals = (appData.adaIndividuals || []).filter(ada =>
                ada.roomAssignment === roomKey
            );

            return `
                <div class="room-poster-page page-break">
                    <div class="header">
                        <h1>Mount 2000 Youth Retreat</h1>
                        <h2>HOUSING</h2>
                    </div>

                    <div class="room-info-box">
                        <h2>${room.building}</h2>
                        <h3>Room ${room.roomId}</h3>
                        <p>Capacity: ${room.capacity} | Gender: ${room.gender.toUpperCase()}</p>
                    </div>

                    <h3 class="section-title">Assigned Groups:</h3>
                    ${assignedGroups.length > 0 ? assignedGroups.map(group => `
                        <div class="group-box" style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-left: 5px solid ${group.gender === 'Male' ? '#061d28' : '#d4af37'};">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <p class="group-name" style="font-size: 1.3em; margin-bottom: 8px;"><strong>Group ${group.id}:</strong> ${group.parish}</p>
                                    <p class="group-info"><strong>Leader:</strong> ${group.leader}</p>
                                    ${group.seminarianSgl ? `<p class="group-info" style="font-size: 0.95em;"><strong>Seminarian SGL:</strong> ${group.seminarianSgl}</p>` : ''}
                                    ${group.religious ? `<p class="group-info" style="font-size: 0.95em;"><strong>Religious:</strong> ${group.religious}</p>` : ''}
                                </div>
                                <div style="text-align: right;">
                                    <p class="group-info" style="font-size: 1.2em; color: ${group.gender === 'Male' ? '#061d28' : '#d4af37'}; font-weight: bold;">${group.count} people</p>
                                    <p class="group-info" style="font-size: 1.1em;">(${group.gender})</p>
                                </div>
                            </div>
                        </div>
                    `).join('') : '<p class="no-groups">No groups assigned to this room yet</p>'}

                    ${adaIndividuals.length > 0 ? `
                        <div class="info-box info-box-blue" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); border-left: 5px solid #2196f3;">
                            <h4>‚ôø ADA Individuals:</h4>
                            ${adaIndividuals.map(ada => {
                                const group = appData.youthGroups.find(g => g.id === ada.groupId);
                                return `
                                    <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px;">
                                        <p style="margin: 5px 0; font-size: 1.1em;"><strong>${ada.name}</strong> (${ada.gender})</p>
                                        <p style="margin: 5px 0;"><strong>Group ${ada.groupId}:</strong> ${group ? group.parish : 'Unknown'}</p>
                                        <p style="margin: 5px 0; color: #d32f2f;"><strong>Accessibility:</strong> ${ada.accessibility}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : ''}

                    ${room.accessibility || note ? `
                        <div class="info-box warning-box">
                            <h4>‚ö†Ô∏è Important Information:</h4>
                            ${room.accessibility ? `<p><strong>Accessibility:</strong> ${room.accessibility}</p>` : ''}
                            ${note ? `<p><strong>Notes:</strong> ${note}</p>` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function generateSmallGroupRoomPosterHTML(room, roomKey) {
            const assignedGroups = getSmallGroupRoomAssignments(roomKey);
            const note = getRoomNote(roomKey);

            return `
                <div class="room-poster-page page-break">
                    <div class="header">
                        <h1>Mount 2000 Youth Retreat</h1>
                        <h2>SMALL GROUP ROOM</h2>
                    </div>

                    <div class="room-info-box">
                        <h2>${room.building}</h2>
                        <h3>Room ${room.roomId}</h3>
                        <p>Capacity: ${room.capacity}</p>
                    </div>

                    <h3 class="section-title">Assigned Groups:</h3>
                    ${assignedGroups.length > 0 ? assignedGroups.map(group => `
                        <div class="group-box" style="background: linear-gradient(135deg, #f0f8ff, #e8f4f8); border-left: 5px solid #3498db;">
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                                <div>
                                    <p class="group-name" style="font-size: 1.3em; margin-bottom: 8px;"><strong>Group ${group.id}:</strong> ${group.parish}</p>
                                    <p class="group-info"><strong>Leader:</strong> ${group.leader}</p>
                                    ${group.seminarianSgl ? `<p class="group-info" style="font-size: 0.95em;"><strong>Seminarian SGL:</strong> ${group.seminarianSgl}</p>` : ''}
                                    ${group.religious ? `<p class="group-info" style="font-size: 0.95em;"><strong>Religious:</strong> ${group.religious}</p>` : ''}
                                </div>
                                <div style="text-align: right;">
                                    <p class="group-info" style="font-size: 1.2em; color: #3498db; font-weight: bold;">${group.count} people</p>
                                </div>
                            </div>
                        </div>
                    `).join('') : '<p class="no-groups">No groups assigned to this room yet</p>'}

                    ${room.features || note ? `
                        <div class="info-box info-box-blue">
                            <h4>ü™ë Setup Requirements:</h4>
                            ${room.features ? `<p><strong>${room.features}</strong></p>` : ''}
                            ${note ? `<p><strong>Notes:</strong> ${note}</p>` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // ===== DATA MANAGEMENT =====
        function autoSave() {
            // Update filtered views before saving
            updateRoomFilteredViews();

            // Create a copy without the derived arrays
            const dataToSave = { ...appData, timestamp: new Date().toISOString() };
            delete dataToSave.housingRooms;  // Remove derived array
            delete dataToSave.smallGroupRooms;  // Remove derived array

            window.housingData = dataToSave;
        }

        function saveData() {
            // Update filtered views before saving
            updateRoomFilteredViews();

            // Create a copy without the derived arrays
            const data = { ...appData, timestamp: new Date().toISOString(), version: '3.0' };
            delete data.housingRooms;  // Remove derived array
            delete data.smallGroupRooms;  // Remove derived array

            const dataStr = JSON.stringify(data, null, 2);

            // Download as JSON file
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'm2k_2026_housing_data.json';
            link.click();

            alert('‚úÖ Data saved successfully as JSON file!');
        }

        // Helper function to update filtered views after room modifications
        function updateRoomFilteredViews() {
            appData.housingRooms = appData.rooms.filter(r => r.type === 'housing');
            appData.smallGroupRooms = appData.rooms.filter(r => r.type === 'smallGroup');
        }

        // ===== GITHUB API INTEGRATION =====
        function getGitHubSettings() {
            const settings = localStorage.getItem('githubSettings');
            const parsedSettings = settings ? JSON.parse(settings) : {
                token: '',
                owner: 'M2KPortal',
                repo: 'M2KPortal.github.io',
                branch: 'main',
                filePath: 'm2k_2026_housing_data (1).json'
            };

            // MIGRATION: Fix any old session data file paths
            if (parsedSettings.filePath === 'm2k_sessions_data.json' ||
                parsedSettings.filePath.includes('session')) {
                console.warn('Migrating old session file path to correct housing data file');
                parsedSettings.filePath = 'm2k_2026_housing_data (1).json';
                saveGitHubSettings(parsedSettings);  // Save corrected settings
            }

            return parsedSettings;
        }

        function saveGitHubSettings(settings) {
            localStorage.setItem('githubSettings', JSON.stringify(settings));
        }

        async function saveToGitHub() {
            const settings = getGitHubSettings();

            // Check if token is set, if not prompt for it
            if (!settings.token) {
                const token = await promptForGitHubToken();
                if (!token) {
                    return; // User cancelled
                }
                settings.token = token;
                saveGitHubSettings(settings);
            }

            const saveBtn = document.getElementById('save-github-btn');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = '‚è≥ Saving to GitHub...';
            }

            try {
                // Commit pending activity logs to appData before saving
                commitPendingLogs();

                // Prepare data
                const data = { ...appData, timestamp: new Date().toISOString(), version: '3.0' };
                const dataStr = JSON.stringify(data, null, 2);
                const content = btoa(unescape(encodeURIComponent(dataStr))); // Base64 encode

                // Get current file SHA (required for updates)
                const getUrl = `https://api.github.com/repos/${settings.owner}/${settings.repo}/contents/${settings.filePath}?ref=${settings.branch}`;
                const getResponse = await fetch(getUrl, {
                    headers: {
                        'Authorization': `token ${settings.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                let sha = null;
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha;
                }

                // Update or create file
                const updateUrl = `https://api.github.com/repos/${settings.owner}/${settings.repo}/contents/${settings.filePath}`;
                const updateResponse = await fetch(updateUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${settings.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update housing data - ${new Date().toLocaleString()}`,
                        content: content,
                        branch: settings.branch,
                        ...(sha && { sha: sha })
                    })
                });

                if (updateResponse.ok) {
                    const result = await updateResponse.json();
                    alert('‚úÖ Data saved to GitHub successfully!\n\nCommit: ' + result.commit.sha.substring(0, 7));
                } else {
                    const error = await updateResponse.json();
                    throw new Error(error.message || 'Failed to save to GitHub');
                }
            } catch (error) {
                console.error('GitHub save error:', error);
                alert('‚ùå Failed to save to GitHub:\n\n' + error.message + '\n\nPlease check:\n‚Ä¢ Your GitHub token is valid\n‚Ä¢ Token has repo permissions\n‚Ä¢ Repository details are correct');
            } finally {
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'üîÑ Save to GitHub';
                }
            }
        }

        function promptForGitHubToken() {
            return new Promise((resolve) => {
                const settings = getGitHubSettings();

                const html = `
                    <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; margin: 20px auto;">
                        <h2 style="margin-bottom: 15px; color: #061d28;">üîë GitHub Personal Access Token</h2>
                        <p style="color: #666; margin-bottom: 20px;">Enter your GitHub token to save changes automatically.</p>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">GitHub Personal Access Token:</label>
                            <input type="password" id="github-token-input"
                                   style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;"
                                   placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                                   onkeypress="if(event.key==='Enter') document.getElementById('save-token-btn').click()">
                        </div>

                        <div style="margin-bottom: 20px; padding: 12px; background: #e3f2fd; border-radius: 8px; font-size: 13px;">
                            <strong style="color: #1565c0;">üìç Saving to:</strong><br>
                            <code style="color: #0d47a1; background: white; padding: 2px 6px; border-radius: 3px; display: inline-block; margin-top: 5px;">
                                ${settings.owner}/${settings.repo}/${settings.filePath}
                            </code>
                        </div>

                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button id="save-token-btn" onclick="submitGitHubToken()" class="btn btn-success" style="flex: 1; padding: 12px;">
                                ‚úÖ Save Token
                            </button>
                            <button onclick="cancelGitHubToken()" class="btn btn-secondary" style="flex: 1; padding: 12px;">
                                Cancel
                            </button>
                        </div>

                        <div style="padding: 15px; background: #ffebee; border-radius: 8px; border-left: 4px solid #f44336; margin-bottom: 15px;">
                            <strong style="color: #c62828; font-size: 14px;">üîí Security:</strong>
                            <ul style="margin: 8px 0 0 20px; line-height: 1.6; color: #c62828; font-size: 13px;">
                                <li>Token stored- ghp_0T6VF0r9igRIEfcqmovj36Mm7HBq4z0QFWg R </li>
                                <li>Never shared or visible to others</li>
                                <li>Only you have access to it</li>
                            </ul>
                        </div>

                        <div style="padding: 15px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #2196F3;">
                            <strong style="font-size: 14px;">üìñ How to get a token:</strong>
                            <ol style="margin: 8px 0 0 20px; line-height: 1.6; font-size: 13px;">
                                <li>Go to <a href="https://github.com/settings/tokens" target="_blank" style="color: #1565c0;">github.com/settings/tokens</a></li>
                                <li>Click "Generate new token (classic)"</li>
                                <li>Select <strong>"repo"</strong> scope</li>
                                <li>Copy and paste the token above</li>
                            </ol>
                        </div>
                    </div>
                `;

                const modal = document.createElement('div');
                modal.id = 'github-token-modal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; overflow-y: auto; padding: 20px; display: flex; align-items: center;';
                modal.innerHTML = html;
                document.body.appendChild(modal);

                // Focus the input
                setTimeout(() => {
                    const input = document.getElementById('github-token-input');
                    if (input) input.focus();
                }, 100);

                // Store resolve function for later use
                window._tokenPromiseResolve = resolve;
            });
        }

        function submitGitHubToken() {
            const input = document.getElementById('github-token-input');
            const token = input.value.trim();

            if (!token) {
                alert('‚ö†Ô∏è Please enter a GitHub token');
                return;
            }

            const modal = document.getElementById('github-token-modal');
            if (modal) modal.remove();

            if (window._tokenPromiseResolve) {
                window._tokenPromiseResolve(token);
                delete window._tokenPromiseResolve;
            }
        }

        function cancelGitHubToken() {
            const modal = document.getElementById('github-token-modal');
            if (modal) modal.remove();

            if (window._tokenPromiseResolve) {
                window._tokenPromiseResolve(null);
                delete window._tokenPromiseResolve;
            }
        }

        function manageGitHubToken() {
            const settings = getGitHubSettings();
            const hasToken = !!settings.token;

            const action = hasToken
                ? confirm('You have a GitHub token saved.\n\nWhat would you like to do?\n\nOK = Update token\nCancel = Remove token')
                : true;

            if (action === null) return; // User clicked Cancel on confirm

            if (!hasToken || action) {
                // Update token
                promptForGitHubToken().then(token => {
                    if (token) {
                        settings.token = token;
                        saveGitHubSettings(settings);
                        alert('‚úÖ GitHub token saved!\n\nYou can now use "Save to GitHub" to automatically save changes.');
                    }
                });
            } else {
                // Remove token
                settings.token = '';
                saveGitHubSettings(settings);
                alert('üóëÔ∏è GitHub token removed.\n\nYou will be prompted for a token next time you save.');
            }
        }

        function loadData() {
            document.getElementById('load-file').click();
        }

        function handleLoadFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.youthGroups && data.housingRooms && data.housingAssignments) {
                        if (confirm('This will replace all current data. Continue?')) {
                            appData.youthGroups = data.youthGroups;
                            appData.housingRooms = data.housingRooms;
                            appData.housingAssignments = data.housingAssignments;
                            appData.smallGroupRooms = data.smallGroupRooms || [];
                            appData.smallGroupAssignments = data.smallGroupAssignments || {};
                            appData.mealColorAssignments = data.mealColorAssignments || {};
                            
                            // Load meal times if available
                            if (data.mealTimes) {
                                appData.mealTimes = data.mealTimes;
                            }
                            
                            // Load default notes if available
                            if (data.defaultNotes) {
                                appData.defaultNotes = data.defaultNotes;
                            }
                            
                            // Load group notes if available
                            if (data.groupNotes) {
                                appData.groupNotes = data.groupNotes;
                            }
                            
                            updateAllDisplays();
                            updateHousingAssignmentDropdown();
                            updateSmallGroupAssignmentDropdown();
                            
                            alert('Data loaded successfully!');
                        }
                    } else {
                        alert('Invalid file format.');
                    }
                } catch (error) {
                    alert('Error reading file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function exportToCSV() {
            const headers = [
                'Group ID', 'Parish Name', 'Group Leader', 'Seminarian SGL', 'Religious', 'Phone Number',
                'Male Teens', 'Female Teens', 'Male Chaperones', 'Female Chaperones', 'Total People',
                'Special Accommodations', 'Meal Color', 'Male Housing Assignments', 'Female Housing Assignments', 
                'Small Group Assignments', 'Housing Assignment Status', 'Small Group Assignment Status'
            ];
            
            let csvContent = headers.join(',') + '\n';
            
            appData.youthGroups.forEach(group => {
                const totalPeople = group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;
                
                // Get housing assignments
                const maleHousingRooms = appData.housingAssignments.male[group.id] || [];
                const femaleHousingRooms = appData.housingAssignments.female[group.id] || [];
                
                const maleHousingRoomNames = maleHousingRooms.map(roomKey => {
                    const room = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                    return room ? `${room.building} - ${room.roomId}` : roomKey;
                });
                
                const femaleHousingRoomNames = femaleHousingRooms.map(roomKey => {
                    const room = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                    return room ? `${room.building} - ${room.roomId}` : roomKey;
                });
                
                // Get small group assignments
                const groupSmallGroupRooms = appData.smallGroupAssignments[group.id] || [];
                
                const groupSmallGroupRoomNames = groupSmallGroupRooms.map(roomKey => {
                    const room = appData.smallGroupRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                    return room ? `${room.building} - ${room.roomId}` : roomKey;
                });
                
                const isHousingAssigned = maleHousingRooms.length > 0 || femaleHousingRooms.length > 0;
                const isSmallGroupAssigned = groupSmallGroupRooms.length > 0;
                const mealColor = appData.mealColorAssignments[group.id] || '';
                
                const row = [
                    group.id,
                    `"${group.parish}"`,
                    `"${group.leader}"`,
                    `"${group.seminarianSgl || ''}"`,
                    `"${group.religious || ''}"`,
                    group.phone,
                    group.maleTeens,
                    group.femaleTeens,
                    group.maleChaperones,
                    group.femaleChaperones,
                    totalPeople,
                    `"${group.specialAccommodations || ''}"`,
                    mealColor,
                    `"${maleHousingRoomNames.join('; ')}"`,
                    `"${femaleHousingRoomNames.join('; ')}"`,
                    `"${groupSmallGroupRoomNames.join('; ')}"`,
                    isHousingAssigned ? 'Assigned' : 'Unassigned',
                    isSmallGroupAssigned ? 'Assigned' : 'Unassigned'
                ];
                csvContent += row.join(',') + '\n';
            });
            
            // Add housing room summary
            csvContent += '\n\nHOUSING ROOM ASSIGNMENTS SUMMARY\n';
            csvContent += 'Building,Room,Gender,Capacity,Occupied,Available,Assigned Groups\n';
            
            appData.housingRooms.forEach(room => {
                const roomKey = `${room.building}-${room.roomId}`;
                const occupiedCount = getHousingRoomOccupancy(roomKey);
                const assignedGroupsText = getHousingRoomAssignedGroupsDisplay(roomKey).replace(/<[^>]*>/g, '').replace('Assigned: ', '') || 'None';
                
                csvContent += `"${room.building}","${room.roomId}","${room.gender}",${room.capacity},${occupiedCount},${room.capacity - occupiedCount},"${assignedGroupsText}"\n`;
            });
            
            // Add small group room summary
            csvContent += '\n\nSMALL GROUP ROOM ASSIGNMENTS SUMMARY\n';
            csvContent += 'Building,Room,Gender,Capacity,Occupied,Available,Assigned Groups\n';
            
            appData.smallGroupRooms.forEach(room => {
                const roomKey = `${room.building}-${room.roomId}`;
                const occupiedCount = getSmallGroupRoomOccupancy(roomKey);
                const assignedGroupsText = getSmallGroupRoomAssignedGroupsDisplay(roomKey).replace(/<[^>]*>/g, '').replace('Assigned: ', '') || 'None';
                
                csvContent += `"${room.building}","${room.roomId}","${room.gender === 'mixed' ? 'Mixed/Co-ed' : room.gender}",${room.capacity},${occupiedCount},${room.capacity - occupiedCount},"${assignedGroupsText}"\n`;
            });
            
            // Add meal color summary
            csvContent += '\n\nMEAL COLOR ASSIGNMENTS SUMMARY\n';
            csvContent += 'Meal Color,Groups Assigned,Total People\n';
            
            const mealColorSummary = {};
            MEAL_COLORS.forEach(color => {
                mealColorSummary[color] = { groups: 0, people: 0 };
            });
            
            Object.keys(appData.mealColorAssignments).forEach(groupId => {
                const color = appData.mealColorAssignments[groupId];
                const group = appData.youthGroups.find(g => g.id === groupId);
                if (group && color && mealColorSummary[color]) {
                    mealColorSummary[color].groups++;
                    mealColorSummary[color].people += group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;
                }
            });
            
            MEAL_COLORS.forEach(color => {
                csvContent += `${color},${mealColorSummary[color].groups},${mealColorSummary[color].people}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `mount2k_complete_assignments_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('Complete housing, small group, and meal color data exported successfully! The CSV includes separate sections for all assignments.');
        }

        function exportCompleteHTML() {
            // Get the current HTML content
            let htmlContent = document.documentElement.outerHTML;
            
            // Create the new loadSampleData function with current data
            const currentDataString = `
            appData.youthGroups = ${JSON.stringify(appData.youthGroups, null, 12)};

            appData.housingRooms = ${JSON.stringify(appData.housingRooms, null, 12)};

            appData.smallGroupRooms = ${JSON.stringify(appData.smallGroupRooms, null, 12)};

            appData.housingAssignments = ${JSON.stringify(appData.housingAssignments, null, 12)};
            appData.smallGroupAssignments = ${JSON.stringify(appData.smallGroupAssignments, null, 12)};`;

            // Find and replace the loadSampleData function content
            const loadSampleDataRegex = /function loadSampleData\(\) \{[\s\S]*?appData\.groupNotes = \{\};[\s\S]*?\}/;
            
            const newLoadSampleDataFunction = `function loadSampleData() {
            ${currentDataString}
        }`;

            // Replace the function in the HTML
            htmlContent = htmlContent.replace(loadSampleDataRegex, newLoadSampleDataFunction);
            
            // Add a comment at the top indicating this is a saved version
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            htmlContent = htmlContent.replace(
                '<title>Mount 2K Management System</title>',
                `<title>Mount 2K Management System - Saved ${new Date().toLocaleDateString()}</title>`
            );
            
            // Create and download the file
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `mount2k_housing_system_complete_${timestamp.split('T')[0]}.html`;
            link.click();
            
            alert('Complete HTML site exported! üåê\n\nYou can now upload this HTML file to any web host and it will load with all your current assignments. The file includes:\n‚Ä¢ All youth groups\n‚Ä¢ All room assignments\n‚Ä¢ All small group assignments\n\nJust upload the HTML file to your hosting service!');
        }

        // ===== PASSWORD PROTECTION =====
        let systemConfig = null;
        const FALLBACK_PASSWORD_HASH = '11928902f4159816e88d463509a2d7c993060f78d664d96127626b9907ac8b18'; // Mount2K2026

        async function loadSystemConfig() {
            try {
                const response = await fetch('m2k_config.json');
                if (!response.ok) {
                    console.warn('Config file not found, using fallback password');
                    return null;
                }
                systemConfig = await response.json();
                console.log('Config loaded successfully');
                return systemConfig;
            } catch (error) {
                console.error('Error loading config:', error);
                console.warn('Using fallback password hash');
                // Fallback to hardcoded hash
                return null;
            }
        }

        async function hashPassword(password) {
            // Check if crypto.subtle is available (requires HTTPS or localhost)
            if (!window.crypto || !window.crypto.subtle) {
                throw new Error('HTTPS_REQUIRED');
            }

            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        async function checkPassword() {
            try {
                console.log('checkPassword function called');
                const usernameInput = document.getElementById('username-input');
                const passwordInput = document.getElementById('password-input');
                const errorDiv = document.getElementById('password-error');

                if (!passwordInput || !errorDiv) {
                    console.error('Password input or error div not found');
                    return;
                }

                const enteredUsername = usernameInput ? usernameInput.value.trim() : '';
                const enteredPassword = passwordInput.value.trim();

                if (!enteredPassword) {
                    errorDiv.textContent = '‚ö†Ô∏è Please enter a password';
                    errorDiv.style.display = 'block';
                    return;
                }

                const hashedInput = await hashPassword(enteredPassword);
                console.log('Password hashed successfully');

                // Check if we have users configured
                if (appData.users && appData.users.length > 0) {
                    // Multi-user authentication
                    if (!enteredUsername) {
                        errorDiv.textContent = '‚ö†Ô∏è Please enter a username';
                        errorDiv.style.display = 'block';
                        return;
                    }

                    const user = appData.users.find(u => u.username === enteredUsername && u.isActive);

                    if (user && user.passwordHash === hashedInput) {
                        console.log('User authenticated:', user.username);
                        unlockSystem(user);
                    } else {
                        console.log('Invalid username or password');
                        errorDiv.textContent = '‚ùå Invalid username or password. Please try again.';
                        errorDiv.style.display = 'block';
                        passwordInput.value = '';
                        passwordInput.focus();

                        // Shake animation
                        passwordInput.style.animation = 'shake 0.5s';
                        setTimeout(() => passwordInput.style.animation = '', 500);
                    }
                } else {
                    // Fallback to single password mode (backward compatibility)
                    let passwordHash = null;
                    if (systemConfig && systemConfig.passwordHash) {
                        passwordHash = systemConfig.passwordHash;
                        console.log('Using config password');
                    } else {
                        passwordHash = FALLBACK_PASSWORD_HASH;
                        console.log('Using fallback password');
                    }

                    if (hashedInput === passwordHash) {
                        console.log('Password correct, unlocking system');
                        unlockSystem({ username: 'admin', fullName: 'Administrator', role: 'admin' });
                    } else {
                        console.log('Password incorrect');
                        errorDiv.textContent = '‚ùå Incorrect password. Please try again.';
                        errorDiv.style.display = 'block';
                        passwordInput.value = '';
                        passwordInput.focus();

                        // Shake animation
                        passwordInput.style.animation = 'shake 0.5s';
                        setTimeout(() => passwordInput.style.animation = '', 500);
                    }
                }
            } catch (error) {
                console.error('Error in checkPassword:', error);
                const errorDiv = document.getElementById('password-error');
                if (errorDiv) {
                    if (error.message === 'HTTPS_REQUIRED') {
                        errorDiv.innerHTML = 'üîí <strong>HTTPS Required</strong><br>Please access this site using <strong>https://</strong> (not http://)<br><br>Example: <strong>https://m2kportal.github.io/master.html</strong>';
                    } else {
                        errorDiv.textContent = '‚ùå Error checking password. Please refresh and try again.';
                    }
                    errorDiv.style.display = 'block';
                }
            }
        }

        function unlockSystem(user) {
            document.getElementById('password-overlay').style.display = 'none';
            document.getElementById('main-content').classList.add('unlocked');

            // Set current user
            currentUser = user;

            // Set session authentication
            sessionStorage.setItem('authenticated', 'true');
            sessionStorage.setItem('currentUser', JSON.stringify(user));

            // Show welcome popup
            alert(`üëã Hello, welcome ${user.fullName}!`);

            // Update header with welcome message
            updateWelcomeHeader();

            // Hide admin-only tabs for non-admin users
            updateTabsBasedOnRole();

            // Store login time (will be logged on Master Save if user makes changes)
            userLoginTime = new Date().toISOString();

            console.log('System unlocked for user:', user.username);
        }

        function updateTabsBasedOnRole() {
            // Hide activity reports menu item for non-admin users
            const activityReportsMenu = document.getElementById('activity-reports-menu');
            if (activityReportsMenu && currentUser) {
                if (currentUser.role === 'admin' || currentUser.isAdmin) {
                    activityReportsMenu.style.display = 'block';
                } else {
                    activityReportsMenu.style.display = 'none';
                }
            }

            // Hide subtitle editor for non-admin users
            const subtitleEditor = document.getElementById('subtitle-editor');
            if (subtitleEditor && currentUser) {
                if (currentUser.role === 'admin' || currentUser.isAdmin) {
                    subtitleEditor.style.display = 'block';
                } else {
                    subtitleEditor.style.display = 'none';
                }
            }
        }

        function updateWelcomeHeader() {
            const welcomeEl = document.getElementById('welcome-user');
            if (welcomeEl && currentUser) {
                welcomeEl.textContent = `Welcome, ${currentUser.fullName}`;
                welcomeEl.style.display = 'inline-block';
            }
        }

        async function logout() {
            // Check if there are pending changes
            if (pendingActivityLogs.length > 0) {
                const saveChanges = confirm('You have unsaved changes.\n\nDo you want to save before logging out?\n\n‚Ä¢ Click OK to save and logout\n‚Ä¢ Click Cancel to logout without saving');

                if (saveChanges) {
                    // Try to save to GitHub
                    try {
                        await saveToGitHub();
                        // saveToGitHub will commit pending logs and show success message
                    } catch (error) {
                        const continuueLogout = confirm('Failed to save changes:\n\n' + error.message + '\n\nDo you still want to logout without saving?');
                        if (!continuueLogout) {
                            return; // Cancel logout
                        }
                    }
                }
            }

            // Log the logout activity
            if (currentUser) {
                const logoutLog = {
                    id: Date.now() + '_logout_' + Math.random().toString(36).substr(2, 9),
                    timestamp: new Date().toISOString(),
                    username: currentUser.username,
                    fullName: currentUser.fullName,
                    action: 'logout',
                    entityType: 'system',
                    entityId: null,
                    details: `User logged out: ${currentUser.fullName} (@${currentUser.username})`
                };
                // Save logout immediately to appData (not pending)
                appData.activityLogs.push(logoutLog);
            }

            // Clear pending logs and login time
            pendingActivityLogs = [];
            userLoginTime = null;

            // Clear session
            sessionStorage.removeItem('authenticated');
            sessionStorage.removeItem('currentUser');
            currentUser = null;

            // Show success message
            alert('‚úÖ Logout successful!\n\nRedirecting to dashboard...');

            // Redirect to index.html
            window.location.href = 'https://m2kportal.github.io/index.html';
        }

        async function initPasswordSystem() {
            // Check if the site is being accessed via HTTPS
            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                const errorDiv = document.getElementById('password-error');
                if (errorDiv) {
                    errorDiv.innerHTML = 'üîí <strong>HTTPS Required</strong><br>This site must be accessed using <strong>https://</strong> for security.<br><br>Please visit: <strong>https://' + window.location.host + window.location.pathname + '</strong>';
                    errorDiv.style.display = 'block';
                }
            }

            // Load credentials from GitHub first
            await loadCredentialsFromGitHub();

            // Load config from GitHub (legacy)
            await loadSystemConfig();

            // Check if already authenticated in this session
            if (sessionStorage.getItem('authenticated') === 'true') {
                const savedUser = sessionStorage.getItem('currentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    console.log('Restored user session:', currentUser.username);
                    // Show welcome message in header
                    updateWelcomeHeader();
                    // Update tabs based on role
                    updateTabsBasedOnRole();
                } else {
                    currentUser = { username: 'admin', fullName: 'Administrator', role: 'admin', isAdmin: true };
                }
                document.getElementById('password-overlay').style.display = 'none';
                document.getElementById('main-content').classList.add('unlocked');
                return;
            }

            const setupMode = document.getElementById('password-setup-mode');
            const btnText = document.getElementById('password-btn-text');
            const passwordInput = document.getElementById('password-input');
            const usernameFieldGroup = document.getElementById('username-field-group');
            const usernameInput = document.getElementById('username-input');
            const loginNoteText = document.getElementById('login-note-text');

            // Always hide setup mode since we use multi-user mode
            setupMode.style.display = 'none';
            btnText.textContent = 'üîì Unlock';

            // Always use multi-user mode
            usernameFieldGroup.style.display = 'block';
            usernameInput.placeholder = 'Enter username';
            passwordInput.placeholder = 'Enter password';
            loginNoteText.textContent = 'Please enter your username and password to access the system.';
            console.log('‚úÖ Multi-user mode enabled - ' + appData.users.length + ' users loaded');
            usernameInput.focus();
        }

        // Add shake animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
                20%, 40%, 60%, 80% { transform: translateX(10px); }
            }
        `;
        document.head.appendChild(style);

        // ===== ACTIVITY LOGGING FUNCTIONS =====
        function logActivity(action, entityType, entityId, details) {
            if (!currentUser) return;

            const log = {
                id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                timestamp: new Date().toISOString(),
                username: currentUser.username,
                fullName: currentUser.fullName,
                action: action,  // 'create', 'update', 'delete', 'login', 'logout'
                entityType: entityType,  // 'youth-group', 'room', 'assignment', 'user', etc.
                entityId: entityId,
                details: details
            };

            // Store in pending logs (will be committed on Master Save)
            pendingActivityLogs.push(log);
            console.log('Activity logged (pending):', log);
        }

        function commitPendingLogs() {
            // Move all pending logs to appData.activityLogs
            if (pendingActivityLogs.length > 0) {
                // Add login log if user made changes
                if (userLoginTime && currentUser) {
                    const loginLog = {
                        id: Date.now() + '_login_' + Math.random().toString(36).substr(2, 9),
                        timestamp: userLoginTime,
                        username: currentUser.username,
                        fullName: currentUser.fullName,
                        action: 'login',
                        entityType: 'system',
                        entityId: null,
                        details: `User logged in: ${currentUser.fullName} (@${currentUser.username})`
                    };
                    appData.activityLogs.push(loginLog);
                }

                // Add all pending logs
                appData.activityLogs.push(...pendingActivityLogs);
                console.log(`Committed ${pendingActivityLogs.length} pending activity logs`);

                // Clear pending logs
                pendingActivityLogs = [];
                userLoginTime = null;  // Reset login time after save
            }
        }

        function displayActivityReports() {
            const container = document.getElementById('activity-reports-list');
            const countSpan = document.getElementById('activity-count');

            if (!appData.activityLogs || appData.activityLogs.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #666;">No activity logs found</div>';
                countSpan.textContent = '0';
                return;
            }

            // Sort by timestamp descending (newest first)
            const sortedLogs = [...appData.activityLogs].sort((a, b) =>
                new Date(b.timestamp) - new Date(a.timestamp)
            );

            countSpan.textContent = sortedLogs.length;

            const html = sortedLogs.map(log => {
                const date = new Date(log.timestamp);
                const formattedDate = date.toLocaleString();

                let actionColor = '#3b82f6';
                let actionIcon = 'üìù';

                switch(log.action) {
                    case 'create': actionColor = '#10b981'; actionIcon = '‚ûï'; break;
                    case 'update': actionColor = '#f59e0b'; actionIcon = '‚úèÔ∏è'; break;
                    case 'delete': actionColor = '#ef4444'; actionIcon = 'üóëÔ∏è'; break;
                    case 'login': actionColor = '#8b5cf6'; actionIcon = 'üîì'; break;
                    case 'logout': actionColor = '#6b7280'; actionIcon = 'üîí'; break;
                }

                return `
                    <div style="border-bottom: 1px solid #e5e7eb; padding: 16px; transition: background 0.2s;"
                         onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'"
                         data-log-user="${log.username}" data-log-action="${log.action}" data-log-date="${date.toISOString().split('T')[0]}">
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 15px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 20px;">${actionIcon}</span>
                                    <span style="background: ${actionColor}; color: white; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; text-transform: uppercase;">
                                        ${log.action}
                                    </span>
                                    <span style="color: #6b7280; font-size: 13px;">${log.entityType}</span>
                                </div>
                                <div style="margin-bottom: 6px;">
                                    <strong style="color: #1f2937;">${log.fullName}</strong>
                                    <span style="color: #9ca3af; font-size: 13px;"> (@${log.username})</span>
                                </div>
                                <div style="color: #4b5563; font-size: 14px; margin-bottom: 4px;">
                                    ${log.details || 'No additional details'}
                                </div>
                                <div style="color: #9ca3af; font-size: 12px;">
                                    üïí ${formattedDate}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function filterActivityReports() {
            const userFilter = document.getElementById('report-user-filter').value;
            const actionFilter = document.getElementById('report-action-filter').value;
            const dateFrom = document.getElementById('report-date-from').value;
            const dateTo = document.getElementById('report-date-to').value;

            const allLogs = document.querySelectorAll('#activity-reports-list > div');
            let visibleCount = 0;

            allLogs.forEach(logDiv => {
                const username = logDiv.getAttribute('data-log-user');
                const action = logDiv.getAttribute('data-log-action');
                const logDate = logDiv.getAttribute('data-log-date');

                let show = true;

                if (userFilter && username !== userFilter) show = false;
                if (actionFilter && action !== actionFilter) show = false;
                if (dateFrom && logDate < dateFrom) show = false;
                if (dateTo && logDate > dateTo) show = false;

                logDiv.style.display = show ? '' : 'none';
                if (show) visibleCount++;
            });

            document.getElementById('activity-count').textContent = visibleCount;
        }

        function exportActivityReports() {
            if (!appData.activityLogs || appData.activityLogs.length === 0) {
                alert('No activity logs to export');
                return;
            }

            // Create CSV content
            const headers = ['Timestamp', 'Username', 'Full Name', 'Action', 'Entity Type', 'Entity ID', 'Details'];
            const rows = appData.activityLogs.map(log => [
                log.timestamp,
                log.username,
                log.fullName,
                log.action,
                log.entityType,
                log.entityId || '',
                log.details || ''
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `activity-report-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('‚úÖ Activity report exported successfully!');
        }

        function clearActivityReports() {
            if (!confirm('‚ö†Ô∏è Are you sure you want to clear all activity logs? This action cannot be undone.')) {
                return;
            }

            appData.activityLogs = [];
            displayActivityReports();
            alert('‚úÖ All activity logs have been cleared');

            logActivity('delete', 'system', 'activity-logs', 'Cleared all activity logs');
        }

        // ===== CREDENTIAL PERSISTENCE SYSTEM =====
        // This system automatically saves all login credentials to GitHub whenever passwords are changed

        async function loadCredentialsFromGitHub() {
            const settings = getGitHubSettings();

            try {
                const getUrl = `https://api.github.com/repos/${settings.owner}/${settings.repo}/contents/m2k_credentials.json?ref=${settings.branch}`;
                const getResponse = await fetch(getUrl, {
                    headers: {
                        'Authorization': settings.token ? `token ${settings.token}` : '',
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    const content = atob(fileData.content.replace(/\n/g, ''));
                    const credentialData = JSON.parse(content);

                    // Load users into appData
                    appData.users = credentialData.users || [];

                    console.log(`‚úÖ Loaded ${appData.users.length} users from GitHub`);
                    return credentialData;
                } else if (getResponse.status === 404) {
                    console.log('‚ÑπÔ∏è No credentials file found on GitHub, will create on first save');
                    // Initialize with default admin users
                    appData.users = await createInitialUsers();
                    return null;
                } else {
                    console.error('Failed to load credentials from GitHub');
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Error loading credentials from GitHub:', error);
                // Initialize with default users if GitHub load fails
                if (!appData.users || appData.users.length === 0) {
                    appData.users = await createInitialUsers();
                }
                return null;
            }
        }

        async function createInitialUsers() {
            // Create initial users if none exist
            const initialUsers = [
                {
                    id: Date.now() + '_juang',
                    username: 'juang',
                    fullName: 'Juan G',
                    passwordHash: await hashPassword('M2K'),
                    role: 'admin',
                    isAdmin: true,
                    createdAt: new Date().toISOString(),
                    isActive: true
                },
                {
                    id: Date.now() + '_isaac',
                    username: 'isaac',
                    fullName: 'Isaac Cross',
                    passwordHash: await hashPassword('M2K'),
                    role: 'user',
                    isAdmin: false,
                    createdAt: new Date().toISOString(),
                    isActive: true
                },
                {
                    id: Date.now() + '_martin',
                    username: 'martin',
                    fullName: 'Martin',
                    passwordHash: await hashPassword('M2K'),
                    role: 'user',
                    isAdmin: false,
                    createdAt: new Date().toISOString(),
                    isActive: true
                }
            ];

            console.log('‚úÖ Created initial 3 users');
            return initialUsers;
        }

        async function saveCredentialsToGitHub() {
            const settings = getGitHubSettings();

            // Check if token is set
            if (!settings.token) {
                alert('‚ö†Ô∏è GitHub token is required. Please head to Settings and enter your token.');
                return false;
            }

            try {
                const credentialData = {
                    timestamp: new Date().toISOString(),
                    systemInfo: {
                        name: 'Mount 2K Housing System',
                        version: '3.0',
                        lastUpdate: new Date().toISOString()
                    },
                    users: appData.users ? appData.users.map(user => ({
                        id: user.id,
                        username: user.username,
                        fullName: user.fullName,
                        passwordHash: user.passwordHash,
                        role: user.role,
                        isAdmin: user.isAdmin || false,
                        createdAt: user.createdAt,
                        isActive: user.isActive
                    })) : [],
                    totalUsers: appData.users ? appData.users.length : 0
                };

                const dataStr = JSON.stringify(credentialData, null, 2);
                const content = btoa(unescape(encodeURIComponent(dataStr)));

                // Get current file SHA
                const getUrl = `https://api.github.com/repos/${settings.owner}/${settings.repo}/contents/m2k_credentials.json?ref=${settings.branch}`;
                const getResponse = await fetch(getUrl, {
                    headers: {
                        'Authorization': `token ${settings.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                let sha = null;
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha;
                }

                // Update or create file
                const updateUrl = `https://api.github.com/repos/${settings.owner}/${settings.repo}/contents/m2k_credentials.json`;
                const updateResponse = await fetch(updateUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${settings.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update credentials - ${new Date().toLocaleString()}`,
                        content: content,
                        branch: settings.branch,
                        ...(sha && { sha: sha })
                    })
                });

                if (updateResponse.ok) {
                    console.log('‚úÖ Credentials saved to GitHub');

                    // Also save to localStorage as backup
                    localStorage.setItem('m2k_credentials_backup', dataStr);

                    return true;
                } else {
                    const error = await updateResponse.json();
                    console.error('Failed to save credentials:', error);
                    alert('‚ùå Failed to save credentials to GitHub: ' + error.message);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error saving credentials to GitHub:', error);
                alert('‚ùå Error saving credentials to GitHub: ' + error.message);
                return false;
            }
        }

        function saveCredentialsToStorage() {
            // Legacy function - now redirects to GitHub save
            return saveCredentialsToGitHub();
        }

        function exportCredentials() {
            const credentialData = saveCredentialsToStorage();

            if (!credentialData) {
                alert('‚ùå Failed to prepare credential data for export');
                return;
            }

            // Create downloadable JSON file
            const dataStr = JSON.stringify(credentialData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
            link.download = `m2k_credentials_backup_${timestamp}.json`;
            link.click();

            alert(`‚úÖ Credentials exported successfully!\n\nüì¶ File: m2k_credentials_backup_${timestamp}.json\nüë• Users: ${credentialData.totalUsers}\n‚è∞ Timestamp: ${new Date().toLocaleString()}`);

            logActivity('export', 'credentials', 'system', `Exported credentials backup with ${credentialData.totalUsers} users`);
        }

        function importCredentials() {
            if (!confirm('‚ö†Ô∏è WARNING: Importing credentials will restore all user accounts and passwords from a backup file.\n\nThis will:\n‚Ä¢ Restore all users from the backup\n‚Ä¢ Overwrite current user data\n‚Ä¢ NOT affect room assignments or other data\n\nDo you want to continue?')) {
                return;
            }

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = async (e) => {
                try {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const credentialData = JSON.parse(event.target.result);

                            // Validate the data structure
                            if (!credentialData.systemInfo || !credentialData.users) {
                                alert('‚ùå Invalid credential backup file format');
                                return;
                            }

                            // Restore users
                            appData.users = credentialData.users;

                            // Save to localStorage
                            saveCredentialsToStorage();

                            // Refresh display
                            displayUsers();

                            alert(`‚úÖ Credentials imported successfully!\n\nüë• Users restored: ${credentialData.users.length}\nüìÖ Backup date: ${new Date(credentialData.timestamp).toLocaleString()}`);

                            logActivity('import', 'credentials', 'system', `Imported credentials backup with ${credentialData.users.length} users`);
                        } catch (error) {
                            console.error('Error parsing credential file:', error);
                            alert('‚ùå Error reading credential backup file. Please ensure it\'s a valid JSON file.');
                        }
                    };

                    reader.readAsText(file);
                } catch (error) {
                    console.error('Error importing credentials:', error);
                    alert('‚ùå Error importing credentials. Please try again.');
                }
            };

            input.click();
        }

        function loadCredentialsFromStorage() {
            try {
                const stored = localStorage.getItem('m2k_credentials_backup');
                if (stored) {
                    const credentialData = JSON.parse(stored);
                    console.log(`üì¶ Found stored credentials backup from ${credentialData.timestamp}`);
                    console.log(`üë• Users in backup: ${credentialData.totalUsers}`);

                    // Show detailed info in an alert
                    const backupDate = new Date(credentialData.timestamp).toLocaleString();
                    const userList = credentialData.users.map(u => `  ‚Ä¢ ${u.fullName} (@${u.username}) - ${u.role}`).join('\n');

                    alert(`üì¶ Stored Credentials Backup Info\n\n` +
                          `üìÖ Last Updated: ${backupDate}\n` +
                          `üë• Total Users: ${credentialData.totalUsers}\n` +
                          `üîê System: ${credentialData.systemInfo.name}\n` +
                          `üìå Version: ${credentialData.systemInfo.version}\n\n` +
                          `Users in backup:\n${userList || '  No users found'}\n\n` +
                          `üíæ Storage: Browser localStorage\n` +
                          `üîÑ Auto-saves: Whenever passwords change`);

                    return credentialData;
                }

                alert('‚ÑπÔ∏è No stored credentials backup found.\n\n' +
                      'Credentials will be automatically backed up to localStorage when you:\n' +
                      '‚Ä¢ Add a new user\n' +
                      '‚Ä¢ Edit a user\'s password\n' +
                      '‚Ä¢ Delete a user');

                return null;
            } catch (error) {
                console.error('Error loading credentials from storage:', error);
                alert('‚ùå Error loading stored credentials. The backup may be corrupted.');
                return null;
            }
        }

        async function autoSaveCredentials() {
            // Automatically save credentials to GitHub
            const saved = await saveCredentialsToGitHub();
            if (saved) {
                console.log(`üîÑ Auto-saved credentials to GitHub`);
            }
        }

        // ===== CLEAR DATA FUNCTIONS (ADMIN ONLY) =====
        function clearHousingData() {
            // Check admin permission
            if (!currentUser || !currentUser.isAdmin) {
                alert('‚ùå Access Denied: Only administrators can clear housing data.');
                return;
            }

            const password = prompt('‚ö†Ô∏è WARNING: This will permanently delete all housing assignments!\n\nEnter your password to confirm:');
            if (!password) return;

            // Verify password
            hashPassword(password).then(hash => {
                if (hash === currentUser.passwordHash) {
                    if (confirm('‚ö†Ô∏è FINAL CONFIRMATION: Are you absolutely sure you want to clear all housing assignments? This cannot be undone!')) {
                        // Clear housing assignments
                        appData.housingAssignments.male = {};
                        appData.housingAssignments.female = {};

                        alert('‚úÖ Housing information cleared successfully!');
                        logActivity('delete', 'system', 'housing-data', 'Cleared all housing assignments');

                        // Refresh displays
                        updateStats();
                        displayGroups();
                    }
                } else {
                    alert('‚ùå Incorrect password. Action cancelled.');
                }
            });
        }

        function clearSmallGroupData() {
            // Check admin permission
            if (!currentUser || !currentUser.isAdmin) {
                alert('‚ùå Access Denied: Only administrators can clear small group data.');
                return;
            }

            const password = prompt('‚ö†Ô∏è WARNING: This will permanently delete all small group locations!\n\nEnter your password to confirm:');
            if (!password) return;

            // Verify password
            hashPassword(password).then(hash => {
                if (hash === currentUser.passwordHash) {
                    if (confirm('‚ö†Ô∏è FINAL CONFIRMATION: Are you absolutely sure you want to clear all small group locations? This cannot be undone!')) {
                        // Clear small group assignments
                        appData.smallGroupAssignments = {};

                        alert('‚úÖ Small group locations cleared successfully!');
                        logActivity('delete', 'system', 'small-group-data', 'Cleared all small group locations');

                        // Refresh displays
                        updateStats();
                        displayGroups();
                    }
                } else {
                    alert('‚ùå Incorrect password. Action cancelled.');
                }
            });
        }

        function clearAllData() {
            // Check admin permission
            if (!currentUser || !currentUser.isAdmin) {
                alert('‚ùå Access Denied: Only administrators can clear all data.');
                return;
            }

            const password = prompt('‚ö†Ô∏è EXTREME WARNING: This will permanently delete EVERYTHING!\n\n' +
                'This includes:\n' +
                '‚Ä¢ All youth groups\n' +
                '‚Ä¢ All housing assignments\n' +
                '‚Ä¢ All small group locations\n' +
                '‚Ä¢ All room definitions\n' +
                '‚Ä¢ All notes and configurations\n\n' +
                'Enter your password to confirm:');
            if (!password) return;

            // Verify password
            hashPassword(password).then(hash => {
                if (hash === currentUser.passwordHash) {
                    const confirmText = prompt('‚ö†Ô∏è FINAL CONFIRMATION: Type "DELETE EVERYTHING" to proceed:');
                    if (confirmText === 'DELETE EVERYTHING') {
                        // Clear all data
                        appData.groups = [];
                        appData.rooms = [];
                        appData.housingRooms = [];
                        appData.smallGroupRooms = [];
                        appData.groupNotes = {};
                        appData.roomNotes = {};
                        appData.adaIndividuals = [];

                        alert('‚úÖ All data cleared successfully! The system has been reset.');
                        logActivity('delete', 'system', 'all-data', 'Cleared all system data');

                        // Refresh all displays
                        updateStats();
                        displayGroups();
                        displayRooms();
                    } else {
                        alert('‚ùå Confirmation text incorrect. Action cancelled.');
                    }
                } else {
                    alert('‚ùå Incorrect password. Action cancelled.');
                }
            });
        }

        // ===== CLEAR DATA SECTION TOGGLE =====
        function toggleClearDataSection() {
            const section = document.getElementById('admin-clear-section');
            const chevron = document.getElementById('clear-data-chevron');

            if (section.style.display === 'none' || !section.style.display) {
                section.style.display = 'block';
                chevron.style.transform = 'rotate(180deg)';
            } else {
                section.style.display = 'none';
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        // ===== CHECKBOX-BASED DATA DELETION =====
        function clearDataCheckboxes() {
            document.getElementById('clear-housing-info').checked = false;
            document.getElementById('clear-small-group-info').checked = false;
            document.getElementById('clear-youth-groups').checked = false;
            document.getElementById('clear-rooms').checked = false;
            document.getElementById('clear-small-group-rooms').checked = false;
        }

        async function clearSelectedData() {
            // Check admin permission
            if (!currentUser || !currentUser.isAdmin) {
                alert('‚ùå Access Denied: Only administrators can delete data.');
                return;
            }

            // Get selected checkboxes
            const clearHousing = document.getElementById('clear-housing-info').checked;
            const clearSmallGroup = document.getElementById('clear-small-group-info').checked;
            const clearYouthGroups = document.getElementById('clear-youth-groups').checked;
            const clearRooms = document.getElementById('clear-rooms').checked;
            const clearSmallGroupRooms = document.getElementById('clear-small-group-rooms').checked;

            // Check if at least one is selected
            if (!clearHousing && !clearSmallGroup && !clearYouthGroups && !clearRooms && !clearSmallGroupRooms) {
                alert('‚ö†Ô∏è Please select at least one item to delete.');
                return;
            }

            // Build confirmation message
            let itemsList = [];
            if (clearHousing) itemsList.push('‚Ä¢ Housing Assignments');
            if (clearSmallGroup) itemsList.push('‚Ä¢ Small Group Assignments');
            if (clearYouthGroups) itemsList.push('‚Ä¢ Youth Group Information');
            if (clearRooms) itemsList.push('‚Ä¢ Housing Rooms');
            if (clearSmallGroupRooms) itemsList.push('‚Ä¢ Small Group Rooms');

            // Step 1: Type safety phrase
            const safetyPhrase = prompt('‚ö†Ô∏è DANGER: This will permanently delete:\n\n' +
                itemsList.join('\n') + '\n\n' +
                'Type "DELETE" (all caps) to continue:');

            if (safetyPhrase !== 'DELETE') {
                if (safetyPhrase !== null) {
                    alert('‚ùå Safety phrase incorrect. Action cancelled.');
                }
                return;
            }

            // Step 2: Enter password
            const password = prompt('‚ö†Ô∏è STEP 2: Enter your password to confirm deletion:');
            if (!password) return;

            // Verify password
            const hash = await hashPassword(password);
            if (hash !== currentUser.passwordHash) {
                alert('‚ùå Incorrect password. Action cancelled.');
                return;
            }

            // Step 3: Final confirmation
            if (!confirm('‚ö†Ô∏è FINAL CONFIRMATION:\n\nThis will permanently delete the selected data.\n\nAre you absolutely sure? This CANNOT be undone!')) {
                return;
            }

            // Perform deletions
            let deletedItems = [];

            if (clearHousing) {
                // Clear all housing assignments
                appData.housingAssignments.male = {};
                appData.housingAssignments.female = {};
                deletedItems.push('Housing Assignments');
                logActivity('delete', 'system', 'housing-data', 'Cleared all housing assignments');
            }

            if (clearSmallGroup) {
                // Clear all small group assignments
                appData.smallGroupAssignments = {};
                deletedItems.push('Small Group Assignments');
                logActivity('delete', 'system', 'small-group-data', 'Cleared all small group assignments');
            }

            if (clearYouthGroups) {
                appData.youthGroups = [];
                deletedItems.push('Youth Group Information');
                logActivity('delete', 'system', 'youth-groups', 'Cleared all youth groups');
            }

            if (clearRooms) {
                appData.housingRooms = [];
                deletedItems.push('Housing Rooms');
                logActivity('delete', 'system', 'housing-rooms', 'Cleared all housing rooms');
            }

            if (clearSmallGroupRooms) {
                appData.smallGroupRooms = [];
                deletedItems.push('Small Group Rooms');
                logActivity('delete', 'system', 'small-group-rooms', 'Cleared all small group rooms');
            }

            // Clear checkboxes
            clearDataCheckboxes();

            // Refresh displays
            updateStats();
            displayGroups();
            displayRooms();

            alert('‚úÖ Successfully deleted:\n\n' + deletedItems.map(item => '‚Ä¢ ' + item).join('\n'));
        }

        // ===== USER MANAGEMENT FUNCTIONS =====
        async function addUser() {
            // Check admin permission
            if (!currentUser || !currentUser.isAdmin) {
                alert('‚ùå Access Denied: Only administrators can add users.');
                return;
            }

            const username = document.getElementById('new-username').value.trim();
            const fullName = document.getElementById('new-user-fullname').value.trim();
            const password = document.getElementById('new-user-password').value;
            const role = document.getElementById('new-user-role').value;
            const isAdmin = document.getElementById('new-user-is-admin').checked;

            if (!username || !fullName || !password) {
                alert('‚ö†Ô∏è Please fill in all required fields');
                return;
            }

            // Check if username already exists
            if (appData.users && appData.users.some(u => u.username === username)) {
                alert('‚ö†Ô∏è Username already exists. Please choose a different username.');
                return;
            }

            // Hash the password
            const passwordHash = await hashPassword(password);

            const newUser = {
                id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                username: username,
                fullName: fullName,
                passwordHash: passwordHash,
                role: role,
                isAdmin: isAdmin,
                createdAt: new Date().toISOString(),
                isActive: true
            };

            if (!appData.users) appData.users = [];
            appData.users.push(newUser);

            // Auto-save credentials to GitHub
            await autoSaveCredentials();

            displayUsers();
            clearUserForm();
            alert('‚úÖ User added successfully and saved to GitHub!');

            logActivity('create', 'user', newUser.id, `Created user: ${fullName} (@${username}) - Admin: ${isAdmin}`);
        }

        function clearUserForm() {
            document.getElementById('new-username').value = '';
            document.getElementById('new-user-fullname').value = '';
            document.getElementById('new-user-password').value = '';
            document.getElementById('new-user-role').value = 'user';
            document.getElementById('new-user-is-admin').checked = false;
        }

        function displayUsers() {
            const container = document.getElementById('users-list');

            if (!appData.users || appData.users.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #666; background: white; border-radius: 8px;">No users found. Add a user to get started.</div>';
                return;
            }

            const html = appData.users.map(user => {
                const roleColors = {
                    admin: { bg: '#fee2e2', text: '#dc2626', border: '#fecaca' },
                    editor: { bg: '#dbeafe', text: '#2563eb', border: '#bfdbfe' },
                    viewer: { bg: '#e0e7ff', text: '#4f46e5', border: '#c7d2fe' }
                };

                const colors = roleColors[user.role] || roleColors.viewer;
                const createdDate = new Date(user.createdAt).toLocaleDateString();

                return `
                    <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #e5e7eb;"
                         data-user-search="${user.username.toLowerCase()} ${user.fullName.toLowerCase()}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <div style="font-size: 18px; font-weight: 700; color: #1f2937; margin-bottom: 6px;">
                                    ${user.fullName}
                                </div>
                                <div style="color: #6b7280; margin-bottom: 8px;">
                                    @${user.username}
                                </div>
                                <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                    <span style="background: ${colors.bg}; color: ${colors.text}; border: 1px solid ${colors.border}; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; text-transform: uppercase;">
                                        ${user.role}
                                    </span>
                                    ${user.isAdmin ? '<span style="background: #fef3c7; color: #92400e; border: 1px solid #fde68a; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">‚≠ê ADMIN</span>' : ''}
                                    <span style="color: #9ca3af; font-size: 13px;">
                                        Created: ${createdDate}
                                    </span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="editUser('${user.id}')" class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button onclick="deleteUser('${user.id}')" class="btn btn-danger" style="padding: 8px 16px; font-size: 13px;">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;

            // Update the user filter in activity reports
            updateActivityUserFilter();
        }

        function updateActivityUserFilter() {
            const filterSelect = document.getElementById('report-user-filter');
            if (!filterSelect) return;

            const currentValue = filterSelect.value;
            const options = ['<option value="">All Users</option>'];

            if (appData.users && appData.users.length > 0) {
                appData.users.forEach(user => {
                    options.push(`<option value="${user.username}">${user.fullName} (@${user.username})</option>`);
                });
            }

            filterSelect.innerHTML = options.join('');
            filterSelect.value = currentValue;
        }

        let editingUserId = null;

        function editUser(userId) {
            // Check admin permission
            if (!currentUser || !currentUser.isAdmin) {
                alert('‚ùå Access Denied: Only administrators can edit users.');
                return;
            }

            const user = appData.users.find(u => u.id === userId);
            if (!user) return;

            // Store the user ID being edited
            editingUserId = userId;

            // Populate the modal with user data
            document.getElementById('edit-user-username').value = user.username;
            document.getElementById('edit-user-fullname').value = user.fullName;
            document.getElementById('edit-user-role').value = user.role;
            document.getElementById('edit-user-is-admin').checked = user.isAdmin || false;
            document.getElementById('edit-user-change-password').checked = false;
            document.getElementById('edit-user-new-password').value = '';
            document.getElementById('edit-user-password-fields').style.display = 'none';

            // Show the modal
            document.getElementById('edit-user-modal').classList.add('active');
        }

        function closeEditUserModal() {
            document.getElementById('edit-user-modal').classList.remove('active');
            editingUserId = null;
        }

        function togglePasswordChange() {
            const checkbox = document.getElementById('edit-user-change-password');
            const passwordFields = document.getElementById('edit-user-password-fields');
            checkbox.checked = !checkbox.checked;
            passwordFields.style.display = checkbox.checked ? 'block' : 'none';
        }

        async function saveUserEdit() {
            if (!editingUserId) return;

            const user = appData.users.find(u => u.id === editingUserId);
            if (!user) return;

            // Get form values
            const newFullName = document.getElementById('edit-user-fullname').value.trim();
            const newRole = document.getElementById('edit-user-role').value;
            const isAdmin = document.getElementById('edit-user-is-admin').checked;
            const changePassword = document.getElementById('edit-user-change-password').checked;
            const newPassword = document.getElementById('edit-user-new-password').value;

            // Validate
            if (!newFullName) {
                alert('‚ö†Ô∏è Full name is required.');
                return;
            }

            if (changePassword && !newPassword) {
                alert('‚ö†Ô∏è Please enter a new password or uncheck the "Change Password" option.');
                return;
            }

            // Update user object
            user.fullName = newFullName;
            user.role = newRole;
            user.isAdmin = isAdmin;

            // Update password if requested
            if (changePassword && newPassword) {
                user.passwordHash = await hashPassword(newPassword);
            }

            // Auto-save credentials to GitHub
            await autoSaveCredentials();

            // Close modal and refresh display
            closeEditUserModal();
            displayUsers();
            alert('‚úÖ User updated successfully and saved to GitHub!');

            logActivity('update', 'user', editingUserId, `Updated user: ${user.fullName} (@${user.username}) - Admin: ${user.isAdmin}`);
        }

        function deleteUser(userId) {
            // Check admin permission
            if (!currentUser || !currentUser.isAdmin) {
                alert('‚ùå Access Denied: Only administrators can delete users.');
                return;
            }

            const user = appData.users.find(u => u.id === userId);
            if (!user) return;

            // Check if this is the only admin
            if (user.isAdmin) {
                const adminCount = appData.users.filter(u => u.isAdmin).length;
                if (adminCount === 1) {
                    alert('‚ùå Cannot Delete Last Admin\n\nYou cannot delete the only administrator account. This would lock everyone out of the system!\n\nPlease create another admin account before deleting this one.');
                    return;
                }
            }

            if (!confirm(`‚ö†Ô∏è Are you sure you want to delete user "${user.fullName}" (@${user.username})? This action cannot be undone.`)) {
                return;
            }

            const index = appData.users.findIndex(u => u.id === userId);
            if (index > -1) {
                appData.users.splice(index, 1);

                // Auto-save credentials to localStorage
                autoSaveCredentials();

                displayUsers();
                alert('‚úÖ User deleted successfully!');

                logActivity('delete', 'user', userId, `Deleted user: ${user.fullName} (@${user.username})`);
            }
        }

        function filterUsers() {
            const searchTerm = document.getElementById('users-search').value.toLowerCase();
            const userCards = document.querySelectorAll('#users-list > div');

            userCards.forEach(card => {
                const searchText = card.getAttribute('data-user-search') || '';
                if (searchText.includes(searchTerm)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // ===== SEARCH/FILTER FUNCTIONS =====
        function filterHousingRooms() {
            const searchTerm = document.getElementById('housing-rooms-search').value.toLowerCase();
            const roomCards = document.querySelectorAll('#housing-available-rooms-list .room-card');

            roomCards.forEach(card => {
                const searchText = card.getAttribute('data-room-search') || '';
                if (searchText.includes(searchTerm)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function filterSmallGroupRooms() {
            const searchTerm = document.getElementById('sg-rooms-search').value.toLowerCase();
            const roomCards = document.querySelectorAll('#sg-available-rooms-list .room-card');

            roomCards.forEach(card => {
                const searchText = card.getAttribute('data-room-search') || '';
                if (searchText.includes(searchTerm)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // ===== DASHBOARD FILTER FUNCTIONS =====
        function applyDashboardFilters() {
            updateAssignmentOverview();
        }

        function clearDashboardFilters() {
            document.getElementById('filter-hide-male-housing-assigned').checked = false;
            document.getElementById('filter-hide-female-housing-assigned').checked = false;
            document.getElementById('filter-show-male-housing-missing').checked = false;
            document.getElementById('filter-show-female-housing-missing').checked = false;
            document.getElementById('filter-hide-off-campus').checked = false;
            document.getElementById('filter-show-off-campus-only').checked = false;
            document.getElementById('filter-hide-small-group-assigned').checked = false;
            document.getElementById('filter-show-small-group-missing').checked = false;
            document.getElementById('filter-hide-meal-color-assigned').checked = false;
            document.getElementById('filter-show-meal-color-missing').checked = false;
            document.getElementById('filter-meal-color').value = '';
            applyDashboardFilters();
        }

        function shouldShowGroupInDashboard(group) {
            // Get filter states
            const hideMaleHousingAssigned = document.getElementById('filter-hide-male-housing-assigned')?.checked || false;
            const hideFemaleHousingAssigned = document.getElementById('filter-hide-female-housing-assigned')?.checked || false;
            const showMaleHousingMissing = document.getElementById('filter-show-male-housing-missing')?.checked || false;
            const showFemaleHousingMissing = document.getElementById('filter-show-female-housing-missing')?.checked || false;
            const hideOffCampus = document.getElementById('filter-hide-off-campus')?.checked || false;
            const showOffCampusOnly = document.getElementById('filter-show-off-campus-only')?.checked || false;
            const hideSmallGroupAssigned = document.getElementById('filter-hide-small-group-assigned')?.checked || false;
            const showSmallGroupMissing = document.getElementById('filter-show-small-group-missing')?.checked || false;
            const hideMealColorAssigned = document.getElementById('filter-hide-meal-color-assigned')?.checked || false;
            const showMealColorMissing = document.getElementById('filter-show-meal-color-missing')?.checked || false;
            const filterMealColor = document.getElementById('filter-meal-color')?.value || '';

            // Get group states
            const isOffCampus = group.stayingOffCampus || false;
            const maleHousingAssigned = appData.housingAssignments.male[group.id] && appData.housingAssignments.male[group.id].length > 0;
            const femaleHousingAssigned = appData.housingAssignments.female[group.id] && appData.housingAssignments.female[group.id].length > 0;
            const smallGroupAssigned = appData.smallGroupAssignments[group.id] && appData.smallGroupAssignments[group.id].length > 0;
            const mealColorAssigned = appData.mealColorAssignments[group.id] ? true : false;
            const groupMealColor = appData.mealColorAssignments[group.id] || '';
            const maleTotal = group.maleTeens + group.maleChaperones;
            const femaleTotal = group.femaleTeens + group.femaleChaperones;

            // Apply Off-Campus filters
            if (hideOffCampus && isOffCampus) return false;
            if (showOffCampusOnly && !isOffCampus) return false;

            // Apply Male Housing filters
            if (hideMaleHousingAssigned && maleHousingAssigned && maleTotal > 0) return false;
            if (showMaleHousingMissing && (maleHousingAssigned || maleTotal === 0)) return false;

            // Apply Female Housing filters
            if (hideFemaleHousingAssigned && femaleHousingAssigned && femaleTotal > 0) return false;
            if (showFemaleHousingMissing && (femaleHousingAssigned || femaleTotal === 0)) return false;

            // Apply Small Group filters
            if (hideSmallGroupAssigned && smallGroupAssigned) return false;
            if (showSmallGroupMissing && smallGroupAssigned) return false;

            // Apply Meal Color filters
            if (hideMealColorAssigned && mealColorAssigned) return false;
            if (showMealColorMissing && mealColorAssigned) return false;
            if (filterMealColor && groupMealColor !== filterMealColor) return false;

            return true;
        }

        // ===== SYSTEM INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            initPasswordSystem();
            initializeSystem();
        });
    </script>
</body>
</html>
