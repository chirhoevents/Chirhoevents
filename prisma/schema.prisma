// ChiRho Events - Prisma Schema
// Database: PostgreSQL 15 (Neon)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===================================
// CORE TABLES
// ===================================

model Organization {
  id                      String   @id @default(uuid()) @db.Uuid
  name                    String   @db.VarChar(255)
  type                    OrganizationType
  address                 Json?
  contactName             String?  @map("contact_name") @db.VarChar(255)
  contactEmail            String   @unique @map("contact_email") @db.VarChar(255)
  contactPhone            String?  @map("contact_phone") @db.VarChar(20)
  stripeAccountId         String?  @unique @map("stripe_account_id") @db.VarChar(255)
  stripeAccountStatus     StripeAccountStatus @default(not_connected) @map("stripe_account_status")
  stripeOnboardingCompleted Boolean @default(false) @map("stripe_onboarding_completed")
  stripeChargesEnabled    Boolean  @default(false) @map("stripe_charges_enabled")
  stripePayoutsEnabled    Boolean  @default(false) @map("stripe_payouts_enabled")
  stripeConnectedAt       DateTime? @map("stripe_connected_at") @db.Timestamptz(6)
  stripeCustomerId        String?  @unique @map("stripe_customer_id") @db.VarChar(255)
  stripeSubscriptionId    String?  @unique @map("stripe_subscription_id") @db.VarChar(255)
  subscriptionTier        SubscriptionTier @map("subscription_tier")
  subscriptionStatus      SubscriptionStatus @map("subscription_status")
  monthlyFee              Decimal  @map("monthly_fee") @db.Decimal(10, 2)
  setupFeePaid            Boolean  @default(false) @map("setup_fee_paid")
  reactivationFeePaid     Boolean  @default(false) @map("reactivation_fee_paid")
  storageUsedGb           Decimal  @default(0) @map("storage_used_gb") @db.Decimal(10, 2)
  storageLimitGb          Int      @map("storage_limit_gb")
  eventsPerYearLimit      Int?     @map("events_per_year_limit")
  logoUrl                 String?  @map("logo_url") @db.Text
  createdAt               DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  archivedAt              DateTime? @map("archived_at") @db.Timestamptz(6)

  // Master Admin fields
  status                  OrganizationStatus @default(active)
  billingCycle            BillingCycle? @map("billing_cycle")
  subscriptionStartedAt   DateTime? @map("subscription_started_at") @db.Timestamptz(6)
  subscriptionRenewsAt    DateTime? @map("subscription_renews_at") @db.Timestamptz(6)
  setupFeeAmount          Decimal  @default(250.00) @map("setup_fee_amount") @db.Decimal(10, 2)
  monthlyPrice            Decimal? @map("monthly_price") @db.Decimal(10, 2)
  annualPrice             Decimal? @map("annual_price") @db.Decimal(10, 2)
  registrationsLimit      Int?     @map("registrations_limit")
  eventsUsed              Int      @default(0) @map("events_used")
  registrationsUsed       Int      @default(0) @map("registrations_used")
  primaryColor            String?  @map("primary_color") @db.VarChar(7)
  secondaryColor          String?  @map("secondary_color") @db.VarChar(7)
  customFieldsEnabled     Json     @default("{}") @map("custom_fields_enabled") @db.JsonB
  modulesEnabled          Json     @default("{\"poros\": true, \"salve\": true, \"rapha\": true}") @map("modules_enabled") @db.JsonB
  checkPaymentName        String?  @map("check_payment_name") @db.Text
  checkPaymentAddress     String?  @map("check_payment_address") @db.Text
  platformFeePercentage   Decimal  @default(1.00) @map("platform_fee_percentage") @db.Decimal(5, 2)
  notes                   String?  @db.Text
  cancelledAt             DateTime? @map("cancelled_at") @db.Timestamptz(6)
  reactivationFee         Decimal  @default(150.00) @map("reactivation_fee") @db.Decimal(10, 2)
  createdByUserId         String?  @map("created_by_user_id") @db.Uuid
  legalEntityName         String?  @map("legal_entity_name") @db.VarChar(255)
  taxId                   String?  @map("tax_id") @db.VarChar(50)
  website                 String?  @db.VarChar(255)
  paymentMethodPreference PaymentMethodPreference? @map("payment_method_preference")

  // Relations
  users                   User[]
  events                  Event[]
  groupRegistrations      GroupRegistration[]
  individualRegistrations IndividualRegistration[]
  participants            Participant[]
  payments                Payment[]
  paymentBalances         PaymentBalance[]
  liabilityForms          LiabilityForm[]
  safeEnvironmentCertificates SafeEnvironmentCertificate[]
  liabilityFormTemplates  LiabilityFormTemplate[]
  supportTickets          SupportTicket[]
  invoices                Invoice[]
  billingNotes            BillingNote[]
  coupons                 Coupon[]
  createdByUser           User?    @relation("OrganizationsCreatedByUser", fields: [createdByUserId], references: [id])

  @@index([contactEmail], name: "idx_org_email")
  @@index([stripeAccountId], name: "idx_org_stripe")
  @@index([status], name: "idx_org_status")
  @@map("organizations")
}

model User {
  id              String   @id @default(uuid()) @db.Uuid
  clerkUserId     String?  @map("clerk_user_id") @db.VarChar(255)
  organizationId  String?  @map("organization_id") @db.Uuid
  email           String   @unique @db.VarChar(255)
  firstName       String   @map("first_name") @db.VarChar(255)
  lastName        String   @map("last_name") @db.VarChar(255)
  preferredName   String?  @map("preferred_name") @db.VarChar(255)
  role            UserRole
  permissions     Json?    @db.JsonB // Custom permission overrides
  phone           String?  @db.VarChar(20)
  createdBy       String?  @map("created_by") @db.Uuid
  lastLogin       DateTime? @map("last_login") @db.Timestamptz(6)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization    Organization? @relation(fields: [organizationId], references: [id])
  createdByUser   User?        @relation("UserCreatedBy", fields: [createdBy], references: [id])
  usersCreated    User[]       @relation("UserCreatedBy")
  eventsCreated   Event[]
  uploadedCertificates SafeEnvironmentCertificate[] @relation("UploadedCertificates")
  verifiedCertificates SafeEnvironmentCertificate[] @relation("VerifiedCertificates")
  registrationEdits RegistrationEdit[]
  refundsProcessed Refund[]
  reportTemplates ReportTemplate[] @relation("ReportTemplatesCreated")
  paymentsProcessed Payment[] @relation("PaymentsProcessed")
  liabilityFormsApproved LiabilityForm[] @relation("LiabilityFormsApproved")
  organizationsCreated Organization[] @relation("OrganizationsCreatedByUser")
  supportTicketsSubmitted SupportTicket[] @relation("TicketsSubmittedByUser")
  supportTicketsAssigned  SupportTicket[] @relation("TicketsAssignedToUser")
  supportTicketMessages   SupportTicketMessage[]
  onboardingRequestsApproved OrganizationOnboardingRequest[] @relation("OnboardingRequestsApprovedByUser")
  platformSettingsUpdated PlatformSetting[] @relation("PlatformSettingsUpdatedByUser")
  invoicesCreated Invoice[] @relation("InvoicesCreatedByUser")
  billingNotesCreated BillingNote[] @relation("BillingNotesCreatedByUser")
  inboundTicketsAssigned InboundSupportTicket[] @relation("InboundTicketsAssignedToUser")
  inboundTicketReplies InboundTicketReply[] @relation("InboundTicketRepliesByUser")
  couponsCreated       Coupon[]

  @@index([organizationId], name: "idx_user_org")
  @@index([email], name: "idx_user_email")
  @@index([role], name: "idx_user_role")
  @@index([clerkUserId], name: "idx_user_clerk")
  @@map("users")
}

model Event {
  id                     String   @id @default(uuid()) @db.Uuid
  organizationId         String   @map("organization_id") @db.Uuid
  name                   String   @db.VarChar(255)
  slug                   String   @unique @db.VarChar(255)
  description            String?  @db.Text
  startDate              DateTime @map("start_date") @db.Date
  endDate                DateTime @map("end_date") @db.Date
  timezone               String   @db.VarChar(50)
  locationName           String?  @map("location_name") @db.VarChar(255)
  locationAddress        Json?    @map("location_address")
  capacityTotal          Int?     @map("capacity_total")
  capacityRemaining      Int?     @map("capacity_remaining")
  registrationOpenDate   DateTime? @map("registration_open_date") @db.Timestamptz(6)
  registrationCloseDate  DateTime? @map("registration_close_date") @db.Timestamptz(6)
  status                 EventStatus @default(draft)
  isPublished            Boolean  @default(false) @map("is_published")
  enableWaitlist         Boolean  @default(false) @map("enable_waitlist")
  waitlistCapacity       Int?     @map("waitlist_capacity")
  createdBy              String   @map("created_by") @db.Uuid
  createdAt              DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization              Organization @relation(fields: [organizationId], references: [id])
  creator                   User         @relation(fields: [createdBy], references: [id])
  settings                  EventSettings?
  pricing                   EventPricing?
  groupRegistrations        GroupRegistration[]
  individualRegistrations   IndividualRegistration[]
  customRegistrationQuestions CustomRegistrationQuestion[]
  liabilityForms            LiabilityForm[]
  liabilityFormTemplates    LiabilityFormTemplate[]
  waitlistEntries           WaitlistEntry[]
  vendorRegistrations       VendorRegistration[]
  staffRegistrations        StaffRegistration[]
  supportTickets            SupportTicket[]
  coupons                   Coupon[]
  porosDataImport           PorosEventDataImport?

  @@index([organizationId], name: "idx_event_org")
  @@index([slug], name: "idx_event_slug")
  @@index([startDate, endDate], name: "idx_event_dates")
  @@map("events")
}

model EventSettings {
  id                              String   @id @default(uuid()) @db.Uuid
  eventId                         String   @unique @map("event_id") @db.Uuid
  groupRegistrationEnabled        Boolean  @default(true) @map("group_registration_enabled")
  individualRegistrationEnabled   Boolean  @default(true) @map("individual_registration_enabled")
  liabilityFormsRequiredGroup     Boolean  @default(true) @map("liability_forms_required_group")
  liabilityFormsRequiredIndividual Boolean @default(false) @map("liability_forms_required_individual")
  showDietaryRestrictions         Boolean  @default(true) @map("show_dietary_restrictions")
  dietaryRestrictionsRequired     Boolean  @default(false) @map("dietary_restrictions_required")
  showAdaAccommodations           Boolean  @default(true) @map("show_ada_accommodations")
  adaAccommodationsRequired       Boolean  @default(false) @map("ada_accommodations_required")
  porosHousingEnabled             Boolean  @default(false) @map("poros_housing_enabled")
  porosPriestHousingEnabled       Boolean  @default(false) @map("poros_priest_housing_enabled")
  porosSeatingEnabled             Boolean  @default(false) @map("poros_seating_enabled")
  porosMealColorsEnabled          Boolean  @default(false) @map("poros_meal_colors_enabled")
  porosSmallGroupEnabled          Boolean  @default(false) @map("poros_small_group_enabled")
  porosSglEnabled                 Boolean  @default(false) @map("poros_sgl_enabled")
  porosSeminarianEnabled          Boolean  @default(false) @map("poros_seminarian_enabled")
  porosReligiousStaffEnabled      Boolean  @default(false) @map("poros_religious_staff_enabled")
  porosAdaEnabled                 Boolean  @default(false) @map("poros_ada_enabled")
  porosPublicPortalEnabled        Boolean  @default(false) @map("poros_public_portal_enabled")
  publicPortalEnabled             Boolean  @default(false) @map("public_portal_enabled")
  salveCheckinEnabled             Boolean  @default(false) @map("salve_checkin_enabled")
  raphaMedicalEnabled             Boolean  @default(false) @map("rapha_medical_enabled")
  tshirtsEnabled                  Boolean  @default(false) @map("tshirts_enabled")
  individualMealsEnabled          Boolean  @default(false) @map("individual_meals_enabled")
  registrationInstructions        String?  @map("registration_instructions") @db.Text
  confirmationEmailMessage        String?  @map("confirmation_email_message") @db.Text
  checkPaymentEnabled             Boolean  @default(true) @map("check_payment_enabled")
  checkPaymentPayableTo           String?  @map("check_payment_payable_to") @db.VarChar(255)
  checkPaymentAddress             String?  @map("check_payment_address") @db.Text
  allowOnCampus                   Boolean  @default(true) @map("allow_on_campus")
  allowOffCampus                  Boolean  @default(true) @map("allow_off_campus")
  allowDayPass                    Boolean  @default(true) @map("allow_day_pass")
  allowSingleRoom                 Boolean  @default(true) @map("allow_single_room")
  allowDoubleRoom                 Boolean  @default(true) @map("allow_double_room")
  allowTripleRoom                 Boolean  @default(true) @map("allow_triple_room")
  allowQuadRoom                   Boolean  @default(true) @map("allow_quad_room")
  singleRoomLabel                 String?  @map("single_room_label") @db.VarChar(100)
  doubleRoomLabel                 String?  @map("double_room_label") @db.VarChar(100)
  tripleRoomLabel                 String?  @map("triple_room_label") @db.VarChar(100)
  quadRoomLabel                   String?  @map("quad_room_label") @db.VarChar(100)
  landingPageShowPrice            Boolean  @default(true) @map("landing_page_show_price")
  landingPageShowSchedule         Boolean  @default(true) @map("landing_page_show_schedule")
  landingPageShowFaq              Boolean  @default(true) @map("landing_page_show_faq")
  landingPageShowIncluded         Boolean  @default(true) @map("landing_page_show_included")
  landingPageShowBring            Boolean  @default(true) @map("landing_page_show_bring")
  landingPageShowContact          Boolean  @default(true) @map("landing_page_show_contact")
  landingPageShowGallery          Boolean  @default(false) @map("landing_page_show_gallery")
  landingPageShowSponsors         Boolean  @default(false) @map("landing_page_show_sponsors")
  showAvailability                Boolean  @default(true) @map("show_availability")
  availabilityThreshold           Int      @default(20) @map("availability_threshold")
  countdownLocation               String   @default("hero") @map("countdown_location") @db.VarChar(50)
  countdownBeforeOpen             Boolean  @default(true) @map("countdown_before_open")
  countdownBeforeClose            Boolean  @default(true) @map("countdown_before_close")
  backgroundImageUrl              String?  @map("background_image_url") @db.Text
  primaryColor                    String   @default("#1E3A5F") @map("primary_color") @db.VarChar(7)
  secondaryColor                  String   @default("#9C8466") @map("secondary_color") @db.VarChar(7)
  overlayColor                    String   @default("#000000") @map("overlay_color") @db.VarChar(7)
  overlayOpacity                  Int      @default(40) @map("overlay_opacity")
  waitlistEnabled                 Boolean  @default(true) @map("waitlist_enabled")
  registrationClosedMessage       String?  @map("registration_closed_message") @db.Text

  // Staff/Volunteer Registration Settings
  staffRegistrationEnabled        Boolean  @default(false) @map("staff_registration_enabled")
  staffVolunteerPrice             Decimal  @default(0) @map("staff_volunteer_price") @db.Decimal(10, 2)
  vendorStaffPrice                Decimal  @default(0) @map("vendor_staff_price") @db.Decimal(10, 2)
  staffRoles                      Json?    @map("staff_roles") @db.JsonB // ["Registration Desk", "Setup Crew", "Kitchen Staff", ...]

  // Vendor Registration Settings
  vendorRegistrationEnabled       Boolean  @default(false) @map("vendor_registration_enabled")
  vendorTiers                     Json?    @map("vendor_tiers") @db.JsonB // [{id, name, price, description, active, quantityLimit?, quantityUsed?}]
  // Allow login when registration is closed (for group leaders to access dashboard)
  allowLoginWhenClosed            Boolean  @default(true) @map("allow_login_when_closed")

  // Show/hide capacity on landing page
  showCapacity                    Boolean  @default(true) @map("show_capacity")

  // Day pass as ticket type for individual registration
  allowIndividualDayPass          Boolean  @default(false) @map("allow_individual_day_pass")

  // Landing page content fields
  faqContent                      String?  @map("faq_content") @db.Text
  scheduleContent                 String?  @map("schedule_content") @db.Text
  includedContent                 String?  @map("included_content") @db.Text
  bringContent                    String?  @map("bring_content") @db.Text
  contactInfo                     String?  @map("contact_info") @db.Text
  contactEmail                    String?  @map("contact_email") @db.VarChar(255)
  contactPhone                    String?  @map("contact_phone") @db.VarChar(20)

  // Confirmation email content options
  showFaqInEmail                  Boolean  @default(false) @map("show_faq_in_email")
  showBringInEmail                Boolean  @default(false) @map("show_bring_in_email")
  showScheduleInEmail             Boolean  @default(false) @map("show_schedule_in_email")
  showIncludedInEmail             Boolean  @default(false) @map("show_included_in_email")
  showContactInEmail              Boolean  @default(true) @map("show_contact_in_email")

  // Add-ons (up to 4)
  addOn1Enabled                   Boolean  @default(false) @map("add_on_1_enabled")
  addOn1Title                     String?  @map("add_on_1_title") @db.VarChar(100)
  addOn1Description               String?  @map("add_on_1_description") @db.Text
  addOn1Price                     Decimal? @map("add_on_1_price") @db.Decimal(10, 2)

  addOn2Enabled                   Boolean  @default(false) @map("add_on_2_enabled")
  addOn2Title                     String?  @map("add_on_2_title") @db.VarChar(100)
  addOn2Description               String?  @map("add_on_2_description") @db.Text
  addOn2Price                     Decimal? @map("add_on_2_price") @db.Decimal(10, 2)

  addOn3Enabled                   Boolean  @default(false) @map("add_on_3_enabled")
  addOn3Title                     String?  @map("add_on_3_title") @db.VarChar(100)
  addOn3Description               String?  @map("add_on_3_description") @db.Text
  addOn3Price                     Decimal? @map("add_on_3_price") @db.Decimal(10, 2)

  addOn4Enabled                   Boolean  @default(false) @map("add_on_4_enabled")
  addOn4Title                     String?  @map("add_on_4_title") @db.VarChar(100)
  addOn4Description               String?  @map("add_on_4_description") @db.Text
  addOn4Price                     Decimal? @map("add_on_4_price") @db.Decimal(10, 2)

  // Coupon Settings
  couponsEnabled                  Boolean  @default(false) @map("coupons_enabled")

  createdAt                       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("event_settings")
}

model EventPricing {
  id                        String   @id @default(uuid()) @db.Uuid
  eventId                   String   @unique @map("event_id") @db.Uuid
  youthEarlyBirdPrice       Decimal? @map("youth_early_bird_price") @db.Decimal(10, 2)
  youthRegularPrice         Decimal  @map("youth_regular_price") @db.Decimal(10, 2)
  youthLatePrice            Decimal? @map("youth_late_price") @db.Decimal(10, 2)
  chaperoneEarlyBirdPrice   Decimal? @map("chaperone_early_bird_price") @db.Decimal(10, 2)
  chaperoneRegularPrice     Decimal  @map("chaperone_regular_price") @db.Decimal(10, 2)
  chaperoneLatePrice        Decimal? @map("chaperone_late_price") @db.Decimal(10, 2)
  priestPrice               Decimal  @default(0.00) @map("priest_price") @db.Decimal(10, 2)
  onCampusYouthPrice        Decimal? @map("on_campus_youth_price") @db.Decimal(10, 2)
  offCampusYouthPrice       Decimal? @map("off_campus_youth_price") @db.Decimal(10, 2)
  dayPassYouthPrice         Decimal? @map("day_pass_youth_price") @db.Decimal(10, 2)
  onCampusChaperonePrice    Decimal? @map("on_campus_chaperone_price") @db.Decimal(10, 2)
  offCampusChaperonePrice   Decimal? @map("off_campus_chaperone_price") @db.Decimal(10, 2)
  dayPassChaperonePrice     Decimal? @map("day_pass_chaperone_price") @db.Decimal(10, 2)
  // Individual registration pricing tiers
  individualEarlyBirdPrice  Decimal? @map("individual_early_bird_price") @db.Decimal(10, 2)
  individualBasePrice       Decimal? @map("individual_base_price") @db.Decimal(10, 2)
  individualLatePrice       Decimal? @map("individual_late_price") @db.Decimal(10, 2)
  singleRoomPrice           Decimal? @map("single_room_price") @db.Decimal(10, 2)
  doubleRoomPrice           Decimal? @map("double_room_price") @db.Decimal(10, 2)
  tripleRoomPrice           Decimal? @map("triple_room_price") @db.Decimal(10, 2)
  quadRoomPrice             Decimal? @map("quad_room_price") @db.Decimal(10, 2)
  individualOffCampusPrice  Decimal? @map("individual_off_campus_price") @db.Decimal(10, 2)
  individualDayPassPrice    Decimal? @map("individual_day_pass_price") @db.Decimal(10, 2)
  individualMealPackagePrice Decimal? @map("individual_meal_package_price") @db.Decimal(10, 2)
  depositAmount             Decimal? @map("deposit_amount") @db.Decimal(10, 2)
  depositPercentage         Decimal? @map("deposit_percentage") @db.Decimal(5, 2)
  requireFullPayment        Boolean  @default(false) @map("require_full_payment")
  depositPerPerson          Boolean  @default(true) @map("deposit_per_person")
  earlyBirdDeadline         DateTime? @map("early_bird_deadline") @db.Timestamptz(6)
  regularDeadline           DateTime? @map("regular_deadline") @db.Timestamptz(6)
  fullPaymentDeadline       DateTime? @map("full_payment_deadline") @db.Timestamptz(6)
  lateFeePercentage         Decimal? @map("late_fee_percentage") @db.Decimal(5, 2)
  lateFeeAutoApply          Boolean  @default(false) @map("late_fee_auto_apply")
  currency                  String   @default("USD") @db.VarChar(3)
  createdAt                 DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                 DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("event_pricing")
}

// ===================================
// REGISTRATION TABLES
// ===================================

model GroupRegistration {
  id                         String   @id @default(uuid()) @db.Uuid
  eventId                    String   @map("event_id") @db.Uuid
  organizationId             String   @map("organization_id") @db.Uuid
  groupName                  String   @map("group_name") @db.VarChar(255)
  parishName                 String?  @map("parish_name") @db.VarChar(255)
  dioceseName                String?  @map("diocese_name") @db.VarChar(255)
  groupLeaderUserId          String?  @map("group_leader_user_id") @db.Uuid
  clerkUserId                String?  @map("clerk_user_id") @db.VarChar(255)
  dashboardLastAccessedAt    DateTime? @map("dashboard_last_accessed_at") @db.Timestamptz(6)
  groupLeaderName            String   @map("group_leader_name") @db.VarChar(255)
  groupLeaderEmail           String   @map("group_leader_email") @db.VarChar(255)
  groupLeaderPhone           String   @map("group_leader_phone") @db.VarChar(20)
  groupLeaderStreet          String?  @map("group_leader_street") @db.VarChar(255)
  groupLeaderCity            String?  @map("group_leader_city") @db.VarChar(100)
  groupLeaderState           String?  @map("group_leader_state") @db.VarChar(2)
  groupLeaderZip             String?  @map("group_leader_zip") @db.VarChar(10)
  alternativeContact1Name    String?  @map("alternative_contact_1_name") @db.VarChar(255)
  alternativeContact1Email   String?  @map("alternative_contact_1_email") @db.VarChar(255)
  alternativeContact1Phone   String?  @map("alternative_contact_1_phone") @db.VarChar(20)
  alternativeContact2Name    String?  @map("alternative_contact_2_name") @db.VarChar(255)
  alternativeContact2Email   String?  @map("alternative_contact_2_email") @db.VarChar(255)
  alternativeContact2Phone   String?  @map("alternative_contact_2_phone") @db.VarChar(20)
  accessCode                 String   @unique @map("access_code") @db.VarChar(50)
  qrCode                     String?  @map("qr_code") @db.Text
  youthCount                 Int      @default(0) @map("youth_count")
  chaperoneCount             Int      @default(0) @map("chaperone_count")
  priestCount                Int      @default(0) @map("priest_count")
  totalParticipants          Int      @map("total_participants")
  housingType                HousingType @map("housing_type")
  specialRequests            String?  @map("special_requests") @db.Text
  dietaryRestrictionsSummary String?  @map("dietary_restrictions_summary") @db.Text
  adaAccommodationsSummary   String?  @map("ada_accommodations_summary") @db.Text
  registrationStatus         RegistrationStatus @default(incomplete) @map("registration_status")
  // Housing assignment fields
  housingAssignmentsLocked   Boolean  @default(false) @map("housing_assignments_locked")
  housingAssignmentsSubmittedAt DateTime? @map("housing_assignments_submitted_at") @db.Timestamptz(6)
  housingUnlockRequested     Boolean  @default(false) @map("housing_unlock_requested")
  housingUnlockRequestedAt   DateTime? @map("housing_unlock_requested_at") @db.Timestamptz(6)
  registeredAt               DateTime @default(now()) @map("registered_at") @db.Timestamptz(6)
  createdAt                  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                  DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  event          Event           @relation(fields: [eventId], references: [id])
  organization   Organization    @relation(fields: [organizationId], references: [id])
  participants   Participant[]
  liabilityForms LiabilityForm[]
  userPreferences UserPreferences[]
  allocatedRooms Room[]          @relation("RoomsAllocatedToGroup")

  @@index([eventId], name: "idx_group_event")
  @@index([organizationId], name: "idx_group_org")
  @@index([accessCode], name: "idx_group_access_code")
  @@index([clerkUserId], name: "idx_group_clerk_user")
  @@map("group_registrations")
}

model IndividualRegistration {
  id                        String   @id @default(uuid()) @db.Uuid
  eventId                   String   @map("event_id") @db.Uuid
  organizationId            String   @map("organization_id") @db.Uuid
  userId                    String?  @map("user_id") @db.Uuid
  firstName                 String   @map("first_name") @db.VarChar(255)
  lastName                  String   @map("last_name") @db.VarChar(255)
  preferredName             String?  @map("preferred_name") @db.VarChar(255)
  email                     String   @db.VarChar(255)
  phone                     String   @db.VarChar(20)
  street                    String?  @db.VarChar(255)
  city                      String?  @db.VarChar(100)
  state                     String?  @db.VarChar(2)
  zip                       String?  @db.VarChar(10)
  age                       Int?
  gender                    Gender?
  housingType               HousingType? @map("housing_type")
  roomType                  RoomType? @map("room_type")
  preferredRoommate         String?  @map("preferred_roommate") @db.Text
  tShirtSize                String?  @map("t_shirt_size") @db.VarChar(10)
  dietaryRestrictions       String?  @map("dietary_restrictions") @db.Text
  adaAccommodations         String?  @map("ada_accommodations") @db.Text
  emergencyContact1Name     String   @map("emergency_contact_1_name") @db.VarChar(255)
  emergencyContact1Phone    String   @map("emergency_contact_1_phone") @db.VarChar(20)
  emergencyContact1Relation String?  @map("emergency_contact_1_relation") @db.VarChar(100)
  emergencyContact2Name     String?  @map("emergency_contact_2_name") @db.VarChar(255)
  emergencyContact2Phone    String?  @map("emergency_contact_2_phone") @db.VarChar(20)
  emergencyContact2Relation String?  @map("emergency_contact_2_relation") @db.VarChar(100)
  registrationStatus        RegistrationStatus @default(incomplete) @map("registration_status")
  qrCode                    String?  @map("qr_code") @db.Text
  confirmationCode          String?  @unique @map("confirmation_code") @db.VarChar(50)
  registeredAt              DateTime @default(now()) @map("registered_at") @db.Timestamptz(6)
  createdAt                 DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                 DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  // Check-in fields
  checkedIn                 Boolean  @default(false) @map("checked_in")
  checkedInAt               DateTime? @map("checked_in_at") @db.Timestamptz(6)
  checkedInBy               String?  @map("checked_in_by") @db.Uuid
  checkInStation            String?  @map("check_in_station") @db.VarChar(100)
  checkInNotes              String?  @map("check_in_notes") @db.Text

  // Relations
  event        Event        @relation(fields: [eventId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])
  liabilityForms LiabilityForm[]

  @@index([confirmationCode], name: "idx_individual_confirmation_code")
  @@index([checkedIn], name: "idx_individual_checked_in")
  @@map("individual_registrations")
}

model Participant {
  id                           String   @id @default(uuid()) @db.Uuid
  groupRegistrationId          String   @map("group_registration_id") @db.Uuid
  organizationId               String   @map("organization_id") @db.Uuid
  firstName                    String   @map("first_name") @db.VarChar(255)
  lastName                     String   @map("last_name") @db.VarChar(255)
  preferredName                String?  @map("preferred_name") @db.VarChar(255)
  email                        String?  @db.VarChar(255)
  age                          Int
  gender                       Gender
  participantType              ParticipantType @map("participant_type")
  clergyTitle                  ClergyTitle? @map("clergy_title")
  tShirtSize                   String?  @map("t_shirt_size") @db.VarChar(10)
  liabilityFormCompleted       Boolean  @default(false) @map("liability_form_completed")
  liabilityFormUrl             String?  @map("liability_form_url") @db.Text
  safeEnvironmentCertUrl       String?  @map("safe_environment_cert_url") @db.Text
  safeEnvironmentCertStatus    SafeEnvironmentStatus? @map("safe_environment_cert_status")
  parentEmail                  String?  @map("parent_email") @db.VarChar(255)
  // Check-in fields
  checkedIn                    Boolean  @default(false) @map("checked_in")
  checkedInAt                  DateTime? @map("checked_in_at") @db.Timestamptz(6)
  checkedInBy                  String?  @map("checked_in_by") @db.Uuid
  checkInStation               String?  @map("check_in_station") @db.VarChar(100)
  checkInNotes                 String?  @map("check_in_notes") @db.Text
  // QR Code for check-in and medical lookup
  qrCode                       String?  @map("qr_code") @db.Text
  createdAt                    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                    DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  groupRegistration GroupRegistration @relation(fields: [groupRegistrationId], references: [id], onDelete: Cascade)
  organization      Organization      @relation(fields: [organizationId], references: [id])
  liabilityForms    LiabilityForm[]
  safeEnvironmentCertificates SafeEnvironmentCertificate[]

  @@index([groupRegistrationId], name: "idx_participant_group")
  @@index([participantType], name: "idx_participant_type")
  @@index([checkedIn], name: "idx_participant_checked_in")
  @@map("participants")
}

// ===================================
// PAYMENT TABLES
// ===================================

model Payment {
  id                    String   @id @default(uuid()) @db.Uuid
  organizationId        String   @map("organization_id") @db.Uuid
  eventId               String   @map("event_id") @db.Uuid
  registrationId        String   @map("registration_id") @db.Uuid
  registrationType      RegistrationType @map("registration_type")
  amount                Decimal  @db.Decimal(10, 2)
  paymentType           PaymentType @map("payment_type")
  paymentMethod         PaymentMethod @map("payment_method")
  paymentStatus         PaymentStatus @map("payment_status")
  stripePaymentIntentId String?  @unique @map("stripe_payment_intent_id") @db.VarChar(255)
  stripeChargeId        String?  @map("stripe_charge_id") @db.VarChar(255)
  stripePaymentMethodId String?  @map("stripe_payment_method_id") @db.VarChar(255)
  stripeTransferId      String?  @map("stripe_transfer_id") @db.VarChar(255)
  platformFeeAmount     Decimal? @map("platform_fee_amount") @db.Decimal(10, 2)
  receiptUrl            String?  @map("receipt_url") @db.Text
  checkNumber           String?  @map("check_number") @db.VarChar(50)
  checkDate             DateTime? @map("check_date") @db.Date
  checkReceivedDate     DateTime? @map("check_received_date") @db.Date
  cardLast4             String?  @map("card_last_4") @db.VarChar(4)
  cardBrand             String?  @map("card_brand") @db.VarChar(50)
  cardholderName        String?  @map("cardholder_name") @db.VarChar(255)
  authorizationCode     String?  @map("authorization_code") @db.VarChar(255)
  paymentMethodDetails  String?  @map("payment_method_details") @db.Text
  transactionReference  String?  @map("transaction_reference") @db.VarChar(255)
  notes                 String?  @db.Text
  processedByUserId     String?  @map("processed_by_user_id") @db.Uuid
  processedVia          ProcessedVia? @map("processed_via")
  processedAt           DateTime? @map("processed_at") @db.Timestamptz(6)
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id])
  processedBy  User?        @relation("PaymentsProcessed", fields: [processedByUserId], references: [id])

  @@index([registrationId, registrationType], name: "idx_payment_registration")
  @@index([stripePaymentIntentId], name: "idx_payment_stripe")
  @@map("payments")
}

model PaymentBalance {
  id                String   @id @default(uuid()) @db.Uuid
  organizationId    String   @map("organization_id") @db.Uuid
  eventId           String   @map("event_id") @db.Uuid
  registrationId    String   @unique @map("registration_id") @db.Uuid
  registrationType  RegistrationType @map("registration_type")
  totalAmountDue    Decimal  @map("total_amount_due") @db.Decimal(10, 2)
  amountPaid        Decimal  @default(0.00) @map("amount_paid") @db.Decimal(10, 2)
  amountRemaining   Decimal  @map("amount_remaining") @db.Decimal(10, 2)
  lateFeesApplied   Decimal  @default(0.00) @map("late_fees_applied") @db.Decimal(10, 2)
  lastPaymentDate   DateTime? @map("last_payment_date") @db.Timestamptz(6)
  paymentStatus     PaymentBalanceStatus @map("payment_status")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([registrationId], name: "idx_balance_registration")
  @@index([eventId], name: "idx_balance_event")
  @@map("payment_balances")
}

// ===================================
// LIABILITY FORM TABLES
// ===================================

model LiabilityForm {
  id                        String   @id @default(uuid()) @db.Uuid
  organizationId            String   @map("organization_id") @db.Uuid
  eventId                   String   @map("event_id") @db.Uuid
  groupRegistrationId       String?  @map("group_registration_id") @db.Uuid
  participantId             String?  @map("participant_id") @db.Uuid
  individualRegistrationId  String?  @map("individual_registration_id") @db.Uuid
  formType                  LiabilityFormType @map("form_type")
  participantType           ParticipantType? @map("participant_type")
  participantFirstName      String   @map("participant_first_name") @db.VarChar(255)
  participantLastName       String   @map("participant_last_name") @db.VarChar(255)
  participantPreferredName  String?  @map("participant_preferred_name") @db.VarChar(255)
  participantAge            Int?     @map("participant_age")
  participantGender         Gender?  @map("participant_gender")
  participantEmail          String?  @map("participant_email") @db.VarChar(255)
  participantPhone          String?  @map("participant_phone") @db.VarChar(20)
  tShirtSize                String?  @map("t_shirt_size") @db.VarChar(10)
  clergyTitle               ClergyTitle? @map("clergy_title")
  dioceseOfIncardination    String?  @map("diocese_of_incardination") @db.VarChar(255)
  currentAssignment         String?  @map("current_assignment") @db.VarChar(255)
  facultyInformation        String?  @map("faculty_information") @db.Text
  parentEmail               String?  @map("parent_email") @db.VarChar(255)
  parentToken               String?  @unique @map("parent_token") @db.VarChar(255)
  parentTokenExpiresAt      DateTime? @map("parent_token_expires_at") @db.Timestamptz(6)
  medicalConditions         String?  @map("medical_conditions") @db.Text
  medications               String?  @db.Text
  allergies                 String?  @db.Text
  dietaryRestrictions       String?  @map("dietary_restrictions") @db.Text
  adaAccommodations         String?  @map("ada_accommodations") @db.Text
  emergencyContact1Name     String?  @map("emergency_contact_1_name") @db.VarChar(255)
  emergencyContact1Phone    String?  @map("emergency_contact_1_phone") @db.VarChar(20)
  emergencyContact1Relation String?  @map("emergency_contact_1_relation") @db.VarChar(100)
  emergencyContact2Name     String?  @map("emergency_contact_2_name") @db.VarChar(255)
  emergencyContact2Phone    String?  @map("emergency_contact_2_phone") @db.VarChar(20)
  emergencyContact2Relation String?  @map("emergency_contact_2_relation") @db.VarChar(100)
  insuranceProvider         String?  @map("insurance_provider") @db.VarChar(255)
  insurancePolicyNumber     String?  @map("insurance_policy_number") @db.VarChar(100)
  insuranceGroupNumber      String?  @map("insurance_group_number") @db.VarChar(100)
  signatureData             Json     @map("signature_data")
  completed                 Boolean  @default(false)
  completedByEmail          String?  @map("completed_by_email") @db.VarChar(255)
  completedAt               DateTime? @map("completed_at") @db.Timestamptz(6)
  pdfUrl                    String?  @map("pdf_url") @db.Text

  // Approval workflow
  formStatus                String   @default("pending") @map("form_status") @db.VarChar(50)  // pending, approved, denied, needs_revision
  approvalNotes             String?  @map("approval_notes") @db.Text
  approvedByUserId          String?  @map("approved_by_user_id") @db.Uuid
  approvedAt                DateTime? @map("approved_at") @db.Timestamptz(6)
  deniedReason              String?  @map("denied_reason") @db.Text

  createdAt                 DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                 DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization           Organization            @relation(fields: [organizationId], references: [id])
  approvedBy             User?                   @relation("LiabilityFormsApproved", fields: [approvedByUserId], references: [id])
  event                  Event                   @relation(fields: [eventId], references: [id])
  groupRegistration      GroupRegistration?      @relation(fields: [groupRegistrationId], references: [id])
  participant            Participant?            @relation(fields: [participantId], references: [id])
  individualRegistration IndividualRegistration? @relation(fields: [individualRegistrationId], references: [id])
  safeEnvironmentCertificates SafeEnvironmentCertificate[]
  staffRegistrations     StaffRegistration[]

  @@index([organizationId], name: "idx_liability_org")
  @@index([eventId], name: "idx_liability_event")
  @@index([groupRegistrationId], name: "idx_liability_group")
  @@index([participantId], name: "idx_liability_participant")
  @@index([parentToken], name: "idx_liability_parent_token")
  @@map("liability_forms")
}

model SafeEnvironmentCertificate {
  id                  String   @id @default(uuid()) @db.Uuid
  participantId       String   @map("participant_id") @db.Uuid
  liabilityFormId     String?  @map("liability_form_id") @db.Uuid
  organizationId      String   @map("organization_id") @db.Uuid
  fileUrl             String   @map("file_url") @db.Text
  originalFilename    String?  @map("original_filename") @db.VarChar(255)
  fileSizeBytes       BigInt?  @map("file_size_bytes")
  programName         String?  @map("program_name") @db.VarChar(255)
  completionDate      DateTime? @map("completion_date") @db.Date
  expirationDate      DateTime? @map("expiration_date") @db.Date
  status              CertificateStatus @default(pending)
  uploadedByUserId    String?  @map("uploaded_by_user_id") @db.Uuid
  uploadedAt          DateTime @default(now()) @map("uploaded_at") @db.Timestamptz(6)
  verifiedAt          DateTime? @map("verified_at") @db.Timestamptz(6)
  verifiedByUserId    String?  @map("verified_by_user_id") @db.Uuid

  // Relations
  participant      Participant @relation(fields: [participantId], references: [id])
  liabilityForm    LiabilityForm? @relation(fields: [liabilityFormId], references: [id])
  organization     Organization @relation(fields: [organizationId], references: [id])
  uploadedBy       User? @relation("UploadedCertificates", fields: [uploadedByUserId], references: [id])
  verifiedBy       User? @relation("VerifiedCertificates", fields: [verifiedByUserId], references: [id])

  @@index([participantId], name: "idx_cert_participant")
  @@index([organizationId], name: "idx_cert_org")
  @@index([status], name: "idx_cert_status")
  @@map("safe_environment_certificates")
}

model LiabilityFormTemplate {
  id                String   @id @default(uuid()) @db.Uuid
  organizationId    String   @map("organization_id") @db.Uuid
  eventId           String?  @map("event_id") @db.Uuid
  formType          LiabilityFormType @map("form_type")

  // Template info
  templateName      String?  @map("template_name") @db.VarChar(255)
  description       String?  @db.Text

  // Waiver text sections
  generalWaiverText        String?  @map("general_waiver_text") @db.Text
  medicalReleaseText       String?  @map("medical_release_text") @db.Text
  photoVideoConsentText    String?  @map("photo_video_consent_text") @db.Text
  transportationConsentText String? @map("transportation_consent_text") @db.Text
  emergencyTreatmentText   String?  @map("emergency_treatment_text") @db.Text

  customQuestions   Json?    @map("custom_questions")
  customSections    Json?    @map("custom_sections")

  // Version tracking
  version           Int      @default(1)
  active            Boolean  @default(true)

  createdByUserId   String?  @map("created_by_user_id") @db.Uuid
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id])
  event        Event?       @relation(fields: [eventId], references: [id])

  @@index([organizationId], name: "idx_template_org")
  @@index([eventId], name: "idx_template_event")
  @@index([active], name: "idx_template_active")
  @@map("liability_form_templates")
}

// ===================================
// ENUMS
// ===================================

enum OrganizationType {
  diocese
  archdiocese
  parish
  seminary
  retreat_center
  other
}

enum SubscriptionTier {
  starter
  small_diocese
  growing
  conference
  enterprise
  test
}

enum SubscriptionStatus {
  active
  archived
  suspended
  trial
}

enum StripeAccountStatus {
  not_connected
  pending
  active
  restricted
  disconnected
}

enum ProcessedVia {
  online
  virtual_terminal
  manual
}

enum UserRole {
  master_admin
  org_admin
  event_manager
  finance_manager
  poros_coordinator
  salve_coordinator
  rapha_coordinator
  staff
  group_leader
  individual
  parent
  salve_user
  rapha_user
}

enum EventStatus {
  draft
  published
  registration_open
  registration_closed
  in_progress
  completed
}

enum HousingType {
  on_campus
  off_campus
  day_pass
}

enum RegistrationStatus {
  incomplete
  pending_forms
  pending_payment
  complete
}

enum Gender {
  male
  female
  prefer_not_to_say
}

enum RoomType {
  single
  double
  triple
  quad
}

enum ParticipantType {
  youth_u18
  youth_o18
  chaperone
  priest
}

enum ClergyTitle {
  father
  deacon
  mr
  most_reverend
  seminarian
}

enum SafeEnvironmentStatus {
  not_required
  pending
  uploaded
  verified
}

enum PaymentType {
  deposit
  balance
  late_fee
  refund
}

enum PaymentMethod {
  card
  check
  cash
  bank_transfer
  other
}

enum PaymentStatus {
  pending
  processing
  succeeded
  failed
  cancelled
  refunded
}

enum RegistrationType {
  group
  individual
  vendor
  staff
}

enum PaymentBalanceStatus {
  unpaid
  partial
  paid_full
  overpaid
  refunded
  pending_check_payment
}

enum LiabilityFormType {
  youth_u18
  youth_o18_chaperone
  clergy
}

enum CertificateStatus {
  pending
  verified
  rejected
  expired
}

enum QuestionType {
  text
  yes_no
  multiple_choice
  dropdown
}

enum QuestionAppliesTo {
  group
  individual
  both
}

enum WaitlistStatus {
  pending
  contacted
  registered
  expired
}

enum EditType {
  info_updated
  participant_added
  participant_removed
  payment_updated
  payment_processed
  refund_processed
}

enum RefundMethod {
  stripe
  manual
}

enum RefundReason {
  participant_removed
  group_cancellation
  event_cancellation
  overpayment_correction
  emergency_illness
  other
}

enum RefundStatus {
  pending
  completed
  failed
}

enum EmailStatus {
  sent
  failed
  bounced
}

enum PreferredPaymentMethod {
  card
  check
  no_preference
}

enum PreferredHousingType {
  on_campus
  off_campus
  day_pass
  no_default
}

enum NotificationFrequency {
  realtime
  daily
  weekly
}

enum DashboardView {
  cards
  list
  detailed
}

enum DateFormat {
  mdy
  dmy
  ymd
}

enum TimeFormat {
  h12
  h24
}

enum ParticipantSortOrder {
  name
  age
  type
  form_status
}

// ===================================
// CUSTOM REGISTRATION QUESTIONS
// ===================================

model CustomRegistrationQuestion {
  id            String   @id @default(uuid()) @db.Uuid
  eventId       String   @map("event_id") @db.Uuid
  questionText  String   @map("question_text") @db.Text
  questionType  QuestionType @map("question_type")
  options       Json?
  required      Boolean  @default(false)
  appliesTo     QuestionAppliesTo @map("applies_to")
  displayOrder  Int      @default(0) @map("display_order")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  event   Event                          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  answers CustomRegistrationAnswer[]

  @@index([eventId], name: "idx_custom_questions_event")
  @@map("custom_registration_questions")
}

model CustomRegistrationAnswer {
  id               String   @id @default(uuid()) @db.Uuid
  questionId       String   @map("question_id") @db.Uuid
  registrationId   String   @map("registration_id") @db.Uuid
  registrationType RegistrationType @map("registration_type")
  answerText       String?  @map("answer_text") @db.Text
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  question CustomRegistrationQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId], name: "idx_custom_answers_question")
  @@index([registrationId, registrationType], name: "idx_custom_answers_registration")
  @@map("custom_registration_answers")
}

// ===================================
// WAITLIST TABLES
// ===================================

model WaitlistEntry {
  id                  String   @id @default(uuid()) @db.Uuid
  eventId             String   @map("event_id") @db.Uuid
  name                String   @db.VarChar(255)
  email               String   @db.VarChar(255)
  phone               String?  @db.VarChar(20)
  partySize           Int      @default(1) @map("party_size")
  notes               String?  @db.Text
  status              WaitlistStatus @default(pending)
  notifiedAt          DateTime? @map("notified_at") @db.Timestamptz(6)
  registrationToken   String?  @unique @map("registration_token") @db.VarChar(64)
  invitationExpires   DateTime? @map("invitation_expires") @db.Timestamptz(6)
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId], name: "idx_waitlist_event")
  @@index([status], name: "idx_waitlist_status")
  @@index([email], name: "idx_waitlist_email")
  @@index([registrationToken], name: "idx_waitlist_token")
  @@map("waitlist_entries")
}

// ===================================
// EMAIL TRACKING TABLES
// ===================================

model EmailLog {
  id               String           @id @default(uuid()) @db.Uuid
  organizationId   String           @map("organization_id") @db.Uuid
  eventId          String?          @map("event_id") @db.Uuid
  registrationId   String?          @map("registration_id") @db.Uuid
  registrationType RegistrationType? @map("registration_type")
  recipientEmail   String           @map("recipient_email") @db.VarChar(255)
  recipientName    String?          @map("recipient_name") @db.VarChar(255)
  emailType        String           @map("email_type") @db.VarChar(100)
  subject          String           @db.VarChar(500)
  htmlContent      String           @map("html_content") @db.Text
  sentAt           DateTime         @default(now()) @map("sent_at") @db.Timestamptz(6)
  sentVia          String           @default("resend") @map("sent_via") @db.VarChar(50)
  sentStatus       EmailStatus      @default(sent) @map("sent_status")
  errorMessage     String?          @map("error_message") @db.Text
  metadata         Json?
  createdAt        DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId], name: "idx_email_org")
  @@index([eventId], name: "idx_email_event")
  @@index([registrationId, registrationType], name: "idx_email_registration")
  @@index([recipientEmail], name: "idx_email_recipient")
  @@index([sentAt], name: "idx_email_sent_at")
  @@map("email_logs")
}

// ===================================
// REGISTRATION MANAGEMENT TABLES
// ===================================

model RegistrationEdit {
  id                  String   @id @default(uuid()) @db.Uuid
  registrationId      String   @map("registration_id") @db.Uuid
  registrationType    RegistrationType @map("registration_type")
  editedByUserId      String   @map("edited_by_user_id") @db.Uuid
  editedAt            DateTime @default(now()) @map("edited_at") @db.Timestamptz(6)
  editType            EditType @map("edit_type")
  changesMade         Json?    @map("changes_made")
  oldTotal            Decimal? @map("old_total") @db.Decimal(10, 2)
  newTotal            Decimal? @map("new_total") @db.Decimal(10, 2)
  difference          Decimal? @db.Decimal(10, 2)
  adminNotes          String?  @map("admin_notes") @db.Text
  emailSent           Boolean  @default(false) @map("email_sent")
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  editedBy User @relation(fields: [editedByUserId], references: [id])

  @@index([registrationId], name: "idx_reg_edit_registration")
  @@index([editedByUserId], name: "idx_reg_edit_user")
  @@index([editedAt], name: "idx_reg_edit_date")
  @@map("registration_edits")
}

model Refund {
  id                  String   @id @default(uuid()) @db.Uuid
  registrationId      String   @map("registration_id") @db.Uuid
  registrationType    RegistrationType @map("registration_type")
  refundAmount        Decimal  @map("refund_amount") @db.Decimal(10, 2)
  refundMethod        RefundMethod @map("refund_method")
  refundReason        RefundReason @map("refund_reason")
  notes               String?  @db.Text
  processedByUserId   String   @map("processed_by_user_id") @db.Uuid
  processedAt         DateTime @default(now()) @map("processed_at") @db.Timestamptz(6)
  stripeRefundId      String?  @map("stripe_refund_id") @db.VarChar(255)
  status              RefundStatus @default(pending)
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  processedBy User @relation(fields: [processedByUserId], references: [id])

  @@index([registrationId], name: "idx_refund_registration")
  @@index([processedByUserId], name: "idx_refund_user")
  @@index([status], name: "idx_refund_status")
  @@map("refunds")
}

// ===================================
// USER PREFERENCES TABLE
// ===================================

model UserPreferences {
  id                           String   @id @default(uuid()) @db.Uuid
  clerkUserId                  String   @unique @map("clerk_user_id") @db.VarChar(255)
  groupRegistrationId          String?  @map("group_registration_id") @db.Uuid
  createdAt                    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                    DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Account Settings
  phone                        String?  @db.Text
  profilePhotoUrl              String?  @map("profile_photo_url") @db.Text
  groupNameDefault             String?  @map("group_name_default") @db.Text
  parishNameDefault            String?  @map("parish_name_default") @db.Text
  dioceseDefault               String?  @map("diocese_default") @db.Text
  mailingAddress               Json?    @map("mailing_address")
  billingAddress               Json?    @map("billing_address")

  // Registration Preferences
  primaryContactName           String?  @map("primary_contact_name") @db.Text
  primaryContactPhone          String?  @map("primary_contact_phone") @db.Text
  primaryContactEmail          String?  @map("primary_contact_email") @db.Text
  secondaryContactName         String?  @map("secondary_contact_name") @db.Text
  secondaryContactPhone        String?  @map("secondary_contact_phone") @db.Text
  secondaryContactEmail        String?  @map("secondary_contact_email") @db.Text
  preferredPaymentMethod       PreferredPaymentMethod? @default(no_preference) @map("preferred_payment_method")
  preferredHousingType         PreferredHousingType? @default(no_default) @map("preferred_housing_type")
  specialRequestsDefault       String?  @map("special_requests_default") @db.Text

  // Notification Settings
  emailRegistrationConfirmation Boolean @default(true) @map("email_registration_confirmation")
  emailPaymentReceived         Boolean  @default(true) @map("email_payment_received")
  emailPaymentReminders        Boolean  @default(true) @map("email_payment_reminders")
  emailPaymentOverdue          Boolean  @default(true) @map("email_payment_overdue")
  emailRegistrationUpdated     Boolean  @default(true) @map("email_registration_updated")
  emailFormCompleted           Boolean  @default(true) @map("email_form_completed")
  emailFormReminders           Boolean  @default(true) @map("email_form_reminders")
  emailAllFormsComplete        Boolean  @default(true) @map("email_all_forms_complete")
  emailFormEdited              Boolean  @default(true) @map("email_form_edited")
  emailEventAnnouncements      Boolean  @default(true) @map("email_event_announcements")
  emailScheduleChanges         Boolean  @default(true) @map("email_schedule_changes")
  emailDeadlines               Boolean  @default(true) @map("email_deadlines")
  emailWeeklyUpdates           Boolean  @default(false) @map("email_weekly_updates")
  emailParticipantAdded        Boolean  @default(true) @map("email_participant_added")
  emailParticipantRemoved      Boolean  @default(true) @map("email_participant_removed")
  emailCertificateVerified     Boolean  @default(true) @map("email_certificate_verified")
  emailNewsletter              Boolean  @default(false) @map("email_newsletter")
  emailNewEvents               Boolean  @default(false) @map("email_new_events")
  emailTips                    Boolean  @default(false) @map("email_tips")
  notificationFrequency        NotificationFrequency @default(realtime) @map("notification_frequency")
  quietHoursEnabled            Boolean  @default(false) @map("quiet_hours_enabled")
  quietHoursStart              DateTime? @map("quiet_hours_start") @db.Time
  quietHoursEnd                DateTime? @map("quiet_hours_end") @db.Time
  smsEnabled                   Boolean  @default(false) @map("sms_enabled")
  smsPaymentReminders          Boolean  @default(false) @map("sms_payment_reminders")
  smsUrgentUpdates             Boolean  @default(false) @map("sms_urgent_updates")
  smsPaymentReceived           Boolean  @default(false) @map("sms_payment_received")

  // Display Preferences
  dashboardView                DashboardView @default(cards) @map("dashboard_view")
  dateFormat                   DateFormat @default(mdy) @map("date_format")
  timeFormat                   TimeFormat @default(h12) @map("time_format")
  timezone                     String   @default("America/Chicago") @db.Text
  participantSortOrder         ParticipantSortOrder @default(name) @map("participant_sort_order")
  itemsPerPage                 Int      @default(25) @map("items_per_page")
  showAge                      Boolean  @default(true) @map("show_age")
  showGender                   Boolean  @default(true) @map("show_gender")
  showTshirt                   Boolean  @default(true) @map("show_tshirt")
  showFormStatus               Boolean  @default(true) @map("show_form_status")
  showDietary                  Boolean  @default(true) @map("show_dietary")
  showAllergies                Boolean  @default(true) @map("show_allergies")
  showEmergencyContact         Boolean  @default(false) @map("show_emergency_contact")
  showMedical                  Boolean  @default(false) @map("show_medical")
  sessionTimeoutMinutes        Int      @default(30) @map("session_timeout_minutes")
  twoFactorEnabled             Boolean  @default(false) @map("two_factor_enabled")
  highContrastMode             Boolean  @default(false) @map("high_contrast_mode")
  largerText                   Boolean  @default(false) @map("larger_text")
  screenReaderOptimized        Boolean  @default(false) @map("screen_reader_optimized")
  language                     String   @default("en") @db.Text

  // Relations
  groupRegistration GroupRegistration? @relation(fields: [groupRegistrationId], references: [id])

  @@index([clerkUserId], name: "idx_user_prefs_clerk_user_id")
  @@index([groupRegistrationId], name: "idx_user_prefs_group_registration")
  @@map("user_preferences")
}

// ===================================
// REPORT TEMPLATES TABLE
// ===================================

model ReportTemplate {
  id              String   @id @default(uuid()) @db.Uuid
  organizationId  String   @map("organization_id") @db.Uuid
  createdByUserId String   @map("created_by_user_id") @db.Uuid
  name            String   @db.VarChar(255)
  description     String?  @db.Text
  reportType      ReportType @map("report_type")
  configuration   Json     // Stores field selections, filters, sorting preferences
  isPublic        Boolean  @default(false) @map("is_public") // Whether other users in org can use this template
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  createdBy User @relation("ReportTemplatesCreated", fields: [createdByUserId], references: [id])

  @@index([organizationId], name: "idx_report_template_org")
  @@index([createdByUserId], name: "idx_report_template_user")
  @@index([reportType], name: "idx_report_template_type")
  @@map("report_templates")
}

enum ReportType {
  registration
  financial
  forms
  housing
  medical
  certificates
  tshirts
  balances
  roster
  custom
}

// ===================================
// POROS PORTAL - HOUSING & ASSIGNMENTS
// ===================================

model Building {
  id           String   @id @default(uuid()) @db.Uuid
  eventId      String   @map("event_id") @db.Uuid
  name         String   @db.VarChar(255)
  gender       BuildingGender
  housingType  BuildingHousingType @map("housing_type")
  totalFloors  Int      @default(1) @map("total_floors")
  totalRooms   Int      @default(0) @map("total_rooms")
  totalBeds    Int      @default(0) @map("total_beds")
  notes        String?  @db.Text
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  rooms Room[]

  @@index([eventId], name: "idx_buildings_event")
  @@map("buildings")
}

model Room {
  id              String   @id @default(uuid()) @db.Uuid
  buildingId      String   @map("building_id") @db.Uuid
  roomNumber      String   @map("room_number") @db.VarChar(50)
  floor           Int      @default(1)
  bedCount        Int      @default(2) @map("bed_count")
  roomType        RoomType? @map("room_type")
  gender          BuildingGender?
  housingType     BuildingHousingType? @map("housing_type")
  capacity        Int
  currentOccupancy Int     @default(0) @map("current_occupancy")
  notes           String?  @db.Text
  isAvailable     Boolean  @default(true) @map("is_available")
  isAdaAccessible Boolean  @default(false) @map("is_ada_accessible")
  adaFeatures     String?  @map("ada_features") @db.Text
  allocatedToGroupId String? @map("allocated_to_group_id") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  building        Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  allocatedToGroup GroupRegistration? @relation("RoomsAllocatedToGroup", fields: [allocatedToGroupId], references: [id], onDelete: SetNull)
  roomAssignments RoomAssignment[]
  smallGroups     SmallGroup[]
  adaIndividuals  AdaIndividual[]

  @@unique([buildingId, roomNumber])
  @@index([buildingId], name: "idx_rooms_building")
  @@index([isAvailable], name: "idx_rooms_available")
  @@index([gender], name: "idx_rooms_gender")
  @@index([allocatedToGroupId], name: "idx_rooms_allocated_group")
  @@map("rooms")
}

model RoomAssignment {
  id                        String   @id @default(uuid()) @db.Uuid
  roomId                    String   @map("room_id") @db.Uuid
  participantId             String?  @map("participant_id") @db.Uuid
  individualRegistrationId  String?  @map("individual_registration_id") @db.Uuid
  groupRegistrationId       String?  @map("group_registration_id") @db.Uuid
  bedNumber                 Int?     @map("bed_number")
  assignedAt                DateTime @default(now()) @map("assigned_at") @db.Timestamptz(6)
  assignedBy                String?  @map("assigned_by") @db.Uuid
  notes                     String?  @db.Text

  // Relations
  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId], name: "idx_room_assignments_room")
  @@index([participantId], name: "idx_room_assignments_participant")
  @@index([individualRegistrationId], name: "idx_room_assignments_individual")
  @@index([groupRegistrationId], name: "idx_room_assignments_group")
  @@map("room_assignments")
}

model SeatingSection {
  id                  String   @id @default(uuid()) @db.Uuid
  eventId             String   @map("event_id") @db.Uuid
  name                String   @db.VarChar(255)
  sectionCode         String?  @map("section_code") @db.VarChar(50)
  color               String   @default("#1E3A5F") @db.VarChar(7)
  capacity            Int      @default(100)
  currentOccupancy    Int      @default(0) @map("current_occupancy")
  locationDescription String?  @map("location_description") @db.Text
  publicVisible       Boolean  @default(true) @map("public_visible")
  displayOrder        Int      @default(0) @map("display_order")
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  seatingAssignments SeatingAssignment[]

  @@index([eventId], name: "idx_seating_sections_event")
  @@map("seating_sections")
}

model SeatingAssignment {
  id                        String   @id @default(uuid()) @db.Uuid
  sectionId                 String   @map("section_id") @db.Uuid
  groupRegistrationId       String?  @map("group_registration_id") @db.Uuid
  individualRegistrationId  String?  @map("individual_registration_id") @db.Uuid
  participantCountOverride  Int?     @map("participant_count_override")
  overrideNotes             String?  @map("override_notes") @db.Text
  assignedAt                DateTime @default(now()) @map("assigned_at") @db.Timestamptz(6)
  assignedBy                String?  @map("assigned_by") @db.Uuid

  // Relations
  section SeatingSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@index([sectionId], name: "idx_seating_assignments_section")
  @@index([groupRegistrationId], name: "idx_seating_assignments_group")
  @@index([individualRegistrationId], name: "idx_seating_assignments_individual")
  @@map("seating_assignments")
}

model PorosStaff {
  id         String   @id @default(uuid()) @db.Uuid
  eventId    String   @map("event_id") @db.Uuid
  firstName  String   @map("first_name") @db.VarChar(255)
  lastName   String   @map("last_name") @db.VarChar(255)
  email      String?  @db.VarChar(255)
  phone      String?  @db.VarChar(20)
  staffType  StaffType @map("staff_type")
  gender     Gender?
  diocese    String?  @db.VarChar(255)
  notes      String?  @db.Text
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  sglSmallGroups   SmallGroup[] @relation("SmallGroupSGL")
  coSglSmallGroups SmallGroup[] @relation("SmallGroupCoSGL")

  @@index([eventId], name: "idx_poros_staff_event")
  @@index([staffType], name: "idx_poros_staff_type")
  @@map("poros_staff")
}

model SmallGroup {
  id            String   @id @default(uuid()) @db.Uuid
  eventId       String   @map("event_id") @db.Uuid
  name          String   @db.VarChar(255)
  groupNumber   Int?     @map("group_number")
  sglId         String?  @map("sgl_id") @db.Uuid
  coSglId       String?  @map("co_sgl_id") @db.Uuid
  meetingRoomId String?  @map("meeting_room_id") @db.Uuid
  meetingTime   String?  @map("meeting_time") @db.VarChar(100)
  meetingPlace  String?  @map("meeting_place") @db.VarChar(255)
  capacity      Int      @default(12)
  currentSize   Int      @default(0) @map("current_size")
  notes         String?  @db.Text
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  sgl         PorosStaff? @relation("SmallGroupSGL", fields: [sglId], references: [id], onDelete: SetNull)
  coSgl       PorosStaff? @relation("SmallGroupCoSGL", fields: [coSglId], references: [id], onDelete: SetNull)
  meetingRoom Room?       @relation(fields: [meetingRoomId], references: [id], onDelete: SetNull)
  assignments SmallGroupAssignment[]

  @@index([eventId], name: "idx_small_groups_event")
  @@index([sglId], name: "idx_small_groups_sgl")
  @@map("small_groups")
}

model SmallGroupAssignment {
  id                        String   @id @default(uuid()) @db.Uuid
  smallGroupId              String   @map("small_group_id") @db.Uuid
  participantId             String?  @map("participant_id") @db.Uuid
  individualRegistrationId  String?  @map("individual_registration_id") @db.Uuid
  groupRegistrationId       String?  @map("group_registration_id") @db.Uuid
  assignedAt                DateTime @default(now()) @map("assigned_at") @db.Timestamptz(6)
  assignedBy                String?  @map("assigned_by") @db.Uuid

  // Relations
  smallGroup SmallGroup @relation(fields: [smallGroupId], references: [id], onDelete: Cascade)

  @@index([smallGroupId], name: "idx_small_group_assignments_group")
  @@index([participantId], name: "idx_small_group_assignments_participant")
  @@index([individualRegistrationId], name: "idx_small_group_assignments_individual")
  @@index([groupRegistrationId], name: "idx_small_group_assignments_group_reg")
  @@map("small_group_assignments")
}

model MealGroup {
  id           String   @id @default(uuid()) @db.Uuid
  eventId      String   @map("event_id") @db.Uuid
  name         String   @db.VarChar(100)
  color        String   @db.VarChar(50)
  colorHex     String   @map("color_hex") @db.VarChar(7)
  breakfastTime String? @map("breakfast_time") @db.VarChar(50)
  lunchTime    String?  @map("lunch_time") @db.VarChar(50)
  dinnerTime   String?  @map("dinner_time") @db.VarChar(50)
  capacity     Int      @default(100)
  currentSize  Int      @default(0) @map("current_size")
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  assignments MealGroupAssignment[]

  @@index([eventId], name: "idx_meal_groups_event")
  @@index([isActive], name: "idx_meal_groups_active")
  @@map("meal_groups")
}

model MealGroupAssignment {
  id                        String   @id @default(uuid()) @db.Uuid
  mealGroupId               String   @map("meal_group_id") @db.Uuid
  groupRegistrationId       String?  @map("group_registration_id") @db.Uuid
  individualRegistrationId  String?  @map("individual_registration_id") @db.Uuid
  participantCountOverride  Int?     @map("participant_count_override")
  overrideNotes             String?  @map("override_notes") @db.Text
  assignedAt                DateTime @default(now()) @map("assigned_at") @db.Timestamptz(6)
  assignedBy                String?  @map("assigned_by") @db.Uuid

  // Relations
  mealGroup MealGroup @relation(fields: [mealGroupId], references: [id], onDelete: Cascade)

  @@index([mealGroupId], name: "idx_meal_group_assignments_group")
  @@index([groupRegistrationId], name: "idx_meal_group_assignments_reg")
  @@map("meal_group_assignments")
}

model AdaIndividual {
  id                        String   @id @default(uuid()) @db.Uuid
  eventId                   String   @map("event_id") @db.Uuid
  participantId             String?  @map("participant_id") @db.Uuid
  individualRegistrationId  String?  @map("individual_registration_id") @db.Uuid
  name                      String   @db.VarChar(255)
  gender                    Gender?
  accessibilityNeed         String   @map("accessibility_need") @db.Text
  roomId                    String?  @map("room_id") @db.Uuid
  notes                     String?  @db.Text
  createdAt                 DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                 DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  room Room? @relation(fields: [roomId], references: [id], onDelete: SetNull)

  @@index([eventId], name: "idx_ada_individuals_event")
  @@index([roomId], name: "idx_ada_individuals_room")
  @@map("ada_individuals")
}

// ===================================
// POROS ENUMS
// ===================================

enum BuildingGender {
  male
  female
  mixed
}

enum BuildingHousingType {
  youth_u18
  chaperone_18plus
  clergy
  general
}

enum StaffType {
  sgl
  co_sgl
  seminarian
  priest
  deacon
  religious
  counselor
  volunteer
  other
}

// ===================================
// POROS PUBLIC PORTAL MODELS
// ===================================

model PorosResource {
  id        String   @id @default(uuid()) @db.Uuid
  eventId   String   @map("event_id") @db.Uuid
  name      String   @db.VarChar(255)
  type      String   @db.VarChar(50) // map, schedule, link, pdf, other
  url       String   @db.Text
  order     Int      @default(0)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([eventId], name: "idx_poros_resources_event")
  @@map("poros_resources")
}

model PorosScheduleEntry {
  id          String   @id @default(uuid()) @db.Uuid
  eventId     String   @map("event_id") @db.Uuid
  day         String   @db.VarChar(50) // friday, saturday, sunday, or custom day name
  dayDate     DateTime? @map("day_date") @db.Date
  startTime   String   @map("start_time") @db.VarChar(20)
  endTime     String?  @map("end_time") @db.VarChar(20)
  title       String   @db.VarChar(255)
  location    String?  @db.VarChar(255)
  description String?  @db.Text
  order       Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([eventId], name: "idx_poros_schedule_event")
  @@index([day], name: "idx_poros_schedule_day")
  @@map("poros_schedule_entries")
}

model PorosMealTime {
  id        String   @id @default(uuid()) @db.Uuid
  eventId   String   @map("event_id") @db.Uuid
  day       String   @db.VarChar(50) // friday, saturday, sunday, or custom
  dayDate   DateTime? @map("day_date") @db.Date
  meal      String   @db.VarChar(20) // breakfast, lunch, dinner
  color     String   @db.VarChar(50) // blue, red, orange, etc.
  time      String   @db.VarChar(20) // e.g., "7:00 AM"
  order     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([eventId, day, meal, color], name: "unique_meal_time")
  @@index([eventId], name: "idx_poros_meal_times_event")
  @@map("poros_meal_times")
}

model MealColorAssignment {
  id                  String   @id @default(uuid()) @db.Uuid
  eventId             String   @map("event_id") @db.Uuid
  groupRegistrationId String?  @map("group_registration_id") @db.Uuid
  color               String   @db.VarChar(50)
  assignedAt          DateTime @default(now()) @map("assigned_at") @db.Timestamptz(6)
  assignedBy          String?  @map("assigned_by") @db.Uuid

  @@unique([groupRegistrationId], name: "unique_meal_color_group")
  @@index([eventId], name: "idx_meal_color_assignments_event")
  @@map("meal_color_assignments")
}

model PorosSchedulePdf {
  id        String   @id @default(uuid()) @db.Uuid
  eventId   String   @unique @map("event_id") @db.Uuid
  filename  String   @db.VarChar(255)
  url       String   @db.Text
  uploadedAt DateTime @default(now()) @map("uploaded_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("poros_schedule_pdfs")
}

// ===================================
// SALVE CHECK-IN SYSTEM
// ===================================

model CheckInLog {
  id            String   @id @default(uuid()) @db.Uuid
  eventId       String   @map("event_id") @db.Uuid
  participantId String?  @map("participant_id") @db.Uuid
  groupRegistrationId String? @map("group_registration_id") @db.Uuid
  individualRegistrationId String? @map("individual_registration_id") @db.Uuid
  action        CheckInAction
  station       String?  @db.VarChar(100)
  userId        String?  @map("user_id") @db.Uuid
  notes         String?  @db.Text
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([eventId], name: "idx_check_in_log_event")
  @@index([participantId], name: "idx_check_in_log_participant")
  @@index([groupRegistrationId], name: "idx_check_in_log_group")
  @@index([individualRegistrationId], name: "idx_check_in_log_individual")
  @@index([createdAt], name: "idx_check_in_log_created")
  @@map("check_in_logs")
}

model NameTagTemplate {
  id              String   @id @default(uuid()) @db.Uuid
  eventId         String   @unique @map("event_id") @db.Uuid
  templateType    NameTagTemplateType @default(classic) @map("template_type")
  logoUrl         String?  @map("logo_url") @db.Text
  backgroundUrl   String?  @map("background_url") @db.Text
  primaryColor    String   @default("#1E3A5F") @map("primary_color") @db.VarChar(7)
  accentColor     String   @default("#9C8466") @map("accent_color") @db.VarChar(7)
  textColor       String   @default("#000000") @map("text_color") @db.VarChar(7)
  tagSize         NameTagSize @default(lanyard) @map("tag_size")
  showParish      Boolean  @default(true) @map("show_parish")
  showAge         Boolean  @default(false) @map("show_age")
  showGrade       Boolean  @default(false) @map("show_grade")
  showCityState   Boolean  @default(false) @map("show_city_state")
  showRole        Boolean  @default(true) @map("show_role")
  showMealColor   Boolean  @default(true) @map("show_meal_color")
  showSmallGroup  Boolean  @default(true) @map("show_small_group")
  showHousing     Boolean  @default(false) @map("show_housing")
  showQrCode      Boolean  @default(true) @map("show_qr_code")
  settingsJson    Json?    @map("settings_json") @db.JsonB // Full template settings as JSON
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("name_tag_templates")
}

model WelcomePacketInsert {
  id           String   @id @default(uuid()) @db.Uuid
  eventId      String   @map("event_id") @db.Uuid
  name         String   @db.VarChar(255)
  fileUrl      String   @map("file_url") @db.Text
  fileType     String   @default("pdf") @map("file_type") @db.VarChar(20) // pdf, image
  imageUrls    Json?    @map("image_urls") // Array of image URLs for embedding in print
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([eventId], name: "idx_welcome_packet_inserts_event")
  @@map("welcome_packet_inserts")
}

model WelcomePacketSettings {
  id                      String   @id @default(uuid()) @db.Uuid
  eventId                 String   @unique @map("event_id") @db.Uuid
  includeCampusMap        Boolean  @default(true) @map("include_campus_map")
  includeMealSchedule     Boolean  @default(true) @map("include_meal_schedule")
  includeEventSchedule    Boolean  @default(true) @map("include_event_schedule")
  includeEmergencyProcedures Boolean @default(true) @map("include_emergency_procedures")
  includeHousingColumn    Boolean  @default(true) @map("include_housing_column")
  campusMapUrl            String?  @map("campus_map_url") @db.Text
  emergencyProceduresUrl  String?  @map("emergency_procedures_url") @db.Text
  welcomeLetterText       String?  @map("welcome_letter_text") @db.Text
  createdAt               DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("welcome_packet_settings")
}

enum CheckInAction {
  check_in
  check_out
  print_packet
  print_name_tag
  print_verification
  staff_override
  late_arrival
}

enum NameTagTemplateType {
  classic
  modern
  bold
  minimal
  custom
}

enum NameTagSize {
  vertical_3x4
  horizontal_4x3
  lanyard
}

// ===================================
// RAPHA MEDICAL PLATFORM
// ===================================

model MedicalIncident {
  id                    String   @id @default(uuid()) @db.Uuid
  eventId               String   @map("event_id") @db.Uuid
  participantId         String?  @map("participant_id") @db.Uuid
  liabilityFormId       String?  @map("liability_form_id") @db.Uuid
  individualRegistrationId String? @map("individual_registration_id") @db.Uuid
  // Store names directly for reliable lookup (denormalized for HIPAA audit trail)
  participantName       String?  @map("participant_name") @db.VarChar(255)
  participantAge        Int?     @map("participant_age")
  groupName             String?  @map("group_name") @db.VarChar(255)
  incidentType          IncidentType @map("incident_type")
  severity              IncidentSeverity
  incidentDate          DateTime @map("incident_date") @db.Date
  incidentTime          String   @map("incident_time") @db.VarChar(20)
  location              String?  @db.Text
  description           String   @db.Text
  treatmentProvided     String   @map("treatment_provided") @db.Text
  staffMemberName       String   @map("staff_member_name") @db.VarChar(255)
  staffMemberUserId     String?  @map("staff_member_user_id") @db.Uuid
  parentContacted       Boolean  @default(false) @map("parent_contacted")
  parentContactTime     DateTime? @map("parent_contact_time") @db.Timestamptz(6)
  parentContactMethod   ParentContactMethod? @map("parent_contact_method")
  parentContactNotes    String?  @map("parent_contact_notes") @db.Text
  sentToHospital        Boolean  @default(false) @map("sent_to_hospital")
  hospitalName          String?  @map("hospital_name") @db.VarChar(255)
  ambulanceCalled       Boolean  @default(false) @map("ambulance_called")
  status                IncidentStatus @default(active)
  participantDisposition ParticipantDisposition? @map("participant_disposition")
  followUpRequired      Boolean  @default(false) @map("follow_up_required")
  followUpNotes         String?  @map("follow_up_notes") @db.Text
  nextCheckTime         DateTime? @map("next_check_time") @db.Timestamptz(6)
  resolvedAt            DateTime? @map("resolved_at") @db.Timestamptz(6)
  resolutionNotes       String?  @map("resolution_notes") @db.Text
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  updates MedicalIncidentUpdate[]

  @@index([eventId, status], name: "idx_medical_incident_event_status")
  @@index([participantId], name: "idx_medical_incident_participant")
  @@index([liabilityFormId], name: "idx_medical_incident_liability_form")
  @@index([incidentDate], name: "idx_medical_incident_date")
  @@map("medical_incidents")
}

model MedicalIncidentUpdate {
  id             String   @id @default(uuid()) @db.Uuid
  incidentId     String   @map("incident_id") @db.Uuid
  updateText     String   @map("update_text") @db.Text
  updatedByName  String   @map("updated_by_name") @db.VarChar(255)
  updatedByUserId String? @map("updated_by_user_id") @db.Uuid
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  incident MedicalIncident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@index([incidentId], name: "idx_medical_incident_update_incident")
  @@map("medical_incident_updates")
}

model MedicalAccessLog {
  id            String   @id @default(uuid()) @db.Uuid
  eventId       String   @map("event_id") @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  userName      String   @map("user_name") @db.VarChar(255)
  action        String   @db.VarChar(100)
  resourceType  String   @map("resource_type") @db.VarChar(50)
  resourceId    String?  @map("resource_id") @db.Uuid
  details       String?  @db.Text
  ipAddress     String?  @map("ip_address") @db.VarChar(50)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([eventId], name: "idx_medical_access_log_event")
  @@index([userId], name: "idx_medical_access_log_user")
  @@index([createdAt], name: "idx_medical_access_log_created")
  @@map("medical_access_logs")
}

enum IncidentType {
  injury
  illness
  allergic_reaction
  medication_administration
  other
}

enum IncidentSeverity {
  minor
  moderate
  severe
}

enum IncidentStatus {
  active
  monitoring
  resolved
}

enum ParentContactMethod {
  phone
  email
  in_person
}

enum ParticipantDisposition {
  returned_to_activities
  resting_in_health_office
  sent_home
  hospitalized
}

// ===================================
// MASTER ADMIN TABLES & ENUMS
// ===================================

enum OrganizationStatus {
  pending
  active
  suspended
  cancelled
}

enum BillingCycle {
  monthly
  annual
}

enum TicketStatus {
  open
  in_progress
  waiting_on_customer
  resolved
  closed
}

enum TicketPriority {
  low
  medium
  high
  urgent
}

enum OnboardingRequestStatus {
  pending
  approved
  rejected
}

enum PaymentMethodPreference {
  credit_card
  check
}

enum HowDidYouHear {
  google_search
  referral
  social_media
  conference_event
  other
}

model SupportTicket {
  id                String   @id @default(uuid()) @db.Uuid
  ticketNumber      String   @unique @map("ticket_number") @db.VarChar(20)
  organizationId    String   @map("organization_id") @db.Uuid
  eventId           String?  @map("event_id") @db.Uuid
  submittedByUserId String   @map("submitted_by_user_id") @db.Uuid
  category          String   @db.VarChar(255)
  subject           String   @db.VarChar(500)
  description       String   @db.Text
  issueUrl          String?  @map("issue_url") @db.Text
  status            TicketStatus @default(open)
  priority          TicketPriority @default(medium)
  assignedToUserId  String?  @map("assigned_to_user_id") @db.Uuid
  resolvedAt        DateTime? @map("resolved_at") @db.Timestamptz(6)
  resolutionNotes   String?  @map("resolution_notes") @db.Text
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization      Organization @relation(fields: [organizationId], references: [id])
  event             Event? @relation(fields: [eventId], references: [id])
  submittedByUser   User @relation("TicketsSubmittedByUser", fields: [submittedByUserId], references: [id])
  assignedToUser    User? @relation("TicketsAssignedToUser", fields: [assignedToUserId], references: [id])
  messages          SupportTicketMessage[]

  @@index([organizationId], name: "idx_support_ticket_org")
  @@index([eventId], name: "idx_support_ticket_event")
  @@index([status], name: "idx_support_ticket_status")
  @@index([priority], name: "idx_support_ticket_priority")
  @@index([submittedByUserId], name: "idx_support_ticket_submitted_by")
  @@index([assignedToUserId], name: "idx_support_ticket_assigned_to")
  @@map("support_tickets")
}

model SupportTicketMessage {
  id         String   @id @default(uuid()) @db.Uuid
  ticketId   String   @map("ticket_id") @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  message    String   @db.Text
  isInternal Boolean  @default(false) @map("is_internal")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  ticket     SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user       User @relation(fields: [userId], references: [id])

  @@index([ticketId], name: "idx_support_ticket_message_ticket")
  @@map("support_ticket_messages")
}

model OrganizationOnboardingRequest {
  id                          String   @id @default(uuid()) @db.Uuid
  status                      OnboardingRequestStatus @default(pending)
  organizationName            String   @map("organization_name") @db.VarChar(255)
  organizationType            String?  @map("organization_type") @db.VarChar(100)
  contactFirstName            String   @map("contact_first_name") @db.VarChar(255)
  contactLastName             String   @map("contact_last_name") @db.VarChar(255)
  contactEmail                String   @map("contact_email") @db.VarChar(255)
  contactPhone                String   @map("contact_phone") @db.VarChar(20)
  contactJobTitle             String?  @map("contact_job_title") @db.VarChar(255)
  legalEntityName             String?  @map("legal_entity_name") @db.VarChar(255)
  taxId                       String?  @map("tax_id") @db.VarChar(50)
  billingAddress              String?  @map("billing_address") @db.Text
  website                     String?  @db.VarChar(255)
  estimatedEventsPerYear      Int?     @map("estimated_events_per_year")
  estimatedRegistrationsPerYear Int?   @map("estimated_registrations_per_year")
  requestedTier               String?  @map("requested_tier") @db.VarChar(50)
  billingCyclePreference      BillingCycle? @map("billing_cycle_preference")
  paymentMethodPreference     PaymentMethodPreference? @map("payment_method_preference")
  howDidYouHear               HowDidYouHear? @map("how_did_you_hear")
  howDidYouHearOther          String?  @map("how_did_you_hear_other") @db.VarChar(255)
  additionalNotes             String?  @map("additional_notes") @db.Text
  approvedByUserId            String?  @map("approved_by_user_id") @db.Uuid
  approvedAt                  DateTime? @map("approved_at") @db.Timestamptz(6)
  rejectedReason              String?  @map("rejected_reason") @db.Text
  createdOrganizationId       String?  @map("created_organization_id") @db.Uuid
  createdAt                   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  approvedByUser              User? @relation("OnboardingRequestsApprovedByUser", fields: [approvedByUserId], references: [id])

  @@index([status], name: "idx_onboarding_request_status")
  @@index([contactEmail], name: "idx_onboarding_request_email")
  @@map("organization_onboarding_requests")
}

model PlatformSetting {
  id              String   @id @default(uuid()) @db.Uuid
  settingKey      String   @unique @map("setting_key") @db.VarChar(100)
  settingValue    String   @map("setting_value") @db.Text
  updatedByUserId String?  @map("updated_by_user_id") @db.Uuid
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  updatedByUser   User? @relation("PlatformSettingsUpdatedByUser", fields: [updatedByUserId], references: [id])

  @@map("platform_settings")
}

model Invoice {
  id                String   @id @default(uuid()) @db.Uuid
  invoiceNumber     Int      @unique @map("invoice_number")
  organizationId    String   @map("organization_id") @db.Uuid
  invoiceType       InvoiceType @map("invoice_type")
  amount            Decimal  @db.Decimal(10, 2)
  description       String?  @db.Text
  lineItems         Json?    @map("line_items") @db.JsonB
  dueDate           DateTime @map("due_date") @db.Date
  status            InvoiceStatus @default(pending)
  paymentMethod     PaymentMethodPreference? @map("payment_method")
  paidAt            DateTime? @map("paid_at") @db.Timestamptz(6)
  pdfUrl            String?  @map("pdf_url") @db.Text
  notes             String?  @db.Text
  periodStart       DateTime? @map("period_start") @db.Date
  periodEnd         DateTime? @map("period_end") @db.Date
  paymentToken      String?  @unique @map("payment_token") @db.VarChar(64)
  stripePaymentIntentId String? @map("stripe_payment_intent_id") @db.VarChar(255)
  stripeCheckoutSessionId String? @map("stripe_checkout_session_id") @db.VarChar(255)
  createdByUserId   String?  @map("created_by_user_id") @db.Uuid
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization      Organization @relation(fields: [organizationId], references: [id])
  createdBy         User? @relation("InvoicesCreatedByUser", fields: [createdByUserId], references: [id])

  @@index([organizationId], name: "idx_invoice_org")
  @@index([status], name: "idx_invoice_status")
  @@index([paymentToken], name: "idx_invoice_payment_token")
  @@map("invoices")
}

enum InvoiceType {
  setup_fee
  subscription
  reactivation_fee
  custom
}

enum InvoiceStatus {
  pending
  paid
  overdue
  cancelled
}

model PlatformActivityLog {
  id              String   @id @default(uuid()) @db.Uuid
  organizationId  String?  @map("organization_id") @db.Uuid
  userId          String?  @map("user_id") @db.Uuid
  activityType    String   @map("activity_type") @db.VarChar(100)
  description     String   @db.Text
  metadata        Json?    @db.JsonB
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([organizationId], name: "idx_platform_activity_org")
  @@index([activityType], name: "idx_platform_activity_type")
  @@index([createdAt], name: "idx_platform_activity_created")
  @@map("platform_activity_logs")
}

// ===================================
// BILLING NOTES (Master Admin)
// ===================================

model BillingNote {
  id              String   @id @default(uuid()) @db.Uuid
  organizationId  String   @map("organization_id") @db.Uuid
  paymentId       String?  @map("payment_id") @db.Uuid
  invoiceId       String?  @map("invoice_id") @db.Uuid
  noteType        BillingNoteType @default(general) @map("note_type")
  note            String   @db.Text
  createdByUserId String   @map("created_by_user_id") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id])
  createdBy       User @relation("BillingNotesCreatedByUser", fields: [createdByUserId], references: [id])

  @@index([organizationId], name: "idx_billing_note_org")
  @@index([paymentId], name: "idx_billing_note_payment")
  @@index([invoiceId], name: "idx_billing_note_invoice")
  @@map("billing_notes")
}

enum BillingNoteType {
  general
  check_expected
  check_received
  payment_plan
  reminder_sent
  special_arrangement
}

// ===================================
// INBOUND EMAIL HANDLING
// ===================================

// Raw storage for received emails via Resend webhook
model ReceivedEmail {
  id            String    @id @default(uuid()) @db.Uuid
  resendEmailId String    @unique @map("resend_email_id") @db.VarChar(255)
  fromAddress   String    @map("from_address") @db.VarChar(500)
  toAddresses   String[]  @map("to_addresses")
  ccAddresses   String[]  @map("cc_addresses") @default([])
  bccAddresses  String[]  @map("bcc_addresses") @default([])
  subject       String?   @db.VarChar(1000)
  textBody      String?   @map("text_body") @db.Text
  htmlBody      String?   @map("html_body") @db.Text
  messageId     String?   @map("message_id") @db.VarChar(500)
  attachments   Json?     @db.JsonB
  processed     Boolean   @default(false)
  processedAt   DateTime? @map("processed_at") @db.Timestamptz(6)
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  inboundTicket InboundSupportTicket?

  @@index([fromAddress], name: "idx_received_email_from")
  @@index([createdAt], name: "idx_received_email_created")
  @@index([processed], name: "idx_received_email_processed")
  @@map("received_emails")
}

// Email forwarding/routing configuration
model EmailForward {
  id            String   @id @default(uuid()) @db.Uuid
  fromAddress   String   @unique @map("from_address") @db.VarChar(255) // e.g., "support@chirhoevents.com"
  forwardTo     String[] @map("forward_to") // Array of emails to forward to
  createTicket  Boolean  @default(true) @map("create_ticket")
  autoReply     Boolean  @default(true) @map("auto_reply")
  autoReplyText String?  @map("auto_reply_text") @db.Text
  active        Boolean  @default(true)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([fromAddress], name: "idx_email_forward_from")
  @@index([active], name: "idx_email_forward_active")
  @@map("email_forwards")
}

// Support tickets from inbound emails (external/anonymous senders)
model InboundSupportTicket {
  id               String    @id @default(uuid()) @db.Uuid
  ticketNumber     Int       @unique @default(autoincrement()) @map("ticket_number")
  receivedEmailId  String?   @unique @map("received_email_id") @db.Uuid
  fromEmail        String    @map("from_email") @db.VarChar(255)
  fromName         String?   @map("from_name") @db.VarChar(255)
  subject          String    @db.VarChar(1000)
  message          String    @db.Text
  status           InboundTicketStatus @default(open)
  priority         InboundTicketPriority @default(normal)
  category         String?   @db.VarChar(100) // general, billing, technical, feature_request
  assignedToUserId String?   @map("assigned_to_user_id") @db.Uuid
  notes            String?   @db.Text
  resolvedAt       DateTime? @map("resolved_at") @db.Timestamptz(6)
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  receivedEmail    ReceivedEmail? @relation(fields: [receivedEmailId], references: [id])
  assignedToUser   User? @relation("InboundTicketsAssignedToUser", fields: [assignedToUserId], references: [id])
  replies          InboundTicketReply[]

  @@index([status], name: "idx_inbound_ticket_status")
  @@index([fromEmail], name: "idx_inbound_ticket_from")
  @@index([createdAt], name: "idx_inbound_ticket_created")
  @@index([assignedToUserId], name: "idx_inbound_ticket_assigned")
  @@map("inbound_support_tickets")
}

model InboundTicketReply {
  id         String   @id @default(uuid()) @db.Uuid
  ticketId   String   @map("ticket_id") @db.Uuid
  userId     String?  @map("user_id") @db.Uuid // null if from external sender
  fromEmail  String?  @map("from_email") @db.VarChar(255) // set if from external
  message    String   @db.Text
  isInternal Boolean  @default(false) @map("is_internal")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  ticket     InboundSupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user       User? @relation("InboundTicketRepliesByUser", fields: [userId], references: [id])

  @@index([ticketId], name: "idx_inbound_reply_ticket")
  @@map("inbound_ticket_replies")
}

enum InboundTicketStatus {
  open
  in_progress
  waiting_reply
  resolved
  closed
}

enum InboundTicketPriority {
  low
  normal
  high
  urgent
}

// ===================================
// STAFF & VENDOR REGISTRATION SYSTEM
// ===================================

model VendorRegistration {
  id                  String   @id @default(uuid()) @db.Uuid
  eventId             String   @map("event_id") @db.Uuid
  organizationId      String   @map("organization_id") @db.Uuid

  // Business Info
  businessName        String   @map("business_name") @db.VarChar(255)
  contactFirstName    String   @map("contact_first_name") @db.VarChar(255)
  contactLastName     String   @map("contact_last_name") @db.VarChar(255)
  email               String   @db.VarChar(255)
  phone               String   @db.VarChar(20)

  // Booth Details
  boothDescription    String   @map("booth_description") @db.Text
  selectedTier        String   @map("selected_tier") @db.VarChar(255)
  tierPrice           Decimal  @map("tier_price") @db.Decimal(10, 2)
  additionalNeeds     String?  @map("additional_needs") @db.Text

  // Business Logo
  logoUrl             String?  @map("logo_url") @db.Text

  // Status & Approval
  status              VendorStatus @default(pending)
  rejectionReason     String?  @map("rejection_reason") @db.Text
  approvedAt          DateTime? @map("approved_at") @db.Timestamptz(6)

  // Invoice (for booth itself)
  invoiceLineItems    Json?    @map("invoice_line_items") @db.JsonB // [{description: string, amount: number}]
  invoiceTotal        Decimal? @map("invoice_total") @db.Decimal(10, 2)
  invoiceNotes        String?  @map("invoice_notes") @db.Text
  paymentStatus       VendorPaymentStatus @default(unpaid) @map("payment_status")
  amountPaid          Decimal  @default(0) @map("amount_paid") @db.Decimal(10, 2)
  stripePaymentIntentId String? @map("stripe_payment_intent_id") @db.VarChar(255)
  paidAt              DateTime? @map("paid_at") @db.Timestamptz(6)

  // Vendor Code (for booth workers to use when registering)
  vendorCode          String   @unique @map("vendor_code") @db.VarChar(50)

  // Portal Access Code
  accessCode          String   @unique @map("access_code") @db.VarChar(50)

  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  event               Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  boothStaff          StaffRegistration[]

  @@index([eventId], name: "idx_vendor_reg_event")
  @@index([organizationId], name: "idx_vendor_reg_org")
  @@index([status], name: "idx_vendor_reg_status")
  @@index([vendorCode], name: "idx_vendor_reg_vendor_code")
  @@index([accessCode], name: "idx_vendor_reg_access_code")
  @@map("vendor_registrations")
}

model StaffRegistration {
  id                  String   @id @default(uuid()) @db.Uuid
  eventId             String   @map("event_id") @db.Uuid
  organizationId      String   @map("organization_id") @db.Uuid

  // Personal Info
  firstName           String   @map("first_name") @db.VarChar(255)
  lastName            String   @map("last_name") @db.VarChar(255)
  email               String   @db.VarChar(255)
  phone               String   @db.VarChar(20)

  // Role
  role                String   @db.VarChar(255) // From admin-defined dropdown

  // Vendor Association
  isVendorStaff       Boolean  @default(false) @map("is_vendor_staff")
  vendorCode          String?  @map("vendor_code") @db.VarChar(50)
  vendorRegistrationId String? @map("vendor_registration_id") @db.Uuid

  // Preferences
  tshirtSize          String   @map("tshirt_size") @db.VarChar(10)
  dietaryRestrictions String?  @map("dietary_restrictions") @db.Text

  // Payment (individual person fee)
  pricePaid           Decimal  @map("price_paid") @db.Decimal(10, 2)
  paymentStatus       StaffPaymentStatus @default(paid) @map("payment_status")
  stripePaymentIntentId String? @map("stripe_payment_intent_id") @db.VarChar(255)

  // Poros Integration (liability forms)
  porosAccessCode     String?  @unique @map("poros_access_code") @db.VarChar(50)
  liabilityFormId     String?  @map("liability_form_id") @db.Uuid

  // Check-in fields (SALVE integration)
  checkedIn           Boolean  @default(false) @map("checked_in")
  checkedInAt         DateTime? @map("checked_in_at") @db.Timestamptz(6)
  checkedInBy         String?  @map("checked_in_by") @db.Uuid
  qrCode              String?  @map("qr_code") @db.Text

  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  event               Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  vendorRegistration  VendorRegistration? @relation(fields: [vendorRegistrationId], references: [id], onDelete: SetNull)
  liabilityForm       LiabilityForm? @relation(fields: [liabilityFormId], references: [id], onDelete: SetNull)

  @@index([eventId], name: "idx_staff_reg_event")
  @@index([organizationId], name: "idx_staff_reg_org")
  @@index([vendorCode], name: "idx_staff_reg_vendor_code")
  @@index([porosAccessCode], name: "idx_staff_reg_poros_code")
  @@index([checkedIn], name: "idx_staff_reg_checked_in")
  @@map("staff_registrations")
}

enum VendorStatus {
  pending
  approved
  rejected
}

enum VendorPaymentStatus {
  unpaid
  partial
  paid
}

enum StaffPaymentStatus {
  pending
  paid
  waived
}

// ===================================
// COUPON SYSTEM
// ===================================

enum DiscountType {
  percentage
  fixed_amount
}

enum UsageLimitType {
  unlimited
  single_use
  limited
}

enum CouponRegistrationType {
  group
  individual
  staff
  vendor
}

model Coupon {
  id                 String         @id @default(uuid()) @db.Uuid
  organizationId     String         @map("organization_id") @db.Uuid
  eventId            String?        @map("event_id") @db.Uuid
  name               String         @db.VarChar(255)
  code               String         @db.VarChar(50)
  discountType       DiscountType   @default(percentage) @map("discount_type")
  discountValue      Decimal        @map("discount_value") @db.Decimal(10, 2)
  usageLimitType     UsageLimitType @default(unlimited) @map("usage_limit_type")
  usageCount         Int            @default(0) @map("usage_count")
  maxUses            Int?           @map("max_uses")
  isStackable        Boolean        @default(false) @map("is_stackable")
  restrictToEmail    String?        @map("restrict_to_email") @db.VarChar(255)
  expirationDate     DateTime?      @map("expiration_date") @db.Timestamptz(6)
  active             Boolean        @default(true)
  createdByUserId    String?        @map("created_by_user_id") @db.Uuid
  createdAt          DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization       Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  event              Event?         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  createdByUser      User?          @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)
  redemptions        CouponRedemption[]

  @@unique([eventId, code], name: "unique_coupon_code_per_event")
  @@index([organizationId], name: "idx_coupon_org")
  @@index([eventId], name: "idx_coupon_event")
  @@index([code], name: "idx_coupon_code")
  @@index([active], name: "idx_coupon_active")
  @@map("coupons")
}

model CouponRedemption {
  id                 String                 @id @default(uuid()) @db.Uuid
  couponId           String                 @map("coupon_id") @db.Uuid
  registrationId     String                 @map("registration_id") @db.Uuid
  registrationType   CouponRegistrationType @map("registration_type")
  discountApplied    Decimal                @map("discount_applied") @db.Decimal(10, 2)
  redeemedAt         DateTime               @default(now()) @map("redeemed_at") @db.Timestamptz(6)

  // Relations
  coupon             Coupon                 @relation(fields: [couponId], references: [id], onDelete: Cascade)

  @@index([couponId], name: "idx_redemption_coupon")
  @@index([registrationId], name: "idx_redemption_registration")
  @@map("coupon_redemptions")
}

// Stores imported JSON data for custom Poros public views (e.g., Mount 2K)
model PorosEventDataImport {
  id             String   @id @default(uuid()) @db.Uuid
  eventId        String   @unique @map("event_id") @db.Uuid
  jsonData       Json     @map("json_data")
  fileName       String?  @map("file_name") @db.VarChar(255)
  importedAt     DateTime @default(now()) @map("imported_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  event          Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId], name: "idx_poros_import_event")
  @@map("poros_event_data_imports")
}

